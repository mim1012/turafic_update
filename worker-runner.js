#!/usr/bin/env npx tsx
"use strict";var hb=Object.create;var Ki=Object.defineProperty;var fb=Object.getOwnPropertyDescriptor;var pb=Object.getOwnPropertyNames;var mb=Object.getPrototypeOf,gb=Object.prototype.hasOwnProperty;var E=(s,e)=>()=>(s&&(e=s(s=0)),e);var R=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports),zi=(s,e)=>{for(var t in e)Ki(s,t,{get:e[t],enumerable:!0})},Of=(s,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of pb(e))!gb.call(s,i)&&i!==t&&Ki(s,i,{get:()=>e[i],enumerable:!(r=fb(e,i))||r.enumerable});return s};var Jt=(s,e,t)=>(t=s!=null?hb(mb(s)):{},Of(e||!s||!s.__esModule?Ki(t,"default",{value:s,enumerable:!0}):t,s)),X=s=>Of(Ki({},"__esModule",{value:!0}),s);function Lr(s){return new Promise(e=>setTimeout(e,s))}async function Sn(s,e,t,r=15){let i=e.trim(),n=t.trim();if(!i||!n)return console.log("\u26A0\uFE0F \uD0A4\uC6CC\uB4DC \uB610\uB294 MID\uAC00 \uBE44\uC5B4 \uC788\uC2B5\uB2C8\uB2E4."),null;let o=Math.max(1,Math.min(r,15));if(console.log(`\u{1F50D} "${i}" / MID ${n} \uC21C\uC704 \uCD94\uC801 (\uCD5C\uB300 ${o}\uD398\uC774\uC9C0)`),!await e_(s,i))return console.log("\u274C \uC1FC\uD551\uD0ED \uC9C4\uC785\uC5D0 \uC2E4\uD328\uD588\uC2B5\uB2C8\uB2E4."),null;if(console.log("\u{1F4C4} 1\uD398\uC774\uC9C0 \uC0C1\uD488 \uC218\uC9D1 (DOM \uBC29\uC2DD)"),await t_(s),await ym(s))return console.log("\u{1F6D1} \uBCF4\uC548 \uD398\uC774\uC9C0 \uAC10\uC9C0\uB428 (CAPTCHA)"),null;let c=(await r_(s,1)).products.find(u=>u.mid===n);if(c)return console.log(`\u2705 \uC21C\uC704 \uBC1C\uACAC: \uC804\uCCB4 ${c.totalRank}\uC704 / \uC624\uAC00\uB2C9 ${c.organicRank>0?c.organicRank:"-"}`),{found:!0,mid:c.mid,productName:c.productName,totalRank:c.totalRank,organicRank:c.organicRank,isAd:c.isAd,page:1,pagePosition:c.pagePosition};for(let u=2;u<=o;u++){console.log(`\u{1F4C4} ${u}\uD398\uC774\uC9C0 \uC0C1\uD488 \uC218\uC9D1 (API \uBC29\uC2DD)`);let f=await s_(s,u);if(!f){console.log(`\u26A0\uFE0F ${u}\uD398\uC774\uC9C0 API \uB370\uC774\uD130 \uC218\uC9D1 \uC2E4\uD328`);break}let d=f.find(h=>h.mid===n);if(d)return console.log(`\u2705 \uC21C\uC704 \uBC1C\uACAC: \uC804\uCCB4 ${d.totalRank}\uC704 / \uC624\uAC00\uB2C9 ${d.organicRank>0?d.organicRank:"-"}`),{found:!0,mid:d.mid,productName:d.productName,totalRank:d.totalRank,organicRank:d.organicRank,isAd:d.isAd,page:u,pagePosition:d.pagePosition};await Lr(2600)}return console.log(`\u274C ${n}\uC744(\uB97C) ${o}\uD398\uC774\uC9C0 \uB0B4\uC5D0\uC11C \uCC3E\uC9C0 \uBABB\uD588\uC2B5\uB2C8\uB2E4.`),null}async function e_(s,e){console.log("\u{1F9ED} \uB124\uC774\uBC84 \uBA54\uC778 \uC9C4\uC785");try{await s.goto("https://www.naver.com/",{waitUntil:"domcontentloaded",timeout:2e4})}catch(i){return console.log("\u26A0\uFE0F \uB124\uC774\uBC84 \uC9C4\uC785 \uC2E4\uD328",i),!1}await Lr(2600);let t=await s.waitForSelector('input[name="query"]',{timeout:7e3}).catch(()=>null);return t?(await t.click({clickCount:3}),await s.keyboard.type(e,{delay:70}),await s.keyboard.press("Enter"),await Lr(3100),console.log("\u{1F6D2} \uC1FC\uD551\uD0ED\uC73C\uB85C \uC774\uB3D9"),await s.evaluate(()=>{let i=document.querySelector('a[href*="search.shopping.naver.com"]');return i?(i.removeAttribute("target"),i.click(),!0):!1})?(await Lr(3400),s.url().includes("search.shopping.naver.com")?await ym(s)?(console.log("\u{1F6D1} \uC1FC\uD551\uD0ED \uC9C4\uC785 \uC911 \uBCF4\uC548 \uD398\uC774\uC9C0\uAC00 \uB178\uCD9C\uB418\uC5C8\uC2B5\uB2C8\uB2E4."),!1):!0:(console.log("\u26A0\uFE0F \uC1FC\uD551\uD0ED URL\uC774 \uD655\uC778\uB418\uC9C0 \uC54A\uC558\uC2B5\uB2C8\uB2E4."),!1)):(console.log("\u274C \uC1FC\uD551\uD0ED \uB9C1\uD06C\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4."),!1)):(console.log("\u274C \uAC80\uC0C9 \uC785\uB825\uCC3D\uC744 \uCC3E\uC744 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4."),!1)}async function t_(s){await s.evaluate(()=>window.scrollTo(0,0));for(let e=0;e<18;e++)await s.evaluate(()=>window.scrollBy(0,550)),await Lr(250);await Lr(600)}async function r_(s,e){return await s.$$eval("a[data-shp-contents-id][data-shp-contents-rank]",(r,i)=>{let n=new Set,o=[];for(let a of r){let l=a.getAttribute("data-shp-contents-id"),c=a.getAttribute("data-shp-contents-rank");if(!l||!c)continue;let u=parseInt(c,10);if(!Number.isFinite(u)||n.has(l))continue;let f=-1,d=a.getAttribute("data-shp-contents-dtl");if(d)try{let b=d.replace(/&quot;/g,'"'),v=JSON.parse(b);if(Array.isArray(v)){let A=v.find(N=>N&&N.key==="organic_expose_order");if(A){let N=parseInt(String(A.value),10);Number.isFinite(N)&&(f=N)}}}catch{}let h="\uC0C1\uD488\uBA85 \uC5C6\uC74C",g=a.getAttribute("title")||a.getAttribute("aria-label");if(g)h=g.trim();else{let b=a.querySelector('.product_title__Mmw2K, [class*="title"], strong');b&&b.textContent?h=b.textContent.replace(/\s+/g," ").trim():a.textContent&&(h=a.textContent.replace(/\s+/g," ").trim().substring(0,50))}let y=a.getAttribute("data-shp-inventory")||"",_=/lst\*(A|P|D)/.test(y);o.push({mid:l,productName:h,totalRank:u,organicRank:f>=0?f:-1,isAd:_,pagePosition:0}),n.add(l)}o.sort((a,l)=>a.totalRank-l.totalRank);for(let a=0;a<o.length;a++)o[a].pagePosition=a+1,o[a].organicRank<0&&!o[a].isAd&&(o[a].organicRank=o[a].totalRank);return{products:o,firstMid:o.length>0?o[0].mid:null,firstRank:o.length>0?o[0].totalRank:null}},e)}async function s_(s,e){if(!await s.evaluate(i=>{let n=document.querySelectorAll('a.pagination_btn_page__utqBz, a[class*="pagination_btn"]');for(let o of n)if(o.textContent?.trim()===String(i))return!0;return!1},e))return console.log(`\u26A0\uFE0F ${e}\uD398\uC774\uC9C0 \uBC84\uD2BC\uC744 \uCC3E\uC9C0 \uBABB\uD588\uC2B5\uB2C8\uB2E4.`),null;let r=s.waitForResponse(i=>{let n=i.url();return n.includes("/api/search/all")&&n.includes(`pagingIndex=${e}`)},{timeout:15e3});try{let i=await s.evaluateHandle(n=>{let o=document.querySelectorAll('a.pagination_btn_page__utqBz, a[class*="pagination_btn"]');for(let a of o)if(a.textContent?.trim()===String(n))return a;return null},e);if(!i)return console.log("\u26A0\uFE0F \uBC84\uD2BC element\uB97C \uAC00\uC838\uC62C \uC218 \uC5C6\uC2B5\uB2C8\uB2E4."),null;await i.asElement().click(),console.log("   \uBC84\uD2BC \uD074\uB9AD, API \uC751\uB2F5 \uB300\uAE30 \uC911...")}catch(i){return console.log(`   \u26A0\uFE0F \uBC84\uD2BC \uD074\uB9AD \uC2E4\uD328: ${i}`),null}try{let i=await r;console.log("   \u2705 API \uC751\uB2F5 \uC218\uC2E0");let n=await i.json();if(!n.shoppingResult?.products)return console.log("   \u26A0\uFE0F API \uC751\uB2F5\uC5D0 products \uC5C6\uC74C"),null;let o=[],a=n.shoppingResult.products;for(let l=0;l<a.length;l++){let c=a[l],u=c.id||c.nvMid||"",f=c.rank||(e-1)*40+l+1,d=c.rankInfo?.organicRank||-1,h=c.productTitle||c.title||"\uC0C1\uD488\uBA85 \uC5C6\uC74C",g=c.adcrType!==void 0&&c.adcrType!==null;u&&o.push({mid:u,productName:h,totalRank:f,organicRank:d>0?d:f,isAd:g,pagePosition:l+1})}return console.log(`   \uC218\uC9D1: ${o.length}\uAC1C \uC0C1\uD488 (${o[0]?.totalRank||"?"}\uC704~${o[o.length-1]?.totalRank||"?"}\uC704)`),o}catch(i){return console.log(`   \u26A0\uFE0F API \uC751\uB2F5 \uD0C0\uC784\uC544\uC6C3 \uB610\uB294 \uD30C\uC2F1 \uC2E4\uD328: ${i}`),null}}async function ym(s){return s.evaluate(()=>{let e=document.body?.innerText??"";return e.includes("\uBCF4\uC548 \uD655\uC778")||e.includes("\uC790\uB3D9 \uC785\uB825 \uBC29\uC9C0")||e.includes("\uC77C\uC2DC\uC801\uC73C\uB85C \uC81C\uD55C")})}var eu=E(()=>{"use strict"});var W={};zi(W,{__addDisposableResource:()=>Fm,__assign:()=>En,__asyncDelegator:()=>Im,__asyncGenerator:()=>$m,__asyncValues:()=>Mm,__await:()=>qr,__awaiter:()=>Pm,__classPrivateFieldGet:()=>qm,__classPrivateFieldIn:()=>Bm,__classPrivateFieldSet:()=>Um,__createBinding:()=>An,__decorate:()=>_m,__disposeResources:()=>Vm,__esDecorate:()=>Sm,__exportStar:()=>Cm,__extends:()=>wm,__generator:()=>xm,__importDefault:()=>Lm,__importStar:()=>jm,__makeTemplateObject:()=>Dm,__metadata:()=>km,__param:()=>vm,__propKey:()=>Tm,__read:()=>su,__rest:()=>bm,__rewriteRelativeImportExtension:()=>Hm,__runInitializers:()=>Em,__setFunctionName:()=>Am,__spread:()=>Rm,__spreadArray:()=>Nm,__spreadArrays:()=>Om,__values:()=>Tn,default:()=>o_});function wm(s,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");tu(s,e);function t(){this.constructor=s}s.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}function bm(s,e){var t={};for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&e.indexOf(r)<0&&(t[r]=s[r]);if(s!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,r=Object.getOwnPropertySymbols(s);i<r.length;i++)e.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(s,r[i])&&(t[r[i]]=s[r[i]]);return t}function _m(s,e,t,r){var i=arguments.length,n=i<3?e:r===null?r=Object.getOwnPropertyDescriptor(e,t):r,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(s,e,t,r);else for(var a=s.length-1;a>=0;a--)(o=s[a])&&(n=(i<3?o(n):i>3?o(e,t,n):o(e,t))||n);return i>3&&n&&Object.defineProperty(e,t,n),n}function vm(s,e){return function(t,r){e(t,r,s)}}function Sm(s,e,t,r,i,n){function o(b){if(b!==void 0&&typeof b!="function")throw new TypeError("Function expected");return b}for(var a=r.kind,l=a==="getter"?"get":a==="setter"?"set":"value",c=!e&&s?r.static?s:s.prototype:null,u=e||(c?Object.getOwnPropertyDescriptor(c,r.name):{}),f,d=!1,h=t.length-1;h>=0;h--){var g={};for(var y in r)g[y]=y==="access"?{}:r[y];for(var y in r.access)g.access[y]=r.access[y];g.addInitializer=function(b){if(d)throw new TypeError("Cannot add initializers after decoration has completed");n.push(o(b||null))};var _=(0,t[h])(a==="accessor"?{get:u.get,set:u.set}:u[l],g);if(a==="accessor"){if(_===void 0)continue;if(_===null||typeof _!="object")throw new TypeError("Object expected");(f=o(_.get))&&(u.get=f),(f=o(_.set))&&(u.set=f),(f=o(_.init))&&i.unshift(f)}else(f=o(_))&&(a==="field"?i.unshift(f):u[l]=f)}c&&Object.defineProperty(c,r.name,u),d=!0}function Em(s,e,t){for(var r=arguments.length>2,i=0;i<e.length;i++)t=r?e[i].call(s,t):e[i].call(s);return r?t:void 0}function Tm(s){return typeof s=="symbol"?s:"".concat(s)}function Am(s,e,t){return typeof e=="symbol"&&(e=e.description?"[".concat(e.description,"]"):""),Object.defineProperty(s,"name",{configurable:!0,value:t?"".concat(t," ",e):e})}function km(s,e){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(s,e)}function Pm(s,e,t,r){function i(n){return n instanceof t?n:new t(function(o){o(n)})}return new(t||(t=Promise))(function(n,o){function a(u){try{c(r.next(u))}catch(f){o(f)}}function l(u){try{c(r.throw(u))}catch(f){o(f)}}function c(u){u.done?n(u.value):i(u.value).then(a,l)}c((r=r.apply(s,e||[])).next())})}function xm(s,e){var t={label:0,sent:function(){if(n[0]&1)throw n[1];return n[1]},trys:[],ops:[]},r,i,n,o=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return o.next=a(0),o.throw=a(1),o.return=a(2),typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function a(c){return function(u){return l([c,u])}}function l(c){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,c[0]&&(t=0)),t;)try{if(r=1,i&&(n=c[0]&2?i.return:c[0]?i.throw||((n=i.return)&&n.call(i),0):i.next)&&!(n=n.call(i,c[1])).done)return n;switch(i=0,n&&(c=[c[0]&2,n.value]),c[0]){case 0:case 1:n=c;break;case 4:return t.label++,{value:c[1],done:!1};case 5:t.label++,i=c[1],c=[0];continue;case 7:c=t.ops.pop(),t.trys.pop();continue;default:if(n=t.trys,!(n=n.length>0&&n[n.length-1])&&(c[0]===6||c[0]===2)){t=0;continue}if(c[0]===3&&(!n||c[1]>n[0]&&c[1]<n[3])){t.label=c[1];break}if(c[0]===6&&t.label<n[1]){t.label=n[1],n=c;break}if(n&&t.label<n[2]){t.label=n[2],t.ops.push(c);break}n[2]&&t.ops.pop(),t.trys.pop();continue}c=e.call(s,t)}catch(u){c=[6,u],i=0}finally{r=n=0}if(c[0]&5)throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}function Cm(s,e){for(var t in s)t!=="default"&&!Object.prototype.hasOwnProperty.call(e,t)&&An(e,s,t)}function Tn(s){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&s[e],r=0;if(t)return t.call(s);if(s&&typeof s.length=="number")return{next:function(){return s&&r>=s.length&&(s=void 0),{value:s&&s[r++],done:!s}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function su(s,e){var t=typeof Symbol=="function"&&s[Symbol.iterator];if(!t)return s;var r=t.call(s),i,n=[],o;try{for(;(e===void 0||e-- >0)&&!(i=r.next()).done;)n.push(i.value)}catch(a){o={error:a}}finally{try{i&&!i.done&&(t=r.return)&&t.call(r)}finally{if(o)throw o.error}}return n}function Rm(){for(var s=[],e=0;e<arguments.length;e++)s=s.concat(su(arguments[e]));return s}function Om(){for(var s=0,e=0,t=arguments.length;e<t;e++)s+=arguments[e].length;for(var r=Array(s),i=0,e=0;e<t;e++)for(var n=arguments[e],o=0,a=n.length;o<a;o++,i++)r[i]=n[o];return r}function Nm(s,e,t){if(t||arguments.length===2)for(var r=0,i=e.length,n;r<i;r++)(n||!(r in e))&&(n||(n=Array.prototype.slice.call(e,0,r)),n[r]=e[r]);return s.concat(n||Array.prototype.slice.call(e))}function qr(s){return this instanceof qr?(this.v=s,this):new qr(s)}function $m(s,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r=t.apply(s,e||[]),i,n=[];return i=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),a("next"),a("throw"),a("return",o),i[Symbol.asyncIterator]=function(){return this},i;function o(h){return function(g){return Promise.resolve(g).then(h,f)}}function a(h,g){r[h]&&(i[h]=function(y){return new Promise(function(_,b){n.push([h,y,_,b])>1||l(h,y)})},g&&(i[h]=g(i[h])))}function l(h,g){try{c(r[h](g))}catch(y){d(n[0][3],y)}}function c(h){h.value instanceof qr?Promise.resolve(h.value.v).then(u,f):d(n[0][2],h)}function u(h){l("next",h)}function f(h){l("throw",h)}function d(h,g){h(g),n.shift(),n.length&&l(n[0][0],n[0][1])}}function Im(s){var e,t;return e={},r("next"),r("throw",function(i){throw i}),r("return"),e[Symbol.iterator]=function(){return this},e;function r(i,n){e[i]=s[i]?function(o){return(t=!t)?{value:qr(s[i](o)),done:!1}:n?n(o):o}:n}}function Mm(s){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=s[Symbol.asyncIterator],t;return e?e.call(s):(s=typeof Tn=="function"?Tn(s):s[Symbol.iterator](),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(n){t[n]=s[n]&&function(o){return new Promise(function(a,l){o=s[n](o),i(a,l,o.done,o.value)})}}function i(n,o,a,l){Promise.resolve(l).then(function(c){n({value:c,done:a})},o)}}function Dm(s,e){return Object.defineProperty?Object.defineProperty(s,"raw",{value:e}):s.raw=e,s}function jm(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t=ru(s),r=0;r<t.length;r++)t[r]!=="default"&&An(e,s,t[r]);return i_(e,s),e}function Lm(s){return s&&s.__esModule?s:{default:s}}function qm(s,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?s!==e||!r:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(s):r?r.value:e.get(s)}function Um(s,e,t,r,i){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?s!==e||!i:!e.has(s))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?i.call(s,t):i?i.value=t:e.set(s,t),t}function Bm(s,e){if(e===null||typeof e!="object"&&typeof e!="function")throw new TypeError("Cannot use 'in' operator on non-object");return typeof s=="function"?e===s:s.has(e)}function Fm(s,e,t){if(e!=null){if(typeof e!="object"&&typeof e!="function")throw new TypeError("Object expected.");var r,i;if(t){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");r=e[Symbol.asyncDispose]}if(r===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");r=e[Symbol.dispose],t&&(i=r)}if(typeof r!="function")throw new TypeError("Object not disposable.");i&&(r=function(){try{i.call(this)}catch(n){return Promise.reject(n)}}),s.stack.push({value:e,dispose:r,async:t})}else t&&s.stack.push({async:!0});return e}function Vm(s){function e(n){s.error=s.hasError?new n_(n,s.error,"An error was suppressed during disposal."):n,s.hasError=!0}var t,r=0;function i(){for(;t=s.stack.pop();)try{if(!t.async&&r===1)return r=0,s.stack.push(t),Promise.resolve().then(i);if(t.dispose){var n=t.dispose.call(t.value);if(t.async)return r|=2,Promise.resolve(n).then(i,function(o){return e(o),i()})}else r|=1}catch(o){e(o)}if(r===1)return s.hasError?Promise.reject(s.error):Promise.resolve();if(s.hasError)throw s.error}return i()}function Hm(s,e){return typeof s=="string"&&/^\.\.?\//.test(s)?s.replace(/\.(tsx)$|((?:\.d)?)((?:\.[^./]+?)?)\.([cm]?)ts$/i,function(t,r,i,n,o){return r?e?".jsx":".js":i&&(!n||!o)?t:i+n+"."+o.toLowerCase()+"js"}):s}var tu,En,An,i_,ru,n_,o_,Q=E(()=>{tu=function(s,e){return tu=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(t[i]=r[i])},tu(s,e)};En=function(){return En=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++){t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e},En.apply(this,arguments)};An=Object.create?(function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}):(function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]});i_=Object.create?(function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}):function(s,e){s.default=e},ru=function(s){return ru=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},ru(s)};n_=typeof SuppressedError=="function"?SuppressedError:function(s,e,t){var r=new Error(t);return r.name="SuppressedError",r.error=s,r.suppressed=e,r};o_={__extends:wm,__assign:En,__rest:bm,__decorate:_m,__param:vm,__esDecorate:Sm,__runInitializers:Em,__propKey:Tm,__setFunctionName:Am,__metadata:km,__awaiter:Pm,__generator:xm,__createBinding:An,__exportStar:Cm,__values:Tn,__read:su,__spread:Rm,__spreadArrays:Om,__spreadArray:Nm,__await:qr,__asyncGenerator:$m,__asyncDelegator:Im,__asyncValues:Mm,__makeTemplateObject:Dm,__importStar:jm,__importDefault:Lm,__classPrivateFieldGet:qm,__classPrivateFieldSet:Um,__classPrivateFieldIn:Bm,__addDisposableResource:Fm,__disposeResources:Vm,__rewriteRelativeImportExtension:Hm}});var Km=R(kn=>{"use strict";Object.defineProperty(kn,"__esModule",{value:!0});kn.resolveFetch=void 0;var a_=s=>s?(...e)=>s(...e):(...e)=>fetch(...e);kn.resolveFetch=a_});var au=R(st=>{"use strict";Object.defineProperty(st,"__esModule",{value:!0});st.FunctionRegion=st.FunctionsHttpError=st.FunctionsRelayError=st.FunctionsFetchError=st.FunctionsError=void 0;var Ur=class extends Error{constructor(e,t="FunctionsError",r){super(e),this.name=t,this.context=r}};st.FunctionsError=Ur;var iu=class extends Ur{constructor(e){super("Failed to send a request to the Edge Function","FunctionsFetchError",e)}};st.FunctionsFetchError=iu;var nu=class extends Ur{constructor(e){super("Relay Error invoking the Edge Function","FunctionsRelayError",e)}};st.FunctionsRelayError=nu;var ou=class extends Ur{constructor(e){super("Edge Function returned a non-2xx status code","FunctionsHttpError",e)}};st.FunctionsHttpError=ou;var zm;(function(s){s.Any="any",s.ApNortheast1="ap-northeast-1",s.ApNortheast2="ap-northeast-2",s.ApSouth1="ap-south-1",s.ApSoutheast1="ap-southeast-1",s.ApSoutheast2="ap-southeast-2",s.CaCentral1="ca-central-1",s.EuCentral1="eu-central-1",s.EuWest1="eu-west-1",s.EuWest2="eu-west-2",s.EuWest3="eu-west-3",s.SaEast1="sa-east-1",s.UsEast1="us-east-1",s.UsWest1="us-west-1",s.UsWest2="us-west-2"})(zm||(st.FunctionRegion=zm={}))});var Wm=R(Pn=>{"use strict";Object.defineProperty(Pn,"__esModule",{value:!0});Pn.FunctionsClient=void 0;var l_=(Q(),X(W)),c_=Km(),Br=au(),lu=class{constructor(e,{headers:t={},customFetch:r,region:i=Br.FunctionRegion.Any}={}){this.url=e,this.headers=t,this.region=i,this.fetch=(0,c_.resolveFetch)(r)}setAuth(e){this.headers.Authorization=`Bearer ${e}`}invoke(e){return l_.__awaiter(this,arguments,void 0,function*(t,r={}){var i;let n,o;try{let{headers:a,method:l,body:c,signal:u,timeout:f}=r,d={},{region:h}=r;h||(h=this.region);let g=new URL(`${this.url}/${t}`);h&&h!=="any"&&(d["x-region"]=h,g.searchParams.set("forceFunctionRegion",h));let y;c&&(a&&!Object.prototype.hasOwnProperty.call(a,"Content-Type")||!a)?typeof Blob<"u"&&c instanceof Blob||c instanceof ArrayBuffer?(d["Content-Type"]="application/octet-stream",y=c):typeof c=="string"?(d["Content-Type"]="text/plain",y=c):typeof FormData<"u"&&c instanceof FormData?y=c:(d["Content-Type"]="application/json",y=JSON.stringify(c)):y=c;let _=u;f&&(o=new AbortController,n=setTimeout(()=>o.abort(),f),u?(_=o.signal,u.addEventListener("abort",()=>o.abort())):_=o.signal);let b=yield this.fetch(g.toString(),{method:l||"POST",headers:Object.assign(Object.assign(Object.assign({},d),this.headers),a),body:y,signal:_}).catch(te=>{throw new Br.FunctionsFetchError(te)}),v=b.headers.get("x-relay-error");if(v&&v==="true")throw new Br.FunctionsRelayError(b);if(!b.ok)throw new Br.FunctionsHttpError(b);let A=((i=b.headers.get("Content-Type"))!==null&&i!==void 0?i:"text/plain").split(";")[0].trim(),N;return A==="application/json"?N=yield b.json():A==="application/octet-stream"||A==="application/pdf"?N=yield b.blob():A==="text/event-stream"?N=b:A==="multipart/form-data"?N=yield b.formData():N=yield b.text(),{data:N,error:null,response:b}}catch(a){return{data:null,error:a,response:a instanceof Br.FunctionsHttpError||a instanceof Br.FunctionsRelayError?a.context:void 0}}finally{n&&clearTimeout(n)}})}};Pn.FunctionsClient=lu});var cu=R(Ke=>{"use strict";Object.defineProperty(Ke,"__esModule",{value:!0});Ke.FunctionRegion=Ke.FunctionsRelayError=Ke.FunctionsHttpError=Ke.FunctionsFetchError=Ke.FunctionsError=Ke.FunctionsClient=void 0;var u_=Wm();Object.defineProperty(Ke,"FunctionsClient",{enumerable:!0,get:function(){return u_.FunctionsClient}});var Zs=au();Object.defineProperty(Ke,"FunctionsError",{enumerable:!0,get:function(){return Zs.FunctionsError}});Object.defineProperty(Ke,"FunctionsFetchError",{enumerable:!0,get:function(){return Zs.FunctionsFetchError}});Object.defineProperty(Ke,"FunctionsHttpError",{enumerable:!0,get:function(){return Zs.FunctionsHttpError}});Object.defineProperty(Ke,"FunctionsRelayError",{enumerable:!0,get:function(){return Zs.FunctionsRelayError}});Object.defineProperty(Ke,"FunctionRegion",{enumerable:!0,get:function(){return Zs.FunctionRegion}})});var hu=R(du=>{"use strict";Object.defineProperty(du,"__esModule",{value:!0});var uu=class extends Error{constructor(e){super(e.message),this.name="PostgrestError",this.details=e.details,this.hint=e.hint,this.code=e.code}};du.default=uu});var mu=R(pu=>{"use strict";Object.defineProperty(pu,"__esModule",{value:!0});var d_=(Q(),X(W)),h_=d_.__importDefault(hu()),fu=class{constructor(e){var t,r;this.shouldThrowOnError=!1,this.method=e.method,this.url=e.url,this.headers=new Headers(e.headers),this.schema=e.schema,this.body=e.body,this.shouldThrowOnError=(t=e.shouldThrowOnError)!==null&&t!==void 0?t:!1,this.signal=e.signal,this.isMaybeSingle=(r=e.isMaybeSingle)!==null&&r!==void 0?r:!1,e.fetch?this.fetch=e.fetch:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(e,t){return this.headers=new Headers(this.headers),this.headers.set(e,t),this}then(e,t){this.schema===void 0||(["GET","HEAD"].includes(this.method)?this.headers.set("Accept-Profile",this.schema):this.headers.set("Content-Profile",this.schema)),this.method!=="GET"&&this.method!=="HEAD"&&this.headers.set("Content-Type","application/json");let r=this.fetch,i=r(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async n=>{var o,a,l,c;let u=null,f=null,d=null,h=n.status,g=n.statusText;if(n.ok){if(this.method!=="HEAD"){let v=await n.text();v===""||(this.headers.get("Accept")==="text/csv"||this.headers.get("Accept")&&(!((o=this.headers.get("Accept"))===null||o===void 0)&&o.includes("application/vnd.pgrst.plan+text"))?f=v:f=JSON.parse(v))}let _=(a=this.headers.get("Prefer"))===null||a===void 0?void 0:a.match(/count=(exact|planned|estimated)/),b=(l=n.headers.get("content-range"))===null||l===void 0?void 0:l.split("/");_&&b&&b.length>1&&(d=parseInt(b[1])),this.isMaybeSingle&&this.method==="GET"&&Array.isArray(f)&&(f.length>1?(u={code:"PGRST116",details:`Results contain ${f.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},f=null,d=null,h=406,g="Not Acceptable"):f.length===1?f=f[0]:f=null)}else{let _=await n.text();try{u=JSON.parse(_),Array.isArray(u)&&n.status===404&&(f=[],u=null,h=200,g="OK")}catch{n.status===404&&_===""?(h=204,g="No Content"):u={message:_}}if(u&&this.isMaybeSingle&&(!((c=u?.details)===null||c===void 0)&&c.includes("0 rows"))&&(u=null,h=200,g="OK"),u&&this.shouldThrowOnError)throw new h_.default(u)}return{error:u,data:f,count:d,status:h,statusText:g}});return this.shouldThrowOnError||(i=i.catch(n=>{var o,a,l,c,u,f;let d="",h=n?.cause;if(h){let g=(o=h?.message)!==null&&o!==void 0?o:"",y=(a=h?.code)!==null&&a!==void 0?a:"";d=`${(l=n?.name)!==null&&l!==void 0?l:"FetchError"}: ${n?.message}`,d+=`

Caused by: ${(c=h?.name)!==null&&c!==void 0?c:"Error"}: ${g}`,y&&(d+=` (${y})`),h?.stack&&(d+=`
${h.stack}`)}else d=(u=n?.stack)!==null&&u!==void 0?u:"";return{error:{message:`${(f=n?.name)!==null&&f!==void 0?f:"FetchError"}: ${n?.message}`,details:d,hint:"",code:""},data:null,count:null,status:0,statusText:""}})),i.then(e,t)}returns(){return this}overrideTypes(){return this}};pu.default=fu});var wu=R(yu=>{"use strict";Object.defineProperty(yu,"__esModule",{value:!0});var f_=(Q(),X(W)),p_=f_.__importDefault(mu()),gu=class extends p_.default{select(e){let t=!1,r=(e??"*").split("").map(i=>/\s/.test(i)&&!t?"":(i==='"'&&(t=!t),i)).join("");return this.url.searchParams.set("select",r),this.headers.append("Prefer","return=representation"),this}order(e,{ascending:t=!0,nullsFirst:r,foreignTable:i,referencedTable:n=i}={}){let o=n?`${n}.order`:"order",a=this.url.searchParams.get(o);return this.url.searchParams.set(o,`${a?`${a},`:""}${e}.${t?"asc":"desc"}${r===void 0?"":r?".nullsfirst":".nullslast"}`),this}limit(e,{foreignTable:t,referencedTable:r=t}={}){let i=typeof r>"u"?"limit":`${r}.limit`;return this.url.searchParams.set(i,`${e}`),this}range(e,t,{foreignTable:r,referencedTable:i=r}={}){let n=typeof i>"u"?"offset":`${i}.offset`,o=typeof i>"u"?"limit":`${i}.limit`;return this.url.searchParams.set(n,`${e}`),this.url.searchParams.set(o,`${t-e+1}`),this}abortSignal(e){return this.signal=e,this}single(){return this.headers.set("Accept","application/vnd.pgrst.object+json"),this}maybeSingle(){return this.method==="GET"?this.headers.set("Accept","application/json"):this.headers.set("Accept","application/vnd.pgrst.object+json"),this.isMaybeSingle=!0,this}csv(){return this.headers.set("Accept","text/csv"),this}geojson(){return this.headers.set("Accept","application/geo+json"),this}explain({analyze:e=!1,verbose:t=!1,settings:r=!1,buffers:i=!1,wal:n=!1,format:o="text"}={}){var a;let l=[e?"analyze":null,t?"verbose":null,r?"settings":null,i?"buffers":null,n?"wal":null].filter(Boolean).join("|"),c=(a=this.headers.get("Accept"))!==null&&a!==void 0?a:"application/json";return this.headers.set("Accept",`application/vnd.pgrst.plan+${o}; for="${c}"; options=${l};`),o==="json"?this:this}rollback(){return this.headers.append("Prefer","tx=rollback"),this}returns(){return this}maxAffected(e){return this.headers.append("Prefer","handling=strict"),this.headers.append("Prefer",`max-affected=${e}`),this}};yu.default=gu});var xn=R(_u=>{"use strict";Object.defineProperty(_u,"__esModule",{value:!0});var m_=(Q(),X(W)),g_=m_.__importDefault(wu()),y_=new RegExp("[,()]"),bu=class extends g_.default{eq(e,t){return this.url.searchParams.append(e,`eq.${t}`),this}neq(e,t){return this.url.searchParams.append(e,`neq.${t}`),this}gt(e,t){return this.url.searchParams.append(e,`gt.${t}`),this}gte(e,t){return this.url.searchParams.append(e,`gte.${t}`),this}lt(e,t){return this.url.searchParams.append(e,`lt.${t}`),this}lte(e,t){return this.url.searchParams.append(e,`lte.${t}`),this}like(e,t){return this.url.searchParams.append(e,`like.${t}`),this}likeAllOf(e,t){return this.url.searchParams.append(e,`like(all).{${t.join(",")}}`),this}likeAnyOf(e,t){return this.url.searchParams.append(e,`like(any).{${t.join(",")}}`),this}ilike(e,t){return this.url.searchParams.append(e,`ilike.${t}`),this}ilikeAllOf(e,t){return this.url.searchParams.append(e,`ilike(all).{${t.join(",")}}`),this}ilikeAnyOf(e,t){return this.url.searchParams.append(e,`ilike(any).{${t.join(",")}}`),this}regexMatch(e,t){return this.url.searchParams.append(e,`match.${t}`),this}regexIMatch(e,t){return this.url.searchParams.append(e,`imatch.${t}`),this}is(e,t){return this.url.searchParams.append(e,`is.${t}`),this}isDistinct(e,t){return this.url.searchParams.append(e,`isdistinct.${t}`),this}in(e,t){let r=Array.from(new Set(t)).map(i=>typeof i=="string"&&y_.test(i)?`"${i}"`:`${i}`).join(",");return this.url.searchParams.append(e,`in.(${r})`),this}contains(e,t){return typeof t=="string"?this.url.searchParams.append(e,`cs.${t}`):Array.isArray(t)?this.url.searchParams.append(e,`cs.{${t.join(",")}}`):this.url.searchParams.append(e,`cs.${JSON.stringify(t)}`),this}containedBy(e,t){return typeof t=="string"?this.url.searchParams.append(e,`cd.${t}`):Array.isArray(t)?this.url.searchParams.append(e,`cd.{${t.join(",")}}`):this.url.searchParams.append(e,`cd.${JSON.stringify(t)}`),this}rangeGt(e,t){return this.url.searchParams.append(e,`sr.${t}`),this}rangeGte(e,t){return this.url.searchParams.append(e,`nxl.${t}`),this}rangeLt(e,t){return this.url.searchParams.append(e,`sl.${t}`),this}rangeLte(e,t){return this.url.searchParams.append(e,`nxr.${t}`),this}rangeAdjacent(e,t){return this.url.searchParams.append(e,`adj.${t}`),this}overlaps(e,t){return typeof t=="string"?this.url.searchParams.append(e,`ov.${t}`):this.url.searchParams.append(e,`ov.{${t.join(",")}}`),this}textSearch(e,t,{config:r,type:i}={}){let n="";i==="plain"?n="pl":i==="phrase"?n="ph":i==="websearch"&&(n="w");let o=r===void 0?"":`(${r})`;return this.url.searchParams.append(e,`${n}fts${o}.${t}`),this}match(e){return Object.entries(e).forEach(([t,r])=>{this.url.searchParams.append(t,`eq.${r}`)}),this}not(e,t,r){return this.url.searchParams.append(e,`not.${t}.${r}`),this}or(e,{foreignTable:t,referencedTable:r=t}={}){let i=r?`${r}.or`:"or";return this.url.searchParams.append(i,`(${e})`),this}filter(e,t,r){return this.url.searchParams.append(e,`${t}.${r}`),this}};_u.default=bu});var Eu=R(Su=>{"use strict";Object.defineProperty(Su,"__esModule",{value:!0});var w_=(Q(),X(W)),ei=w_.__importDefault(xn()),vu=class{constructor(e,{headers:t={},schema:r,fetch:i}){this.url=e,this.headers=new Headers(t),this.schema=r,this.fetch=i}select(e,t){let{head:r=!1,count:i}=t??{},n=r?"HEAD":"GET",o=!1,a=(e??"*").split("").map(l=>/\s/.test(l)&&!o?"":(l==='"'&&(o=!o),l)).join("");return this.url.searchParams.set("select",a),i&&this.headers.append("Prefer",`count=${i}`),new ei.default({method:n,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch})}insert(e,{count:t,defaultToNull:r=!0}={}){var i;let n="POST";if(t&&this.headers.append("Prefer",`count=${t}`),r||this.headers.append("Prefer","missing=default"),Array.isArray(e)){let o=e.reduce((a,l)=>a.concat(Object.keys(l)),[]);if(o.length>0){let a=[...new Set(o)].map(l=>`"${l}"`);this.url.searchParams.set("columns",a.join(","))}}return new ei.default({method:n,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:(i=this.fetch)!==null&&i!==void 0?i:fetch})}upsert(e,{onConflict:t,ignoreDuplicates:r=!1,count:i,defaultToNull:n=!0}={}){var o;let a="POST";if(this.headers.append("Prefer",`resolution=${r?"ignore":"merge"}-duplicates`),t!==void 0&&this.url.searchParams.set("on_conflict",t),i&&this.headers.append("Prefer",`count=${i}`),n||this.headers.append("Prefer","missing=default"),Array.isArray(e)){let l=e.reduce((c,u)=>c.concat(Object.keys(u)),[]);if(l.length>0){let c=[...new Set(l)].map(u=>`"${u}"`);this.url.searchParams.set("columns",c.join(","))}}return new ei.default({method:a,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:(o=this.fetch)!==null&&o!==void 0?o:fetch})}update(e,{count:t}={}){var r;let i="PATCH";return t&&this.headers.append("Prefer",`count=${t}`),new ei.default({method:i,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:(r=this.fetch)!==null&&r!==void 0?r:fetch})}delete({count:e}={}){var t;let r="DELETE";return e&&this.headers.append("Prefer",`count=${e}`),new ei.default({method:r,url:this.url,headers:this.headers,schema:this.schema,fetch:(t=this.fetch)!==null&&t!==void 0?t:fetch})}};Su.default=vu});var Jm=R(Au=>{"use strict";Object.defineProperty(Au,"__esModule",{value:!0});var Qm=(Q(),X(W)),b_=Qm.__importDefault(Eu()),__=Qm.__importDefault(xn()),Tu=class s{constructor(e,{headers:t={},schema:r,fetch:i}={}){this.url=e,this.headers=new Headers(t),this.schemaName=r,this.fetch=i}from(e){if(!e||typeof e!="string"||e.trim()==="")throw new Error("Invalid relation name: relation must be a non-empty string.");let t=new URL(`${this.url}/${e}`);return new b_.default(t,{headers:new Headers(this.headers),schema:this.schemaName,fetch:this.fetch})}schema(e){return new s(this.url,{headers:this.headers,schema:e,fetch:this.fetch})}rpc(e,t={},{head:r=!1,get:i=!1,count:n}={}){var o;let a,l=new URL(`${this.url}/rpc/${e}`),c;r||i?(a=r?"HEAD":"GET",Object.entries(t).filter(([f,d])=>d!==void 0).map(([f,d])=>[f,Array.isArray(d)?`{${d.join(",")}}`:`${d}`]).forEach(([f,d])=>{l.searchParams.append(f,d)})):(a="POST",c=t);let u=new Headers(this.headers);return n&&u.set("Prefer",`count=${n}`),new __.default({method:a,url:l,headers:u,schema:this.schemaName,body:c,fetch:(o=this.fetch)!==null&&o!==void 0?o:fetch})}};Au.default=Tu});var ku=R(je=>{"use strict";Object.defineProperty(je,"__esModule",{value:!0});je.PostgrestError=je.PostgrestBuilder=je.PostgrestTransformBuilder=je.PostgrestFilterBuilder=je.PostgrestQueryBuilder=je.PostgrestClient=void 0;var Fr=(Q(),X(W)),Gm=Fr.__importDefault(Jm());je.PostgrestClient=Gm.default;var Xm=Fr.__importDefault(Eu());je.PostgrestQueryBuilder=Xm.default;var Ym=Fr.__importDefault(xn());je.PostgrestFilterBuilder=Ym.default;var Zm=Fr.__importDefault(wu());je.PostgrestTransformBuilder=Zm.default;var eg=Fr.__importDefault(mu());je.PostgrestBuilder=eg.default;var tg=Fr.__importDefault(hu());je.PostgrestError=tg.default;je.default={PostgrestClient:Gm.default,PostgrestQueryBuilder:Xm.default,PostgrestFilterBuilder:Ym.default,PostgrestTransformBuilder:Zm.default,PostgrestBuilder:eg.default,PostgrestError:tg.default}});var Pu=R(ti=>{"use strict";Object.defineProperty(ti,"__esModule",{value:!0});ti.WebSocketFactory=void 0;var Cn=class{constructor(){}static detectEnvironment(){var e;if(typeof WebSocket<"u")return{type:"native",constructor:WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocket<"u")return{type:"native",constructor:globalThis.WebSocket};if(typeof global<"u"&&typeof global.WebSocket<"u")return{type:"native",constructor:global.WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocketPair<"u"&&typeof globalThis.WebSocket>"u")return{type:"cloudflare",error:"Cloudflare Workers detected. WebSocket clients are not supported in Cloudflare Workers.",workaround:"Use Cloudflare Workers WebSocket API for server-side WebSocket handling, or deploy to a different runtime."};if(typeof globalThis<"u"&&globalThis.EdgeRuntime||typeof navigator<"u"&&(!((e=navigator.userAgent)===null||e===void 0)&&e.includes("Vercel-Edge")))return{type:"unsupported",error:"Edge runtime detected (Vercel Edge/Netlify Edge). WebSockets are not supported in edge functions.",workaround:"Use serverless functions or a different deployment target for WebSocket functionality."};if(typeof process<"u"){let t=process.versions;if(t&&t.node){let r=t.node,i=parseInt(r.replace(/^v/,"").split(".")[0]);return i>=22?typeof globalThis.WebSocket<"u"?{type:"native",constructor:globalThis.WebSocket}:{type:"unsupported",error:`Node.js ${i} detected but native WebSocket not found.`,workaround:"Provide a WebSocket implementation via the transport option."}:{type:"unsupported",error:`Node.js ${i} detected without native WebSocket support.`,workaround:`For Node.js < 22, install "ws" package and provide it via the transport option:
import ws from "ws"
new RealtimeClient(url, { transport: ws })`}}}return{type:"unsupported",error:"Unknown JavaScript runtime without WebSocket support.",workaround:"Ensure you're running in a supported environment (browser, Node.js, Deno) or provide a custom WebSocket implementation."}}static getWebSocketConstructor(){let e=this.detectEnvironment();if(e.constructor)return e.constructor;let t=e.error||"WebSocket not supported in this environment.";throw e.workaround&&(t+=`

Suggested solution: ${e.workaround}`),new Error(t)}static createWebSocket(e,t){let r=this.getWebSocketConstructor();return new r(e,t)}static isWebSocketSupported(){try{let e=this.detectEnvironment();return e.type==="native"||e.type==="ws"}catch{return!1}}};ti.WebSocketFactory=Cn;ti.default=Cn});var rg=R(Rn=>{"use strict";Object.defineProperty(Rn,"__esModule",{value:!0});Rn.version=void 0;Rn.version="2.86.0"});var On=R(re=>{"use strict";Object.defineProperty(re,"__esModule",{value:!0});re.CONNECTION_STATE=re.TRANSPORTS=re.CHANNEL_EVENTS=re.CHANNEL_STATES=re.SOCKET_STATES=re.MAX_PUSH_BUFFER_SIZE=re.WS_CLOSE_NORMAL=re.DEFAULT_TIMEOUT=re.VERSION=re.DEFAULT_VSN=re.VSN_2_0_0=re.VSN_1_0_0=re.DEFAULT_VERSION=void 0;var lg=rg();re.DEFAULT_VERSION=`realtime-js/${lg.version}`;re.VSN_1_0_0="1.0.0";re.VSN_2_0_0="2.0.0";re.DEFAULT_VSN=re.VSN_1_0_0;re.VERSION=lg.version;re.DEFAULT_TIMEOUT=1e4;re.WS_CLOSE_NORMAL=1e3;re.MAX_PUSH_BUFFER_SIZE=100;var sg;(function(s){s[s.connecting=0]="connecting",s[s.open=1]="open",s[s.closing=2]="closing",s[s.closed=3]="closed"})(sg||(re.SOCKET_STATES=sg={}));var ig;(function(s){s.closed="closed",s.errored="errored",s.joined="joined",s.joining="joining",s.leaving="leaving"})(ig||(re.CHANNEL_STATES=ig={}));var ng;(function(s){s.close="phx_close",s.error="phx_error",s.join="phx_join",s.reply="phx_reply",s.leave="phx_leave",s.access_token="access_token"})(ng||(re.CHANNEL_EVENTS=ng={}));var og;(function(s){s.websocket="websocket"})(og||(re.TRANSPORTS=og={}));var ag;(function(s){s.Connecting="connecting",s.Open="open",s.Closing="closing",s.Closed="closed"})(ag||(re.CONNECTION_STATE=ag={}))});var cg=R(Cu=>{"use strict";Object.defineProperty(Cu,"__esModule",{value:!0});var xu=class{constructor(e){this.HEADER_LENGTH=1,this.USER_BROADCAST_PUSH_META_LENGTH=6,this.KINDS={userBroadcastPush:3,userBroadcast:4},this.BINARY_ENCODING=0,this.JSON_ENCODING=1,this.BROADCAST_EVENT="broadcast",this.allowedMetadataKeys=[],this.allowedMetadataKeys=e??[]}encode(e,t){if(e.event===this.BROADCAST_EVENT&&!(e.payload instanceof ArrayBuffer)&&typeof e.payload.event=="string")return t(this._binaryEncodeUserBroadcastPush(e));let r=[e.join_ref,e.ref,e.topic,e.event,e.payload];return t(JSON.stringify(r))}_binaryEncodeUserBroadcastPush(e){var t;return this._isArrayBuffer((t=e.payload)===null||t===void 0?void 0:t.payload)?this._encodeBinaryUserBroadcastPush(e):this._encodeJsonUserBroadcastPush(e)}_encodeBinaryUserBroadcastPush(e){var t,r;let i=(r=(t=e.payload)===null||t===void 0?void 0:t.payload)!==null&&r!==void 0?r:new ArrayBuffer(0);return this._encodeUserBroadcastPush(e,this.BINARY_ENCODING,i)}_encodeJsonUserBroadcastPush(e){var t,r;let i=(r=(t=e.payload)===null||t===void 0?void 0:t.payload)!==null&&r!==void 0?r:{},o=new TextEncoder().encode(JSON.stringify(i)).buffer;return this._encodeUserBroadcastPush(e,this.JSON_ENCODING,o)}_encodeUserBroadcastPush(e,t,r){var i,n;let o=e.topic,a=(i=e.ref)!==null&&i!==void 0?i:"",l=(n=e.join_ref)!==null&&n!==void 0?n:"",c=e.payload.event,u=this.allowedMetadataKeys?this._pick(e.payload,this.allowedMetadataKeys):{},f=Object.keys(u).length===0?"":JSON.stringify(u);if(l.length>255)throw new Error(`joinRef length ${l.length} exceeds maximum of 255`);if(a.length>255)throw new Error(`ref length ${a.length} exceeds maximum of 255`);if(o.length>255)throw new Error(`topic length ${o.length} exceeds maximum of 255`);if(c.length>255)throw new Error(`userEvent length ${c.length} exceeds maximum of 255`);if(f.length>255)throw new Error(`metadata length ${f.length} exceeds maximum of 255`);let d=this.USER_BROADCAST_PUSH_META_LENGTH+l.length+a.length+o.length+c.length+f.length,h=new ArrayBuffer(this.HEADER_LENGTH+d),g=new DataView(h),y=0;g.setUint8(y++,this.KINDS.userBroadcastPush),g.setUint8(y++,l.length),g.setUint8(y++,a.length),g.setUint8(y++,o.length),g.setUint8(y++,c.length),g.setUint8(y++,f.length),g.setUint8(y++,t),Array.from(l,b=>g.setUint8(y++,b.charCodeAt(0))),Array.from(a,b=>g.setUint8(y++,b.charCodeAt(0))),Array.from(o,b=>g.setUint8(y++,b.charCodeAt(0))),Array.from(c,b=>g.setUint8(y++,b.charCodeAt(0))),Array.from(f,b=>g.setUint8(y++,b.charCodeAt(0)));var _=new Uint8Array(h.byteLength+r.byteLength);return _.set(new Uint8Array(h),0),_.set(new Uint8Array(r),h.byteLength),_.buffer}decode(e,t){if(this._isArrayBuffer(e)){let r=this._binaryDecode(e);return t(r)}if(typeof e=="string"){let r=JSON.parse(e),[i,n,o,a,l]=r;return t({join_ref:i,ref:n,topic:o,event:a,payload:l})}return t({})}_binaryDecode(e){let t=new DataView(e),r=t.getUint8(0),i=new TextDecoder;switch(r){case this.KINDS.userBroadcast:return this._decodeUserBroadcast(e,t,i)}}_decodeUserBroadcast(e,t,r){let i=t.getUint8(1),n=t.getUint8(2),o=t.getUint8(3),a=t.getUint8(4),l=this.HEADER_LENGTH+4,c=r.decode(e.slice(l,l+i));l=l+i;let u=r.decode(e.slice(l,l+n));l=l+n;let f=r.decode(e.slice(l,l+o));l=l+o;let d=e.slice(l,e.byteLength),h=a===this.JSON_ENCODING?JSON.parse(r.decode(d)):d,g={type:this.BROADCAST_EVENT,event:u,payload:h};return o>0&&(g.meta=JSON.parse(f)),{join_ref:null,ref:null,topic:c,event:this.BROADCAST_EVENT,payload:g}}_isArrayBuffer(e){var t;return e instanceof ArrayBuffer||((t=e?.constructor)===null||t===void 0?void 0:t.name)==="ArrayBuffer"}_pick(e,t){return!e||typeof e!="object"?{}:Object.fromEntries(Object.entries(e).filter(([r])=>t.includes(r)))}};Cu.default=xu});var Nu=R(Ou=>{"use strict";Object.defineProperty(Ou,"__esModule",{value:!0});var Ru=class{constructor(e,t){this.callback=e,this.timerCalc=t,this.timer=void 0,this.tries=0,this.callback=e,this.timerCalc=t}reset(){this.tries=0,clearTimeout(this.timer),this.timer=void 0}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}};Ou.default=Ru});var Nn=R(Y=>{"use strict";Object.defineProperty(Y,"__esModule",{value:!0});Y.httpEndpointURL=Y.toTimestampString=Y.toArray=Y.toJson=Y.toNumber=Y.toBoolean=Y.convertCell=Y.convertColumn=Y.convertChangeData=Y.PostgresTypes=void 0;var ae;(function(s){s.abstime="abstime",s.bool="bool",s.date="date",s.daterange="daterange",s.float4="float4",s.float8="float8",s.int2="int2",s.int4="int4",s.int4range="int4range",s.int8="int8",s.int8range="int8range",s.json="json",s.jsonb="jsonb",s.money="money",s.numeric="numeric",s.oid="oid",s.reltime="reltime",s.text="text",s.time="time",s.timestamp="timestamp",s.timestamptz="timestamptz",s.timetz="timetz",s.tsrange="tsrange",s.tstzrange="tstzrange"})(ae||(Y.PostgresTypes=ae={}));var v_=(s,e,t={})=>{var r;let i=(r=t.skipTypes)!==null&&r!==void 0?r:[];return e?Object.keys(e).reduce((n,o)=>(n[o]=(0,Y.convertColumn)(o,s,e,i),n),{}):{}};Y.convertChangeData=v_;var S_=(s,e,t,r)=>{let i=e.find(a=>a.name===s),n=i?.type,o=t[s];return n&&!r.includes(n)?(0,Y.convertCell)(n,o):$u(o)};Y.convertColumn=S_;var E_=(s,e)=>{if(s.charAt(0)==="_"){let t=s.slice(1,s.length);return(0,Y.toArray)(e,t)}switch(s){case ae.bool:return(0,Y.toBoolean)(e);case ae.float4:case ae.float8:case ae.int2:case ae.int4:case ae.int8:case ae.numeric:case ae.oid:return(0,Y.toNumber)(e);case ae.json:case ae.jsonb:return(0,Y.toJson)(e);case ae.timestamp:return(0,Y.toTimestampString)(e);case ae.abstime:case ae.date:case ae.daterange:case ae.int4range:case ae.int8range:case ae.money:case ae.reltime:case ae.text:case ae.time:case ae.timestamptz:case ae.timetz:case ae.tsrange:case ae.tstzrange:return $u(e);default:return $u(e)}};Y.convertCell=E_;var $u=s=>s,T_=s=>{switch(s){case"t":return!0;case"f":return!1;default:return s}};Y.toBoolean=T_;var A_=s=>{if(typeof s=="string"){let e=parseFloat(s);if(!Number.isNaN(e))return e}return s};Y.toNumber=A_;var k_=s=>{if(typeof s=="string")try{return JSON.parse(s)}catch(e){return console.log(`JSON parse error: ${e}`),s}return s};Y.toJson=k_;var P_=(s,e)=>{if(typeof s!="string")return s;let t=s.length-1,r=s[t];if(s[0]==="{"&&r==="}"){let n,o=s.slice(1,t);try{n=JSON.parse("["+o+"]")}catch{n=o?o.split(","):[]}return n.map(a=>(0,Y.convertCell)(e,a))}return s};Y.toArray=P_;var x_=s=>typeof s=="string"?s.replace(" ","T"):s;Y.toTimestampString=x_;var C_=s=>{let e=new URL(s);return e.protocol=e.protocol.replace(/^ws/i,"http"),e.pathname=e.pathname.replace(/\/+$/,"").replace(/\/socket\/websocket$/i,"").replace(/\/socket$/i,"").replace(/\/websocket$/i,""),e.pathname===""||e.pathname==="/"?e.pathname="/api/broadcast":e.pathname=e.pathname+"/api/broadcast",e.href};Y.httpEndpointURL=C_});var ug=R(Mu=>{"use strict";Object.defineProperty(Mu,"__esModule",{value:!0});var R_=On(),Iu=class{constructor(e,t,r={},i=R_.DEFAULT_TIMEOUT){this.channel=e,this.event=t,this.payload=r,this.timeout=i,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(e){this.timeout=e,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(e){this.payload=Object.assign(Object.assign({},this.payload),e)}receive(e,t){var r;return this._hasReceived(e)&&t((r=this.receivedResp)===null||r===void 0?void 0:r.response),this.recHooks.push({status:e,callback:t}),this}startTimeout(){if(this.timeoutTimer)return;this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref);let e=t=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=t,this._matchReceive(t)};this.channel._on(this.refEvent,{},e),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}trigger(e,t){this.refEvent&&this.channel._trigger(this.refEvent,{status:e,response:t})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:e,response:t}){this.recHooks.filter(r=>r.status===e).forEach(r=>r.callback(t))}_hasReceived(e){return this.receivedResp&&this.receivedResp.status===e}};Mu.default=Iu});var ju=R(ri=>{"use strict";Object.defineProperty(ri,"__esModule",{value:!0});ri.REALTIME_PRESENCE_LISTEN_EVENTS=void 0;var dg;(function(s){s.SYNC="sync",s.JOIN="join",s.LEAVE="leave"})(dg||(ri.REALTIME_PRESENCE_LISTEN_EVENTS=dg={}));var Du=class s{constructor(e,t){this.channel=e,this.state={},this.pendingDiffs=[],this.joinRef=null,this.enabled=!1,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};let r=t?.events||{state:"presence_state",diff:"presence_diff"};this.channel._on(r.state,{},i=>{let{onJoin:n,onLeave:o,onSync:a}=this.caller;this.joinRef=this.channel._joinRef(),this.state=s.syncState(this.state,i,n,o),this.pendingDiffs.forEach(l=>{this.state=s.syncDiff(this.state,l,n,o)}),this.pendingDiffs=[],a()}),this.channel._on(r.diff,{},i=>{let{onJoin:n,onLeave:o,onSync:a}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(i):(this.state=s.syncDiff(this.state,i,n,o),a())}),this.onJoin((i,n,o)=>{this.channel._trigger("presence",{event:"join",key:i,currentPresences:n,newPresences:o})}),this.onLeave((i,n,o)=>{this.channel._trigger("presence",{event:"leave",key:i,currentPresences:n,leftPresences:o})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(e,t,r,i){let n=this.cloneDeep(e),o=this.transformState(t),a={},l={};return this.map(n,(c,u)=>{o[c]||(l[c]=u)}),this.map(o,(c,u)=>{let f=n[c];if(f){let d=u.map(_=>_.presence_ref),h=f.map(_=>_.presence_ref),g=u.filter(_=>h.indexOf(_.presence_ref)<0),y=f.filter(_=>d.indexOf(_.presence_ref)<0);g.length>0&&(a[c]=g),y.length>0&&(l[c]=y)}else a[c]=u}),this.syncDiff(n,{joins:a,leaves:l},r,i)}static syncDiff(e,t,r,i){let{joins:n,leaves:o}={joins:this.transformState(t.joins),leaves:this.transformState(t.leaves)};return r||(r=()=>{}),i||(i=()=>{}),this.map(n,(a,l)=>{var c;let u=(c=e[a])!==null&&c!==void 0?c:[];if(e[a]=this.cloneDeep(l),u.length>0){let f=e[a].map(h=>h.presence_ref),d=u.filter(h=>f.indexOf(h.presence_ref)<0);e[a].unshift(...d)}r(a,u,l)}),this.map(o,(a,l)=>{let c=e[a];if(!c)return;let u=l.map(f=>f.presence_ref);c=c.filter(f=>u.indexOf(f.presence_ref)<0),e[a]=c,i(a,c,l),c.length===0&&delete e[a]}),e}static map(e,t){return Object.getOwnPropertyNames(e).map(r=>t(r,e[r]))}static transformState(e){return e=this.cloneDeep(e),Object.getOwnPropertyNames(e).reduce((t,r)=>{let i=e[r];return"metas"in i?t[r]=i.metas.map(n=>(n.presence_ref=n.phx_ref,delete n.phx_ref,delete n.phx_ref_prev,n)):t[r]=i,t},{})}static cloneDeep(e){return JSON.parse(JSON.stringify(e))}onJoin(e){this.caller.onJoin=e}onLeave(e){this.caller.onLeave=e}onSync(e){this.caller.onSync=e}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}};ri.default=Du});var Uu=R(pt=>{"use strict";Object.defineProperty(pt,"__esModule",{value:!0});pt.REALTIME_CHANNEL_STATES=pt.REALTIME_SUBSCRIBE_STATES=pt.REALTIME_LISTEN_TYPES=pt.REALTIME_POSTGRES_CHANGES_LISTEN_EVENT=void 0;var $n=(Q(),X(W)),le=On(),Lu=$n.__importDefault(ug()),O_=$n.__importDefault(Nu()),N_=$n.__importDefault(ju()),hg=$n.__importStar(Nn()),$_=Nn(),fg;(function(s){s.ALL="*",s.INSERT="INSERT",s.UPDATE="UPDATE",s.DELETE="DELETE"})(fg||(pt.REALTIME_POSTGRES_CHANGES_LISTEN_EVENT=fg={}));var si;(function(s){s.BROADCAST="broadcast",s.PRESENCE="presence",s.POSTGRES_CHANGES="postgres_changes",s.SYSTEM="system"})(si||(pt.REALTIME_LISTEN_TYPES=si={}));var jt;(function(s){s.SUBSCRIBED="SUBSCRIBED",s.TIMED_OUT="TIMED_OUT",s.CLOSED="CLOSED",s.CHANNEL_ERROR="CHANNEL_ERROR"})(jt||(pt.REALTIME_SUBSCRIBE_STATES=jt={}));pt.REALTIME_CHANNEL_STATES=le.CHANNEL_STATES;var qu=class s{constructor(e,t={config:{}},r){var i,n;if(this.topic=e,this.params=t,this.socket=r,this.bindings={},this.state=le.CHANNEL_STATES.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=e.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:"",enabled:!1},private:!1},t.config),this.timeout=this.socket.timeout,this.joinPush=new Lu.default(this,le.CHANNEL_EVENTS.join,this.params,this.timeout),this.rejoinTimer=new O_.default(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=le.CHANNEL_STATES.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(o=>o.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=le.CHANNEL_STATES.closed,this.socket._remove(this)}),this._onError(o=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,o),this.state=le.CHANNEL_STATES.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=le.CHANNEL_STATES.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("error",o=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,o),this.state=le.CHANNEL_STATES.errored,this.rejoinTimer.scheduleTimeout())}),this._on(le.CHANNEL_EVENTS.reply,{},(o,a)=>{this._trigger(this._replyEventName(a),o)}),this.presence=new N_.default(this),this.broadcastEndpointURL=(0,$_.httpEndpointURL)(this.socket.endPoint),this.private=this.params.config.private||!1,!this.private&&(!((n=(i=this.params.config)===null||i===void 0?void 0:i.broadcast)===null||n===void 0)&&n.replay))throw`tried to use replay on public channel '${this.topic}'. It must be a private channel.`}subscribe(e,t=this.timeout){var r,i,n;if(this.socket.isConnected()||this.socket.connect(),this.state==le.CHANNEL_STATES.closed){let{config:{broadcast:o,presence:a,private:l}}=this.params,c=(i=(r=this.bindings.postgres_changes)===null||r===void 0?void 0:r.map(h=>h.filter))!==null&&i!==void 0?i:[],u=!!this.bindings[si.PRESENCE]&&this.bindings[si.PRESENCE].length>0||((n=this.params.config.presence)===null||n===void 0?void 0:n.enabled)===!0,f={},d={broadcast:o,presence:Object.assign(Object.assign({},a),{enabled:u}),postgres_changes:c,private:l};this.socket.accessTokenValue&&(f.access_token=this.socket.accessTokenValue),this._onError(h=>e?.(jt.CHANNEL_ERROR,h)),this._onClose(()=>e?.(jt.CLOSED)),this.updateJoinPayload(Object.assign({config:d},f)),this.joinedOnce=!0,this._rejoin(t),this.joinPush.receive("ok",async({postgres_changes:h})=>{var g;if(this.socket.setAuth(),h===void 0){e?.(jt.SUBSCRIBED);return}else{let y=this.bindings.postgres_changes,_=(g=y?.length)!==null&&g!==void 0?g:0,b=[];for(let v=0;v<_;v++){let A=y[v],{filter:{event:N,schema:te,table:U,filter:I}}=A,B=h&&h[v];if(B&&B.event===N&&B.schema===te&&B.table===U&&B.filter===I)b.push(Object.assign(Object.assign({},A),{id:B.id}));else{this.unsubscribe(),this.state=le.CHANNEL_STATES.errored,e?.(jt.CHANNEL_ERROR,new Error("mismatch between server and client bindings for postgres changes"));return}}this.bindings.postgres_changes=b,e&&e(jt.SUBSCRIBED);return}}).receive("error",h=>{this.state=le.CHANNEL_STATES.errored,e?.(jt.CHANNEL_ERROR,new Error(JSON.stringify(Object.values(h).join(", ")||"error")))}).receive("timeout",()=>{e?.(jt.TIMED_OUT)})}return this}presenceState(){return this.presence.state}async track(e,t={}){return await this.send({type:"presence",event:"track",payload:e},t.timeout||this.timeout)}async untrack(e={}){return await this.send({type:"presence",event:"untrack"},e)}on(e,t,r){return this.state===le.CHANNEL_STATES.joined&&e===si.PRESENCE&&(this.socket.log("channel",`resubscribe to ${this.topic} due to change in presence callbacks on joined channel`),this.unsubscribe().then(()=>this.subscribe())),this._on(e,t,r)}async httpSend(e,t,r={}){var i;let n=this.socket.accessTokenValue?`Bearer ${this.socket.accessTokenValue}`:"";if(t==null)return Promise.reject("Payload is required for httpSend()");let o={method:"POST",headers:{Authorization:n,apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"},body:JSON.stringify({messages:[{topic:this.subTopic,event:e,payload:t,private:this.private}]})},a=await this._fetchWithTimeout(this.broadcastEndpointURL,o,(i=r.timeout)!==null&&i!==void 0?i:this.timeout);if(a.status===202)return{success:!0};let l=a.statusText;try{let c=await a.json();l=c.error||c.message||l}catch{}return Promise.reject(new Error(l))}async send(e,t={}){var r,i;if(!this._canPush()&&e.type==="broadcast"){console.warn("Realtime send() is automatically falling back to REST API. This behavior will be deprecated in the future. Please use httpSend() explicitly for REST delivery.");let{event:n,payload:o}=e,l={method:"POST",headers:{Authorization:this.socket.accessTokenValue?`Bearer ${this.socket.accessTokenValue}`:"",apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"},body:JSON.stringify({messages:[{topic:this.subTopic,event:n,payload:o,private:this.private}]})};try{let c=await this._fetchWithTimeout(this.broadcastEndpointURL,l,(r=t.timeout)!==null&&r!==void 0?r:this.timeout);return await((i=c.body)===null||i===void 0?void 0:i.cancel()),c.ok?"ok":"error"}catch(c){return c.name==="AbortError"?"timed out":"error"}}else return new Promise(n=>{var o,a,l;let c=this._push(e.type,e,t.timeout||this.timeout);e.type==="broadcast"&&!(!((l=(a=(o=this.params)===null||o===void 0?void 0:o.config)===null||a===void 0?void 0:a.broadcast)===null||l===void 0)&&l.ack)&&n("ok"),c.receive("ok",()=>n("ok")),c.receive("error",()=>n("error")),c.receive("timeout",()=>n("timed out"))})}updateJoinPayload(e){this.joinPush.updatePayload(e)}unsubscribe(e=this.timeout){this.state=le.CHANNEL_STATES.leaving;let t=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(le.CHANNEL_EVENTS.close,"leave",this._joinRef())};this.joinPush.destroy();let r=null;return new Promise(i=>{r=new Lu.default(this,le.CHANNEL_EVENTS.leave,{},e),r.receive("ok",()=>{t(),i("ok")}).receive("timeout",()=>{t(),i("timed out")}).receive("error",()=>{i("error")}),r.send(),this._canPush()||r.trigger("ok",{})}).finally(()=>{r?.destroy()})}teardown(){this.pushBuffer.forEach(e=>e.destroy()),this.pushBuffer=[],this.rejoinTimer.reset(),this.joinPush.destroy(),this.state=le.CHANNEL_STATES.closed,this.bindings={}}async _fetchWithTimeout(e,t,r){let i=new AbortController,n=setTimeout(()=>i.abort(),r),o=await this.socket.fetch(e,Object.assign(Object.assign({},t),{signal:i.signal}));return clearTimeout(n),o}_push(e,t,r=this.timeout){if(!this.joinedOnce)throw`tried to push '${e}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let i=new Lu.default(this,e,t,r);return this._canPush()?i.send():this._addToPushBuffer(i),i}_addToPushBuffer(e){if(e.startTimeout(),this.pushBuffer.push(e),this.pushBuffer.length>le.MAX_PUSH_BUFFER_SIZE){let t=this.pushBuffer.shift();t&&(t.destroy(),this.socket.log("channel",`discarded push due to buffer overflow: ${t.event}`,t.payload))}}_onMessage(e,t,r){return t}_isMember(e){return this.topic===e}_joinRef(){return this.joinPush.ref}_trigger(e,t,r){var i,n;let o=e.toLocaleLowerCase(),{close:a,error:l,leave:c,join:u}=le.CHANNEL_EVENTS;if(r&&[a,l,c,u].indexOf(o)>=0&&r!==this._joinRef())return;let d=this._onMessage(o,t,r);if(t&&!d)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(o)?(i=this.bindings.postgres_changes)===null||i===void 0||i.filter(h=>{var g,y,_;return((g=h.filter)===null||g===void 0?void 0:g.event)==="*"||((_=(y=h.filter)===null||y===void 0?void 0:y.event)===null||_===void 0?void 0:_.toLocaleLowerCase())===o}).map(h=>h.callback(d,r)):(n=this.bindings[o])===null||n===void 0||n.filter(h=>{var g,y,_,b,v,A;if(["broadcast","presence","postgres_changes"].includes(o))if("id"in h){let N=h.id,te=(g=h.filter)===null||g===void 0?void 0:g.event;return N&&((y=t.ids)===null||y===void 0?void 0:y.includes(N))&&(te==="*"||te?.toLocaleLowerCase()===((_=t.data)===null||_===void 0?void 0:_.type.toLocaleLowerCase()))}else{let N=(v=(b=h?.filter)===null||b===void 0?void 0:b.event)===null||v===void 0?void 0:v.toLocaleLowerCase();return N==="*"||N===((A=t?.event)===null||A===void 0?void 0:A.toLocaleLowerCase())}else return h.type.toLocaleLowerCase()===o}).map(h=>{if(typeof d=="object"&&"ids"in d){let g=d.data,{schema:y,table:_,commit_timestamp:b,type:v,errors:A}=g;d=Object.assign(Object.assign({},{schema:y,table:_,commit_timestamp:b,eventType:v,new:{},old:{},errors:A}),this._getPayloadRecords(g))}h.callback(d,r)})}_isClosed(){return this.state===le.CHANNEL_STATES.closed}_isJoined(){return this.state===le.CHANNEL_STATES.joined}_isJoining(){return this.state===le.CHANNEL_STATES.joining}_isLeaving(){return this.state===le.CHANNEL_STATES.leaving}_replyEventName(e){return`chan_reply_${e}`}_on(e,t,r){let i=e.toLocaleLowerCase(),n={type:i,filter:t,callback:r};return this.bindings[i]?this.bindings[i].push(n):this.bindings[i]=[n],this}_off(e,t){let r=e.toLocaleLowerCase();return this.bindings[r]&&(this.bindings[r]=this.bindings[r].filter(i=>{var n;return!(((n=i.type)===null||n===void 0?void 0:n.toLocaleLowerCase())===r&&s.isEqual(i.filter,t))})),this}static isEqual(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(let r in e)if(e[r]!==t[r])return!1;return!0}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(e){this._on(le.CHANNEL_EVENTS.close,{},e)}_onError(e){this._on(le.CHANNEL_EVENTS.error,{},t=>e(t))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(e=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=le.CHANNEL_STATES.joining,this.joinPush.resend(e))}_getPayloadRecords(e){let t={new:{},old:{}};return(e.type==="INSERT"||e.type==="UPDATE")&&(t.new=hg.convertChangeData(e.columns,e.record)),(e.type==="UPDATE"||e.type==="DELETE")&&(t.old=hg.convertChangeData(e.columns,e.old_record)),t}};pt.default=qu});var pg=R(Vu=>{"use strict";Object.defineProperty(Vu,"__esModule",{value:!0});var Mn=(Q(),X(W)),I_=Mn.__importDefault(Pu()),_e=On(),M_=Mn.__importDefault(cg()),D_=Mn.__importDefault(Nu()),j_=Nn(),L_=Mn.__importDefault(Uu()),Bu=()=>{},In={HEARTBEAT_INTERVAL:25e3,RECONNECT_DELAY:10,HEARTBEAT_TIMEOUT_FALLBACK:100},q_=[1e3,2e3,5e3,1e4],U_=1e4,B_=`
  addEventListener("message", (e) => {
    if (e.data.event === "start") {
      setInterval(() => postMessage({ event: "keepAlive" }), e.data.interval);
    }
  });`,Fu=class{constructor(e,t){var r;if(this.accessTokenValue=null,this.apiKey=null,this.channels=new Array,this.endPoint="",this.httpEndpoint="",this.headers={},this.params={},this.timeout=_e.DEFAULT_TIMEOUT,this.transport=null,this.heartbeatIntervalMs=In.HEARTBEAT_INTERVAL,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.heartbeatCallback=Bu,this.ref=0,this.reconnectTimer=null,this.vsn=_e.DEFAULT_VSN,this.logger=Bu,this.conn=null,this.sendBuffer=[],this.serializer=new M_.default,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.accessToken=null,this._connectionState="disconnected",this._wasManualDisconnect=!1,this._authPromise=null,this._resolveFetch=i=>i?(...n)=>i(...n):(...n)=>fetch(...n),!(!((r=t?.params)===null||r===void 0)&&r.apikey))throw new Error("API key is required to connect to Realtime");this.apiKey=t.params.apikey,this.endPoint=`${e}/${_e.TRANSPORTS.websocket}`,this.httpEndpoint=(0,j_.httpEndpointURL)(e),this._initializeOptions(t),this._setupReconnectionTimer(),this.fetch=this._resolveFetch(t?.fetch)}connect(){if(!(this.isConnecting()||this.isDisconnecting()||this.conn!==null&&this.isConnected())){if(this._setConnectionState("connecting"),this.accessToken&&!this._authPromise&&this._setAuthSafely("connect"),this.transport)this.conn=new this.transport(this.endpointURL());else try{this.conn=I_.default.createWebSocket(this.endpointURL())}catch(e){this._setConnectionState("disconnected");let t=e.message;throw t.includes("Node.js")?new Error(`${t}

To use Realtime in Node.js, you need to provide a WebSocket implementation:

Option 1: Use Node.js 22+ which has native WebSocket support
Option 2: Install and provide the "ws" package:

  npm install ws

  import ws from "ws"
  const client = new RealtimeClient(url, {
    ...options,
    transport: ws
  })`):new Error(`WebSocket not available: ${t}`)}this._setupConnectionHandlers()}}endpointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:this.vsn}))}disconnect(e,t){if(!this.isDisconnecting())if(this._setConnectionState("disconnecting",!0),this.conn){let r=setTimeout(()=>{this._setConnectionState("disconnected")},100);this.conn.onclose=()=>{clearTimeout(r),this._setConnectionState("disconnected")},typeof this.conn.close=="function"&&(e?this.conn.close(e,t??""):this.conn.close()),this._teardownConnection()}else this._setConnectionState("disconnected")}getChannels(){return this.channels}async removeChannel(e){let t=await e.unsubscribe();return this.channels.length===0&&this.disconnect(),t}async removeAllChannels(){let e=await Promise.all(this.channels.map(t=>t.unsubscribe()));return this.channels=[],this.disconnect(),e}log(e,t,r){this.logger(e,t,r)}connectionState(){switch(this.conn&&this.conn.readyState){case _e.SOCKET_STATES.connecting:return _e.CONNECTION_STATE.Connecting;case _e.SOCKET_STATES.open:return _e.CONNECTION_STATE.Open;case _e.SOCKET_STATES.closing:return _e.CONNECTION_STATE.Closing;default:return _e.CONNECTION_STATE.Closed}}isConnected(){return this.connectionState()===_e.CONNECTION_STATE.Open}isConnecting(){return this._connectionState==="connecting"}isDisconnecting(){return this._connectionState==="disconnecting"}channel(e,t={config:{}}){let r=`realtime:${e}`,i=this.getChannels().find(n=>n.topic===r);if(i)return i;{let n=new L_.default(`realtime:${e}`,t,this);return this.channels.push(n),n}}push(e){let{topic:t,event:r,payload:i,ref:n}=e,o=()=>{this.encode(e,a=>{var l;(l=this.conn)===null||l===void 0||l.send(a)})};this.log("push",`${t} ${r} (${n})`,i),this.isConnected()?o():this.sendBuffer.push(o)}async setAuth(e=null){this._authPromise=this._performAuth(e);try{await this._authPromise}finally{this._authPromise=null}}async sendHeartbeat(){var e;if(!this.isConnected()){try{this.heartbeatCallback("disconnected")}catch(t){this.log("error","error in heartbeat callback",t)}return}if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection");try{this.heartbeatCallback("timeout")}catch(t){this.log("error","error in heartbeat callback",t)}this._wasManualDisconnect=!1,(e=this.conn)===null||e===void 0||e.close(_e.WS_CLOSE_NORMAL,"heartbeat timeout"),setTimeout(()=>{var t;this.isConnected()||(t=this.reconnectTimer)===null||t===void 0||t.scheduleTimeout()},In.HEARTBEAT_TIMEOUT_FALLBACK);return}this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef});try{this.heartbeatCallback("sent")}catch(t){this.log("error","error in heartbeat callback",t)}this._setAuthSafely("heartbeat")}onHeartbeat(e){this.heartbeatCallback=e}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(e=>e()),this.sendBuffer=[])}_makeRef(){let e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}_leaveOpenTopic(e){let t=this.channels.find(r=>r.topic===e&&(r._isJoined()||r._isJoining()));t&&(this.log("transport",`leaving duplicate topic "${e}"`),t.unsubscribe())}_remove(e){this.channels=this.channels.filter(t=>t.topic!==e.topic)}_onConnMessage(e){this.decode(e.data,t=>{if(t.topic==="phoenix"&&t.event==="phx_reply")try{this.heartbeatCallback(t.payload.status==="ok"?"ok":"error")}catch(c){this.log("error","error in heartbeat callback",c)}t.ref&&t.ref===this.pendingHeartbeatRef&&(this.pendingHeartbeatRef=null);let{topic:r,event:i,payload:n,ref:o}=t,a=o?`(${o})`:"",l=n.status||"";this.log("receive",`${l} ${r} ${i} ${a}`.trim(),n),this.channels.filter(c=>c._isMember(r)).forEach(c=>c._trigger(i,n,o)),this._triggerStateCallbacks("message",t)})}_clearTimer(e){var t;e==="heartbeat"&&this.heartbeatTimer?(clearInterval(this.heartbeatTimer),this.heartbeatTimer=void 0):e==="reconnect"&&((t=this.reconnectTimer)===null||t===void 0||t.reset())}_clearAllTimers(){this._clearTimer("heartbeat"),this._clearTimer("reconnect")}_setupConnectionHandlers(){this.conn&&("binaryType"in this.conn&&(this.conn.binaryType="arraybuffer"),this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=e=>this._onConnError(e),this.conn.onmessage=e=>this._onConnMessage(e),this.conn.onclose=e=>this._onConnClose(e))}_teardownConnection(){if(this.conn){if(this.conn.readyState===_e.SOCKET_STATES.open||this.conn.readyState===_e.SOCKET_STATES.connecting)try{this.conn.close()}catch(e){this.log("error","Error closing connection",e)}this.conn.onopen=null,this.conn.onerror=null,this.conn.onmessage=null,this.conn.onclose=null,this.conn=null}this._clearAllTimers(),this.channels.forEach(e=>e.teardown())}_onConnOpen(){this._setConnectionState("connected"),this.log("transport",`connected to ${this.endpointURL()}`),(this._authPromise||(this.accessToken&&!this.accessTokenValue?this.setAuth():Promise.resolve())).then(()=>{this.flushSendBuffer()}).catch(t=>{this.log("error","error waiting for auth on connect",t),this.flushSendBuffer()}),this._clearTimer("reconnect"),this.worker?this.workerRef||this._startWorkerHeartbeat():this._startHeartbeat(),this._triggerStateCallbacks("open")}_startHeartbeat(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this.sendHeartbeat(),this.heartbeatIntervalMs)}_startWorkerHeartbeat(){this.workerUrl?this.log("worker",`starting worker for from ${this.workerUrl}`):this.log("worker","starting default worker");let e=this._workerObjectUrl(this.workerUrl);this.workerRef=new Worker(e),this.workerRef.onerror=t=>{this.log("worker","worker error",t.message),this.workerRef.terminate()},this.workerRef.onmessage=t=>{t.data.event==="keepAlive"&&this.sendHeartbeat()},this.workerRef.postMessage({event:"start",interval:this.heartbeatIntervalMs})}_onConnClose(e){var t;this._setConnectionState("disconnected"),this.log("transport","close",e),this._triggerChanError(),this._clearTimer("heartbeat"),this._wasManualDisconnect||(t=this.reconnectTimer)===null||t===void 0||t.scheduleTimeout(),this._triggerStateCallbacks("close",e)}_onConnError(e){this._setConnectionState("disconnected"),this.log("transport",`${e}`),this._triggerChanError(),this._triggerStateCallbacks("error",e)}_triggerChanError(){this.channels.forEach(e=>e._trigger(_e.CHANNEL_EVENTS.error))}_appendParams(e,t){if(Object.keys(t).length===0)return e;let r=e.match(/\?/)?"&":"?",i=new URLSearchParams(t);return`${e}${r}${i}`}_workerObjectUrl(e){let t;if(e)t=e;else{let r=new Blob([B_],{type:"application/javascript"});t=URL.createObjectURL(r)}return t}_setConnectionState(e,t=!1){this._connectionState=e,e==="connecting"?this._wasManualDisconnect=!1:e==="disconnecting"&&(this._wasManualDisconnect=t)}async _performAuth(e=null){let t;e?t=e:this.accessToken?t=await this.accessToken():t=this.accessTokenValue,this.accessTokenValue!=t&&(this.accessTokenValue=t,this.channels.forEach(r=>{let i={access_token:t,version:_e.DEFAULT_VERSION};t&&r.updateJoinPayload(i),r.joinedOnce&&r._isJoined()&&r._push(_e.CHANNEL_EVENTS.access_token,{access_token:t})}))}async _waitForAuthIfNeeded(){this._authPromise&&await this._authPromise}_setAuthSafely(e="general"){this.setAuth().catch(t=>{this.log("error",`error setting auth in ${e}`,t)})}_triggerStateCallbacks(e,t){try{this.stateChangeCallbacks[e].forEach(r=>{try{r(t)}catch(i){this.log("error",`error in ${e} callback`,i)}})}catch(r){this.log("error",`error triggering ${e} callbacks`,r)}}_setupReconnectionTimer(){this.reconnectTimer=new D_.default(async()=>{setTimeout(async()=>{await this._waitForAuthIfNeeded(),this.isConnected()||this.connect()},In.RECONNECT_DELAY)},this.reconnectAfterMs)}_initializeOptions(e){var t,r,i,n,o,a,l,c,u,f,d,h;switch(this.transport=(t=e?.transport)!==null&&t!==void 0?t:null,this.timeout=(r=e?.timeout)!==null&&r!==void 0?r:_e.DEFAULT_TIMEOUT,this.heartbeatIntervalMs=(i=e?.heartbeatIntervalMs)!==null&&i!==void 0?i:In.HEARTBEAT_INTERVAL,this.worker=(n=e?.worker)!==null&&n!==void 0?n:!1,this.accessToken=(o=e?.accessToken)!==null&&o!==void 0?o:null,this.heartbeatCallback=(a=e?.heartbeatCallback)!==null&&a!==void 0?a:Bu,this.vsn=(l=e?.vsn)!==null&&l!==void 0?l:_e.DEFAULT_VSN,e?.params&&(this.params=e.params),e?.logger&&(this.logger=e.logger),(e?.logLevel||e?.log_level)&&(this.logLevel=e.logLevel||e.log_level,this.params=Object.assign(Object.assign({},this.params),{log_level:this.logLevel})),this.reconnectAfterMs=(c=e?.reconnectAfterMs)!==null&&c!==void 0?c:(g=>q_[g-1]||U_),this.vsn){case _e.VSN_1_0_0:this.encode=(u=e?.encode)!==null&&u!==void 0?u:((g,y)=>y(JSON.stringify(g))),this.decode=(f=e?.decode)!==null&&f!==void 0?f:((g,y)=>y(JSON.parse(g)));break;case _e.VSN_2_0_0:this.encode=(d=e?.encode)!==null&&d!==void 0?d:this.serializer.encode.bind(this.serializer),this.decode=(h=e?.decode)!==null&&h!==void 0?h:this.serializer.decode.bind(this.serializer);break;default:throw new Error(`Unsupported serializer version: ${this.vsn}`)}if(this.worker){if(typeof window<"u"&&!window.Worker)throw new Error("Web Worker is not supported");this.workerUrl=e?.workerUrl}}};Vu.default=Fu});var Hu=R(Te=>{"use strict";Object.defineProperty(Te,"__esModule",{value:!0});Te.WebSocketFactory=Te.REALTIME_CHANNEL_STATES=Te.REALTIME_SUBSCRIBE_STATES=Te.REALTIME_PRESENCE_LISTEN_EVENTS=Te.REALTIME_POSTGRES_CHANGES_LISTEN_EVENT=Te.REALTIME_LISTEN_TYPES=Te.RealtimeClient=Te.RealtimeChannel=Te.RealtimePresence=void 0;var Dn=(Q(),X(W)),F_=Dn.__importDefault(pg());Te.RealtimeClient=F_.default;var ii=Dn.__importStar(Uu());Te.RealtimeChannel=ii.default;Object.defineProperty(Te,"REALTIME_LISTEN_TYPES",{enumerable:!0,get:function(){return ii.REALTIME_LISTEN_TYPES}});Object.defineProperty(Te,"REALTIME_POSTGRES_CHANGES_LISTEN_EVENT",{enumerable:!0,get:function(){return ii.REALTIME_POSTGRES_CHANGES_LISTEN_EVENT}});Object.defineProperty(Te,"REALTIME_SUBSCRIBE_STATES",{enumerable:!0,get:function(){return ii.REALTIME_SUBSCRIBE_STATES}});Object.defineProperty(Te,"REALTIME_CHANNEL_STATES",{enumerable:!0,get:function(){return ii.REALTIME_CHANNEL_STATES}});var mg=Dn.__importStar(ju());Te.RealtimePresence=mg.default;Object.defineProperty(Te,"REALTIME_PRESENCE_LISTEN_EVENTS",{enumerable:!0,get:function(){return mg.REALTIME_PRESENCE_LISTEN_EVENTS}});var V_=Dn.__importDefault(Pu());Te.WebSocketFactory=V_.default});var Yt=R(Lt=>{"use strict";Object.defineProperty(Lt,"__esModule",{value:!0});Lt.StorageUnknownError=Lt.StorageApiError=Lt.StorageError=void 0;Lt.isStorageError=H_;var ni=class extends Error{constructor(e){super(e),this.__isStorageError=!0,this.name="StorageError"}};Lt.StorageError=ni;function H_(s){return typeof s=="object"&&s!==null&&"__isStorageError"in s}var Ku=class extends ni{constructor(e,t,r){super(e),this.name="StorageApiError",this.status=t,this.statusCode=r}toJSON(){return{name:this.name,message:this.message,status:this.status,statusCode:this.statusCode}}};Lt.StorageApiError=Ku;var zu=class extends ni{constructor(e,t){super(e),this.name="StorageUnknownError",this.originalError=t}};Lt.StorageUnknownError=zu});var oi=R(ze=>{"use strict";Object.defineProperty(ze,"__esModule",{value:!0});ze.isValidBucketName=ze.isPlainObject=ze.recursiveToCamel=ze.resolveResponse=ze.resolveFetch=void 0;var K_=s=>s?(...e)=>s(...e):(...e)=>fetch(...e);ze.resolveFetch=K_;var z_=()=>Response;ze.resolveResponse=z_;var W_=s=>{if(Array.isArray(s))return s.map(t=>(0,ze.recursiveToCamel)(t));if(typeof s=="function"||s!==Object(s))return s;let e={};return Object.entries(s).forEach(([t,r])=>{let i=t.replace(/([-_][a-z])/gi,n=>n.toUpperCase().replace(/[-_]/g,""));e[i]=(0,ze.recursiveToCamel)(r)}),e};ze.recursiveToCamel=W_;var Q_=s=>{if(typeof s!="object"||s===null)return!1;let e=Object.getPrototypeOf(s);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in s)&&!(Symbol.iterator in s)};ze.isPlainObject=Q_;var J_=s=>!s||typeof s!="string"||s.length===0||s.length>100||s.trim()!==s||s.includes("/")||s.includes("\\")?!1:/^[\w!.\*'() &$@=;:+,?-]+$/.test(s);ze.isValidBucketName=J_});var jn=R(mr=>{"use strict";Object.defineProperty(mr,"__esModule",{value:!0});mr.get=Y_;mr.post=Z_;mr.put=ev;mr.head=tv;mr.remove=rv;var pr=(Q(),X(W)),Wu=Yt(),gg=oi(),Qu=s=>{var e;return s.msg||s.message||s.error_description||(typeof s.error=="string"?s.error:(e=s.error)===null||e===void 0?void 0:e.message)||JSON.stringify(s)},G_=(s,e,t)=>pr.__awaiter(void 0,void 0,void 0,function*(){let r=yield(0,gg.resolveResponse)();s instanceof r&&!t?.noResolveJson?s.json().then(i=>{let n=s.status||500,o=i?.statusCode||n+"";e(new Wu.StorageApiError(Qu(i),n,o))}).catch(i=>{e(new Wu.StorageUnknownError(Qu(i),i))}):e(new Wu.StorageUnknownError(Qu(s),s))}),X_=(s,e,t,r)=>{let i={method:s,headers:e?.headers||{}};return s==="GET"||!r?i:((0,gg.isPlainObject)(r)?(i.headers=Object.assign({"Content-Type":"application/json"},e?.headers),i.body=JSON.stringify(r)):i.body=r,e?.duplex&&(i.duplex=e.duplex),Object.assign(Object.assign({},i),t))};function ai(s,e,t,r,i,n){return pr.__awaiter(this,void 0,void 0,function*(){return new Promise((o,a)=>{s(t,X_(e,r,i,n)).then(l=>{if(!l.ok)throw l;return r?.noResolveJson?l:l.json()}).then(l=>o(l)).catch(l=>G_(l,a,r))})})}function Y_(s,e,t,r){return pr.__awaiter(this,void 0,void 0,function*(){return ai(s,"GET",e,t,r)})}function Z_(s,e,t,r,i){return pr.__awaiter(this,void 0,void 0,function*(){return ai(s,"POST",e,r,i,t)})}function ev(s,e,t,r,i){return pr.__awaiter(this,void 0,void 0,function*(){return ai(s,"PUT",e,r,i,t)})}function tv(s,e,t,r){return pr.__awaiter(this,void 0,void 0,function*(){return ai(s,"HEAD",e,Object.assign(Object.assign({},t),{noResolveJson:!0}),r)})}function rv(s,e,t,r,i){return pr.__awaiter(this,void 0,void 0,function*(){return ai(s,"DELETE",e,r,i,t)})}});var yg=R(Gu=>{"use strict";Object.defineProperty(Gu,"__esModule",{value:!0});var sv=(Q(),X(W)),iv=Yt(),Ju=class{constructor(e,t){this.downloadFn=e,this.shouldThrowOnError=t}then(e,t){return this.execute().then(e,t)}execute(){return sv.__awaiter(this,void 0,void 0,function*(){try{return{data:(yield this.downloadFn()).body,error:null}}catch(e){if(this.shouldThrowOnError)throw e;if((0,iv.isStorageError)(e))return{data:null,error:e};throw e}})}};Gu.default=Ju});var _g=R(Yu=>{"use strict";var wg;Object.defineProperty(Yu,"__esModule",{value:!0});var bg=(Q(),X(W)),nv=Yt(),ov=bg.__importDefault(yg()),Xu=class{constructor(e,t){this.downloadFn=e,this.shouldThrowOnError=t,this[wg]="BlobDownloadBuilder",this.promise=null}asStream(){return new ov.default(this.downloadFn,this.shouldThrowOnError)}then(e,t){return this.getPromise().then(e,t)}catch(e){return this.getPromise().catch(e)}finally(e){return this.getPromise().finally(e)}getPromise(){return this.promise||(this.promise=this.execute()),this.promise}execute(){return bg.__awaiter(this,void 0,void 0,function*(){try{return{data:yield(yield this.downloadFn()).blob(),error:null}}catch(e){if(this.shouldThrowOnError)throw e;if((0,nv.isStorageError)(e))return{data:null,error:e};throw e}})}};wg=Symbol.toStringTag;Yu.default=Xu});var Eg=R(ed=>{"use strict";Object.defineProperty(ed,"__esModule",{value:!0});var Le=(Q(),X(W)),We=Yt(),Qe=jn(),vg=oi(),av=Le.__importDefault(_g()),lv={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},Sg={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1},Zu=class{constructor(e,t={},r,i){this.shouldThrowOnError=!1,this.url=e,this.headers=t,this.bucketId=r,this.fetch=(0,vg.resolveFetch)(i)}throwOnError(){return this.shouldThrowOnError=!0,this}uploadOrUpdate(e,t,r,i){return Le.__awaiter(this,void 0,void 0,function*(){try{let n,o=Object.assign(Object.assign({},Sg),i),a=Object.assign(Object.assign({},this.headers),e==="POST"&&{"x-upsert":String(o.upsert)}),l=o.metadata;typeof Blob<"u"&&r instanceof Blob?(n=new FormData,n.append("cacheControl",o.cacheControl),l&&n.append("metadata",this.encodeMetadata(l)),n.append("",r)):typeof FormData<"u"&&r instanceof FormData?(n=r,n.has("cacheControl")||n.append("cacheControl",o.cacheControl),l&&!n.has("metadata")&&n.append("metadata",this.encodeMetadata(l))):(n=r,a["cache-control"]=`max-age=${o.cacheControl}`,a["content-type"]=o.contentType,l&&(a["x-metadata"]=this.toBase64(this.encodeMetadata(l))),(typeof ReadableStream<"u"&&n instanceof ReadableStream||n&&typeof n=="object"&&"pipe"in n&&typeof n.pipe=="function")&&!o.duplex&&(o.duplex="half")),i?.headers&&(a=Object.assign(Object.assign({},a),i.headers));let c=this._removeEmptyFolders(t),u=this._getFinalPath(c),f=yield(e=="PUT"?Qe.put:Qe.post)(this.fetch,`${this.url}/object/${u}`,n,Object.assign({headers:a},o?.duplex?{duplex:o.duplex}:{}));return{data:{path:c,id:f.Id,fullPath:f.Key},error:null}}catch(n){if(this.shouldThrowOnError)throw n;if((0,We.isStorageError)(n))return{data:null,error:n};throw n}})}upload(e,t,r){return Le.__awaiter(this,void 0,void 0,function*(){return this.uploadOrUpdate("POST",e,t,r)})}uploadToSignedUrl(e,t,r,i){return Le.__awaiter(this,void 0,void 0,function*(){let n=this._removeEmptyFolders(e),o=this._getFinalPath(n),a=new URL(this.url+`/object/upload/sign/${o}`);a.searchParams.set("token",t);try{let l,c=Object.assign({upsert:Sg.upsert},i),u=Object.assign(Object.assign({},this.headers),{"x-upsert":String(c.upsert)});typeof Blob<"u"&&r instanceof Blob?(l=new FormData,l.append("cacheControl",c.cacheControl),l.append("",r)):typeof FormData<"u"&&r instanceof FormData?(l=r,l.append("cacheControl",c.cacheControl)):(l=r,u["cache-control"]=`max-age=${c.cacheControl}`,u["content-type"]=c.contentType);let f=yield(0,Qe.put)(this.fetch,a.toString(),l,{headers:u});return{data:{path:n,fullPath:f.Key},error:null}}catch(l){if(this.shouldThrowOnError)throw l;if((0,We.isStorageError)(l))return{data:null,error:l};throw l}})}createSignedUploadUrl(e,t){return Le.__awaiter(this,void 0,void 0,function*(){try{let r=this._getFinalPath(e),i=Object.assign({},this.headers);t?.upsert&&(i["x-upsert"]="true");let n=yield(0,Qe.post)(this.fetch,`${this.url}/object/upload/sign/${r}`,{},{headers:i}),o=new URL(this.url+n.url),a=o.searchParams.get("token");if(!a)throw new We.StorageError("No token returned by API");return{data:{signedUrl:o.toString(),path:e,token:a},error:null}}catch(r){if(this.shouldThrowOnError)throw r;if((0,We.isStorageError)(r))return{data:null,error:r};throw r}})}update(e,t,r){return Le.__awaiter(this,void 0,void 0,function*(){return this.uploadOrUpdate("PUT",e,t,r)})}move(e,t,r){return Le.__awaiter(this,void 0,void 0,function*(){try{return{data:yield(0,Qe.post)(this.fetch,`${this.url}/object/move`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t,destinationBucket:r?.destinationBucket},{headers:this.headers}),error:null}}catch(i){if(this.shouldThrowOnError)throw i;if((0,We.isStorageError)(i))return{data:null,error:i};throw i}})}copy(e,t,r){return Le.__awaiter(this,void 0,void 0,function*(){try{return{data:{path:(yield(0,Qe.post)(this.fetch,`${this.url}/object/copy`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t,destinationBucket:r?.destinationBucket},{headers:this.headers})).Key},error:null}}catch(i){if(this.shouldThrowOnError)throw i;if((0,We.isStorageError)(i))return{data:null,error:i};throw i}})}createSignedUrl(e,t,r){return Le.__awaiter(this,void 0,void 0,function*(){try{let i=this._getFinalPath(e),n=yield(0,Qe.post)(this.fetch,`${this.url}/object/sign/${i}`,Object.assign({expiresIn:t},r?.transform?{transform:r.transform}:{}),{headers:this.headers}),o=r?.download?`&download=${r.download===!0?"":r.download}`:"";return n={signedUrl:encodeURI(`${this.url}${n.signedURL}${o}`)},{data:n,error:null}}catch(i){if(this.shouldThrowOnError)throw i;if((0,We.isStorageError)(i))return{data:null,error:i};throw i}})}createSignedUrls(e,t,r){return Le.__awaiter(this,void 0,void 0,function*(){try{let i=yield(0,Qe.post)(this.fetch,`${this.url}/object/sign/${this.bucketId}`,{expiresIn:t,paths:e},{headers:this.headers}),n=r?.download?`&download=${r.download===!0?"":r.download}`:"";return{data:i.map(o=>Object.assign(Object.assign({},o),{signedUrl:o.signedURL?encodeURI(`${this.url}${o.signedURL}${n}`):null})),error:null}}catch(i){if(this.shouldThrowOnError)throw i;if((0,We.isStorageError)(i))return{data:null,error:i};throw i}})}download(e,t){let i=typeof t?.transform<"u"?"render/image/authenticated":"object",n=this.transformOptsToQueryString(t?.transform||{}),o=n?`?${n}`:"",a=this._getFinalPath(e),l=()=>(0,Qe.get)(this.fetch,`${this.url}/${i}/${a}${o}`,{headers:this.headers,noResolveJson:!0});return new av.default(l,this.shouldThrowOnError)}info(e){return Le.__awaiter(this,void 0,void 0,function*(){let t=this._getFinalPath(e);try{let r=yield(0,Qe.get)(this.fetch,`${this.url}/object/info/${t}`,{headers:this.headers});return{data:(0,vg.recursiveToCamel)(r),error:null}}catch(r){if(this.shouldThrowOnError)throw r;if((0,We.isStorageError)(r))return{data:null,error:r};throw r}})}exists(e){return Le.__awaiter(this,void 0,void 0,function*(){let t=this._getFinalPath(e);try{return yield(0,Qe.head)(this.fetch,`${this.url}/object/${t}`,{headers:this.headers}),{data:!0,error:null}}catch(r){if(this.shouldThrowOnError)throw r;if((0,We.isStorageError)(r)&&r instanceof We.StorageUnknownError){let i=r.originalError;if([400,404].includes(i?.status))return{data:!1,error:r}}throw r}})}getPublicUrl(e,t){let r=this._getFinalPath(e),i=[],n=t?.download?`download=${t.download===!0?"":t.download}`:"";n!==""&&i.push(n);let a=typeof t?.transform<"u"?"render/image":"object",l=this.transformOptsToQueryString(t?.transform||{});l!==""&&i.push(l);let c=i.join("&");return c!==""&&(c=`?${c}`),{data:{publicUrl:encodeURI(`${this.url}/${a}/public/${r}${c}`)}}}remove(e){return Le.__awaiter(this,void 0,void 0,function*(){try{return{data:yield(0,Qe.remove)(this.fetch,`${this.url}/object/${this.bucketId}`,{prefixes:e},{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if((0,We.isStorageError)(t))return{data:null,error:t};throw t}})}list(e,t,r){return Le.__awaiter(this,void 0,void 0,function*(){try{let i=Object.assign(Object.assign(Object.assign({},lv),t),{prefix:e||""});return{data:yield(0,Qe.post)(this.fetch,`${this.url}/object/list/${this.bucketId}`,i,{headers:this.headers},r),error:null}}catch(i){if(this.shouldThrowOnError)throw i;if((0,We.isStorageError)(i))return{data:null,error:i};throw i}})}listV2(e,t){return Le.__awaiter(this,void 0,void 0,function*(){try{let r=Object.assign({},e);return{data:yield(0,Qe.post)(this.fetch,`${this.url}/object/list-v2/${this.bucketId}`,r,{headers:this.headers},t),error:null}}catch(r){if(this.shouldThrowOnError)throw r;if((0,We.isStorageError)(r))return{data:null,error:r};throw r}})}encodeMetadata(e){return JSON.stringify(e)}toBase64(e){return typeof Buffer<"u"?Buffer.from(e).toString("base64"):btoa(e)}_getFinalPath(e){return`${this.bucketId}/${e.replace(/^\/+/,"")}`}_removeEmptyFolders(e){return e.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(e){let t=[];return e.width&&t.push(`width=${e.width}`),e.height&&t.push(`height=${e.height}`),e.resize&&t.push(`resize=${e.resize}`),e.format&&t.push(`format=${e.format}`),e.quality&&t.push(`quality=${e.quality}`),t.join("&")}};ed.default=Zu});var td=R(Ln=>{"use strict";Object.defineProperty(Ln,"__esModule",{value:!0});Ln.version=void 0;Ln.version="2.86.0"});var rd=R(qn=>{"use strict";Object.defineProperty(qn,"__esModule",{value:!0});qn.DEFAULT_HEADERS=void 0;var cv=td();qn.DEFAULT_HEADERS={"X-Client-Info":`storage-js/${cv.version}`}});var Tg=R(id=>{"use strict";Object.defineProperty(id,"__esModule",{value:!0});var Vr=(Q(),X(W)),uv=rd(),Hr=Yt(),Kr=jn(),dv=oi(),sd=class{constructor(e,t={},r,i){this.shouldThrowOnError=!1;let n=new URL(e);i?.useNewHostname&&/supabase\.(co|in|red)$/.test(n.hostname)&&!n.hostname.includes("storage.supabase.")&&(n.hostname=n.hostname.replace("supabase.","storage.supabase.")),this.url=n.href.replace(/\/$/,""),this.headers=Object.assign(Object.assign({},uv.DEFAULT_HEADERS),t),this.fetch=(0,dv.resolveFetch)(r)}throwOnError(){return this.shouldThrowOnError=!0,this}listBuckets(e){return Vr.__awaiter(this,void 0,void 0,function*(){try{let t=this.listBucketOptionsToQueryString(e);return{data:yield(0,Kr.get)(this.fetch,`${this.url}/bucket${t}`,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if((0,Hr.isStorageError)(t))return{data:null,error:t};throw t}})}getBucket(e){return Vr.__awaiter(this,void 0,void 0,function*(){try{return{data:yield(0,Kr.get)(this.fetch,`${this.url}/bucket/${e}`,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if((0,Hr.isStorageError)(t))return{data:null,error:t};throw t}})}createBucket(e){return Vr.__awaiter(this,arguments,void 0,function*(t,r={public:!1}){try{return{data:yield(0,Kr.post)(this.fetch,`${this.url}/bucket`,{id:t,name:t,type:r.type,public:r.public,file_size_limit:r.fileSizeLimit,allowed_mime_types:r.allowedMimeTypes},{headers:this.headers}),error:null}}catch(i){if(this.shouldThrowOnError)throw i;if((0,Hr.isStorageError)(i))return{data:null,error:i};throw i}})}updateBucket(e,t){return Vr.__awaiter(this,void 0,void 0,function*(){try{return{data:yield(0,Kr.put)(this.fetch,`${this.url}/bucket/${e}`,{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(r){if(this.shouldThrowOnError)throw r;if((0,Hr.isStorageError)(r))return{data:null,error:r};throw r}})}emptyBucket(e){return Vr.__awaiter(this,void 0,void 0,function*(){try{return{data:yield(0,Kr.post)(this.fetch,`${this.url}/bucket/${e}/empty`,{},{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if((0,Hr.isStorageError)(t))return{data:null,error:t};throw t}})}deleteBucket(e){return Vr.__awaiter(this,void 0,void 0,function*(){try{return{data:yield(0,Kr.remove)(this.fetch,`${this.url}/bucket/${e}`,{},{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if((0,Hr.isStorageError)(t))return{data:null,error:t};throw t}})}listBucketOptionsToQueryString(e){let t={};return e&&("limit"in e&&(t.limit=String(e.limit)),"offset"in e&&(t.offset=String(e.offset)),e.search&&(t.search=e.search),e.sortColumn&&(t.sortColumn=e.sortColumn),e.sortOrder&&(t.sortOrder=e.sortOrder)),Object.keys(t).length>0?"?"+new URLSearchParams(t).toString():""}};id.default=sd});var Ag=R(Bn=>{"use strict";var Wr=class extends Error{constructor(s,e){super(s),this.name="IcebergError",this.status=e.status,this.icebergType=e.icebergType,this.icebergCode=e.icebergCode,this.details=e.details,this.isCommitStateUnknown=e.icebergType==="CommitStateUnknownException"||[500,502,504].includes(e.status)&&e.icebergType?.includes("CommitState")===!0}isNotFound(){return this.status===404}isConflict(){return this.status===409}isAuthenticationTimeout(){return this.status===419}};function hv(s,e,t){let r=new URL(e,s);if(t)for(let[i,n]of Object.entries(t))n!==void 0&&r.searchParams.set(i,n);return r.toString()}async function fv(s){return!s||s.type==="none"?{}:s.type==="bearer"?{Authorization:`Bearer ${s.token}`}:s.type==="header"?{[s.name]:s.value}:s.type==="custom"?await s.getHeaders():{}}function pv(s){let e=s.fetchImpl??globalThis.fetch;return{async request({method:t,path:r,query:i,body:n,headers:o}){let a=hv(s.baseUrl,r,i),l=await fv(s.auth),c=await e(a,{method:t,headers:{...n?{"Content-Type":"application/json"}:{},...l,...o},body:n?JSON.stringify(n):void 0}),u=await c.text(),f=(c.headers.get("content-type")||"").includes("application/json"),d=f&&u?JSON.parse(u):u;if(!c.ok){let h=f?d:void 0,g=h?.error;throw new Wr(g?.message??`Request failed with status ${c.status}`,{status:c.status,icebergType:g?.type,icebergCode:g?.code,details:h})}return{status:c.status,headers:c.headers,data:d}}}}function Un(s){return s.join("")}var mv=class{constructor(s,e=""){this.client=s,this.prefix=e}async listNamespaces(s){let e=s?{parent:Un(s.namespace)}:void 0;return(await this.client.request({method:"GET",path:`${this.prefix}/namespaces`,query:e})).data.namespaces.map(r=>({namespace:r}))}async createNamespace(s,e){let t={namespace:s.namespace,properties:e?.properties};return(await this.client.request({method:"POST",path:`${this.prefix}/namespaces`,body:t})).data}async dropNamespace(s){await this.client.request({method:"DELETE",path:`${this.prefix}/namespaces/${Un(s.namespace)}`})}async loadNamespaceMetadata(s){return{properties:(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${Un(s.namespace)}`})).data.properties}}async namespaceExists(s){try{return await this.client.request({method:"HEAD",path:`${this.prefix}/namespaces/${Un(s.namespace)}`}),!0}catch(e){if(e instanceof Wr&&e.status===404)return!1;throw e}}async createNamespaceIfNotExists(s,e){try{return await this.createNamespace(s,e)}catch(t){if(t instanceof Wr&&t.status===409)return;throw t}}};function zr(s){return s.join("")}var gv=class{constructor(s,e="",t){this.client=s,this.prefix=e,this.accessDelegation=t}async listTables(s){return(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${zr(s.namespace)}/tables`})).data.identifiers}async createTable(s,e){let t={};return this.accessDelegation&&(t["X-Iceberg-Access-Delegation"]=this.accessDelegation),(await this.client.request({method:"POST",path:`${this.prefix}/namespaces/${zr(s.namespace)}/tables`,body:e,headers:t})).data.metadata}async updateTable(s,e){let t=await this.client.request({method:"POST",path:`${this.prefix}/namespaces/${zr(s.namespace)}/tables/${s.name}`,body:e});return{"metadata-location":t.data["metadata-location"],metadata:t.data.metadata}}async dropTable(s,e){await this.client.request({method:"DELETE",path:`${this.prefix}/namespaces/${zr(s.namespace)}/tables/${s.name}`,query:{purgeRequested:String(e?.purge??!1)}})}async loadTable(s){let e={};return this.accessDelegation&&(e["X-Iceberg-Access-Delegation"]=this.accessDelegation),(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${zr(s.namespace)}/tables/${s.name}`,headers:e})).data.metadata}async tableExists(s){let e={};this.accessDelegation&&(e["X-Iceberg-Access-Delegation"]=this.accessDelegation);try{return await this.client.request({method:"HEAD",path:`${this.prefix}/namespaces/${zr(s.namespace)}/tables/${s.name}`,headers:e}),!0}catch(t){if(t instanceof Wr&&t.status===404)return!1;throw t}}async createTableIfNotExists(s,e){try{return await this.createTable(s,e)}catch(t){if(t instanceof Wr&&t.status===409)return await this.loadTable({namespace:s.namespace,name:e.name});throw t}}},yv=class{constructor(s){let e="v1";s.catalogName&&(e+=`/${s.catalogName}`);let t=s.baseUrl.endsWith("/")?s.baseUrl:`${s.baseUrl}/`;this.client=pv({baseUrl:t,auth:s.auth,fetchImpl:s.fetch}),this.accessDelegation=s.accessDelegation?.join(","),this.namespaceOps=new mv(this.client,e),this.tableOps=new gv(this.client,e,this.accessDelegation)}async listNamespaces(s){return this.namespaceOps.listNamespaces(s)}async createNamespace(s,e){return this.namespaceOps.createNamespace(s,e)}async dropNamespace(s){await this.namespaceOps.dropNamespace(s)}async loadNamespaceMetadata(s){return this.namespaceOps.loadNamespaceMetadata(s)}async listTables(s){return this.tableOps.listTables(s)}async createTable(s,e){return this.tableOps.createTable(s,e)}async updateTable(s,e){return this.tableOps.updateTable(s,e)}async dropTable(s,e){await this.tableOps.dropTable(s,e)}async loadTable(s){return this.tableOps.loadTable(s)}async namespaceExists(s){return this.namespaceOps.namespaceExists(s)}async tableExists(s){return this.tableOps.tableExists(s)}async createNamespaceIfNotExists(s,e){return this.namespaceOps.createNamespaceIfNotExists(s,e)}async createTableIfNotExists(s,e){return this.tableOps.createTableIfNotExists(s,e)}};function wv(s){return s.schemas.find(e=>e["schema-id"]===s["current-schema-id"])}Bn.IcebergError=Wr;Bn.IcebergRestCatalog=yv;Bn.getCurrentSchema=wv});var ld=R(ad=>{"use strict";Object.defineProperty(ad,"__esModule",{value:!0});var Fn=(Q(),X(W)),bv=Ag(),_v=rd(),Vn=Yt(),nd=jn(),kg=oi(),od=class{constructor(e,t={},r){this.shouldThrowOnError=!1,this.url=e.replace(/\/$/,""),this.headers=Object.assign(Object.assign({},_v.DEFAULT_HEADERS),t),this.fetch=(0,kg.resolveFetch)(r)}throwOnError(){return this.shouldThrowOnError=!0,this}createBucket(e){return Fn.__awaiter(this,void 0,void 0,function*(){try{return{data:yield(0,nd.post)(this.fetch,`${this.url}/bucket`,{name:e},{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if((0,Vn.isStorageError)(t))return{data:null,error:t};throw t}})}listBuckets(e){return Fn.__awaiter(this,void 0,void 0,function*(){try{let t=new URLSearchParams;e?.limit!==void 0&&t.set("limit",e.limit.toString()),e?.offset!==void 0&&t.set("offset",e.offset.toString()),e?.sortColumn&&t.set("sortColumn",e.sortColumn),e?.sortOrder&&t.set("sortOrder",e.sortOrder),e?.search&&t.set("search",e.search);let r=t.toString(),i=r?`${this.url}/bucket?${r}`:`${this.url}/bucket`;return{data:yield(0,nd.get)(this.fetch,i,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if((0,Vn.isStorageError)(t))return{data:null,error:t};throw t}})}deleteBucket(e){return Fn.__awaiter(this,void 0,void 0,function*(){try{return{data:yield(0,nd.remove)(this.fetch,`${this.url}/bucket/${e}`,{},{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if((0,Vn.isStorageError)(t))return{data:null,error:t};throw t}})}from(e){if(!(0,kg.isValidBucketName)(e))throw new Vn.StorageError("Invalid bucket name: File, folder, and bucket names must follow AWS object key naming guidelines and should avoid the use of any other characters.");return new bv.IcebergRestCatalog({baseUrl:this.url,catalogName:e,auth:{type:"custom",getHeaders:()=>Fn.__awaiter(this,void 0,void 0,function*(){return this.headers})},fetch:this.fetch})}};ad.default=od});var Kn=R(Hn=>{"use strict";Object.defineProperty(Hn,"__esModule",{value:!0});Hn.DEFAULT_HEADERS=void 0;var vv=td();Hn.DEFAULT_HEADERS={"X-Client-Info":`storage-js/${vv.version}`,"Content-Type":"application/json"}});var Qr=R(mt=>{"use strict";Object.defineProperty(mt,"__esModule",{value:!0});mt.StorageVectorsErrorCode=mt.StorageVectorsUnknownError=mt.StorageVectorsApiError=mt.StorageVectorsError=void 0;mt.isStorageVectorsError=Sv;var li=class extends Error{constructor(e){super(e),this.__isStorageVectorsError=!0,this.name="StorageVectorsError"}};mt.StorageVectorsError=li;function Sv(s){return typeof s=="object"&&s!==null&&"__isStorageVectorsError"in s}var cd=class extends li{constructor(e,t,r){super(e),this.name="StorageVectorsApiError",this.status=t,this.statusCode=r}toJSON(){return{name:this.name,message:this.message,status:this.status,statusCode:this.statusCode}}};mt.StorageVectorsApiError=cd;var ud=class extends li{constructor(e,t){super(e),this.name="StorageVectorsUnknownError",this.originalError=t}};mt.StorageVectorsUnknownError=ud;var Pg;(function(s){s.InternalError="InternalError",s.S3VectorConflictException="S3VectorConflictException",s.S3VectorNotFoundException="S3VectorNotFoundException",s.S3VectorBucketNotEmpty="S3VectorBucketNotEmpty",s.S3VectorMaxBucketsExceeded="S3VectorMaxBucketsExceeded",s.S3VectorMaxIndexesExceeded="S3VectorMaxIndexesExceeded"})(Pg||(mt.StorageVectorsErrorCode=Pg={}))});var Jr=R(it=>{"use strict";Object.defineProperty(it,"__esModule",{value:!0});it.validateVectorDimension=it.normalizeToFloat32=it.isPlainObject=it.resolveResponse=it.resolveFetch=void 0;var Ev=s=>s?(...e)=>s(...e):(...e)=>fetch(...e);it.resolveFetch=Ev;var Tv=()=>Response;it.resolveResponse=Tv;var Av=s=>{if(typeof s!="object"||s===null)return!1;let e=Object.getPrototypeOf(s);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in s)&&!(Symbol.iterator in s)};it.isPlainObject=Av;var kv=s=>Array.from(new Float32Array(s));it.normalizeToFloat32=kv;var Pv=(s,e)=>{if(e!==void 0&&s.float32.length!==e)throw new Error(`Vector dimension mismatch: expected ${e}, got ${s.float32.length}`)};it.validateVectorDimension=Pv});var Qn=R(Xr=>{"use strict";Object.defineProperty(Xr,"__esModule",{value:!0});Xr.get=Ov;Xr.post=Nv;Xr.put=$v;Xr.remove=Iv;var Gr=(Q(),X(W)),zn=Qr(),xv=Jr(),xg=s=>s.msg||s.message||s.error_description||s.error||JSON.stringify(s),Cv=(s,e,t)=>Gr.__awaiter(void 0,void 0,void 0,function*(){if(s&&typeof s=="object"&&"status"in s&&"ok"in s&&typeof s.status=="number"&&!t?.noResolveJson){let i=s.status||500,n=s;if(typeof n.json=="function")n.json().then(o=>{let a=o?.statusCode||o?.code||i+"";e(new zn.StorageVectorsApiError(xg(o),i,a))}).catch(()=>{let o=i+"",a=n.statusText||`HTTP ${i} error`;e(new zn.StorageVectorsApiError(a,i,o))});else{let o=i+"",a=n.statusText||`HTTP ${i} error`;e(new zn.StorageVectorsApiError(a,i,o))}}else e(new zn.StorageVectorsUnknownError(xg(s),s))}),Rv=(s,e,t,r)=>{let i={method:s,headers:e?.headers||{}};return s==="GET"||!r?i:((0,xv.isPlainObject)(r)?(i.headers=Object.assign({"Content-Type":"application/json"},e?.headers),i.body=JSON.stringify(r)):i.body=r,Object.assign(Object.assign({},i),t))};function Wn(s,e,t,r,i,n){return Gr.__awaiter(this,void 0,void 0,function*(){return new Promise((o,a)=>{s(t,Rv(e,r,i,n)).then(l=>{if(!l.ok)throw l;if(r?.noResolveJson)return l;let c=l.headers.get("content-type");return!c||!c.includes("application/json")?{}:l.json()}).then(l=>o(l)).catch(l=>Cv(l,a,r))})})}function Ov(s,e,t,r){return Gr.__awaiter(this,void 0,void 0,function*(){return Wn(s,"GET",e,t,r)})}function Nv(s,e,t,r,i){return Gr.__awaiter(this,void 0,void 0,function*(){return Wn(s,"POST",e,r,i,t)})}function $v(s,e,t,r,i){return Gr.__awaiter(this,void 0,void 0,function*(){return Wn(s,"PUT",e,r,i,t)})}function Iv(s,e,t,r,i){return Gr.__awaiter(this,void 0,void 0,function*(){return Wn(s,"DELETE",e,r,i,t)})}});var fd=R(hd=>{"use strict";Object.defineProperty(hd,"__esModule",{value:!0});var Jn=(Q(),X(W)),Mv=Kn(),Gn=Qr(),Xn=Qn(),Dv=Jr(),dd=class{constructor(e,t={},r){this.shouldThrowOnError=!1,this.url=e.replace(/\/$/,""),this.headers=Object.assign(Object.assign({},Mv.DEFAULT_HEADERS),t),this.fetch=(0,Dv.resolveFetch)(r)}throwOnError(){return this.shouldThrowOnError=!0,this}createIndex(e){return Jn.__awaiter(this,void 0,void 0,function*(){try{return{data:(yield(0,Xn.post)(this.fetch,`${this.url}/CreateIndex`,e,{headers:this.headers}))||{},error:null}}catch(t){if(this.shouldThrowOnError)throw t;if((0,Gn.isStorageVectorsError)(t))return{data:null,error:t};throw t}})}getIndex(e,t){return Jn.__awaiter(this,void 0,void 0,function*(){try{return{data:yield(0,Xn.post)(this.fetch,`${this.url}/GetIndex`,{vectorBucketName:e,indexName:t},{headers:this.headers}),error:null}}catch(r){if(this.shouldThrowOnError)throw r;if((0,Gn.isStorageVectorsError)(r))return{data:null,error:r};throw r}})}listIndexes(e){return Jn.__awaiter(this,void 0,void 0,function*(){try{return{data:yield(0,Xn.post)(this.fetch,`${this.url}/ListIndexes`,e,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if((0,Gn.isStorageVectorsError)(t))return{data:null,error:t};throw t}})}deleteIndex(e,t){return Jn.__awaiter(this,void 0,void 0,function*(){try{return{data:(yield(0,Xn.post)(this.fetch,`${this.url}/DeleteIndex`,{vectorBucketName:e,indexName:t},{headers:this.headers}))||{},error:null}}catch(r){if(this.shouldThrowOnError)throw r;if((0,Gn.isStorageVectorsError)(r))return{data:null,error:r};throw r}})}};hd.default=dd});var gd=R(md=>{"use strict";Object.defineProperty(md,"__esModule",{value:!0});var ci=(Q(),X(W)),jv=Kn(),ui=Qr(),di=Qn(),Lv=Jr(),pd=class{constructor(e,t={},r){this.shouldThrowOnError=!1,this.url=e.replace(/\/$/,""),this.headers=Object.assign(Object.assign({},jv.DEFAULT_HEADERS),t),this.fetch=(0,Lv.resolveFetch)(r)}throwOnError(){return this.shouldThrowOnError=!0,this}putVectors(e){return ci.__awaiter(this,void 0,void 0,function*(){try{if(e.vectors.length<1||e.vectors.length>500)throw new Error("Vector batch size must be between 1 and 500 items");return{data:(yield(0,di.post)(this.fetch,`${this.url}/PutVectors`,e,{headers:this.headers}))||{},error:null}}catch(t){if(this.shouldThrowOnError)throw t;if((0,ui.isStorageVectorsError)(t))return{data:null,error:t};throw t}})}getVectors(e){return ci.__awaiter(this,void 0,void 0,function*(){try{return{data:yield(0,di.post)(this.fetch,`${this.url}/GetVectors`,e,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if((0,ui.isStorageVectorsError)(t))return{data:null,error:t};throw t}})}listVectors(e){return ci.__awaiter(this,void 0,void 0,function*(){try{if(e.segmentCount!==void 0){if(e.segmentCount<1||e.segmentCount>16)throw new Error("segmentCount must be between 1 and 16");if(e.segmentIndex!==void 0&&(e.segmentIndex<0||e.segmentIndex>=e.segmentCount))throw new Error(`segmentIndex must be between 0 and ${e.segmentCount-1}`)}return{data:yield(0,di.post)(this.fetch,`${this.url}/ListVectors`,e,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if((0,ui.isStorageVectorsError)(t))return{data:null,error:t};throw t}})}queryVectors(e){return ci.__awaiter(this,void 0,void 0,function*(){try{return{data:yield(0,di.post)(this.fetch,`${this.url}/QueryVectors`,e,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if((0,ui.isStorageVectorsError)(t))return{data:null,error:t};throw t}})}deleteVectors(e){return ci.__awaiter(this,void 0,void 0,function*(){try{if(e.keys.length<1||e.keys.length>500)throw new Error("Keys batch size must be between 1 and 500 items");return{data:(yield(0,di.post)(this.fetch,`${this.url}/DeleteVectors`,e,{headers:this.headers}))||{},error:null}}catch(t){if(this.shouldThrowOnError)throw t;if((0,ui.isStorageVectorsError)(t))return{data:null,error:t};throw t}})}};md.default=pd});var bd=R(wd=>{"use strict";Object.defineProperty(wd,"__esModule",{value:!0});var Yn=(Q(),X(W)),qv=Kn(),Zn=Qr(),eo=Qn(),Uv=Jr(),yd=class{constructor(e,t={},r){this.shouldThrowOnError=!1,this.url=e.replace(/\/$/,""),this.headers=Object.assign(Object.assign({},qv.DEFAULT_HEADERS),t),this.fetch=(0,Uv.resolveFetch)(r)}throwOnError(){return this.shouldThrowOnError=!0,this}createBucket(e){return Yn.__awaiter(this,void 0,void 0,function*(){try{return{data:(yield(0,eo.post)(this.fetch,`${this.url}/CreateVectorBucket`,{vectorBucketName:e},{headers:this.headers}))||{},error:null}}catch(t){if(this.shouldThrowOnError)throw t;if((0,Zn.isStorageVectorsError)(t))return{data:null,error:t};throw t}})}getBucket(e){return Yn.__awaiter(this,void 0,void 0,function*(){try{return{data:yield(0,eo.post)(this.fetch,`${this.url}/GetVectorBucket`,{vectorBucketName:e},{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if((0,Zn.isStorageVectorsError)(t))return{data:null,error:t};throw t}})}listBuckets(){return Yn.__awaiter(this,arguments,void 0,function*(e={}){try{return{data:yield(0,eo.post)(this.fetch,`${this.url}/ListVectorBuckets`,e,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if((0,Zn.isStorageVectorsError)(t))return{data:null,error:t};throw t}})}deleteBucket(e){return Yn.__awaiter(this,void 0,void 0,function*(){try{return{data:(yield(0,eo.post)(this.fetch,`${this.url}/DeleteVectorBucket`,{vectorBucketName:e},{headers:this.headers}))||{},error:null}}catch(t){if(this.shouldThrowOnError)throw t;if((0,Zn.isStorageVectorsError)(t))return{data:null,error:t};throw t}})}};wd.default=yd});var Cg=R(Zt=>{"use strict";Object.defineProperty(Zt,"__esModule",{value:!0});Zt.VectorIndexScope=Zt.VectorBucketScope=Zt.StorageVectorsClient=void 0;var Ie=(Q(),X(W)),Bv=Ie.__importDefault(fd()),Fv=Ie.__importDefault(gd()),Vv=Ie.__importDefault(bd()),_d=class extends Vv.default{constructor(e,t={}){super(e,t.headers||{},t.fetch)}from(e){return new to(this.url,this.headers,e,this.fetch)}createBucket(e){let t=Object.create(null,{createBucket:{get:()=>super.createBucket}});return Ie.__awaiter(this,void 0,void 0,function*(){return t.createBucket.call(this,e)})}getBucket(e){let t=Object.create(null,{getBucket:{get:()=>super.getBucket}});return Ie.__awaiter(this,void 0,void 0,function*(){return t.getBucket.call(this,e)})}listBuckets(){let e=Object.create(null,{listBuckets:{get:()=>super.listBuckets}});return Ie.__awaiter(this,arguments,void 0,function*(t={}){return e.listBuckets.call(this,t)})}deleteBucket(e){let t=Object.create(null,{deleteBucket:{get:()=>super.deleteBucket}});return Ie.__awaiter(this,void 0,void 0,function*(){return t.deleteBucket.call(this,e)})}};Zt.StorageVectorsClient=_d;var to=class extends Bv.default{constructor(e,t,r,i){super(e,t,i),this.vectorBucketName=r}createIndex(e){let t=Object.create(null,{createIndex:{get:()=>super.createIndex}});return Ie.__awaiter(this,void 0,void 0,function*(){return t.createIndex.call(this,Object.assign(Object.assign({},e),{vectorBucketName:this.vectorBucketName}))})}listIndexes(){let e=Object.create(null,{listIndexes:{get:()=>super.listIndexes}});return Ie.__awaiter(this,arguments,void 0,function*(t={}){return e.listIndexes.call(this,Object.assign(Object.assign({},t),{vectorBucketName:this.vectorBucketName}))})}getIndex(e){let t=Object.create(null,{getIndex:{get:()=>super.getIndex}});return Ie.__awaiter(this,void 0,void 0,function*(){return t.getIndex.call(this,this.vectorBucketName,e)})}deleteIndex(e){let t=Object.create(null,{deleteIndex:{get:()=>super.deleteIndex}});return Ie.__awaiter(this,void 0,void 0,function*(){return t.deleteIndex.call(this,this.vectorBucketName,e)})}index(e){return new ro(this.url,this.headers,this.vectorBucketName,e,this.fetch)}};Zt.VectorBucketScope=to;var ro=class extends Fv.default{constructor(e,t,r,i,n){super(e,t,n),this.vectorBucketName=r,this.indexName=i}putVectors(e){let t=Object.create(null,{putVectors:{get:()=>super.putVectors}});return Ie.__awaiter(this,void 0,void 0,function*(){return t.putVectors.call(this,Object.assign(Object.assign({},e),{vectorBucketName:this.vectorBucketName,indexName:this.indexName}))})}getVectors(e){let t=Object.create(null,{getVectors:{get:()=>super.getVectors}});return Ie.__awaiter(this,void 0,void 0,function*(){return t.getVectors.call(this,Object.assign(Object.assign({},e),{vectorBucketName:this.vectorBucketName,indexName:this.indexName}))})}listVectors(){let e=Object.create(null,{listVectors:{get:()=>super.listVectors}});return Ie.__awaiter(this,arguments,void 0,function*(t={}){return e.listVectors.call(this,Object.assign(Object.assign({},t),{vectorBucketName:this.vectorBucketName,indexName:this.indexName}))})}queryVectors(e){let t=Object.create(null,{queryVectors:{get:()=>super.queryVectors}});return Ie.__awaiter(this,void 0,void 0,function*(){return t.queryVectors.call(this,Object.assign(Object.assign({},e),{vectorBucketName:this.vectorBucketName,indexName:this.indexName}))})}deleteVectors(e){let t=Object.create(null,{deleteVectors:{get:()=>super.deleteVectors}});return Ie.__awaiter(this,void 0,void 0,function*(){return t.deleteVectors.call(this,Object.assign(Object.assign({},e),{vectorBucketName:this.vectorBucketName,indexName:this.indexName}))})}};Zt.VectorIndexScope=ro});var Ed=R(z=>{"use strict";Object.defineProperty(z,"__esModule",{value:!0});z.validateVectorDimension=z.normalizeToFloat32=z.isPlainObject=z.resolveResponse=z.resolveFetch=z.isStorageVectorsError=z.StorageVectorsErrorCode=z.StorageVectorsUnknownError=z.StorageVectorsApiError=z.StorageVectorsError=z.VectorDataApi=z.VectorIndexApi=z.VectorBucketApi=z.VectorIndexScope=z.VectorBucketScope=z.StorageVectorsClient=void 0;var vd=(Q(),X(W)),Sd=Cg();Object.defineProperty(z,"StorageVectorsClient",{enumerable:!0,get:function(){return Sd.StorageVectorsClient}});Object.defineProperty(z,"VectorBucketScope",{enumerable:!0,get:function(){return Sd.VectorBucketScope}});Object.defineProperty(z,"VectorIndexScope",{enumerable:!0,get:function(){return Sd.VectorIndexScope}});var Hv=bd();Object.defineProperty(z,"VectorBucketApi",{enumerable:!0,get:function(){return vd.__importDefault(Hv).default}});var Kv=fd();Object.defineProperty(z,"VectorIndexApi",{enumerable:!0,get:function(){return vd.__importDefault(Kv).default}});var zv=gd();Object.defineProperty(z,"VectorDataApi",{enumerable:!0,get:function(){return vd.__importDefault(zv).default}});var hi=Qr();Object.defineProperty(z,"StorageVectorsError",{enumerable:!0,get:function(){return hi.StorageVectorsError}});Object.defineProperty(z,"StorageVectorsApiError",{enumerable:!0,get:function(){return hi.StorageVectorsApiError}});Object.defineProperty(z,"StorageVectorsUnknownError",{enumerable:!0,get:function(){return hi.StorageVectorsUnknownError}});Object.defineProperty(z,"StorageVectorsErrorCode",{enumerable:!0,get:function(){return hi.StorageVectorsErrorCode}});Object.defineProperty(z,"isStorageVectorsError",{enumerable:!0,get:function(){return hi.isStorageVectorsError}});var fi=Jr();Object.defineProperty(z,"resolveFetch",{enumerable:!0,get:function(){return fi.resolveFetch}});Object.defineProperty(z,"resolveResponse",{enumerable:!0,get:function(){return fi.resolveResponse}});Object.defineProperty(z,"isPlainObject",{enumerable:!0,get:function(){return fi.isPlainObject}});Object.defineProperty(z,"normalizeToFloat32",{enumerable:!0,get:function(){return fi.normalizeToFloat32}});Object.defineProperty(z,"validateVectorDimension",{enumerable:!0,get:function(){return fi.validateVectorDimension}})});var Rg=R(so=>{"use strict";Object.defineProperty(so,"__esModule",{value:!0});so.StorageClient=void 0;var Ad=(Q(),X(W)),Wv=Ad.__importDefault(Eg()),Qv=Ad.__importDefault(Tg()),Jv=Ad.__importDefault(ld()),Gv=Ed(),Td=class extends Qv.default{constructor(e,t={},r,i){super(e,t,r,i)}from(e){return new Wv.default(this.url,this.headers,e,this.fetch)}get vectors(){return new Gv.StorageVectorsClient(this.url+"/vector",{headers:this.headers,fetch:this.fetch})}get analytics(){return new Jv.default(this.url+"/iceberg",this.headers,this.fetch)}};so.StorageClient=Td});var Ng=R(Og=>{"use strict";Object.defineProperty(Og,"__esModule",{value:!0})});var $g=R(qt=>{"use strict";Object.defineProperty(qt,"__esModule",{value:!0});qt.StorageAnalyticsClient=qt.StorageClient=void 0;var io=(Q(),X(W)),Xv=Rg();Object.defineProperty(qt,"StorageClient",{enumerable:!0,get:function(){return Xv.StorageClient}});var Yv=ld();Object.defineProperty(qt,"StorageAnalyticsClient",{enumerable:!0,get:function(){return io.__importDefault(Yv).default}});io.__exportStar(Ng(),qt);io.__exportStar(Yt(),qt);io.__exportStar(Ed(),qt)});var Ig=R(no=>{"use strict";Object.defineProperty(no,"__esModule",{value:!0});no.version=void 0;no.version="2.86.0"});var Mg=R(Xe=>{"use strict";Object.defineProperty(Xe,"__esModule",{value:!0});Xe.DEFAULT_REALTIME_OPTIONS=Xe.DEFAULT_AUTH_OPTIONS=Xe.DEFAULT_DB_OPTIONS=Xe.DEFAULT_GLOBAL_OPTIONS=Xe.DEFAULT_HEADERS=void 0;var Zv=Ig(),pi="";typeof Deno<"u"?pi="deno":typeof document<"u"?pi="web":typeof navigator<"u"&&navigator.product==="ReactNative"?pi="react-native":pi="node";Xe.DEFAULT_HEADERS={"X-Client-Info":`supabase-js-${pi}/${Zv.version}`};Xe.DEFAULT_GLOBAL_OPTIONS={headers:Xe.DEFAULT_HEADERS};Xe.DEFAULT_DB_OPTIONS={schema:"public"};Xe.DEFAULT_AUTH_OPTIONS={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"};Xe.DEFAULT_REALTIME_OPTIONS={}});var Dg=R(vt=>{"use strict";Object.defineProperty(vt,"__esModule",{value:!0});vt.fetchWithAuth=vt.resolveHeadersConstructor=vt.resolveFetch=void 0;var e0=s=>s?(...e)=>s(...e):(...e)=>fetch(...e);vt.resolveFetch=e0;var t0=()=>Headers;vt.resolveHeadersConstructor=t0;var r0=(s,e,t)=>{let r=(0,vt.resolveFetch)(t),i=(0,vt.resolveHeadersConstructor)();return async(n,o)=>{var a;let l=(a=await e())!==null&&a!==void 0?a:s,c=new i(o?.headers);return c.has("apikey")||c.set("apikey",s),c.has("Authorization")||c.set("Authorization",`Bearer ${l}`),r(n,Object.assign(Object.assign({},o),{headers:c}))}};vt.fetchWithAuth=r0});var Lg=R(er=>{"use strict";Object.defineProperty(er,"__esModule",{value:!0});er.isBrowser=void 0;er.uuid=s0;er.ensureTrailingSlash=jg;er.applySettingDefaults=n0;er.validateSupabaseUrl=o0;function s0(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(s){var e=Math.random()*16|0,t=s=="x"?e:e&3|8;return t.toString(16)})}function jg(s){return s.endsWith("/")?s:s+"/"}var i0=()=>typeof window<"u";er.isBrowser=i0;function n0(s,e){var t,r;let{db:i,auth:n,realtime:o,global:a}=s,{db:l,auth:c,realtime:u,global:f}=e,d={db:Object.assign(Object.assign({},l),i),auth:Object.assign(Object.assign({},c),n),realtime:Object.assign(Object.assign({},u),o),storage:{},global:Object.assign(Object.assign(Object.assign({},f),a),{headers:Object.assign(Object.assign({},(t=f?.headers)!==null&&t!==void 0?t:{}),(r=a?.headers)!==null&&r!==void 0?r:{})}),accessToken:async()=>""};return s.accessToken?d.accessToken=s.accessToken:delete d.accessToken,d}function o0(s){let e=s?.trim();if(!e)throw new Error("supabaseUrl is required.");if(!e.match(/^https?:\/\//i))throw new Error("Invalid supabaseUrl: Must be a valid HTTP or HTTPS URL.");try{return new URL(jg(e))}catch{throw Error("Invalid supabaseUrl: Provided URL is malformed.")}}});var kd=R(oo=>{"use strict";Object.defineProperty(oo,"__esModule",{value:!0});oo.version=void 0;oo.version="2.86.0"});var ao=R(ie=>{"use strict";Object.defineProperty(ie,"__esModule",{value:!0});ie.JWKS_TTL=ie.BASE64URL_REGEX=ie.API_VERSIONS=ie.API_VERSION_HEADER_NAME=ie.NETWORK_FAILURE=ie.DEFAULT_HEADERS=ie.AUDIENCE=ie.STORAGE_KEY=ie.GOTRUE_URL=ie.EXPIRY_MARGIN_MS=ie.AUTO_REFRESH_TICK_THRESHOLD=ie.AUTO_REFRESH_TICK_DURATION_MS=void 0;var a0=kd();ie.AUTO_REFRESH_TICK_DURATION_MS=30*1e3;ie.AUTO_REFRESH_TICK_THRESHOLD=3;ie.EXPIRY_MARGIN_MS=ie.AUTO_REFRESH_TICK_THRESHOLD*ie.AUTO_REFRESH_TICK_DURATION_MS;ie.GOTRUE_URL="http://localhost:9999";ie.STORAGE_KEY="supabase.auth.token";ie.AUDIENCE="";ie.DEFAULT_HEADERS={"X-Client-Info":`gotrue-js/${a0.version}`};ie.NETWORK_FAILURE={MAX_RETRIES:10,RETRY_INTERVAL:2};ie.API_VERSION_HEADER_NAME="X-Supabase-Api-Version";ie.API_VERSIONS={"2024-01-01":{timestamp:Date.parse("2024-01-01T00:00:00.0Z"),name:"2024-01-01"}};ie.BASE64URL_REGEX=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}$|[a-z0-9_-]{2}$)$/i;ie.JWKS_TTL=600*1e3});var gr=R(J=>{"use strict";Object.defineProperty(J,"__esModule",{value:!0});J.AuthInvalidJwtError=J.AuthWeakPasswordError=J.AuthRetryableFetchError=J.AuthPKCEGrantCodeExchangeError=J.AuthImplicitGrantRedirectError=J.AuthInvalidCredentialsError=J.AuthInvalidTokenResponseError=J.AuthSessionMissingError=J.CustomAuthError=J.AuthUnknownError=J.AuthApiError=J.AuthError=void 0;J.isAuthError=Zr;J.isAuthApiError=l0;J.isAuthSessionMissingError=c0;J.isAuthImplicitGrantRedirectError=u0;J.isAuthRetryableFetchError=d0;J.isAuthWeakPasswordError=h0;var Yr=class extends Error{constructor(e,t,r){super(e),this.__isAuthError=!0,this.name="AuthError",this.status=t,this.code=r}};J.AuthError=Yr;function Zr(s){return typeof s=="object"&&s!==null&&"__isAuthError"in s}var Pd=class extends Yr{constructor(e,t,r){super(e,t,r),this.name="AuthApiError",this.status=t,this.code=r}};J.AuthApiError=Pd;function l0(s){return Zr(s)&&s.name==="AuthApiError"}var xd=class extends Yr{constructor(e,t){super(e),this.name="AuthUnknownError",this.originalError=t}};J.AuthUnknownError=xd;var gt=class extends Yr{constructor(e,t,r,i){super(e,r,i),this.name=t,this.status=r}};J.CustomAuthError=gt;var Cd=class extends gt{constructor(){super("Auth session missing!","AuthSessionMissingError",400,void 0)}};J.AuthSessionMissingError=Cd;function c0(s){return Zr(s)&&s.name==="AuthSessionMissingError"}var Rd=class extends gt{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500,void 0)}};J.AuthInvalidTokenResponseError=Rd;var Od=class extends gt{constructor(e){super(e,"AuthInvalidCredentialsError",400,void 0)}};J.AuthInvalidCredentialsError=Od;var Nd=class extends gt{constructor(e,t=null){super(e,"AuthImplicitGrantRedirectError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}};J.AuthImplicitGrantRedirectError=Nd;function u0(s){return Zr(s)&&s.name==="AuthImplicitGrantRedirectError"}var $d=class extends gt{constructor(e,t=null){super(e,"AuthPKCEGrantCodeExchangeError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}};J.AuthPKCEGrantCodeExchangeError=$d;var Id=class extends gt{constructor(e,t){super(e,"AuthRetryableFetchError",t,void 0)}};J.AuthRetryableFetchError=Id;function d0(s){return Zr(s)&&s.name==="AuthRetryableFetchError"}var Md=class extends gt{constructor(e,t,r){super(e,"AuthWeakPasswordError",t,"weak_password"),this.reasons=r}};J.AuthWeakPasswordError=Md;function h0(s){return Zr(s)&&s.name==="AuthWeakPasswordError"}var Dd=class extends gt{constructor(e){super(e,"AuthInvalidJwtError",400,"invalid_jwt")}};J.AuthInvalidJwtError=Dd});var co=R(nt=>{"use strict";Object.defineProperty(nt,"__esModule",{value:!0});nt.byteToBase64URL=mi;nt.byteFromBase64URL=jd;nt.stringToBase64URL=p0;nt.stringFromBase64URL=m0;nt.codepointToUTF8=Ug;nt.stringToUTF8=Ld;nt.stringFromUTF8=Bg;nt.base64UrlToUint8Array=g0;nt.stringToUint8Array=y0;nt.bytesToBase64URL=w0;var lo="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".split(""),qg=` 	
\r=`.split(""),f0=(()=>{let s=new Array(128);for(let e=0;e<s.length;e+=1)s[e]=-1;for(let e=0;e<qg.length;e+=1)s[qg[e].charCodeAt(0)]=-2;for(let e=0;e<lo.length;e+=1)s[lo[e].charCodeAt(0)]=e;return s})();function mi(s,e,t){if(s!==null)for(e.queue=e.queue<<8|s,e.queuedBits+=8;e.queuedBits>=6;){let r=e.queue>>e.queuedBits-6&63;t(lo[r]),e.queuedBits-=6}else if(e.queuedBits>0)for(e.queue=e.queue<<6-e.queuedBits,e.queuedBits=6;e.queuedBits>=6;){let r=e.queue>>e.queuedBits-6&63;t(lo[r]),e.queuedBits-=6}}function jd(s,e,t){let r=f0[s];if(r>-1)for(e.queue=e.queue<<6|r,e.queuedBits+=6;e.queuedBits>=8;)t(e.queue>>e.queuedBits-8&255),e.queuedBits-=8;else{if(r===-2)return;throw new Error(`Invalid Base64-URL character "${String.fromCharCode(s)}"`)}}function p0(s){let e=[],t=i=>{e.push(i)},r={queue:0,queuedBits:0};return Ld(s,i=>{mi(i,r,t)}),mi(null,r,t),e.join("")}function m0(s){let e=[],t=o=>{e.push(String.fromCodePoint(o))},r={utf8seq:0,codepoint:0},i={queue:0,queuedBits:0},n=o=>{Bg(o,r,t)};for(let o=0;o<s.length;o+=1)jd(s.charCodeAt(o),i,n);return e.join("")}function Ug(s,e){if(s<=127){e(s);return}else if(s<=2047){e(192|s>>6),e(128|s&63);return}else if(s<=65535){e(224|s>>12),e(128|s>>6&63),e(128|s&63);return}else if(s<=1114111){e(240|s>>18),e(128|s>>12&63),e(128|s>>6&63),e(128|s&63);return}throw new Error(`Unrecognized Unicode codepoint: ${s.toString(16)}`)}function Ld(s,e){for(let t=0;t<s.length;t+=1){let r=s.charCodeAt(t);if(r>55295&&r<=56319){let i=(r-55296)*1024&65535;r=(s.charCodeAt(t+1)-56320&65535|i)+65536,t+=1}Ug(r,e)}}function Bg(s,e,t){if(e.utf8seq===0){if(s<=127){t(s);return}for(let r=1;r<6;r+=1)if((s>>7-r&1)===0){e.utf8seq=r;break}if(e.utf8seq===2)e.codepoint=s&31;else if(e.utf8seq===3)e.codepoint=s&15;else if(e.utf8seq===4)e.codepoint=s&7;else throw new Error("Invalid UTF-8 sequence");e.utf8seq-=1}else if(e.utf8seq>0){if(s<=127)throw new Error("Invalid UTF-8 sequence");e.codepoint=e.codepoint<<6|s&63,e.utf8seq-=1,e.utf8seq===0&&t(e.codepoint)}}function g0(s){let e=[],t={queue:0,queuedBits:0},r=i=>{e.push(i)};for(let i=0;i<s.length;i+=1)jd(s.charCodeAt(i),t,r);return new Uint8Array(e)}function y0(s){let e=[];return Ld(s,t=>e.push(t)),new Uint8Array(e)}function w0(s){let e=[],t={queue:0,queuedBits:0},r=i=>{e.push(i)};return s.forEach(i=>mi(i,t,r)),mi(null,t,r),e.join("")}});var es=R(V=>{"use strict";Object.defineProperty(V,"__esModule",{value:!0});V.Deferred=V.removeItemAsync=V.getItemAsync=V.setItemAsync=V.looksLikeFetchResponse=V.resolveFetch=V.supportsLocalStorage=V.isBrowser=void 0;V.expiresAt=b0;V.generateCallbackId=_0;V.parseParametersFromURL=E0;V.decodeJWT=C0;V.sleep=R0;V.retryable=O0;V.generatePKCEVerifier=Hg;V.generatePKCEChallenge=Kg;V.getCodeChallengeAndMethod=I0;V.parseResponseAPIVersion=D0;V.validateExp=j0;V.getAlgorithm=L0;V.validateUUID=U0;V.userNotAvailableProxy=B0;V.insecureUserWarningProxy=F0;V.deepClone=V0;var Vg=ao(),Fg=gr(),qd=co();function b0(s){return Math.round(Date.now()/1e3)+s}function _0(){return Symbol("auth-callback")}var v0=()=>typeof window<"u"&&typeof document<"u";V.isBrowser=v0;var yr={tested:!1,writable:!1},S0=()=>{if(!(0,V.isBrowser)())return!1;try{if(typeof globalThis.localStorage!="object")return!1}catch{return!1}if(yr.tested)return yr.writable;let s=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(s,s),globalThis.localStorage.removeItem(s),yr.tested=!0,yr.writable=!0}catch{yr.tested=!0,yr.writable=!1}return yr.writable};V.supportsLocalStorage=S0;function E0(s){let e={},t=new URL(s);if(t.hash&&t.hash[0]==="#")try{new URLSearchParams(t.hash.substring(1)).forEach((i,n)=>{e[n]=i})}catch{}return t.searchParams.forEach((r,i)=>{e[i]=r}),e}var T0=s=>s?(...e)=>s(...e):(...e)=>fetch(...e);V.resolveFetch=T0;var A0=s=>typeof s=="object"&&s!==null&&"status"in s&&"ok"in s&&"json"in s&&typeof s.json=="function";V.looksLikeFetchResponse=A0;var k0=async(s,e,t)=>{await s.setItem(e,JSON.stringify(t))};V.setItemAsync=k0;var P0=async(s,e)=>{let t=await s.getItem(e);if(!t)return null;try{return JSON.parse(t)}catch{return t}};V.getItemAsync=P0;var x0=async(s,e)=>{await s.removeItem(e)};V.removeItemAsync=x0;var uo=class s{constructor(){this.promise=new s.promiseConstructor((e,t)=>{this.resolve=e,this.reject=t})}};V.Deferred=uo;uo.promiseConstructor=Promise;function C0(s){let e=s.split(".");if(e.length!==3)throw new Fg.AuthInvalidJwtError("Invalid JWT structure");for(let r=0;r<e.length;r++)if(!Vg.BASE64URL_REGEX.test(e[r]))throw new Fg.AuthInvalidJwtError("JWT not in base64url format");return{header:JSON.parse((0,qd.stringFromBase64URL)(e[0])),payload:JSON.parse((0,qd.stringFromBase64URL)(e[1])),signature:(0,qd.base64UrlToUint8Array)(e[2]),raw:{header:e[0],payload:e[1]}}}async function R0(s){return await new Promise(e=>{setTimeout(()=>e(null),s)})}function O0(s,e){return new Promise((r,i)=>{(async()=>{for(let n=0;n<1/0;n++)try{let o=await s(n);if(!e(n,null,o)){r(o);return}}catch(o){if(!e(n,o)){i(o);return}}})()})}function N0(s){return("0"+s.toString(16)).substr(-2)}function Hg(){let e=new Uint32Array(56);if(typeof crypto>"u"){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",r=t.length,i="";for(let n=0;n<56;n++)i+=t.charAt(Math.floor(Math.random()*r));return i}return crypto.getRandomValues(e),Array.from(e,N0).join("")}async function $0(s){let t=new TextEncoder().encode(s),r=await crypto.subtle.digest("SHA-256",t),i=new Uint8Array(r);return Array.from(i).map(n=>String.fromCharCode(n)).join("")}async function Kg(s){if(!(typeof crypto<"u"&&typeof crypto.subtle<"u"&&typeof TextEncoder<"u"))return console.warn("WebCrypto API is not supported. Code challenge method will default to use plain instead of sha256."),s;let t=await $0(s);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function I0(s,e,t=!1){let r=Hg(),i=r;t&&(i+="/PASSWORD_RECOVERY"),await(0,V.setItemAsync)(s,`${e}-code-verifier`,i);let n=await Kg(r);return[n,r===n?"plain":"s256"]}var M0=/^2[0-9]{3}-(0[1-9]|1[0-2])-(0[1-9]|1[0-9]|2[0-9]|3[0-1])$/i;function D0(s){let e=s.headers.get(Vg.API_VERSION_HEADER_NAME);if(!e||!e.match(M0))return null;try{return new Date(`${e}T00:00:00.0Z`)}catch{return null}}function j0(s){if(!s)throw new Error("Missing exp claim");let e=Math.floor(Date.now()/1e3);if(s<=e)throw new Error("JWT has expired")}function L0(s){switch(s){case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"ES256":return{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}};default:throw new Error("Invalid alg claim")}}var q0=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;function U0(s){if(!q0.test(s))throw new Error("@supabase/auth-js: Expected parameter to be UUID but is not")}function B0(){let s={};return new Proxy(s,{get:(e,t)=>{if(t==="__isUserNotAvailableProxy")return!0;if(typeof t=="symbol"){let r=t.toString();if(r==="Symbol(Symbol.toPrimitive)"||r==="Symbol(Symbol.toStringTag)"||r==="Symbol(util.inspect.custom)")return}throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Accessing the "${t}" property of the session object is not supported. Please use getUser() instead.`)},set:(e,t)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Setting the "${t}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)},deleteProperty:(e,t)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Deleting the "${t}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)}})}function F0(s,e){return new Proxy(s,{get:(t,r,i)=>{if(r==="__isInsecureUserWarningProxy")return!0;if(typeof r=="symbol"){let n=r.toString();if(n==="Symbol(Symbol.toPrimitive)"||n==="Symbol(Symbol.toStringTag)"||n==="Symbol(util.inspect.custom)"||n==="Symbol(nodejs.util.inspect.custom)")return Reflect.get(t,r,i)}return!e.value&&typeof r=="string"&&(console.warn("Using the user object as returned from supabase.auth.getSession() or from some supabase.auth.onAuthStateChange() events could be insecure! This value comes directly from the storage medium (usually cookies on the server) and may not be authentic. Use supabase.auth.getUser() instead which authenticates the data by contacting the Supabase Auth server."),e.value=!0),Reflect.get(t,r,i)}})}function V0(s){return JSON.parse(JSON.stringify(s))}});var Fd=R(St=>{"use strict";Object.defineProperty(St,"__esModule",{value:!0});St.handleError=Bd;St._request=W0;St._sessionResponse=zg;St._sessionResponsePassword=J0;St._userResponse=G0;St._ssoResponse=X0;St._generateLinkResponse=Y0;St._noResolveJsonResponse=Z0;var H0=(Q(),X(W)),ho=ao(),Ud=es(),tr=gr(),wr=s=>s.msg||s.message||s.error_description||s.error||JSON.stringify(s),K0=[502,503,504];async function Bd(s){var e;if(!(0,Ud.looksLikeFetchResponse)(s))throw new tr.AuthRetryableFetchError(wr(s),0);if(K0.includes(s.status))throw new tr.AuthRetryableFetchError(wr(s),s.status);let t;try{t=await s.json()}catch(n){throw new tr.AuthUnknownError(wr(n),n)}let r,i=(0,Ud.parseResponseAPIVersion)(s);if(i&&i.getTime()>=ho.API_VERSIONS["2024-01-01"].timestamp&&typeof t=="object"&&t&&typeof t.code=="string"?r=t.code:typeof t=="object"&&t&&typeof t.error_code=="string"&&(r=t.error_code),r){if(r==="weak_password")throw new tr.AuthWeakPasswordError(wr(t),s.status,((e=t.weak_password)===null||e===void 0?void 0:e.reasons)||[]);if(r==="session_not_found")throw new tr.AuthSessionMissingError}else if(typeof t=="object"&&t&&typeof t.weak_password=="object"&&t.weak_password&&Array.isArray(t.weak_password.reasons)&&t.weak_password.reasons.length&&t.weak_password.reasons.reduce((n,o)=>n&&typeof o=="string",!0))throw new tr.AuthWeakPasswordError(wr(t),s.status,t.weak_password.reasons);throw new tr.AuthApiError(wr(t),s.status||500,r)}var z0=(s,e,t,r)=>{let i={method:s,headers:e?.headers||{}};return s==="GET"?i:(i.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},e?.headers),i.body=JSON.stringify(r),Object.assign(Object.assign({},i),t))};async function W0(s,e,t,r){var i;let n=Object.assign({},r?.headers);n[ho.API_VERSION_HEADER_NAME]||(n[ho.API_VERSION_HEADER_NAME]=ho.API_VERSIONS["2024-01-01"].name),r?.jwt&&(n.Authorization=`Bearer ${r.jwt}`);let o=(i=r?.query)!==null&&i!==void 0?i:{};r?.redirectTo&&(o.redirect_to=r.redirectTo);let a=Object.keys(o).length?"?"+new URLSearchParams(o).toString():"",l=await Q0(s,e,t+a,{headers:n,noResolveJson:r?.noResolveJson},{},r?.body);return r?.xform?r?.xform(l):{data:Object.assign({},l),error:null}}async function Q0(s,e,t,r,i,n){let o=z0(e,r,i,n),a;try{a=await s(t,Object.assign({},o))}catch(l){throw console.error(l),new tr.AuthRetryableFetchError(wr(l),0)}if(a.ok||await Bd(a),r?.noResolveJson)return a;try{return await a.json()}catch(l){await Bd(l)}}function zg(s){var e;let t=null;eS(s)&&(t=Object.assign({},s),s.expires_at||(t.expires_at=(0,Ud.expiresAt)(s.expires_in)));let r=(e=s.user)!==null&&e!==void 0?e:s;return{data:{session:t,user:r},error:null}}function J0(s){let e=zg(s);return!e.error&&s.weak_password&&typeof s.weak_password=="object"&&Array.isArray(s.weak_password.reasons)&&s.weak_password.reasons.length&&s.weak_password.message&&typeof s.weak_password.message=="string"&&s.weak_password.reasons.reduce((t,r)=>t&&typeof r=="string",!0)&&(e.data.weak_password=s.weak_password),e}function G0(s){var e;return{data:{user:(e=s.user)!==null&&e!==void 0?e:s},error:null}}function X0(s){return{data:s,error:null}}function Y0(s){let{action_link:e,email_otp:t,hashed_token:r,redirect_to:i,verification_type:n}=s,o=H0.__rest(s,["action_link","email_otp","hashed_token","redirect_to","verification_type"]),a={action_link:e,email_otp:t,hashed_token:r,redirect_to:i,verification_type:n},l=Object.assign({},o);return{data:{properties:a,user:l},error:null}}function Z0(s){return s}function eS(s){return s.access_token&&s.refresh_token&&s.expires_in}});var Vd=R(fo=>{"use strict";Object.defineProperty(fo,"__esModule",{value:!0});fo.SIGN_OUT_SCOPES=void 0;fo.SIGN_OUT_SCOPES=["global","local","others"]});var po=R(zd=>{"use strict";Object.defineProperty(zd,"__esModule",{value:!0});var tS=(Q(),X(W)),fe=Fd(),br=es(),Hd=Vd(),Me=gr(),Kd=class{constructor({url:e="",headers:t={},fetch:r}){this.url=e,this.headers=t,this.fetch=(0,br.resolveFetch)(r),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)},this.oauth={listClients:this._listOAuthClients.bind(this),createClient:this._createOAuthClient.bind(this),getClient:this._getOAuthClient.bind(this),updateClient:this._updateOAuthClient.bind(this),deleteClient:this._deleteOAuthClient.bind(this),regenerateClientSecret:this._regenerateOAuthClientSecret.bind(this)}}async signOut(e,t=Hd.SIGN_OUT_SCOPES[0]){if(Hd.SIGN_OUT_SCOPES.indexOf(t)<0)throw new Error(`@supabase/auth-js: Parameter scope must be one of ${Hd.SIGN_OUT_SCOPES.join(", ")}`);try{return await(0,fe._request)(this.fetch,"POST",`${this.url}/logout?scope=${t}`,{headers:this.headers,jwt:e,noResolveJson:!0}),{data:null,error:null}}catch(r){if((0,Me.isAuthError)(r))return{data:null,error:r};throw r}}async inviteUserByEmail(e,t={}){try{return await(0,fe._request)(this.fetch,"POST",`${this.url}/invite`,{body:{email:e,data:t.data},headers:this.headers,redirectTo:t.redirectTo,xform:fe._userResponse})}catch(r){if((0,Me.isAuthError)(r))return{data:{user:null},error:r};throw r}}async generateLink(e){try{let{options:t}=e,r=tS.__rest(e,["options"]),i=Object.assign(Object.assign({},r),t);return"newEmail"in r&&(i.new_email=r?.newEmail,delete i.newEmail),await(0,fe._request)(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:i,headers:this.headers,xform:fe._generateLinkResponse,redirectTo:t?.redirectTo})}catch(t){if((0,Me.isAuthError)(t))return{data:{properties:null,user:null},error:t};throw t}}async createUser(e){try{return await(0,fe._request)(this.fetch,"POST",`${this.url}/admin/users`,{body:e,headers:this.headers,xform:fe._userResponse})}catch(t){if((0,Me.isAuthError)(t))return{data:{user:null},error:t};throw t}}async listUsers(e){var t,r,i,n,o,a,l;try{let c={nextPage:null,lastPage:0,total:0},u=await(0,fe._request)(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:(r=(t=e?.page)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:"",per_page:(n=(i=e?.perPage)===null||i===void 0?void 0:i.toString())!==null&&n!==void 0?n:""},xform:fe._noResolveJsonResponse});if(u.error)throw u.error;let f=await u.json(),d=(o=u.headers.get("x-total-count"))!==null&&o!==void 0?o:0,h=(l=(a=u.headers.get("link"))===null||a===void 0?void 0:a.split(","))!==null&&l!==void 0?l:[];return h.length>0&&(h.forEach(g=>{let y=parseInt(g.split(";")[0].split("=")[1].substring(0,1)),_=JSON.parse(g.split(";")[1].split("=")[1]);c[`${_}Page`]=y}),c.total=parseInt(d)),{data:Object.assign(Object.assign({},f),c),error:null}}catch(c){if((0,Me.isAuthError)(c))return{data:{users:[]},error:c};throw c}}async getUserById(e){(0,br.validateUUID)(e);try{return await(0,fe._request)(this.fetch,"GET",`${this.url}/admin/users/${e}`,{headers:this.headers,xform:fe._userResponse})}catch(t){if((0,Me.isAuthError)(t))return{data:{user:null},error:t};throw t}}async updateUserById(e,t){(0,br.validateUUID)(e);try{return await(0,fe._request)(this.fetch,"PUT",`${this.url}/admin/users/${e}`,{body:t,headers:this.headers,xform:fe._userResponse})}catch(r){if((0,Me.isAuthError)(r))return{data:{user:null},error:r};throw r}}async deleteUser(e,t=!1){(0,br.validateUUID)(e);try{return await(0,fe._request)(this.fetch,"DELETE",`${this.url}/admin/users/${e}`,{headers:this.headers,body:{should_soft_delete:t},xform:fe._userResponse})}catch(r){if((0,Me.isAuthError)(r))return{data:{user:null},error:r};throw r}}async _listFactors(e){(0,br.validateUUID)(e.userId);try{let{data:t,error:r}=await(0,fe._request)(this.fetch,"GET",`${this.url}/admin/users/${e.userId}/factors`,{headers:this.headers,xform:i=>({data:{factors:i},error:null})});return{data:t,error:r}}catch(t){if((0,Me.isAuthError)(t))return{data:null,error:t};throw t}}async _deleteFactor(e){(0,br.validateUUID)(e.userId),(0,br.validateUUID)(e.id);try{return{data:await(0,fe._request)(this.fetch,"DELETE",`${this.url}/admin/users/${e.userId}/factors/${e.id}`,{headers:this.headers}),error:null}}catch(t){if((0,Me.isAuthError)(t))return{data:null,error:t};throw t}}async _listOAuthClients(e){var t,r,i,n,o,a,l;try{let c={nextPage:null,lastPage:0,total:0},u=await(0,fe._request)(this.fetch,"GET",`${this.url}/admin/oauth/clients`,{headers:this.headers,noResolveJson:!0,query:{page:(r=(t=e?.page)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:"",per_page:(n=(i=e?.perPage)===null||i===void 0?void 0:i.toString())!==null&&n!==void 0?n:""},xform:fe._noResolveJsonResponse});if(u.error)throw u.error;let f=await u.json(),d=(o=u.headers.get("x-total-count"))!==null&&o!==void 0?o:0,h=(l=(a=u.headers.get("link"))===null||a===void 0?void 0:a.split(","))!==null&&l!==void 0?l:[];return h.length>0&&(h.forEach(g=>{let y=parseInt(g.split(";")[0].split("=")[1].substring(0,1)),_=JSON.parse(g.split(";")[1].split("=")[1]);c[`${_}Page`]=y}),c.total=parseInt(d)),{data:Object.assign(Object.assign({},f),c),error:null}}catch(c){if((0,Me.isAuthError)(c))return{data:{clients:[]},error:c};throw c}}async _createOAuthClient(e){try{return await(0,fe._request)(this.fetch,"POST",`${this.url}/admin/oauth/clients`,{body:e,headers:this.headers,xform:t=>({data:t,error:null})})}catch(t){if((0,Me.isAuthError)(t))return{data:null,error:t};throw t}}async _getOAuthClient(e){try{return await(0,fe._request)(this.fetch,"GET",`${this.url}/admin/oauth/clients/${e}`,{headers:this.headers,xform:t=>({data:t,error:null})})}catch(t){if((0,Me.isAuthError)(t))return{data:null,error:t};throw t}}async _updateOAuthClient(e,t){try{return await(0,fe._request)(this.fetch,"PUT",`${this.url}/admin/oauth/clients/${e}`,{body:t,headers:this.headers,xform:r=>({data:r,error:null})})}catch(r){if((0,Me.isAuthError)(r))return{data:null,error:r};throw r}}async _deleteOAuthClient(e){try{return await(0,fe._request)(this.fetch,"DELETE",`${this.url}/admin/oauth/clients/${e}`,{headers:this.headers,noResolveJson:!0}),{data:null,error:null}}catch(t){if((0,Me.isAuthError)(t))return{data:null,error:t};throw t}}async _regenerateOAuthClientSecret(e){try{return await(0,fe._request)(this.fetch,"POST",`${this.url}/admin/oauth/clients/${e}/regenerate_secret`,{headers:this.headers,xform:t=>({data:t,error:null})})}catch(t){if((0,Me.isAuthError)(t))return{data:null,error:t};throw t}}};zd.default=Kd});var Wg=R(Wd=>{"use strict";Object.defineProperty(Wd,"__esModule",{value:!0});Wd.memoryLocalStorageAdapter=rS;function rS(s={}){return{getItem:e=>s[e]||null,setItem:(e,t)=>{s[e]=t},removeItem:e=>{delete s[e]}}}});var Qd=R(xe=>{"use strict";Object.defineProperty(xe,"__esModule",{value:!0});xe.ProcessLockAcquireTimeoutError=xe.NavigatorLockAcquireTimeoutError=xe.LockAcquireTimeoutError=xe.internals=void 0;xe.navigatorLock=iS;xe.processLock=nS;var sS=es();xe.internals={debug:!!(globalThis&&(0,sS.supportsLocalStorage)()&&globalThis.localStorage&&globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug")==="true")};var gi=class extends Error{constructor(e){super(e),this.isAcquireTimeout=!0}};xe.LockAcquireTimeoutError=gi;var mo=class extends gi{};xe.NavigatorLockAcquireTimeoutError=mo;var go=class extends gi{};xe.ProcessLockAcquireTimeoutError=go;async function iS(s,e,t){xe.internals.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquire lock",s,e);let r=new globalThis.AbortController;return e>0&&setTimeout(()=>{r.abort(),xe.internals.debug&&console.log("@supabase/gotrue-js: navigatorLock acquire timed out",s)},e),await Promise.resolve().then(()=>globalThis.navigator.locks.request(s,e===0?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:r.signal},async i=>{if(i){xe.internals.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquired",s,i.name);try{return await t()}finally{xe.internals.debug&&console.log("@supabase/gotrue-js: navigatorLock: released",s,i.name)}}else{if(e===0)throw xe.internals.debug&&console.log("@supabase/gotrue-js: navigatorLock: not immediately available",s),new mo(`Acquiring an exclusive Navigator LockManager lock "${s}" immediately failed`);if(xe.internals.debug)try{let n=await globalThis.navigator.locks.query();console.log("@supabase/gotrue-js: Navigator LockManager state",JSON.stringify(n,null,"  "))}catch(n){console.warn("@supabase/gotrue-js: Error when querying Navigator LockManager state",n)}return console.warn("@supabase/gotrue-js: Navigator LockManager returned a null lock when using #request without ifAvailable set to true, it appears this browser is not following the LockManager spec https://developer.mozilla.org/en-US/docs/Web/API/LockManager/request"),await t()}}))}var Qg={};async function nS(s,e,t){var r;let i=(r=Qg[s])!==null&&r!==void 0?r:Promise.resolve(),n=Promise.race([i.catch(()=>null),e>=0?new Promise((o,a)=>{setTimeout(()=>{a(new go(`Acquring process lock with name "${s}" timed out`))},e)}):null].filter(o=>o)).catch(o=>{if(o&&o.isAcquireTimeout)throw o;return null}).then(async()=>await t());return Qg[s]=n.catch(async o=>{if(o&&o.isAcquireTimeout)return await i,null;throw o}),await n}});var Jg=R(Jd=>{"use strict";Object.defineProperty(Jd,"__esModule",{value:!0});Jd.polyfillGlobalThis=oS;function oS(){if(typeof globalThis!="object")try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch{typeof self<"u"&&(self.globalThis=self)}}});var Xg=R(ts=>{"use strict";Object.defineProperty(ts,"__esModule",{value:!0});ts.getAddress=Gg;ts.fromHex=aS;ts.toHex=lS;ts.createSiweMessage=cS;function Gg(s){if(!/^0x[a-fA-F0-9]{40}$/.test(s))throw new Error(`@supabase/auth-js: Address "${s}" is invalid.`);return s.toLowerCase()}function aS(s){return parseInt(s,16)}function lS(s){let e=new TextEncoder().encode(s);return"0x"+Array.from(e,r=>r.toString(16).padStart(2,"0")).join("")}function cS(s){var e;let{chainId:t,domain:r,expirationTime:i,issuedAt:n=new Date,nonce:o,notBefore:a,requestId:l,resources:c,scheme:u,uri:f,version:d}=s;{if(!Number.isInteger(t))throw new Error(`@supabase/auth-js: Invalid SIWE message field "chainId". Chain ID must be a EIP-155 chain ID. Provided value: ${t}`);if(!r)throw new Error('@supabase/auth-js: Invalid SIWE message field "domain". Domain must be provided.');if(o&&o.length<8)throw new Error(`@supabase/auth-js: Invalid SIWE message field "nonce". Nonce must be at least 8 characters. Provided value: ${o}`);if(!f)throw new Error('@supabase/auth-js: Invalid SIWE message field "uri". URI must be provided.');if(d!=="1")throw new Error(`@supabase/auth-js: Invalid SIWE message field "version". Version must be '1'. Provided value: ${d}`);if(!((e=s.statement)===null||e===void 0)&&e.includes(`
`))throw new Error(`@supabase/auth-js: Invalid SIWE message field "statement". Statement must not include '\\n'. Provided value: ${s.statement}`)}let h=Gg(s.address),g=u?`${u}://${r}`:r,y=s.statement?`${s.statement}
`:"",_=`${g} wants you to sign in with your Ethereum account:
${h}

${y}`,b=`URI: ${f}
Version: ${d}
Chain ID: ${t}${o?`
Nonce: ${o}`:""}
Issued At: ${n.toISOString()}`;if(i&&(b+=`
Expiration Time: ${i.toISOString()}`),a&&(b+=`
Not Before: ${a.toISOString()}`),l&&(b+=`
Request ID: ${l}`),c){let v=`
Resources:`;for(let A of c){if(!A||typeof A!="string")throw new Error(`@supabase/auth-js: Invalid SIWE message field "resources". Every resource must be a valid string. Provided value: ${A}`);v+=`
- ${A}`}b+=v}return`${_}
${b}`}});var Zg=R(Ut=>{"use strict";Object.defineProperty(Ut,"__esModule",{value:!0});Ut.WebAuthnUnknownError=Ut.WebAuthnError=void 0;Ut.isWebAuthnError=uS;Ut.identifyRegistrationError=dS;Ut.identifyAuthenticationError=hS;var Yg=Xd(),ge=class extends Error{constructor({message:e,code:t,cause:r,name:i}){var n;super(e,{cause:r}),this.__isWebAuthnError=!0,this.name=(n=i??(r instanceof Error?r.name:void 0))!==null&&n!==void 0?n:"Unknown Error",this.code=t}};Ut.WebAuthnError=ge;var Gd=class extends ge{constructor(e,t){super({code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:t,message:e}),this.name="WebAuthnUnknownError",this.originalError=t}};Ut.WebAuthnUnknownError=Gd;function uS(s){return typeof s=="object"&&s!==null&&"__isWebAuthnError"in s}function dS({error:s,options:e}){var t,r,i;let{publicKey:n}=e;if(!n)throw Error("options was missing required publicKey property");if(s.name==="AbortError"){if(e.signal instanceof AbortSignal)return new ge({message:"Registration ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:s})}else if(s.name==="ConstraintError"){if(((t=n.authenticatorSelection)===null||t===void 0?void 0:t.requireResidentKey)===!0)return new ge({message:"Discoverable credentials were required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_DISCOVERABLE_CREDENTIAL_SUPPORT",cause:s});if(e.mediation==="conditional"&&((r=n.authenticatorSelection)===null||r===void 0?void 0:r.userVerification)==="required")return new ge({message:"User verification was required during automatic registration but it could not be performed",code:"ERROR_AUTO_REGISTER_USER_VERIFICATION_FAILURE",cause:s});if(((i=n.authenticatorSelection)===null||i===void 0?void 0:i.userVerification)==="required")return new ge({message:"User verification was required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_USER_VERIFICATION_SUPPORT",cause:s})}else{if(s.name==="InvalidStateError")return new ge({message:"The authenticator was previously registered",code:"ERROR_AUTHENTICATOR_PREVIOUSLY_REGISTERED",cause:s});if(s.name==="NotAllowedError")return new ge({message:s.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:s});if(s.name==="NotSupportedError")return n.pubKeyCredParams.filter(a=>a.type==="public-key").length===0?new ge({message:'No entry in pubKeyCredParams was of type "public-key"',code:"ERROR_MALFORMED_PUBKEYCREDPARAMS",cause:s}):new ge({message:"No available authenticator supported any of the specified pubKeyCredParams algorithms",code:"ERROR_AUTHENTICATOR_NO_SUPPORTED_PUBKEYCREDPARAMS_ALG",cause:s});if(s.name==="SecurityError"){let o=window.location.hostname;if((0,Yg.isValidDomain)(o)){if(n.rp.id!==o)return new ge({message:`The RP ID "${n.rp.id}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:s})}else return new ge({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:s})}else if(s.name==="TypeError"){if(n.user.id.byteLength<1||n.user.id.byteLength>64)return new ge({message:"User ID was not between 1 and 64 characters",code:"ERROR_INVALID_USER_ID_LENGTH",cause:s})}else if(s.name==="UnknownError")return new ge({message:"The authenticator was unable to process the specified options, or could not create a new credential",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:s})}return new ge({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:s})}function hS({error:s,options:e}){let{publicKey:t}=e;if(!t)throw Error("options was missing required publicKey property");if(s.name==="AbortError"){if(e.signal instanceof AbortSignal)return new ge({message:"Authentication ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:s})}else{if(s.name==="NotAllowedError")return new ge({message:s.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:s});if(s.name==="SecurityError"){let r=window.location.hostname;if((0,Yg.isValidDomain)(r)){if(t.rpId!==r)return new ge({message:`The RP ID "${t.rpId}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:s})}else return new ge({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:s})}else if(s.name==="UnknownError")return new ge({message:"The authenticator was unable to process the specified options, or could not create a new assertion signature",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:s})}return new ge({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:s})}});var Xd=R(G=>{"use strict";Object.defineProperty(G,"__esModule",{value:!0});G.WebAuthnApi=G.DEFAULT_REQUEST_OPTIONS=G.DEFAULT_CREATION_OPTIONS=G.webAuthnAbortService=G.WebAuthnAbortService=G.identifyAuthenticationError=G.identifyRegistrationError=G.isWebAuthnError=G.WebAuthnError=void 0;G.deserializeCredentialCreationOptions=pS;G.deserializeCredentialRequestOptions=mS;G.serializeCredentialCreationResponse=gS;G.serializeCredentialRequestResponse=yS;G.isValidDomain=wS;G.createCredential=ry;G.getCredential=sy;G.mergeCredentialCreationOptions=iy;G.mergeCredentialRequestOptions=ny;var ty=(Q(),X(W)),yt=co(),Et=gr(),fS=es(),Tt=Zg();Object.defineProperty(G,"identifyAuthenticationError",{enumerable:!0,get:function(){return Tt.identifyAuthenticationError}});Object.defineProperty(G,"identifyRegistrationError",{enumerable:!0,get:function(){return Tt.identifyRegistrationError}});Object.defineProperty(G,"isWebAuthnError",{enumerable:!0,get:function(){return Tt.isWebAuthnError}});Object.defineProperty(G,"WebAuthnError",{enumerable:!0,get:function(){return Tt.WebAuthnError}});var yo=class{createNewAbortSignal(){if(this.controller){let t=new Error("Cancelling existing WebAuthn API call for new one");t.name="AbortError",this.controller.abort(t)}let e=new AbortController;return this.controller=e,e.signal}cancelCeremony(){if(this.controller){let e=new Error("Manually cancelling existing WebAuthn API call");e.name="AbortError",this.controller.abort(e),this.controller=void 0}}};G.WebAuthnAbortService=yo;G.webAuthnAbortService=new yo;function pS(s){if(!s)throw new Error("Credential creation options are required");if(typeof PublicKeyCredential<"u"&&"parseCreationOptionsFromJSON"in PublicKeyCredential&&typeof PublicKeyCredential.parseCreationOptionsFromJSON=="function")return PublicKeyCredential.parseCreationOptionsFromJSON(s);let{challenge:e,user:t,excludeCredentials:r}=s,i=ty.__rest(s,["challenge","user","excludeCredentials"]),n=(0,yt.base64UrlToUint8Array)(e).buffer,o=Object.assign(Object.assign({},t),{id:(0,yt.base64UrlToUint8Array)(t.id).buffer}),a=Object.assign(Object.assign({},i),{challenge:n,user:o});if(r&&r.length>0){a.excludeCredentials=new Array(r.length);for(let l=0;l<r.length;l++){let c=r[l];a.excludeCredentials[l]=Object.assign(Object.assign({},c),{id:(0,yt.base64UrlToUint8Array)(c.id).buffer,type:c.type||"public-key",transports:c.transports})}}return a}function mS(s){if(!s)throw new Error("Credential request options are required");if(typeof PublicKeyCredential<"u"&&"parseRequestOptionsFromJSON"in PublicKeyCredential&&typeof PublicKeyCredential.parseRequestOptionsFromJSON=="function")return PublicKeyCredential.parseRequestOptionsFromJSON(s);let{challenge:e,allowCredentials:t}=s,r=ty.__rest(s,["challenge","allowCredentials"]),i=(0,yt.base64UrlToUint8Array)(e).buffer,n=Object.assign(Object.assign({},r),{challenge:i});if(t&&t.length>0){n.allowCredentials=new Array(t.length);for(let o=0;o<t.length;o++){let a=t[o];n.allowCredentials[o]=Object.assign(Object.assign({},a),{id:(0,yt.base64UrlToUint8Array)(a.id).buffer,type:a.type||"public-key",transports:a.transports})}}return n}function gS(s){var e;if("toJSON"in s&&typeof s.toJSON=="function")return s.toJSON();let t=s;return{id:s.id,rawId:s.id,response:{attestationObject:(0,yt.bytesToBase64URL)(new Uint8Array(s.response.attestationObject)),clientDataJSON:(0,yt.bytesToBase64URL)(new Uint8Array(s.response.clientDataJSON))},type:"public-key",clientExtensionResults:s.getClientExtensionResults(),authenticatorAttachment:(e=t.authenticatorAttachment)!==null&&e!==void 0?e:void 0}}function yS(s){var e;if("toJSON"in s&&typeof s.toJSON=="function")return s.toJSON();let t=s,r=s.getClientExtensionResults(),i=s.response;return{id:s.id,rawId:s.id,response:{authenticatorData:(0,yt.bytesToBase64URL)(new Uint8Array(i.authenticatorData)),clientDataJSON:(0,yt.bytesToBase64URL)(new Uint8Array(i.clientDataJSON)),signature:(0,yt.bytesToBase64URL)(new Uint8Array(i.signature)),userHandle:i.userHandle?(0,yt.bytesToBase64URL)(new Uint8Array(i.userHandle)):void 0},type:"public-key",clientExtensionResults:r,authenticatorAttachment:(e=t.authenticatorAttachment)!==null&&e!==void 0?e:void 0}}function wS(s){return s==="localhost"||/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/i.test(s)}function ey(){var s,e;return!!((0,fS.isBrowser)()&&"PublicKeyCredential"in window&&window.PublicKeyCredential&&"credentials"in navigator&&typeof((s=navigator?.credentials)===null||s===void 0?void 0:s.create)=="function"&&typeof((e=navigator?.credentials)===null||e===void 0?void 0:e.get)=="function")}async function ry(s){try{let e=await navigator.credentials.create(s);return e?e instanceof PublicKeyCredential?{data:e,error:null}:{data:null,error:new Tt.WebAuthnUnknownError("Browser returned unexpected credential type",e)}:{data:null,error:new Tt.WebAuthnUnknownError("Empty credential response",e)}}catch(e){return{data:null,error:(0,Tt.identifyRegistrationError)({error:e,options:s})}}}async function sy(s){try{let e=await navigator.credentials.get(s);return e?e instanceof PublicKeyCredential?{data:e,error:null}:{data:null,error:new Tt.WebAuthnUnknownError("Browser returned unexpected credential type",e)}:{data:null,error:new Tt.WebAuthnUnknownError("Empty credential response",e)}}catch(e){return{data:null,error:(0,Tt.identifyAuthenticationError)({error:e,options:s})}}}G.DEFAULT_CREATION_OPTIONS={hints:["security-key"],authenticatorSelection:{authenticatorAttachment:"cross-platform",requireResidentKey:!1,userVerification:"preferred",residentKey:"discouraged"},attestation:"direct"};G.DEFAULT_REQUEST_OPTIONS={userVerification:"preferred",hints:["security-key"],attestation:"direct"};function wo(...s){let e=i=>i!==null&&typeof i=="object"&&!Array.isArray(i),t=i=>i instanceof ArrayBuffer||ArrayBuffer.isView(i),r={};for(let i of s)if(i)for(let n in i){let o=i[n];if(o!==void 0)if(Array.isArray(o))r[n]=o;else if(t(o))r[n]=o;else if(e(o)){let a=r[n];e(a)?r[n]=wo(a,o):r[n]=wo(o)}else r[n]=o}return r}function iy(s,e){return wo(G.DEFAULT_CREATION_OPTIONS,s,e||{})}function ny(s,e){return wo(G.DEFAULT_REQUEST_OPTIONS,s,e||{})}var Yd=class{constructor(e){this.client=e,this.enroll=this._enroll.bind(this),this.challenge=this._challenge.bind(this),this.verify=this._verify.bind(this),this.authenticate=this._authenticate.bind(this),this.register=this._register.bind(this)}async _enroll(e){return this.client.mfa.enroll(Object.assign(Object.assign({},e),{factorType:"webauthn"}))}async _challenge({factorId:e,webauthn:t,friendlyName:r,signal:i},n){try{let{data:o,error:a}=await this.client.mfa.challenge({factorId:e,webauthn:t});if(!o)return{data:null,error:a};let l=i??G.webAuthnAbortService.createNewAbortSignal();if(o.webauthn.type==="create"){let{user:c}=o.webauthn.credential_options.publicKey;c.name||(c.name=`${c.id}:${r}`),c.displayName||(c.displayName=c.name)}switch(o.webauthn.type){case"create":{let c=iy(o.webauthn.credential_options.publicKey,n?.create),{data:u,error:f}=await ry({publicKey:c,signal:l});return u?{data:{factorId:e,challengeId:o.id,webauthn:{type:o.webauthn.type,credential_response:u}},error:null}:{data:null,error:f}}case"request":{let c=ny(o.webauthn.credential_options.publicKey,n?.request),{data:u,error:f}=await sy(Object.assign(Object.assign({},o.webauthn.credential_options),{publicKey:c,signal:l}));return u?{data:{factorId:e,challengeId:o.id,webauthn:{type:o.webauthn.type,credential_response:u}},error:null}:{data:null,error:f}}}}catch(o){return(0,Et.isAuthError)(o)?{data:null,error:o}:{data:null,error:new Et.AuthUnknownError("Unexpected error in challenge",o)}}}async _verify({challengeId:e,factorId:t,webauthn:r}){return this.client.mfa.verify({factorId:t,challengeId:e,webauthn:r})}async _authenticate({factorId:e,webauthn:{rpId:t=typeof window<"u"?window.location.hostname:void 0,rpOrigins:r=typeof window<"u"?[window.location.origin]:void 0,signal:i}={}},n){if(!t)return{data:null,error:new Et.AuthError("rpId is required for WebAuthn authentication")};try{if(!ey())return{data:null,error:new Et.AuthUnknownError("Browser does not support WebAuthn",null)};let{data:o,error:a}=await this.challenge({factorId:e,webauthn:{rpId:t,rpOrigins:r},signal:i},{request:n});if(!o)return{data:null,error:a};let{webauthn:l}=o;return this._verify({factorId:e,challengeId:o.challengeId,webauthn:{type:l.type,rpId:t,rpOrigins:r,credential_response:l.credential_response}})}catch(o){return(0,Et.isAuthError)(o)?{data:null,error:o}:{data:null,error:new Et.AuthUnknownError("Unexpected error in authenticate",o)}}}async _register({friendlyName:e,webauthn:{rpId:t=typeof window<"u"?window.location.hostname:void 0,rpOrigins:r=typeof window<"u"?[window.location.origin]:void 0,signal:i}={}},n){if(!t)return{data:null,error:new Et.AuthError("rpId is required for WebAuthn registration")};try{if(!ey())return{data:null,error:new Et.AuthUnknownError("Browser does not support WebAuthn",null)};let{data:o,error:a}=await this._enroll({friendlyName:e});if(!o)return await this.client.mfa.listFactors().then(u=>{var f;return(f=u.data)===null||f===void 0?void 0:f.all.find(d=>d.factor_type==="webauthn"&&d.friendly_name===e&&d.status!=="unverified")}).then(u=>u?this.client.mfa.unenroll({factorId:u?.id}):void 0),{data:null,error:a};let{data:l,error:c}=await this._challenge({factorId:o.id,friendlyName:o.friendly_name,webauthn:{rpId:t,rpOrigins:r},signal:i},{create:n});return l?this._verify({factorId:o.id,challengeId:l.challengeId,webauthn:{rpId:t,rpOrigins:r,type:l.webauthn.type,credential_response:l.webauthn.credential_response}}):{data:null,error:c}}catch(o){return(0,Et.isAuthError)(o)?{data:null,error:o}:{data:null,error:new Et.AuthUnknownError("Unexpected error in register",o)}}}};G.WebAuthnApi=Yd});var eh=R(Zd=>{"use strict";Object.defineProperty(Zd,"__esModule",{value:!0});var bS=(Q(),X(W)),_S=bS.__importDefault(po()),Je=ao(),x=gr(),L=Fd(),M=es(),oy=Wg(),ay=Qd(),vS=Jg(),SS=kd(),ly=co(),bo=Xg(),yi=Xd();(0,vS.polyfillGlobalThis)();var ES={url:Je.GOTRUE_URL,storageKey:Je.STORAGE_KEY,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:Je.DEFAULT_HEADERS,flowType:"implicit",debug:!1,hasCustomAuthorizationHeader:!1,throwOnError:!1};async function cy(s,e,t){return await t()}var rs={},_o=class s{get jwks(){var e,t;return(t=(e=rs[this.storageKey])===null||e===void 0?void 0:e.jwks)!==null&&t!==void 0?t:{keys:[]}}set jwks(e){rs[this.storageKey]=Object.assign(Object.assign({},rs[this.storageKey]),{jwks:e})}get jwks_cached_at(){var e,t;return(t=(e=rs[this.storageKey])===null||e===void 0?void 0:e.cachedAt)!==null&&t!==void 0?t:Number.MIN_SAFE_INTEGER}set jwks_cached_at(e){rs[this.storageKey]=Object.assign(Object.assign({},rs[this.storageKey]),{cachedAt:e})}constructor(e){var t,r,i;this.userStorage=null,this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.hasCustomAuthorizationHeader=!1,this.suppressGetSessionWarning=!1,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log;let n=Object.assign(Object.assign({},ES),e);if(this.storageKey=n.storageKey,this.instanceID=(t=s.nextInstanceID[this.storageKey])!==null&&t!==void 0?t:0,s.nextInstanceID[this.storageKey]=this.instanceID+1,this.logDebugMessages=!!n.debug,typeof n.debug=="function"&&(this.logger=n.debug),this.instanceID>0&&(0,M.isBrowser)()){let o=`${this._logPrefix()} Multiple GoTrueClient instances detected in the same browser context. It is not an error, but this should be avoided as it may produce undefined behavior when used concurrently under the same storage key.`;console.warn(o),this.logDebugMessages&&console.trace(o)}if(this.persistSession=n.persistSession,this.autoRefreshToken=n.autoRefreshToken,this.admin=new _S.default({url:n.url,headers:n.headers,fetch:n.fetch}),this.url=n.url,this.headers=n.headers,this.fetch=(0,M.resolveFetch)(n.fetch),this.lock=n.lock||cy,this.detectSessionInUrl=n.detectSessionInUrl,this.flowType=n.flowType,this.hasCustomAuthorizationHeader=n.hasCustomAuthorizationHeader,this.throwOnError=n.throwOnError,n.lock?this.lock=n.lock:(0,M.isBrowser)()&&(!((r=globalThis?.navigator)===null||r===void 0)&&r.locks)?this.lock=ay.navigatorLock:this.lock=cy,this.jwks||(this.jwks={keys:[]},this.jwks_cached_at=Number.MIN_SAFE_INTEGER),this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this),webauthn:new yi.WebAuthnApi(this)},this.oauth={getAuthorizationDetails:this._getAuthorizationDetails.bind(this),approveAuthorization:this._approveAuthorization.bind(this),denyAuthorization:this._denyAuthorization.bind(this),listGrants:this._listOAuthGrants.bind(this),revokeGrant:this._revokeOAuthGrant.bind(this)},this.persistSession?(n.storage?this.storage=n.storage:(0,M.supportsLocalStorage)()?this.storage=globalThis.localStorage:(this.memoryStorage={},this.storage=(0,oy.memoryLocalStorageAdapter)(this.memoryStorage)),n.userStorage&&(this.userStorage=n.userStorage)):(this.memoryStorage={},this.storage=(0,oy.memoryLocalStorageAdapter)(this.memoryStorage)),(0,M.isBrowser)()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(o){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",o)}(i=this.broadcastChannel)===null||i===void 0||i.addEventListener("message",async o=>{this._debug("received broadcast notification from other tab or client",o),await this._notifyAllSubscribers(o.data.event,o.data.session,!1)})}this.initialize()}isThrowOnErrorEnabled(){return this.throwOnError}_returnResult(e){if(this.throwOnError&&e&&e.error)throw e.error;return e}_logPrefix(){return`GoTrueClient@${this.storageKey}:${this.instanceID} (${SS.version}) ${new Date().toISOString()}`}_debug(...e){return this.logDebugMessages&&this.logger(this._logPrefix(),...e),this}async initialize(){return this.initializePromise?await this.initializePromise:(this.initializePromise=(async()=>await this._acquireLock(-1,async()=>await this._initialize()))(),await this.initializePromise)}async _initialize(){var e;try{let t={},r="none";if((0,M.isBrowser)()&&(t=(0,M.parseParametersFromURL)(window.location.href),this._isImplicitGrantCallback(t)?r="implicit":await this._isPKCECallback(t)&&(r="pkce")),(0,M.isBrowser)()&&this.detectSessionInUrl&&r!=="none"){let{data:i,error:n}=await this._getSessionFromURL(t,r);if(n){if(this._debug("#_initialize()","error detecting session from URL",n),(0,x.isAuthImplicitGrantRedirectError)(n)){let l=(e=n.details)===null||e===void 0?void 0:e.code;if(l==="identity_already_exists"||l==="identity_not_found"||l==="single_identity_not_deletable")return{error:n}}return await this._removeSession(),{error:n}}let{session:o,redirectType:a}=i;return this._debug("#_initialize()","detected session in URL",o,"redirect type",a),await this._saveSession(o),setTimeout(async()=>{a==="recovery"?await this._notifyAllSubscribers("PASSWORD_RECOVERY",o):await this._notifyAllSubscribers("SIGNED_IN",o)},0),{error:null}}return await this._recoverAndRefresh(),{error:null}}catch(t){return(0,x.isAuthError)(t)?this._returnResult({error:t}):this._returnResult({error:new x.AuthUnknownError("Unexpected error during initialization",t)})}finally{await this._handleVisibilityChange(),this._debug("#_initialize()","end")}}async signInAnonymously(e){var t,r,i;try{let n=await(0,L._request)(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{data:(r=(t=e?.options)===null||t===void 0?void 0:t.data)!==null&&r!==void 0?r:{},gotrue_meta_security:{captcha_token:(i=e?.options)===null||i===void 0?void 0:i.captchaToken}},xform:L._sessionResponse}),{data:o,error:a}=n;if(a||!o)return this._returnResult({data:{user:null,session:null},error:a});let l=o.session,c=o.user;return o.session&&(await this._saveSession(o.session),await this._notifyAllSubscribers("SIGNED_IN",l)),this._returnResult({data:{user:c,session:l},error:null})}catch(n){if((0,x.isAuthError)(n))return this._returnResult({data:{user:null,session:null},error:n});throw n}}async signUp(e){var t,r,i;try{let n;if("email"in e){let{email:u,password:f,options:d}=e,h=null,g=null;this.flowType==="pkce"&&([h,g]=await(0,M.getCodeChallengeAndMethod)(this.storage,this.storageKey)),n=await(0,L._request)(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:d?.emailRedirectTo,body:{email:u,password:f,data:(t=d?.data)!==null&&t!==void 0?t:{},gotrue_meta_security:{captcha_token:d?.captchaToken},code_challenge:h,code_challenge_method:g},xform:L._sessionResponse})}else if("phone"in e){let{phone:u,password:f,options:d}=e;n=await(0,L._request)(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:u,password:f,data:(r=d?.data)!==null&&r!==void 0?r:{},channel:(i=d?.channel)!==null&&i!==void 0?i:"sms",gotrue_meta_security:{captcha_token:d?.captchaToken}},xform:L._sessionResponse})}else throw new x.AuthInvalidCredentialsError("You must provide either an email or phone number and a password");let{data:o,error:a}=n;if(a||!o)return this._returnResult({data:{user:null,session:null},error:a});let l=o.session,c=o.user;return o.session&&(await this._saveSession(o.session),await this._notifyAllSubscribers("SIGNED_IN",l)),this._returnResult({data:{user:c,session:l},error:null})}catch(n){if((0,x.isAuthError)(n))return this._returnResult({data:{user:null,session:null},error:n});throw n}}async signInWithPassword(e){try{let t;if("email"in e){let{email:n,password:o,options:a}=e;t=await(0,L._request)(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:n,password:o,gotrue_meta_security:{captcha_token:a?.captchaToken}},xform:L._sessionResponsePassword})}else if("phone"in e){let{phone:n,password:o,options:a}=e;t=await(0,L._request)(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:n,password:o,gotrue_meta_security:{captcha_token:a?.captchaToken}},xform:L._sessionResponsePassword})}else throw new x.AuthInvalidCredentialsError("You must provide either an email or phone number and a password");let{data:r,error:i}=t;if(i)return this._returnResult({data:{user:null,session:null},error:i});if(!r||!r.session||!r.user){let n=new x.AuthInvalidTokenResponseError;return this._returnResult({data:{user:null,session:null},error:n})}return r.session&&(await this._saveSession(r.session),await this._notifyAllSubscribers("SIGNED_IN",r.session)),this._returnResult({data:Object.assign({user:r.user,session:r.session},r.weak_password?{weakPassword:r.weak_password}:null),error:i})}catch(t){if((0,x.isAuthError)(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async signInWithOAuth(e){var t,r,i,n;return await this._handleProviderSignIn(e.provider,{redirectTo:(t=e.options)===null||t===void 0?void 0:t.redirectTo,scopes:(r=e.options)===null||r===void 0?void 0:r.scopes,queryParams:(i=e.options)===null||i===void 0?void 0:i.queryParams,skipBrowserRedirect:(n=e.options)===null||n===void 0?void 0:n.skipBrowserRedirect})}async exchangeCodeForSession(e){return await this.initializePromise,this._acquireLock(-1,async()=>this._exchangeCodeForSession(e))}async signInWithWeb3(e){let{chain:t}=e;switch(t){case"ethereum":return await this.signInWithEthereum(e);case"solana":return await this.signInWithSolana(e);default:throw new Error(`@supabase/auth-js: Unsupported chain "${t}"`)}}async signInWithEthereum(e){var t,r,i,n,o,a,l,c,u,f,d;let h,g;if("message"in e)h=e.message,g=e.signature;else{let{chain:y,wallet:_,statement:b,options:v}=e,A;if((0,M.isBrowser)())if(typeof _=="object")A=_;else{let he=window;if("ethereum"in he&&typeof he.ethereum=="object"&&"request"in he.ethereum&&typeof he.ethereum.request=="function")A=he.ethereum;else throw new Error("@supabase/auth-js: No compatible Ethereum wallet interface on the window object (window.ethereum) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'ethereum', wallet: resolvedUserWallet }) instead.")}else{if(typeof _!="object"||!v?.url)throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");A=_}let N=new URL((t=v?.url)!==null&&t!==void 0?t:window.location.href),te=await A.request({method:"eth_requestAccounts"}).then(he=>he).catch(()=>{throw new Error("@supabase/auth-js: Wallet method eth_requestAccounts is missing or invalid")});if(!te||te.length===0)throw new Error("@supabase/auth-js: No accounts available. Please ensure the wallet is connected.");let U=(0,bo.getAddress)(te[0]),I=(r=v?.signInWithEthereum)===null||r===void 0?void 0:r.chainId;if(!I){let he=await A.request({method:"eth_chainId"});I=(0,bo.fromHex)(he)}let B={domain:N.host,address:U,statement:b,uri:N.href,version:"1",chainId:I,nonce:(i=v?.signInWithEthereum)===null||i===void 0?void 0:i.nonce,issuedAt:(o=(n=v?.signInWithEthereum)===null||n===void 0?void 0:n.issuedAt)!==null&&o!==void 0?o:new Date,expirationTime:(a=v?.signInWithEthereum)===null||a===void 0?void 0:a.expirationTime,notBefore:(l=v?.signInWithEthereum)===null||l===void 0?void 0:l.notBefore,requestId:(c=v?.signInWithEthereum)===null||c===void 0?void 0:c.requestId,resources:(u=v?.signInWithEthereum)===null||u===void 0?void 0:u.resources};h=(0,bo.createSiweMessage)(B),g=await A.request({method:"personal_sign",params:[(0,bo.toHex)(h),U]})}try{let{data:y,error:_}=await(0,L._request)(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"ethereum",message:h,signature:g},!((f=e.options)===null||f===void 0)&&f.captchaToken?{gotrue_meta_security:{captcha_token:(d=e.options)===null||d===void 0?void 0:d.captchaToken}}:null),xform:L._sessionResponse});if(_)throw _;if(!y||!y.session||!y.user){let b=new x.AuthInvalidTokenResponseError;return this._returnResult({data:{user:null,session:null},error:b})}return y.session&&(await this._saveSession(y.session),await this._notifyAllSubscribers("SIGNED_IN",y.session)),this._returnResult({data:Object.assign({},y),error:_})}catch(y){if((0,x.isAuthError)(y))return this._returnResult({data:{user:null,session:null},error:y});throw y}}async signInWithSolana(e){var t,r,i,n,o,a,l,c,u,f,d,h;let g,y;if("message"in e)g=e.message,y=e.signature;else{let{chain:_,wallet:b,statement:v,options:A}=e,N;if((0,M.isBrowser)())if(typeof b=="object")N=b;else{let U=window;if("solana"in U&&typeof U.solana=="object"&&("signIn"in U.solana&&typeof U.solana.signIn=="function"||"signMessage"in U.solana&&typeof U.solana.signMessage=="function"))N=U.solana;else throw new Error("@supabase/auth-js: No compatible Solana wallet interface on the window object (window.solana) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'solana', wallet: resolvedUserWallet }) instead.")}else{if(typeof b!="object"||!A?.url)throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");N=b}let te=new URL((t=A?.url)!==null&&t!==void 0?t:window.location.href);if("signIn"in N&&N.signIn){let U=await N.signIn(Object.assign(Object.assign(Object.assign({issuedAt:new Date().toISOString()},A?.signInWithSolana),{version:"1",domain:te.host,uri:te.href}),v?{statement:v}:null)),I;if(Array.isArray(U)&&U[0]&&typeof U[0]=="object")I=U[0];else if(U&&typeof U=="object"&&"signedMessage"in U&&"signature"in U)I=U;else throw new Error("@supabase/auth-js: Wallet method signIn() returned unrecognized value");if("signedMessage"in I&&"signature"in I&&(typeof I.signedMessage=="string"||I.signedMessage instanceof Uint8Array)&&I.signature instanceof Uint8Array)g=typeof I.signedMessage=="string"?I.signedMessage:new TextDecoder().decode(I.signedMessage),y=I.signature;else throw new Error("@supabase/auth-js: Wallet method signIn() API returned object without signedMessage and signature fields")}else{if(!("signMessage"in N)||typeof N.signMessage!="function"||!("publicKey"in N)||typeof N!="object"||!N.publicKey||!("toBase58"in N.publicKey)||typeof N.publicKey.toBase58!="function")throw new Error("@supabase/auth-js: Wallet does not have a compatible signMessage() and publicKey.toBase58() API");g=[`${te.host} wants you to sign in with your Solana account:`,N.publicKey.toBase58(),...v?["",v,""]:[""],"Version: 1",`URI: ${te.href}`,`Issued At: ${(i=(r=A?.signInWithSolana)===null||r===void 0?void 0:r.issuedAt)!==null&&i!==void 0?i:new Date().toISOString()}`,...!((n=A?.signInWithSolana)===null||n===void 0)&&n.notBefore?[`Not Before: ${A.signInWithSolana.notBefore}`]:[],...!((o=A?.signInWithSolana)===null||o===void 0)&&o.expirationTime?[`Expiration Time: ${A.signInWithSolana.expirationTime}`]:[],...!((a=A?.signInWithSolana)===null||a===void 0)&&a.chainId?[`Chain ID: ${A.signInWithSolana.chainId}`]:[],...!((l=A?.signInWithSolana)===null||l===void 0)&&l.nonce?[`Nonce: ${A.signInWithSolana.nonce}`]:[],...!((c=A?.signInWithSolana)===null||c===void 0)&&c.requestId?[`Request ID: ${A.signInWithSolana.requestId}`]:[],...!((f=(u=A?.signInWithSolana)===null||u===void 0?void 0:u.resources)===null||f===void 0)&&f.length?["Resources",...A.signInWithSolana.resources.map(I=>`- ${I}`)]:[]].join(`
`);let U=await N.signMessage(new TextEncoder().encode(g),"utf8");if(!U||!(U instanceof Uint8Array))throw new Error("@supabase/auth-js: Wallet signMessage() API returned an recognized value");y=U}}try{let{data:_,error:b}=await(0,L._request)(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"solana",message:g,signature:(0,ly.bytesToBase64URL)(y)},!((d=e.options)===null||d===void 0)&&d.captchaToken?{gotrue_meta_security:{captcha_token:(h=e.options)===null||h===void 0?void 0:h.captchaToken}}:null),xform:L._sessionResponse});if(b)throw b;if(!_||!_.session||!_.user){let v=new x.AuthInvalidTokenResponseError;return this._returnResult({data:{user:null,session:null},error:v})}return _.session&&(await this._saveSession(_.session),await this._notifyAllSubscribers("SIGNED_IN",_.session)),this._returnResult({data:Object.assign({},_),error:b})}catch(_){if((0,x.isAuthError)(_))return this._returnResult({data:{user:null,session:null},error:_});throw _}}async _exchangeCodeForSession(e){let t=await(0,M.getItemAsync)(this.storage,`${this.storageKey}-code-verifier`),[r,i]=(t??"").split("/");try{let{data:n,error:o}=await(0,L._request)(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:e,code_verifier:r},xform:L._sessionResponse});if(await(0,M.removeItemAsync)(this.storage,`${this.storageKey}-code-verifier`),o)throw o;if(!n||!n.session||!n.user){let a=new x.AuthInvalidTokenResponseError;return this._returnResult({data:{user:null,session:null,redirectType:null},error:a})}return n.session&&(await this._saveSession(n.session),await this._notifyAllSubscribers("SIGNED_IN",n.session)),this._returnResult({data:Object.assign(Object.assign({},n),{redirectType:i??null}),error:o})}catch(n){if((0,x.isAuthError)(n))return this._returnResult({data:{user:null,session:null,redirectType:null},error:n});throw n}}async signInWithIdToken(e){try{let{options:t,provider:r,token:i,access_token:n,nonce:o}=e,a=await(0,L._request)(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:r,id_token:i,access_token:n,nonce:o,gotrue_meta_security:{captcha_token:t?.captchaToken}},xform:L._sessionResponse}),{data:l,error:c}=a;if(c)return this._returnResult({data:{user:null,session:null},error:c});if(!l||!l.session||!l.user){let u=new x.AuthInvalidTokenResponseError;return this._returnResult({data:{user:null,session:null},error:u})}return l.session&&(await this._saveSession(l.session),await this._notifyAllSubscribers("SIGNED_IN",l.session)),this._returnResult({data:l,error:c})}catch(t){if((0,x.isAuthError)(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async signInWithOtp(e){var t,r,i,n,o;try{if("email"in e){let{email:a,options:l}=e,c=null,u=null;this.flowType==="pkce"&&([c,u]=await(0,M.getCodeChallengeAndMethod)(this.storage,this.storageKey));let{error:f}=await(0,L._request)(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:a,data:(t=l?.data)!==null&&t!==void 0?t:{},create_user:(r=l?.shouldCreateUser)!==null&&r!==void 0?r:!0,gotrue_meta_security:{captcha_token:l?.captchaToken},code_challenge:c,code_challenge_method:u},redirectTo:l?.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:f})}if("phone"in e){let{phone:a,options:l}=e,{data:c,error:u}=await(0,L._request)(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:a,data:(i=l?.data)!==null&&i!==void 0?i:{},create_user:(n=l?.shouldCreateUser)!==null&&n!==void 0?n:!0,gotrue_meta_security:{captcha_token:l?.captchaToken},channel:(o=l?.channel)!==null&&o!==void 0?o:"sms"}});return this._returnResult({data:{user:null,session:null,messageId:c?.message_id},error:u})}throw new x.AuthInvalidCredentialsError("You must provide either an email or phone number.")}catch(a){if((0,x.isAuthError)(a))return this._returnResult({data:{user:null,session:null},error:a});throw a}}async verifyOtp(e){var t,r;try{let i,n;"options"in e&&(i=(t=e.options)===null||t===void 0?void 0:t.redirectTo,n=(r=e.options)===null||r===void 0?void 0:r.captchaToken);let{data:o,error:a}=await(0,L._request)(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},e),{gotrue_meta_security:{captcha_token:n}}),redirectTo:i,xform:L._sessionResponse});if(a)throw a;if(!o)throw new Error("An error occurred on token verification.");let l=o.session,c=o.user;return l?.access_token&&(await this._saveSession(l),await this._notifyAllSubscribers(e.type=="recovery"?"PASSWORD_RECOVERY":"SIGNED_IN",l)),this._returnResult({data:{user:c,session:l},error:null})}catch(i){if((0,x.isAuthError)(i))return this._returnResult({data:{user:null,session:null},error:i});throw i}}async signInWithSSO(e){var t,r,i,n,o;try{let a=null,l=null;this.flowType==="pkce"&&([a,l]=await(0,M.getCodeChallengeAndMethod)(this.storage,this.storageKey));let c=await(0,L._request)(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in e?{provider_id:e.providerId}:null),"domain"in e?{domain:e.domain}:null),{redirect_to:(r=(t=e.options)===null||t===void 0?void 0:t.redirectTo)!==null&&r!==void 0?r:void 0}),!((i=e?.options)===null||i===void 0)&&i.captchaToken?{gotrue_meta_security:{captcha_token:e.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:a,code_challenge_method:l}),headers:this.headers,xform:L._ssoResponse});return!((n=c.data)===null||n===void 0)&&n.url&&(0,M.isBrowser)()&&!(!((o=e.options)===null||o===void 0)&&o.skipBrowserRedirect)&&window.location.assign(c.data.url),this._returnResult(c)}catch(a){if((0,x.isAuthError)(a))return this._returnResult({data:null,error:a});throw a}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._reauthenticate())}async _reauthenticate(){try{return await this._useSession(async e=>{let{data:{session:t},error:r}=e;if(r)throw r;if(!t)throw new x.AuthSessionMissingError;let{error:i}=await(0,L._request)(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:t.access_token});return this._returnResult({data:{user:null,session:null},error:i})})}catch(e){if((0,x.isAuthError)(e))return this._returnResult({data:{user:null,session:null},error:e});throw e}}async resend(e){try{let t=`${this.url}/resend`;if("email"in e){let{email:r,type:i,options:n}=e,{error:o}=await(0,L._request)(this.fetch,"POST",t,{headers:this.headers,body:{email:r,type:i,gotrue_meta_security:{captcha_token:n?.captchaToken}},redirectTo:n?.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:o})}else if("phone"in e){let{phone:r,type:i,options:n}=e,{data:o,error:a}=await(0,L._request)(this.fetch,"POST",t,{headers:this.headers,body:{phone:r,type:i,gotrue_meta_security:{captcha_token:n?.captchaToken}}});return this._returnResult({data:{user:null,session:null,messageId:o?.message_id},error:a})}throw new x.AuthInvalidCredentialsError("You must provide either an email or phone number and a type")}catch(t){if((0,x.isAuthError)(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async getSession(){return await this.initializePromise,await this._acquireLock(-1,async()=>this._useSession(async t=>t))}async _acquireLock(e,t){this._debug("#_acquireLock","begin",e);try{if(this.lockAcquired){let r=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),i=(async()=>(await r,await t()))();return this.pendingInLock.push((async()=>{try{await i}catch{}})()),i}return await this.lock(`lock:${this.storageKey}`,e,async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;let r=t();for(this.pendingInLock.push((async()=>{try{await r}catch{}})()),await r;this.pendingInLock.length;){let i=[...this.pendingInLock];await Promise.all(i),this.pendingInLock.splice(0,i.length)}return await r}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}})}finally{this._debug("#_acquireLock","end")}}async _useSession(e){this._debug("#_useSession","begin");try{let t=await this.__loadSession();return await e(t)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",new Error().stack);try{let e=null,t=await(0,M.getItemAsync)(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",t),t!==null&&(this._isValidSession(t)?e=t:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!e)return{data:{session:null},error:null};let r=e.expires_at?e.expires_at*1e3-Date.now()<Je.EXPIRY_MARGIN_MS:!1;if(this._debug("#__loadSession()",`session has${r?"":" not"} expired`,"expires_at",e.expires_at),!r){if(this.userStorage){let o=await(0,M.getItemAsync)(this.userStorage,this.storageKey+"-user");o?.user?e.user=o.user:e.user=(0,M.userNotAvailableProxy)()}if(this.storage.isServer&&e.user&&!e.user.__isUserNotAvailableProxy){let o={value:this.suppressGetSessionWarning};e.user=(0,M.insecureUserWarningProxy)(e.user,o),o.value&&(this.suppressGetSessionWarning=!0)}return{data:{session:e},error:null}}let{data:i,error:n}=await this._callRefreshToken(e.refresh_token);return n?this._returnResult({data:{session:null},error:n}):this._returnResult({data:{session:i},error:null})}finally{this._debug("#__loadSession()","end")}}async getUser(e){return e?await this._getUser(e):(await this.initializePromise,await this._acquireLock(-1,async()=>await this._getUser()))}async _getUser(e){try{return e?await(0,L._request)(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:e,xform:L._userResponse}):await this._useSession(async t=>{var r,i,n;let{data:o,error:a}=t;if(a)throw a;return!(!((r=o.session)===null||r===void 0)&&r.access_token)&&!this.hasCustomAuthorizationHeader?{data:{user:null},error:new x.AuthSessionMissingError}:await(0,L._request)(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:(n=(i=o.session)===null||i===void 0?void 0:i.access_token)!==null&&n!==void 0?n:void 0,xform:L._userResponse})})}catch(t){if((0,x.isAuthError)(t))return(0,x.isAuthSessionMissingError)(t)&&(await this._removeSession(),await(0,M.removeItemAsync)(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({data:{user:null},error:t});throw t}}async updateUser(e,t={}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._updateUser(e,t))}async _updateUser(e,t={}){try{return await this._useSession(async r=>{let{data:i,error:n}=r;if(n)throw n;if(!i.session)throw new x.AuthSessionMissingError;let o=i.session,a=null,l=null;this.flowType==="pkce"&&e.email!=null&&([a,l]=await(0,M.getCodeChallengeAndMethod)(this.storage,this.storageKey));let{data:c,error:u}=await(0,L._request)(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:t?.emailRedirectTo,body:Object.assign(Object.assign({},e),{code_challenge:a,code_challenge_method:l}),jwt:o.access_token,xform:L._userResponse});if(u)throw u;return o.user=c.user,await this._saveSession(o),await this._notifyAllSubscribers("USER_UPDATED",o),this._returnResult({data:{user:o.user},error:null})})}catch(r){if((0,x.isAuthError)(r))return this._returnResult({data:{user:null},error:r});throw r}}async setSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._setSession(e))}async _setSession(e){try{if(!e.access_token||!e.refresh_token)throw new x.AuthSessionMissingError;let t=Date.now()/1e3,r=t,i=!0,n=null,{payload:o}=(0,M.decodeJWT)(e.access_token);if(o.exp&&(r=o.exp,i=r<=t),i){let{data:a,error:l}=await this._callRefreshToken(e.refresh_token);if(l)return this._returnResult({data:{user:null,session:null},error:l});if(!a)return{data:{user:null,session:null},error:null};n=a}else{let{data:a,error:l}=await this._getUser(e.access_token);if(l)throw l;n={access_token:e.access_token,refresh_token:e.refresh_token,user:a.user,token_type:"bearer",expires_in:r-t,expires_at:r},await this._saveSession(n),await this._notifyAllSubscribers("SIGNED_IN",n)}return this._returnResult({data:{user:n.user,session:n},error:null})}catch(t){if((0,x.isAuthError)(t))return this._returnResult({data:{session:null,user:null},error:t});throw t}}async refreshSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._refreshSession(e))}async _refreshSession(e){try{return await this._useSession(async t=>{var r;if(!e){let{data:o,error:a}=t;if(a)throw a;e=(r=o.session)!==null&&r!==void 0?r:void 0}if(!e?.refresh_token)throw new x.AuthSessionMissingError;let{data:i,error:n}=await this._callRefreshToken(e.refresh_token);return n?this._returnResult({data:{user:null,session:null},error:n}):i?this._returnResult({data:{user:i.user,session:i},error:null}):this._returnResult({data:{user:null,session:null},error:null})})}catch(t){if((0,x.isAuthError)(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async _getSessionFromURL(e,t){try{if(!(0,M.isBrowser)())throw new x.AuthImplicitGrantRedirectError("No browser detected.");if(e.error||e.error_description||e.error_code)throw new x.AuthImplicitGrantRedirectError(e.error_description||"Error in URL with unspecified error_description",{error:e.error||"unspecified_error",code:e.error_code||"unspecified_code"});switch(t){case"implicit":if(this.flowType==="pkce")throw new x.AuthPKCEGrantCodeExchangeError("Not a valid PKCE flow url.");break;case"pkce":if(this.flowType==="implicit")throw new x.AuthImplicitGrantRedirectError("Not a valid implicit grant flow url.");break;default:}if(t==="pkce"){if(this._debug("#_initialize()","begin","is PKCE flow",!0),!e.code)throw new x.AuthPKCEGrantCodeExchangeError("No code detected.");let{data:v,error:A}=await this._exchangeCodeForSession(e.code);if(A)throw A;let N=new URL(window.location.href);return N.searchParams.delete("code"),window.history.replaceState(window.history.state,"",N.toString()),{data:{session:v.session,redirectType:null},error:null}}let{provider_token:r,provider_refresh_token:i,access_token:n,refresh_token:o,expires_in:a,expires_at:l,token_type:c}=e;if(!n||!a||!o||!c)throw new x.AuthImplicitGrantRedirectError("No session defined in URL");let u=Math.round(Date.now()/1e3),f=parseInt(a),d=u+f;l&&(d=parseInt(l));let h=d-u;h*1e3<=Je.AUTO_REFRESH_TICK_DURATION_MS&&console.warn(`@supabase/gotrue-js: Session as retrieved from URL expires in ${h}s, should have been closer to ${f}s`);let g=d-f;u-g>=120?console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued over 120s ago, URL could be stale",g,d,u):u-g<0&&console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued in the future? Check the device clock for skew",g,d,u);let{data:y,error:_}=await this._getUser(n);if(_)throw _;let b={provider_token:r,provider_refresh_token:i,access_token:n,expires_in:f,expires_at:d,refresh_token:o,token_type:c,user:y.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),this._returnResult({data:{session:b,redirectType:e.type},error:null})}catch(r){if((0,x.isAuthError)(r))return this._returnResult({data:{session:null,redirectType:null},error:r});throw r}}_isImplicitGrantCallback(e){return!!(e.access_token||e.error_description)}async _isPKCECallback(e){let t=await(0,M.getItemAsync)(this.storage,`${this.storageKey}-code-verifier`);return!!(e.code&&t)}async signOut(e={scope:"global"}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._signOut(e))}async _signOut({scope:e}={scope:"global"}){return await this._useSession(async t=>{var r;let{data:i,error:n}=t;if(n)return this._returnResult({error:n});let o=(r=i.session)===null||r===void 0?void 0:r.access_token;if(o){let{error:a}=await this.admin.signOut(o,e);if(a&&!((0,x.isAuthApiError)(a)&&(a.status===404||a.status===401||a.status===403)))return this._returnResult({error:a})}return e!=="others"&&(await this._removeSession(),await(0,M.removeItemAsync)(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({error:null})})}onAuthStateChange(e){let t=(0,M.generateCallbackId)(),r={id:t,callback:e,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",t),this.stateChangeEmitters.delete(t)}};return this._debug("#onAuthStateChange()","registered callback with id",t),this.stateChangeEmitters.set(t,r),(async()=>(await this.initializePromise,await this._acquireLock(-1,async()=>{this._emitInitialSession(t)})))(),{data:{subscription:r}}}async _emitInitialSession(e){return await this._useSession(async t=>{var r,i;try{let{data:{session:n},error:o}=t;if(o)throw o;await((r=this.stateChangeEmitters.get(e))===null||r===void 0?void 0:r.callback("INITIAL_SESSION",n)),this._debug("INITIAL_SESSION","callback id",e,"session",n)}catch(n){await((i=this.stateChangeEmitters.get(e))===null||i===void 0?void 0:i.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",e,"error",n),console.error(n)}})}async resetPasswordForEmail(e,t={}){let r=null,i=null;this.flowType==="pkce"&&([r,i]=await(0,M.getCodeChallengeAndMethod)(this.storage,this.storageKey,!0));try{return await(0,L._request)(this.fetch,"POST",`${this.url}/recover`,{body:{email:e,code_challenge:r,code_challenge_method:i,gotrue_meta_security:{captcha_token:t.captchaToken}},headers:this.headers,redirectTo:t.redirectTo})}catch(n){if((0,x.isAuthError)(n))return this._returnResult({data:null,error:n});throw n}}async getUserIdentities(){var e;try{let{data:t,error:r}=await this.getUser();if(r)throw r;return this._returnResult({data:{identities:(e=t.user.identities)!==null&&e!==void 0?e:[]},error:null})}catch(t){if((0,x.isAuthError)(t))return this._returnResult({data:null,error:t});throw t}}async linkIdentity(e){return"token"in e?this.linkIdentityIdToken(e):this.linkIdentityOAuth(e)}async linkIdentityOAuth(e){var t;try{let{data:r,error:i}=await this._useSession(async n=>{var o,a,l,c,u;let{data:f,error:d}=n;if(d)throw d;let h=await this._getUrlForProvider(`${this.url}/user/identities/authorize`,e.provider,{redirectTo:(o=e.options)===null||o===void 0?void 0:o.redirectTo,scopes:(a=e.options)===null||a===void 0?void 0:a.scopes,queryParams:(l=e.options)===null||l===void 0?void 0:l.queryParams,skipBrowserRedirect:!0});return await(0,L._request)(this.fetch,"GET",h,{headers:this.headers,jwt:(u=(c=f.session)===null||c===void 0?void 0:c.access_token)!==null&&u!==void 0?u:void 0})});if(i)throw i;return(0,M.isBrowser)()&&!(!((t=e.options)===null||t===void 0)&&t.skipBrowserRedirect)&&window.location.assign(r?.url),this._returnResult({data:{provider:e.provider,url:r?.url},error:null})}catch(r){if((0,x.isAuthError)(r))return this._returnResult({data:{provider:e.provider,url:null},error:r});throw r}}async linkIdentityIdToken(e){return await this._useSession(async t=>{var r;try{let{error:i,data:{session:n}}=t;if(i)throw i;let{options:o,provider:a,token:l,access_token:c,nonce:u}=e,f=await(0,L._request)(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,jwt:(r=n?.access_token)!==null&&r!==void 0?r:void 0,body:{provider:a,id_token:l,access_token:c,nonce:u,link_identity:!0,gotrue_meta_security:{captcha_token:o?.captchaToken}},xform:L._sessionResponse}),{data:d,error:h}=f;return h?this._returnResult({data:{user:null,session:null},error:h}):!d||!d.session||!d.user?this._returnResult({data:{user:null,session:null},error:new x.AuthInvalidTokenResponseError}):(d.session&&(await this._saveSession(d.session),await this._notifyAllSubscribers("USER_UPDATED",d.session)),this._returnResult({data:d,error:h}))}catch(i){if((0,x.isAuthError)(i))return this._returnResult({data:{user:null,session:null},error:i});throw i}})}async unlinkIdentity(e){try{return await this._useSession(async t=>{var r,i;let{data:n,error:o}=t;if(o)throw o;return await(0,L._request)(this.fetch,"DELETE",`${this.url}/user/identities/${e.identity_id}`,{headers:this.headers,jwt:(i=(r=n.session)===null||r===void 0?void 0:r.access_token)!==null&&i!==void 0?i:void 0})})}catch(t){if((0,x.isAuthError)(t))return this._returnResult({data:null,error:t});throw t}}async _refreshAccessToken(e){let t=`#_refreshAccessToken(${e.substring(0,5)}...)`;this._debug(t,"begin");try{let r=Date.now();return await(0,M.retryable)(async i=>(i>0&&await(0,M.sleep)(200*Math.pow(2,i-1)),this._debug(t,"refreshing attempt",i),await(0,L._request)(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:e},headers:this.headers,xform:L._sessionResponse})),(i,n)=>{let o=200*Math.pow(2,i);return n&&(0,x.isAuthRetryableFetchError)(n)&&Date.now()+o-r<Je.AUTO_REFRESH_TICK_DURATION_MS})}catch(r){if(this._debug(t,"error",r),(0,x.isAuthError)(r))return this._returnResult({data:{session:null,user:null},error:r});throw r}finally{this._debug(t,"end")}}_isValidSession(e){return typeof e=="object"&&e!==null&&"access_token"in e&&"refresh_token"in e&&"expires_at"in e}async _handleProviderSignIn(e,t){let r=await this._getUrlForProvider(`${this.url}/authorize`,e,{redirectTo:t.redirectTo,scopes:t.scopes,queryParams:t.queryParams});return this._debug("#_handleProviderSignIn()","provider",e,"options",t,"url",r),(0,M.isBrowser)()&&!t.skipBrowserRedirect&&window.location.assign(r),{data:{provider:e,url:r},error:null}}async _recoverAndRefresh(){var e,t;let r="#_recoverAndRefresh()";this._debug(r,"begin");try{let i=await(0,M.getItemAsync)(this.storage,this.storageKey);if(i&&this.userStorage){let o=await(0,M.getItemAsync)(this.userStorage,this.storageKey+"-user");!this.storage.isServer&&Object.is(this.storage,this.userStorage)&&!o&&(o={user:i.user},await(0,M.setItemAsync)(this.userStorage,this.storageKey+"-user",o)),i.user=(e=o?.user)!==null&&e!==void 0?e:(0,M.userNotAvailableProxy)()}else if(i&&!i.user&&!i.user){let o=await(0,M.getItemAsync)(this.storage,this.storageKey+"-user");o&&o?.user?(i.user=o.user,await(0,M.removeItemAsync)(this.storage,this.storageKey+"-user"),await(0,M.setItemAsync)(this.storage,this.storageKey,i)):i.user=(0,M.userNotAvailableProxy)()}if(this._debug(r,"session from storage",i),!this._isValidSession(i)){this._debug(r,"session is not valid"),i!==null&&await this._removeSession();return}let n=((t=i.expires_at)!==null&&t!==void 0?t:1/0)*1e3-Date.now()<Je.EXPIRY_MARGIN_MS;if(this._debug(r,`session has${n?"":" not"} expired with margin of ${Je.EXPIRY_MARGIN_MS}s`),n){if(this.autoRefreshToken&&i.refresh_token){let{error:o}=await this._callRefreshToken(i.refresh_token);o&&(console.error(o),(0,x.isAuthRetryableFetchError)(o)||(this._debug(r,"refresh failed with a non-retryable error, removing the session",o),await this._removeSession()))}}else if(i.user&&i.user.__isUserNotAvailableProxy===!0)try{let{data:o,error:a}=await this._getUser(i.access_token);!a&&o?.user?(i.user=o.user,await this._saveSession(i),await this._notifyAllSubscribers("SIGNED_IN",i)):this._debug(r,"could not get user data, skipping SIGNED_IN notification")}catch(o){console.error("Error getting user data:",o),this._debug(r,"error getting user data, skipping SIGNED_IN notification",o)}else await this._notifyAllSubscribers("SIGNED_IN",i)}catch(i){this._debug(r,"error",i),console.error(i);return}finally{this._debug(r,"end")}}async _callRefreshToken(e){var t,r;if(!e)throw new x.AuthSessionMissingError;if(this.refreshingDeferred)return this.refreshingDeferred.promise;let i=`#_callRefreshToken(${e.substring(0,5)}...)`;this._debug(i,"begin");try{this.refreshingDeferred=new M.Deferred;let{data:n,error:o}=await this._refreshAccessToken(e);if(o)throw o;if(!n.session)throw new x.AuthSessionMissingError;await this._saveSession(n.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",n.session);let a={data:n.session,error:null};return this.refreshingDeferred.resolve(a),a}catch(n){if(this._debug(i,"error",n),(0,x.isAuthError)(n)){let o={data:null,error:n};return(0,x.isAuthRetryableFetchError)(n)||await this._removeSession(),(t=this.refreshingDeferred)===null||t===void 0||t.resolve(o),o}throw(r=this.refreshingDeferred)===null||r===void 0||r.reject(n),n}finally{this.refreshingDeferred=null,this._debug(i,"end")}}async _notifyAllSubscribers(e,t,r=!0){let i=`#_notifyAllSubscribers(${e})`;this._debug(i,"begin",t,`broadcast = ${r}`);try{this.broadcastChannel&&r&&this.broadcastChannel.postMessage({event:e,session:t});let n=[],o=Array.from(this.stateChangeEmitters.values()).map(async a=>{try{await a.callback(e,t)}catch(l){n.push(l)}});if(await Promise.all(o),n.length>0){for(let a=0;a<n.length;a+=1)console.error(n[a]);throw n[0]}}finally{this._debug(i,"end")}}async _saveSession(e){this._debug("#_saveSession()",e),this.suppressGetSessionWarning=!0;let t=Object.assign({},e),r=t.user&&t.user.__isUserNotAvailableProxy===!0;if(this.userStorage){!r&&t.user&&await(0,M.setItemAsync)(this.userStorage,this.storageKey+"-user",{user:t.user});let i=Object.assign({},t);delete i.user;let n=(0,M.deepClone)(i);await(0,M.setItemAsync)(this.storage,this.storageKey,n)}else{let i=(0,M.deepClone)(t);await(0,M.setItemAsync)(this.storage,this.storageKey,i)}}async _removeSession(){this._debug("#_removeSession()"),await(0,M.removeItemAsync)(this.storage,this.storageKey),await(0,M.removeItemAsync)(this.storage,this.storageKey+"-code-verifier"),await(0,M.removeItemAsync)(this.storage,this.storageKey+"-user"),this.userStorage&&await(0,M.removeItemAsync)(this.userStorage,this.storageKey+"-user"),await this._notifyAllSubscribers("SIGNED_OUT",null)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");let e=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{e&&(0,M.isBrowser)()&&window?.removeEventListener&&window.removeEventListener("visibilitychange",e)}catch(t){console.error("removing visibilitychange callback failed",t)}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");let e=setInterval(()=>this._autoRefreshTokenTick(),Je.AUTO_REFRESH_TICK_DURATION_MS);this.autoRefreshTicker=e,e&&typeof e=="object"&&typeof e.unref=="function"?e.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(e),setTimeout(async()=>{await this.initializePromise,await this._autoRefreshTokenTick()},0)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");let e=this.autoRefreshTicker;this.autoRefreshTicker=null,e&&clearInterval(e)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,async()=>{try{let e=Date.now();try{return await this._useSession(async t=>{let{data:{session:r}}=t;if(!r||!r.refresh_token||!r.expires_at){this._debug("#_autoRefreshTokenTick()","no session");return}let i=Math.floor((r.expires_at*1e3-e)/Je.AUTO_REFRESH_TICK_DURATION_MS);this._debug("#_autoRefreshTokenTick()",`access token expires in ${i} ticks, a tick lasts ${Je.AUTO_REFRESH_TICK_DURATION_MS}ms, refresh threshold is ${Je.AUTO_REFRESH_TICK_THRESHOLD} ticks`),i<=Je.AUTO_REFRESH_TICK_THRESHOLD&&await this._callRefreshToken(r.refresh_token)})}catch(t){console.error("Auto refresh tick failed with error. This is likely a transient error.",t)}}finally{this._debug("#_autoRefreshTokenTick()","end")}})}catch(e){if(e.isAcquireTimeout||e instanceof ay.LockAcquireTimeoutError)this._debug("auto refresh token tick lock not available");else throw e}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!(0,M.isBrowser)()||!window?.addEventListener)return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>await this._onVisibilityChanged(!1),window?.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(e){console.error("_handleVisibilityChange",e)}}async _onVisibilityChanged(e){let t=`#_onVisibilityChanged(${e})`;this._debug(t,"visibilityState",document.visibilityState),document.visibilityState==="visible"?(this.autoRefreshToken&&this._startAutoRefresh(),e||(await this.initializePromise,await this._acquireLock(-1,async()=>{if(document.visibilityState!=="visible"){this._debug(t,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting");return}await this._recoverAndRefresh()}))):document.visibilityState==="hidden"&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(e,t,r){let i=[`provider=${encodeURIComponent(t)}`];if(r?.redirectTo&&i.push(`redirect_to=${encodeURIComponent(r.redirectTo)}`),r?.scopes&&i.push(`scopes=${encodeURIComponent(r.scopes)}`),this.flowType==="pkce"){let[n,o]=await(0,M.getCodeChallengeAndMethod)(this.storage,this.storageKey),a=new URLSearchParams({code_challenge:`${encodeURIComponent(n)}`,code_challenge_method:`${encodeURIComponent(o)}`});i.push(a.toString())}if(r?.queryParams){let n=new URLSearchParams(r.queryParams);i.push(n.toString())}return r?.skipBrowserRedirect&&i.push(`skip_http_redirect=${r.skipBrowserRedirect}`),`${e}?${i.join("&")}`}async _unenroll(e){try{return await this._useSession(async t=>{var r;let{data:i,error:n}=t;return n?this._returnResult({data:null,error:n}):await(0,L._request)(this.fetch,"DELETE",`${this.url}/factors/${e.factorId}`,{headers:this.headers,jwt:(r=i?.session)===null||r===void 0?void 0:r.access_token})})}catch(t){if((0,x.isAuthError)(t))return this._returnResult({data:null,error:t});throw t}}async _enroll(e){try{return await this._useSession(async t=>{var r,i;let{data:n,error:o}=t;if(o)return this._returnResult({data:null,error:o});let a=Object.assign({friendly_name:e.friendlyName,factor_type:e.factorType},e.factorType==="phone"?{phone:e.phone}:e.factorType==="totp"?{issuer:e.issuer}:{}),{data:l,error:c}=await(0,L._request)(this.fetch,"POST",`${this.url}/factors`,{body:a,headers:this.headers,jwt:(r=n?.session)===null||r===void 0?void 0:r.access_token});return c?this._returnResult({data:null,error:c}):(e.factorType==="totp"&&l.type==="totp"&&(!((i=l?.totp)===null||i===void 0)&&i.qr_code)&&(l.totp.qr_code=`data:image/svg+xml;utf-8,${l.totp.qr_code}`),this._returnResult({data:l,error:null}))})}catch(t){if((0,x.isAuthError)(t))return this._returnResult({data:null,error:t});throw t}}async _verify(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async t=>{var r;let{data:i,error:n}=t;if(n)return this._returnResult({data:null,error:n});let o=Object.assign({challenge_id:e.challengeId},"webauthn"in e?{webauthn:Object.assign(Object.assign({},e.webauthn),{credential_response:e.webauthn.type==="create"?(0,yi.serializeCredentialCreationResponse)(e.webauthn.credential_response):(0,yi.serializeCredentialRequestResponse)(e.webauthn.credential_response)})}:{code:e.code}),{data:a,error:l}=await(0,L._request)(this.fetch,"POST",`${this.url}/factors/${e.factorId}/verify`,{body:o,headers:this.headers,jwt:(r=i?.session)===null||r===void 0?void 0:r.access_token});return l?this._returnResult({data:null,error:l}):(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+a.expires_in},a)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",a),this._returnResult({data:a,error:l}))})}catch(t){if((0,x.isAuthError)(t))return this._returnResult({data:null,error:t});throw t}})}async _challenge(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async t=>{var r;let{data:i,error:n}=t;if(n)return this._returnResult({data:null,error:n});let o=await(0,L._request)(this.fetch,"POST",`${this.url}/factors/${e.factorId}/challenge`,{body:e,headers:this.headers,jwt:(r=i?.session)===null||r===void 0?void 0:r.access_token});if(o.error)return o;let{data:a}=o;if(a.type!=="webauthn")return{data:a,error:null};switch(a.webauthn.type){case"create":return{data:Object.assign(Object.assign({},a),{webauthn:Object.assign(Object.assign({},a.webauthn),{credential_options:Object.assign(Object.assign({},a.webauthn.credential_options),{publicKey:(0,yi.deserializeCredentialCreationOptions)(a.webauthn.credential_options.publicKey)})})}),error:null};case"request":return{data:Object.assign(Object.assign({},a),{webauthn:Object.assign(Object.assign({},a.webauthn),{credential_options:Object.assign(Object.assign({},a.webauthn.credential_options),{publicKey:(0,yi.deserializeCredentialRequestOptions)(a.webauthn.credential_options.publicKey)})})}),error:null}}})}catch(t){if((0,x.isAuthError)(t))return this._returnResult({data:null,error:t});throw t}})}async _challengeAndVerify(e){let{data:t,error:r}=await this._challenge({factorId:e.factorId});return r?this._returnResult({data:null,error:r}):await this._verify({factorId:e.factorId,challengeId:t.id,code:e.code})}async _listFactors(){var e;let{data:{user:t},error:r}=await this.getUser();if(r)return{data:null,error:r};let i={all:[],phone:[],totp:[],webauthn:[]};for(let n of(e=t?.factors)!==null&&e!==void 0?e:[])i.all.push(n),n.status==="verified"&&i[n.factor_type].push(n);return{data:i,error:null}}async _getAuthenticatorAssuranceLevel(){var e,t;let{data:{session:r},error:i}=await this.getSession();if(i)return this._returnResult({data:null,error:i});if(!r)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};let{payload:n}=(0,M.decodeJWT)(r.access_token),o=null;n.aal&&(o=n.aal);let a=o;((t=(e=r.user.factors)===null||e===void 0?void 0:e.filter(u=>u.status==="verified"))!==null&&t!==void 0?t:[]).length>0&&(a="aal2");let c=n.amr||[];return{data:{currentLevel:o,nextLevel:a,currentAuthenticationMethods:c},error:null}}async _getAuthorizationDetails(e){try{return await this._useSession(async t=>{let{data:{session:r},error:i}=t;return i?this._returnResult({data:null,error:i}):r?await(0,L._request)(this.fetch,"GET",`${this.url}/oauth/authorizations/${e}`,{headers:this.headers,jwt:r.access_token,xform:n=>({data:n,error:null})}):this._returnResult({data:null,error:new x.AuthSessionMissingError})})}catch(t){if((0,x.isAuthError)(t))return this._returnResult({data:null,error:t});throw t}}async _approveAuthorization(e,t){try{return await this._useSession(async r=>{let{data:{session:i},error:n}=r;if(n)return this._returnResult({data:null,error:n});if(!i)return this._returnResult({data:null,error:new x.AuthSessionMissingError});let o=await(0,L._request)(this.fetch,"POST",`${this.url}/oauth/authorizations/${e}/consent`,{headers:this.headers,jwt:i.access_token,body:{action:"approve"},xform:a=>({data:a,error:null})});return o.data&&o.data.redirect_url&&(0,M.isBrowser)()&&!t?.skipBrowserRedirect&&window.location.assign(o.data.redirect_url),o})}catch(r){if((0,x.isAuthError)(r))return this._returnResult({data:null,error:r});throw r}}async _denyAuthorization(e,t){try{return await this._useSession(async r=>{let{data:{session:i},error:n}=r;if(n)return this._returnResult({data:null,error:n});if(!i)return this._returnResult({data:null,error:new x.AuthSessionMissingError});let o=await(0,L._request)(this.fetch,"POST",`${this.url}/oauth/authorizations/${e}/consent`,{headers:this.headers,jwt:i.access_token,body:{action:"deny"},xform:a=>({data:a,error:null})});return o.data&&o.data.redirect_url&&(0,M.isBrowser)()&&!t?.skipBrowserRedirect&&window.location.assign(o.data.redirect_url),o})}catch(r){if((0,x.isAuthError)(r))return this._returnResult({data:null,error:r});throw r}}async _listOAuthGrants(){try{return await this._useSession(async e=>{let{data:{session:t},error:r}=e;return r?this._returnResult({data:null,error:r}):t?await(0,L._request)(this.fetch,"GET",`${this.url}/user/oauth/grants`,{headers:this.headers,jwt:t.access_token,xform:i=>({data:i,error:null})}):this._returnResult({data:null,error:new x.AuthSessionMissingError})})}catch(e){if((0,x.isAuthError)(e))return this._returnResult({data:null,error:e});throw e}}async _revokeOAuthGrant(e){try{return await this._useSession(async t=>{let{data:{session:r},error:i}=t;return i?this._returnResult({data:null,error:i}):r?(await(0,L._request)(this.fetch,"DELETE",`${this.url}/user/oauth/grants`,{headers:this.headers,jwt:r.access_token,query:{client_id:e.clientId},noResolveJson:!0}),{data:{},error:null}):this._returnResult({data:null,error:new x.AuthSessionMissingError})})}catch(t){if((0,x.isAuthError)(t))return this._returnResult({data:null,error:t});throw t}}async fetchJwk(e,t={keys:[]}){let r=t.keys.find(a=>a.kid===e);if(r)return r;let i=Date.now();if(r=this.jwks.keys.find(a=>a.kid===e),r&&this.jwks_cached_at+Je.JWKS_TTL>i)return r;let{data:n,error:o}=await(0,L._request)(this.fetch,"GET",`${this.url}/.well-known/jwks.json`,{headers:this.headers});if(o)throw o;return!n.keys||n.keys.length===0||(this.jwks=n,this.jwks_cached_at=i,r=n.keys.find(a=>a.kid===e),!r)?null:r}async getClaims(e,t={}){try{let r=e;if(!r){let{data:h,error:g}=await this.getSession();if(g||!h.session)return this._returnResult({data:null,error:g});r=h.session.access_token}let{header:i,payload:n,signature:o,raw:{header:a,payload:l}}=(0,M.decodeJWT)(r);t?.allowExpired||(0,M.validateExp)(n.exp);let c=!i.alg||i.alg.startsWith("HS")||!i.kid||!("crypto"in globalThis&&"subtle"in globalThis.crypto)?null:await this.fetchJwk(i.kid,t?.keys?{keys:t.keys}:t?.jwks);if(!c){let{error:h}=await this.getUser(r);if(h)throw h;return{data:{claims:n,header:i,signature:o},error:null}}let u=(0,M.getAlgorithm)(i.alg),f=await crypto.subtle.importKey("jwk",c,u,!0,["verify"]);if(!await crypto.subtle.verify(u,f,o,(0,ly.stringToUint8Array)(`${a}.${l}`)))throw new x.AuthInvalidJwtError("Invalid JWT signature");return{data:{claims:n,header:i,signature:o},error:null}}catch(r){if((0,x.isAuthError)(r))return this._returnResult({data:null,error:r});throw r}}};_o.nextInstanceID={};Zd.default=_o});var uy=R(th=>{"use strict";Object.defineProperty(th,"__esModule",{value:!0});var TS=(Q(),X(W)),AS=TS.__importDefault(po()),kS=AS.default;th.default=kS});var dy=R(rh=>{"use strict";Object.defineProperty(rh,"__esModule",{value:!0});var PS=(Q(),X(W)),xS=PS.__importDefault(eh()),CS=xS.default;rh.default=CS});var sh=R(Ae=>{"use strict";Object.defineProperty(Ae,"__esModule",{value:!0});Ae.processLock=Ae.lockInternals=Ae.NavigatorLockAcquireTimeoutError=Ae.navigatorLock=Ae.AuthClient=Ae.AuthAdminApi=Ae.GoTrueClient=Ae.GoTrueAdminApi=void 0;var ss=(Q(),X(W)),RS=ss.__importDefault(po());Ae.GoTrueAdminApi=RS.default;var OS=ss.__importDefault(eh());Ae.GoTrueClient=OS.default;var NS=ss.__importDefault(uy());Ae.AuthAdminApi=NS.default;var $S=ss.__importDefault(dy());Ae.AuthClient=$S.default;ss.__exportStar(Vd(),Ae);ss.__exportStar(gr(),Ae);var vo=Qd();Object.defineProperty(Ae,"navigatorLock",{enumerable:!0,get:function(){return vo.navigatorLock}});Object.defineProperty(Ae,"NavigatorLockAcquireTimeoutError",{enumerable:!0,get:function(){return vo.NavigatorLockAcquireTimeoutError}});Object.defineProperty(Ae,"lockInternals",{enumerable:!0,get:function(){return vo.internals}});Object.defineProperty(Ae,"processLock",{enumerable:!0,get:function(){return vo.processLock}})});var hy=R(So=>{"use strict";Object.defineProperty(So,"__esModule",{value:!0});So.SupabaseAuthClient=void 0;var IS=sh(),ih=class extends IS.AuthClient{constructor(e){super(e)}};So.SupabaseAuthClient=ih});var ah=R(oh=>{"use strict";Object.defineProperty(oh,"__esModule",{value:!0});var MS=cu(),DS=ku(),jS=Hu(),LS=$g(),Eo=Mg(),qS=Dg(),fy=Lg(),US=hy(),nh=class{constructor(e,t,r){var i,n,o;this.supabaseUrl=e,this.supabaseKey=t;let a=(0,fy.validateSupabaseUrl)(e);if(!t)throw new Error("supabaseKey is required.");this.realtimeUrl=new URL("realtime/v1",a),this.realtimeUrl.protocol=this.realtimeUrl.protocol.replace("http","ws"),this.authUrl=new URL("auth/v1",a),this.storageUrl=new URL("storage/v1",a),this.functionsUrl=new URL("functions/v1",a);let l=`sb-${a.hostname.split(".")[0]}-auth-token`,c={db:Eo.DEFAULT_DB_OPTIONS,realtime:Eo.DEFAULT_REALTIME_OPTIONS,auth:Object.assign(Object.assign({},Eo.DEFAULT_AUTH_OPTIONS),{storageKey:l}),global:Eo.DEFAULT_GLOBAL_OPTIONS},u=(0,fy.applySettingDefaults)(r??{},c);this.storageKey=(i=u.auth.storageKey)!==null&&i!==void 0?i:"",this.headers=(n=u.global.headers)!==null&&n!==void 0?n:{},u.accessToken?(this.accessToken=u.accessToken,this.auth=new Proxy({},{get:(f,d)=>{throw new Error(`@supabase/supabase-js: Supabase Client is configured with the accessToken option, accessing supabase.auth.${String(d)} is not possible`)}})):this.auth=this._initSupabaseAuthClient((o=u.auth)!==null&&o!==void 0?o:{},this.headers,u.global.fetch),this.fetch=(0,qS.fetchWithAuth)(t,this._getAccessToken.bind(this),u.global.fetch),this.realtime=this._initRealtimeClient(Object.assign({headers:this.headers,accessToken:this._getAccessToken.bind(this)},u.realtime)),this.accessToken&&this.accessToken().then(f=>this.realtime.setAuth(f)).catch(f=>console.warn("Failed to set initial Realtime auth token:",f)),this.rest=new DS.PostgrestClient(new URL("rest/v1",a).href,{headers:this.headers,schema:u.db.schema,fetch:this.fetch}),this.storage=new LS.StorageClient(this.storageUrl.href,this.headers,this.fetch,r?.storage),u.accessToken||this._listenForAuthEvents()}get functions(){return new MS.FunctionsClient(this.functionsUrl.href,{headers:this.headers,customFetch:this.fetch})}from(e){return this.rest.from(e)}schema(e){return this.rest.schema(e)}rpc(e,t={},r={head:!1,get:!1,count:void 0}){return this.rest.rpc(e,t,r)}channel(e,t={config:{}}){return this.realtime.channel(e,t)}getChannels(){return this.realtime.getChannels()}removeChannel(e){return this.realtime.removeChannel(e)}removeAllChannels(){return this.realtime.removeAllChannels()}async _getAccessToken(){var e,t;if(this.accessToken)return await this.accessToken();let{data:r}=await this.auth.getSession();return(t=(e=r.session)===null||e===void 0?void 0:e.access_token)!==null&&t!==void 0?t:this.supabaseKey}_initSupabaseAuthClient({autoRefreshToken:e,persistSession:t,detectSessionInUrl:r,storage:i,userStorage:n,storageKey:o,flowType:a,lock:l,debug:c,throwOnError:u},f,d){let h={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new US.SupabaseAuthClient({url:this.authUrl.href,headers:Object.assign(Object.assign({},h),f),storageKey:o,autoRefreshToken:e,persistSession:t,detectSessionInUrl:r,storage:i,userStorage:n,flowType:a,lock:l,debug:c,throwOnError:u,fetch:d,hasCustomAuthorizationHeader:Object.keys(this.headers).some(g=>g.toLowerCase()==="authorization")})}_initRealtimeClient(e){return new jS.RealtimeClient(this.realtimeUrl.href,Object.assign(Object.assign({},e),{params:Object.assign({apikey:this.supabaseKey},e?.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((t,r)=>{this._handleTokenChanged(t,"CLIENT",r?.access_token)})}_handleTokenChanged(e,t,r){(e==="TOKEN_REFRESHED"||e==="SIGNED_IN")&&this.changedAccessToken!==r?(this.changedAccessToken=r,this.realtime.setAuth(r)):e==="SIGNED_OUT"&&(this.realtime.setAuth(),t=="STORAGE"&&this.auth.signOut(),this.changedAccessToken=void 0)}};oh.default=nh});var gy=R(ce=>{"use strict";var BS=ce&&ce.__createBinding||(Object.create?(function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}):(function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]})),py=ce&&ce.__exportStar||function(s,e){for(var t in s)t!=="default"&&!Object.prototype.hasOwnProperty.call(e,t)&&BS(e,s,t)},my=ce&&ce.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(ce,"__esModule",{value:!0});ce.createClient=ce.SupabaseClient=ce.FunctionRegion=ce.FunctionsError=ce.FunctionsRelayError=ce.FunctionsFetchError=ce.FunctionsHttpError=ce.PostgrestError=void 0;var FS=my(ah());py(sh(),ce);var VS=ku();Object.defineProperty(ce,"PostgrestError",{enumerable:!0,get:function(){return VS.PostgrestError}});var wi=cu();Object.defineProperty(ce,"FunctionsHttpError",{enumerable:!0,get:function(){return wi.FunctionsHttpError}});Object.defineProperty(ce,"FunctionsFetchError",{enumerable:!0,get:function(){return wi.FunctionsFetchError}});Object.defineProperty(ce,"FunctionsRelayError",{enumerable:!0,get:function(){return wi.FunctionsRelayError}});Object.defineProperty(ce,"FunctionsError",{enumerable:!0,get:function(){return wi.FunctionsError}});Object.defineProperty(ce,"FunctionRegion",{enumerable:!0,get:function(){return wi.FunctionRegion}});py(Hu(),ce);var HS=ah();Object.defineProperty(ce,"SupabaseClient",{enumerable:!0,get:function(){return my(HS).default}});var KS=(s,e,t)=>new FS.default(s,e,t);ce.createClient=KS;function zS(){if(typeof window<"u"||typeof process>"u")return!1;let s=process.version;if(s==null)return!1;let e=s.match(/^v(\d+)\./);return e?parseInt(e[1],10)<=18:!1}zS()&&console.warn("\u26A0\uFE0F  Node.js 18 and below are deprecated and will no longer be supported in future versions of @supabase/supabase-js. Please upgrade to Node.js 20 or later. For more information, visit: https://github.com/orgs/supabase/discussions/37217")});var yy,To,wy=E(()=>{"use strict";yy=Jt(gy(),1),To=class{supabase;constructor(){let e=process.env.SUPABASE_PRODUCTION_URL,t=process.env.SUPABASE_PRODUCTION_KEY;if(!e||!t)throw new Error("SUPABASE_PRODUCTION_URL and SUPABASE_PRODUCTION_KEY must be set");this.supabase=(0,yy.createClient)(e,t)}async getAllPendingTrafficTasks(){let{data:e,error:t}=await this.supabase.from("traffic_navershopping").select("*").order("id",{ascending:!0});if(t)throw console.error("\uD2B8\uB798\uD53D \uC870\uD68C \uC624\uB958:",t),t;return e||[]}async getPendingTrafficTasks(e){let{data:t,error:r}=await this.supabase.from("traffic_navershopping").select("*").order("id",{ascending:!0}).limit(e);if(r)throw console.error("\uD2B8\uB798\uD53D \uC870\uD68C \uC624\uB958:",r),r;return t||[]}async findSlotNaver(e){if(e.slot_id){let{data:r}=await this.supabase.from("slot_naver").select("id").eq("id",e.slot_id).single();if(r)return r.id}let{data:t}=await this.supabase.from("slot_naver").select("id").eq("slot_sequence",e.slot_sequence).eq("keyword",e.keyword).eq("link_url",e.link_url).eq("slot_type","\uB124\uC774\uBC84\uC1FC\uD551").single();return t?.id||null}async getSlotProductInfo(e){let{data:t,error:r}=await this.supabase.from("slot_naver").select("product_name, mid").eq("id",e).single();return r||!t?{productName:null,mid:null}:{productName:t.product_name||null,mid:t.mid||null}}async updateSlotResult(e,t){let r=t?"success_count":"fail_count",{data:i,error:n}=await this.supabase.from("slot_naver").select(r).eq("id",e).single();if(n)throw console.error(`slot_naver \uC870\uD68C \uC624\uB958 (id=${e}):`,n),n;let o=i?.[r]||0,a=o+1,{error:l}=await this.supabase.from("slot_naver").update({[r]:a}).eq("id",e);if(l)throw console.error(`slot_naver \uC5C5\uB370\uC774\uD2B8 \uC624\uB958 (id=${e}):`,l),l;console.log(`\u{1F4CA} slot_naver[${e}] ${r}: ${o} \u2192 ${a}`)}async deleteProcessedTraffic(e){let{error:t}=await this.supabase.from("traffic_navershopping").delete().eq("id",e);if(t)throw console.error(`\uD2B8\uB798\uD53D \uC0AD\uC81C \uC624\uB958 (id=${e}):`,t),t;console.log(`\u{1F5D1}\uFE0F \uD2B8\uB798\uD53D ID ${e} \uC0AD\uC81C \uC644\uB8CC`)}async testConnection(){try{let{data:e,error:t}=await this.supabase.from("traffic_navershopping").select("count").limit(1);return t?(console.error("\uC5F0\uACB0 \uD14C\uC2A4\uD2B8 \uC2E4\uD328:",t),!1):(console.log("\u2705 Production Supabase \uC5F0\uACB0 \uC131\uACF5"),!0)}catch(e){return console.error("\uC5F0\uACB0 \uD14C\uC2A4\uD2B8 \uC608\uC678:",e),!1}}async getPendingTaskCount(){let{count:e,error:t}=await this.supabase.from("traffic_navershopping").select("*",{count:"exact",head:!0});return t?(console.error("\uC791\uC5C5 \uC218 \uC870\uD68C \uC624\uB958:",t),0):e||0}async insertFailure(e){let{error:t}=await this.supabase.from("traffic_failures").insert({task_id:e.task_id,slot_id:e.slot_id,keyword:e.keyword,target_mid:e.target_mid,fail_reason:e.fail_reason,search_url:e.search_url,found_mids:e.found_mids,found_count:e.found_count??0,engine_version:e.engine_version,error_message:e.error_message});if(t)throw console.error("\uC2E4\uD328 \uB85C\uADF8 \uC800\uC7A5 \uC624\uB958:",t),t;console.log(`\u{1F4DD} \uC2E4\uD328 \uB85C\uADF8 \uC800\uC7A5: ${e.fail_reason} - ${e.keyword}`)}async getFailureStats(){let{data:e,error:t}=await this.supabase.from("traffic_failures").select("fail_reason").order("created_at",{ascending:!1});if(t)return console.error("\uC2E4\uD328 \uB85C\uADF8 \uD1B5\uACC4 \uC624\uB958:",t),[];let r={};for(let i of e||[]){let n=i.fail_reason;r[n]=(r[n]||0)+1}return Object.entries(r).map(([i,n])=>({fail_reason:i,count:n}))}async getRecentFailures(e=20){let{data:t,error:r}=await this.supabase.from("traffic_failures").select("*").order("created_at",{ascending:!1}).limit(e);return r?(console.error("\uCD5C\uADFC \uC2E4\uD328 \uB85C\uADF8 \uC870\uD68C \uC624\uB958:",r),[]):t||[]}}});function Ao(){return lh||(lh=new ch),lh}var At,bi,ch,lh,by=E(()=>{"use strict";At=Jt(require("fs"),1),bi=Jt(require("path"),1);wy();ch=class{logDir;client=null;dbEnabled=!0;constructor(e){if(this.logDir=bi.join(process.cwd(),"logs"),this.dbEnabled=e?.dbEnabled??!0,this.ensureLogDir(),this.dbEnabled)try{this.client=new To}catch(t){console.warn("[FailureLogger] DB \uD074\uB77C\uC774\uC5B8\uD2B8 \uCD08\uAE30\uD654 \uC2E4\uD328, \uD30C\uC77C \uB85C\uAE45\uB9CC \uC0AC\uC6A9:",t),this.dbEnabled=!1}}ensureLogDir(){At.existsSync(this.logDir)||(At.mkdirSync(this.logDir,{recursive:!0}),console.log(`\u{1F4C1} \uB85C\uADF8 \uB514\uB809\uD1A0\uB9AC \uC0DD\uC131: ${this.logDir}`))}async logFailure(e){let r={timestamp:new Date().toISOString(),...e};if(this.appendToJsonl(r),this.dbEnabled&&this.client)try{await this.insertToDb(r)}catch(i){console.error("[FailureLogger] DB \uC800\uC7A5 \uC2E4\uD328:",i)}}async logMidNotFound(e){await this.logFailure({...e,failReason:"MID_NOT_FOUND",errorMessage:`MID ${e.targetMid} not found in search results`})}async logCaptcha(e){await this.logFailure({...e,failReason:"CAPTCHA"})}async logBlocked(e){await this.logFailure({...e,failReason:"BLOCKED"})}appendToJsonl(e){try{let t=this.getFilename(e.failReason),r=bi.join(this.logDir,t),i=JSON.stringify(e)+`
`;At.appendFileSync(r,i,"utf-8");let n=bi.join(this.logDir,"all-failures.jsonl");At.appendFileSync(n,i,"utf-8"),console.log(`\u{1F4DD} [${e.failReason}] ${e.keyword} \u2192 ${t}`)}catch(t){console.error("[FailureLogger] \uD30C\uC77C \uC800\uC7A5 \uC2E4\uD328:",t)}}getFilename(e){switch(e){case"MID_NOT_FOUND":return"mid-not-found.jsonl";case"CAPTCHA":return"captcha-failures.jsonl";case"BLOCKED":return"blocked-failures.jsonl";case"TIMEOUT":return"timeout-failures.jsonl";default:return"other-failures.jsonl"}}async insertToDb(e){this.client&&await this.client.insertFailure({task_id:e.taskId,slot_id:e.slotId,keyword:e.keyword,target_mid:e.targetMid,fail_reason:e.failReason,search_url:e.searchUrl,found_mids:e.foundMids,found_count:e.foundCount,engine_version:e.engineVersion,error_message:e.errorMessage})}readLogs(e){let t=e?this.getFilename(e):"all-failures.jsonl",r=bi.join(this.logDir,t);return At.existsSync(r)?At.readFileSync(r,"utf-8").trim().split(`
`).filter(Boolean).map(o=>{try{return JSON.parse(o)}catch{return null}}).filter(o=>o!==null):[]}getStats(){let e=this.readLogs(),t={total:e.length};for(let r of e)t[r.failReason]=(t[r.failReason]||0)+1;return t}},lh=null});var vy,_y=E(()=>{vy={version:"v7",deviceName:"Samsung Galaxy S23",userAgent:"Mozilla/5.0 (Linux; Android 13; SM-S911N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Mobile Safari/537.36",viewport:{width:360,height:800,deviceScaleFactor:3},platform:"Linux armv8l",webgl:{vendor:"Qualcomm",renderer:"Adreno (TM) 740"},deviceMemory:8,hardwareConcurrency:8,maxTouchPoints:10,headers:{"accept-language":"ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7","sec-ch-ua":'"Google Chrome";v="131", "Chromium";v="131", "Not_A Brand";v="24"',"sec-ch-ua-mobile":"?1","sec-ch-ua-platform":'"Android"'},timezone:"Asia/Seoul",languages:["ko-KR","ko","en-US","en"],colorDepth:24}});var Sy,QS,ko,Ey=E(()=>{"use strict";Sy=require("puppeteer-real-browser");eu();by();QS=["cr.shopping.naver.com/bridge","cr2.shopping.naver.com/bridge","cr3.shopping.naver.com/bridge","cr4.shopping.naver.com/bridge","shopping.naver.com/bridge","naver.com/v2/bridge","/bridge?"],ko=class{browser=null;page=null;async init(){let{browser:e,page:t}=await(0,Sy.connect)({headless:!1,turnstile:!0});this.browser=e,this.page=t,this.page.setDefaultTimeout(3e4),this.page.setDefaultNavigationTimeout(3e4),console.log("[v7-simple] No profile applied (PC mode)")}async close(){try{this.page&&await this.page.close().catch(()=>{}),this.browser&&await this.browser.close().catch(()=>{})}catch{}this.browser=null,this.page=null}async execute(e){let t=Date.now();if(!this.page)return{success:!1,version:"v7-simple",blocked:!1,bridgeDetected:!1,midClicked:!1,error:"Browser not initialized"};try{await this.page.goto("https://m.naver.com/",{waitUntil:"domcontentloaded"}),await this.delay(1500+Math.random()*1e3);let r=e.productName.substring(0,50);if(!await this.page.evaluate(d=>{let h=document.querySelector('input[type="search"], input[name="query"]');if(h){h.value=d,h.dispatchEvent(new Event("input",{bubbles:!0}));let g=h.closest("form");if(g)return g.submit(),!0}return!1},r))return{success:!1,version:"v7-simple",blocked:!1,bridgeDetected:!1,midClicked:!1,error:"Search input not found"};if(await this.page.waitForNavigation({waitUntil:"domcontentloaded",timeout:2e4}).catch(()=>{}),await this.delay(2500+Math.random()*1e3),await this.checkCaptcha())return await Ao().logCaptcha({taskId:e.taskId,slotId:e.slotId,keyword:e.keyword||e.productName,targetMid:e.nvMid,searchUrl:this.page.url(),engineVersion:"v7-simple",errorMessage:"\uD1B5\uD569\uAC80\uC0C9 CAPTCHA \uAC10\uC9C0"}),{success:!1,version:"v7-simple",blocked:!0,bridgeDetected:!1,midClicked:!1,error:"\uD1B5\uD569\uAC80\uC0C9 CAPTCHA",duration:Date.now()-t};for(let d=0;d<3;d++)await this.page.evaluate(()=>window.scrollBy(0,400)),await this.delay(500);let o=await this.clickDirectSmartStore(e.nvMid);console.log(`[v7-simple] clickDirectSmartStore: ${o}`),o||(o=await this.findAndClickMid(e.nvMid),console.log(`[v7-simple] findAndClickMid: ${o}`));let a=!1;if(o||(console.log("[v7-simple] 1\uCC28 \uC2DC\uB3C4 \uC2E4\uD328 \u2192 Fallback \uC804\uB7B5 \uC2DC\uC791"),o=await this.tryShoppingTabFallback(e),a=!0,console.log(`[v7-simple] Fallback result: ${o}`)),!o){let{mids:d,count:h}=await this.collectFoundMids();return await Ao().logMidNotFound({taskId:e.taskId,slotId:e.slotId,keyword:e.keyword||e.productName,targetMid:e.nvMid,searchUrl:this.page.url(),foundMids:d,foundCount:h,engineVersion:"v7-simple"}),{success:!1,version:"v7-simple",blocked:!1,bridgeDetected:!1,midClicked:!1,error:`MID ${e.nvMid} not found (both strategies failed)`,duration:Date.now()-t,foundMids:d,foundCount:h}}if(!a){try{await this.page.waitForNavigation({waitUntil:"domcontentloaded",timeout:1e4})}catch{}await this.delay(3e3);let d=this.page.url();if(console.log(`[v7-simple] Current URL after navigation: ${d.substring(0,100)}`),this.isBridgeUrl(d)){console.log("[v7-simple] Bridge URL detected, waiting for redirect...");for(let h=0;h<10;h++)if(await this.delay(1e3),d=this.page.url(),!this.isBridgeUrl(d)){console.log(`[v7-simple] Redirect completed to: ${d.substring(0,80)}`);break}}}await this.delay(1e3);let l=this.page.url();if(console.log(`[v7-simple] Final URL for validation: ${l.substring(0,100)}`),!(l.includes("/catalog/")||l.includes("/products/")||l.includes("smartstore.naver.com")||l.includes("brand.naver.com")))return{success:!1,version:"v7-simple",blocked:!1,bridgeDetected:!1,midClicked:!0,error:"Not a product page",duration:Date.now()-t};let u=await this.page.evaluate(d=>{let h=window.location.href;if(h.includes(d))return{found:!0,method:"URL",url:h};let g=document.querySelectorAll("[data-nv-mid], [data-nvmid], [data-product-id]");for(let v of Array.from(g))if((v.getAttribute("data-nv-mid")||v.getAttribute("data-nvmid")||v.getAttribute("data-product-id"))===d)return{found:!0,method:"data-attr",url:h};let y=document.querySelectorAll('meta[property*="product"], meta[name*="product"]');for(let v of Array.from(y))if((v.getAttribute("content")||"").includes(d))return{found:!0,method:"meta",url:h};let _=document.body.innerText,b=_.includes("\uBCF4\uC548 \uD655\uC778")||_.includes("\uC77C\uC2DC\uC801\uC73C\uB85C \uC81C\uD55C")||_.includes("\uBE44\uC815\uC0C1\uC801\uC778 \uC811\uADFC");return{found:!1,url:h,bodyPreview:_.substring(0,200),isBlocked:b}},e.nvMid),f=u.found;return u.isBlocked?(await Ao().logBlocked({taskId:e.taskId,slotId:e.slotId,keyword:e.keyword||e.productName,targetMid:e.nvMid,searchUrl:this.page.url(),engineVersion:"v7-simple",errorMessage:`Blocked after click - ${u.bodyPreview?.substring(0,100)}`}),{success:!1,version:"v7-simple",blocked:!0,bridgeDetected:!1,midClicked:!0,error:`Blocked after click - ${u.bodyPreview?.substring(0,50)}`,duration:Date.now()-t}):(f||console.log(`[v7-simple] WARNING: MID mismatch - expected ${e.nvMid}, got ${u.url?.substring(0,80)}`),await this.delay(2e3),{success:!0,version:"v7-simple",blocked:!1,bridgeDetected:!1,midClicked:!0,duration:Date.now()-t})}catch(r){return{success:!1,version:"v7-simple",blocked:!1,bridgeDetected:!1,midClicked:!1,error:r.message,duration:Date.now()-t}}}async checkCaptcha(){try{return await this.page.evaluate(()=>{let e=document.body.innerText,t=["\uBCF4\uC548 \uD655\uC778","\uC77C\uC2DC\uC801\uC73C\uB85C \uC81C\uD55C","\uBCF4\uC548 \uD655\uC778\uC744 \uC644\uB8CC\uD574 \uC8FC\uC138\uC694","\uC1FC\uD551 \uC11C\uBE44\uC2A4 \uC811\uC18D\uC774 \uC77C\uC2DC\uC801\uC73C\uB85C \uC81C\uD55C","\uC2E4\uC81C \uC0AC\uC6A9\uC790\uC784\uC744 \uD655\uC778","\uC790\uB3D9\uC785\uB825 \uBC29\uC9C0","\uBCF4\uC548\uBB38\uC790","\uC790\uB3D9\uB4F1\uB85D\uBC29\uC9C0","\uBE44\uC815\uC0C1\uC801\uC778 \uC811\uADFC"];for(let r of t)if(e.includes(r))return!0;return!!document.querySelector('[id*="captcha"], [class*="captcha"]')})}catch{return!1}}async clickDirectSmartStore(e){return await this.page.evaluate(t=>{let r=Array.from(document.querySelectorAll("a"));for(let i of r){let n=i.href||"";if(!(n.includes("/bridge")||n.includes("cr.shopping")||n.includes("cr2.shopping")||n.includes("cr3.shopping")||n.includes("cr4.shopping"))&&(n.includes("smartstore.naver.com")&&n.includes("/products/")&&n.includes(t)||n.includes("brand.naver.com")&&n.includes("/products/")&&n.includes(t)))return i.click(),!0}return!1},e)}async findAndClickMid(e){let t=await this.page.evaluate(r=>{let i=Array.from(document.querySelectorAll("a"));for(let n of i){let o=n.href||"";if(o.includes(r)||o.includes(`nvMid=${r}`))return{found:!0,href:o};if((n.getAttribute("data-nv-mid")||n.getAttribute("data-nvmid"))===r)return{found:!0,href:o}}return{found:!1}},e);return console.log("[v7-simple] findAndClickMid result:",t),t.found?(this.isBridgeUrl(t.href)&&console.log("[v7-simple] Bridge URL \uAC10\uC9C0, \uC9C1\uC811 \uD074\uB9AD (\uB9AC\uB2E4\uC774\uB809\uD2B8 \uB300\uAE30)"),await this.page.evaluate(r=>{let i=Array.from(document.querySelectorAll("a")).find(n=>n.href===r);i&&i.click()},t.href),!0):!1}async navigateViaCatalogUrl(e){let t=`https://search.shopping.naver.com/catalog/${e}`,r=await this.page.evaluate(i=>{try{let n=document.createElement("a");return n.href=i,n.target="_self",document.body.appendChild(n),n.click(),!0}catch{return!1}},t);return r&&(console.log(`[v7-simple] \u2705 Catalog URL\uB85C \uC774\uB3D9: ${t}`),await this.delay(3e3)),r}isBridgeUrl(e){return QS.some(t=>e.includes(t))}async avoidBridgeAndRetry(e){for(let r=0;r<3;r++){await this.delay(800);let i=this.page.url();if(this.isBridgeUrl(i)){console.log(`[v7-simple] \uBE0C\uB9BF\uC9C0 \uAC10\uC9C0 (${r+1}/3)`),await this.page.evaluate(()=>window.stop());try{await this.page.goBack({waitUntil:"domcontentloaded"})}catch{}if(await this.delay(1e3),await this.clickDirectSmartStore(e)){await this.delay(1500);let a=this.page.url();if(!this.isBridgeUrl(a))return{success:!0,detected:!0}}await this.findAndClickMid(e)&&await this.delay(1500)}else return{success:!0,detected:!1}}return{success:!1,detected:!0}}delay(e){return new Promise(t=>setTimeout(t,e))}async collectFoundMids(){if(!this.page)return{mids:[],count:0};try{return await this.page.evaluate(()=>{let e=[],t=Array.from(document.querySelectorAll("a"));for(let r of t){let i=r.href||"",n=i.match(/products\/(\d+)/);n&&!e.includes(n[1])&&e.push(n[1]);let o=i.match(/catalog\/(\d+)/);o&&!e.includes(o[1])&&e.push(o[1]);let a=r.getAttribute("data-nv-mid");a&&!e.includes(a)&&e.push(a);let l=r.getAttribute("data-nvmid");l&&!e.includes(l)&&e.push(l)}return{mids:e.slice(0,20),count:e.length}})}catch(e){return console.error("[v7-simple] collectFoundMids error:",e),{mids:[],count:0}}}async tryShoppingTabFallback(e){if(!this.page)return!1;try{console.log("[v7-simple] Fallback: \uC21C\uC704 \uCCB4\uD06C \uC2DC\uC2A4\uD15C\uC73C\uB85C MID \uAC80\uC0C9");let t=await Sn(this.page,e.keyword,e.nvMid,10);if(!t||!t.found)return console.log(`[v7-simple] MID ${e.nvMid} not found in shopping tab (10 pages)`),!1;console.log(`[v7-simple] MID found: Page ${t.page}, Rank ${t.totalRank}`),console.log(`[v7-simple] Already on page ${t.page}, attempting to click MID...`),await this.delay(2e3),console.log(`[v7-simple] Creating catalog link for MID ${e.nvMid}...`);let r=`https://search.shopping.naver.com/catalog/${e.nvMid}`;if(!await this.page.evaluate(o=>{try{let a=document.createElement("a");return a.href=o,a.target="_self",document.body.appendChild(a),a.click(),!0}catch{return!1}},r))return console.log("[v7-simple] Failed to create/click catalog link"),!1;console.log("[v7-simple] \u2705 Catalog link clicked, waiting for navigation..."),await this.delay(4e3);let n=this.page.url();return console.log(`[v7-simple] \u2705 Fallback success: Final URL: ${n.substring(0,80)}`),!0}catch(t){return console.log(`[v7-simple] Fallback error: ${t.message}`),!1}}}});var _i,Ty=E(()=>{"use strict";_i=class{static getConnectArgs(e){return["--no-sandbox","--disable-setuid-sandbox","--disable-blink-features=AutomationControlled",`--user-agent=${e.userAgent}`]}static async apply(e,t){await e.setViewport({width:t.viewport.width,height:t.viewport.height,deviceScaleFactor:t.viewport.deviceScaleFactor,isMobile:!0,hasTouch:!0}),await e.evaluateOnNewDocument(r=>{Object.defineProperty(navigator,"platform",{get:()=>r.platform}),Object.defineProperty(navigator,"hardwareConcurrency",{get:()=>r.hardwareConcurrency}),Object.defineProperty(navigator,"deviceMemory",{get:()=>r.deviceMemory}),Object.defineProperty(navigator,"maxTouchPoints",{get:()=>r.maxTouchPoints}),Object.defineProperty(navigator,"languages",{get:()=>r.languages});let i=WebGLRenderingContext.prototype.getParameter;if(WebGLRenderingContext.prototype.getParameter=function(n){return n===37445?r.webgl.vendor:n===37446?r.webgl.renderer:i.call(this,n)},typeof WebGL2RenderingContext<"u"){let n=WebGL2RenderingContext.prototype.getParameter;WebGL2RenderingContext.prototype.getParameter=function(o){return o===37445?r.webgl.vendor:o===37446?r.webgl.renderer:n.call(this,o)}}},t)}}});var Po,uh=E(()=>{Po={version:"v8",deviceName:"iPhone 15 Pro",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 17_2 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.2 Mobile/15E148 Safari/604.1",viewport:{width:393,height:852,deviceScaleFactor:3},platform:"iPhone",webgl:{vendor:"Apple Inc.",renderer:"Apple GPU"},deviceMemory:8,hardwareConcurrency:6,maxTouchPoints:5,headers:{"accept-language":"ko-KR,ko;q=0.9","sec-ch-ua":'"Not A(Brand";v="99", "Safari";v="17"',"sec-ch-ua-mobile":"?1","sec-ch-ua-platform":'"iOS"'},timezone:"Asia/Seoul",languages:["ko-KR","ko"],colorDepth:32}});var Ay,dh,xo,ky=E(()=>{"use strict";Ay=require("puppeteer-real-browser");Ty();uh();dh=Po,xo=class{browser=null;page=null;async init(){let{browser:e,page:t}=await(0,Ay.connect)({headless:!1,turnstile:!0,fingerprint:!0,args:_i.getConnectArgs(dh)});this.browser=e,this.page=t,await _i.apply(this.page,dh),this.page.setDefaultTimeout(3e4),this.page.setDefaultNavigationTimeout(3e4),console.log(`[v8-simple] Profile applied: ${dh.deviceName}`)}async close(){try{this.page&&await this.page.close().catch(()=>{}),this.browser&&await this.browser.close().catch(()=>{})}catch{}this.browser=null,this.page=null}async execute(e){let t=Date.now();if(!this.page)return{success:!1,version:"v8-simple",blocked:!1,bridgeDetected:!1,midClicked:!1,error:"Browser not initialized"};try{await this.page.goto("https://m.naver.com/",{waitUntil:"domcontentloaded"}),await this.delay(1500+Math.random()*1e3);let r=e.productName.substring(0,50);if(!await this.page.evaluate(f=>{let d=document.querySelector('input[type="search"], input[name="query"]');if(d){d.value=f,d.dispatchEvent(new Event("input",{bubbles:!0}));let h=d.closest("form");if(h)return h.submit(),!0}return!1},r))return{success:!1,version:"v8-simple",blocked:!1,bridgeDetected:!1,midClicked:!1,error:"Search input not found"};if(await this.page.waitForNavigation({waitUntil:"domcontentloaded",timeout:2e4}).catch(()=>{}),await this.delay(2500+Math.random()*1e3),await this.checkCaptcha())return{success:!1,version:"v8-simple",blocked:!0,bridgeDetected:!1,midClicked:!1,error:"\uD1B5\uD569\uAC80\uC0C9 CAPTCHA",duration:Date.now()-t};for(let f=0;f<3;f++)await this.page.evaluate(()=>window.scrollBy(0,400)),await this.delay(500);let o=await this.clickDirectSmartStore(e.nvMid);if(console.log(`[v8-simple] clickDirectSmartStore: ${o}`),o||(o=await this.findAndClickMid(e.nvMid),console.log(`[v8-simple] findAndClickMid: ${o}`)),!o)return{success:!1,version:"v8-simple",blocked:!1,bridgeDetected:!1,midClicked:!1,error:`MID ${e.nvMid} not found`,duration:Date.now()-t};try{await this.page.waitForNavigation({waitUntil:"domcontentloaded",timeout:1e4})}catch{}await this.delay(3e3),await this.delay(1e3);let a=this.page.url();if(!(a.includes("/catalog/")||a.includes("/products/")||a.includes("smartstore.naver.com")||a.includes("brand.naver.com")))return{success:!1,version:"v8-simple",blocked:!1,bridgeDetected:!1,midClicked:!0,error:"Not a product page",duration:Date.now()-t};let c=await this.page.evaluate(f=>{let d=window.location.href;if(d.includes(f))return{found:!0,method:"URL",url:d};let h=document.querySelectorAll("[data-nv-mid], [data-nvmid], [data-product-id]");for(let b of Array.from(h))if((b.getAttribute("data-nv-mid")||b.getAttribute("data-nvmid")||b.getAttribute("data-product-id"))===f)return{found:!0,method:"data-attr",url:d};let g=document.querySelectorAll('meta[property*="product"], meta[name*="product"]');for(let b of Array.from(g))if((b.getAttribute("content")||"").includes(f))return{found:!0,method:"meta",url:d};let y=document.body.innerText,_=y.includes("\uBCF4\uC548 \uD655\uC778")||y.includes("\uC77C\uC2DC\uC801\uC73C\uB85C \uC81C\uD55C")||y.includes("\uBE44\uC815\uC0C1\uC801\uC778 \uC811\uADFC");return{found:!1,url:d,bodyPreview:y.substring(0,200),isBlocked:_}},e.nvMid),u=c.found;return c.isBlocked?{success:!1,version:"v8-simple",blocked:!0,bridgeDetected:!1,midClicked:!0,error:`Blocked after click - ${c.bodyPreview?.substring(0,50)}`,duration:Date.now()-t}:(u||console.log(`[v8-simple] WARNING: MID mismatch - expected ${e.nvMid}, got ${c.url?.substring(0,80)}`),await this.delay(2e3),{success:!0,version:"v8-simple",blocked:!1,bridgeDetected:!1,midClicked:!0,duration:Date.now()-t})}catch(r){return{success:!1,version:"v8-simple",blocked:!1,bridgeDetected:!1,midClicked:!1,error:r.message,duration:Date.now()-t}}}async checkCaptcha(){try{return await this.page.evaluate(()=>{let e=document.body.innerText,t=["\uBCF4\uC548 \uD655\uC778","\uC77C\uC2DC\uC801\uC73C\uB85C \uC81C\uD55C","\uBCF4\uC548 \uD655\uC778\uC744 \uC644\uB8CC\uD574 \uC8FC\uC138\uC694","\uC1FC\uD551 \uC11C\uBE44\uC2A4 \uC811\uC18D\uC774 \uC77C\uC2DC\uC801\uC73C\uB85C \uC81C\uD55C","\uC2E4\uC81C \uC0AC\uC6A9\uC790\uC784\uC744 \uD655\uC778","\uC790\uB3D9\uC785\uB825 \uBC29\uC9C0","\uBCF4\uC548\uBB38\uC790","\uC790\uB3D9\uB4F1\uB85D\uBC29\uC9C0","\uBE44\uC815\uC0C1\uC801\uC778 \uC811\uADFC"];for(let r of t)if(e.includes(r))return!0;return!!document.querySelector('[id*="captcha"], [class*="captcha"]')})}catch{return!1}}async clickDirectSmartStore(e){return await this.page.evaluate(t=>{let r=Array.from(document.querySelectorAll("a"));for(let i of r){let n=i.href||"";if(!(n.includes("/bridge")||n.includes("cr.shopping")||n.includes("cr2.shopping")||n.includes("cr3.shopping")||n.includes("cr4.shopping"))&&(n.includes("smartstore.naver.com")&&n.includes("/products/")&&n.includes(t)||n.includes("brand.naver.com")&&n.includes("/products/")&&n.includes(t)))return i.click(),!0}return!1},e)}async findAndClickMid(e){let t=await this.page.evaluate(r=>{let i=Array.from(document.querySelectorAll("a"));for(let n of i){let o=n.href||"";if(o.includes(r)||o.includes(`nvMid=${r}`))return{found:!0,href:o};if((n.getAttribute("data-nv-mid")||n.getAttribute("data-nvmid"))===r)return{found:!0,href:o}}return{found:!1}},e);return console.log("[v8-simple] findAndClickMid result:",t),t.found?(await this.page.evaluate(r=>{let i=Array.from(document.querySelectorAll("a")).find(n=>n.href===r);i&&i.click()},t.href),!0):!1}delay(e){return new Promise(t=>setTimeout(t,e))}}});function C(s,e,t,r,i){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?s!==e||!i:!e.has(s))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?i.call(s,t):i?i.value=t:e.set(s,t),t}function w(s,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?s!==e||!r:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(s):r?r.value:e.get(s)}var Bt=E(()=>{});var hh,Py=E(()=>{hh=function(){let{crypto:s}=globalThis;if(s?.randomUUID)return hh=s.randomUUID.bind(s),s.randomUUID();let e=new Uint8Array(1),t=s?()=>s.getRandomValues(e)[0]:()=>Math.random()*255&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,r=>(+r^t()&15>>+r/4).toString(16))}});function Ft(s){return typeof s=="object"&&s!==null&&("name"in s&&s.name==="AbortError"||"message"in s&&String(s.message).includes("FetchRequestCanceledException"))}var vi,is=E(()=>{vi=s=>{if(s instanceof Error)return s;if(typeof s=="object"&&s!==null){try{if(Object.prototype.toString.call(s)==="[object Error]"){let e=new Error(s.message,s.cause?{cause:s.cause}:{});return s.stack&&(e.stack=s.stack),s.cause&&!e.cause&&(e.cause=s.cause),s.name&&(e.name=s.name),e}}catch{}try{return new Error(JSON.stringify(s))}catch{}}return new Error(s)}});var D,Ce,Oe,rr,ns,os,as,ls,cs,us,ds,hs,fs,ot=E(()=>{is();D=class extends Error{},Ce=class s extends D{constructor(e,t,r,i){super(`${s.makeMessage(e,t,r)}`),this.status=e,this.headers=i,this.requestID=i?.get("request-id"),this.error=t}static makeMessage(e,t,r){let i=t?.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):r;return e&&i?`${e} ${i}`:e?`${e} status code (no body)`:i||"(no status code or body)"}static generate(e,t,r,i){if(!e||!i)return new rr({message:r,cause:vi(t)});let n=t;return e===400?new os(e,n,r,i):e===401?new as(e,n,r,i):e===403?new ls(e,n,r,i):e===404?new cs(e,n,r,i):e===409?new us(e,n,r,i):e===422?new ds(e,n,r,i):e===429?new hs(e,n,r,i):e>=500?new fs(e,n,r,i):new s(e,n,r,i)}},Oe=class extends Ce{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}},rr=class extends Ce{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}},ns=class extends rr{constructor({message:e}={}){super({message:e??"Request timed out."})}},os=class extends Ce{},as=class extends Ce{},ls=class extends Ce{},cs=class extends Ce{},us=class extends Ce{},ds=class extends Ce{},hs=class extends Ce{},fs=class extends Ce{}});function Co(s){return typeof s!="object"?{}:s??{}}function Cy(s){if(!s)return!0;for(let e in s)return!1;return!0}function Ry(s,e){return Object.prototype.hasOwnProperty.call(s,e)}var XS,xy,fh,ph,Oy,Ro,_r=E(()=>{ot();XS=/^[a-z][a-z0-9+.-]*:/i,xy=s=>XS.test(s),fh=s=>(fh=Array.isArray,fh(s)),ph=fh;Oy=(s,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new D(`${s} must be an integer`);if(e<0)throw new D(`${s} must be a positive integer`);return e},Ro=s=>{try{return JSON.parse(s)}catch{return}}});var Ny,$y=E(()=>{Ny=s=>new Promise(e=>setTimeout(e,s))});var sr,mh=E(()=>{sr="0.71.0"});function YS(){return typeof Deno<"u"&&Deno.build!=null?"deno":typeof EdgeRuntime<"u"?"edge":Object.prototype.toString.call(typeof globalThis.process<"u"?globalThis.process:0)==="[object process]"?"node":"unknown"}function eE(){if(typeof navigator>"u"||!navigator)return null;let s=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(let{key:e,pattern:t}of s){let r=t.exec(navigator.userAgent);if(r){let i=r[1]||0,n=r[2]||0,o=r[3]||0;return{browser:e,version:`${i}.${n}.${o}`}}}return null}var jy,ZS,Iy,My,Dy,Ly,gh=E(()=>{mh();jy=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u";ZS=()=>{let s=YS();if(s==="deno")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":sr,"X-Stainless-OS":My(Deno.build.os),"X-Stainless-Arch":Iy(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:Deno.version?.deno??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":sr,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if(s==="node")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":sr,"X-Stainless-OS":My(globalThis.process.platform??"unknown"),"X-Stainless-Arch":Iy(globalThis.process.arch??"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":globalThis.process.version??"unknown"};let e=eE();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":sr,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":sr,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};Iy=s=>s==="x32"?"x32":s==="x86_64"||s==="x64"?"x64":s==="arm"?"arm":s==="aarch64"||s==="arm64"?"arm64":s?`other:${s}`:"unknown",My=s=>(s=s.toLowerCase(),s.includes("ios")?"iOS":s==="android"?"Android":s==="darwin"?"MacOS":s==="win32"?"Windows":s==="freebsd"?"FreeBSD":s==="openbsd"?"OpenBSD":s==="linux"?"Linux":s?`Other:${s}`:"Unknown"),Ly=()=>Dy??(Dy=ZS())});function qy(){if(typeof fetch<"u")return fetch;throw new Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new Anthropic({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}function yh(...s){let e=globalThis.ReadableStream;if(typeof e>"u")throw new Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new e(...s)}function Oo(s){let e=Symbol.asyncIterator in s?s[Symbol.asyncIterator]():s[Symbol.iterator]();return yh({start(){},async pull(t){let{done:r,value:i}=await e.next();r?t.close():t.enqueue(i)},async cancel(){await e.return?.()}})}function Si(s){if(s[Symbol.asyncIterator])return s;let e=s.getReader();return{async next(){try{let t=await e.read();return t?.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){let t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}async function Uy(s){if(s===null||typeof s!="object")return;if(s[Symbol.asyncIterator]){await s[Symbol.asyncIterator]().return?.();return}let e=s.getReader(),t=e.cancel();e.releaseLock(),await t}var ps=E(()=>{});var By,Fy=E(()=>{By=({headers:s,body:e})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(e)})});function Ky(s){let e=0;for(let i of s)e+=i.length;let t=new Uint8Array(e),r=0;for(let i of s)t.set(i,r),r+=i.length;return t}function Ei(s){let e;return(Vy??(e=new globalThis.TextEncoder,Vy=e.encode.bind(e)))(s)}function wh(s){let e;return(Hy??(e=new globalThis.TextDecoder,Hy=e.decode.bind(e)))(s)}var Vy,Hy,bh=E(()=>{});function sE(s,e){for(let i=e??0;i<s.length;i++){if(s[i]===10)return{preceding:i,index:i+1,carriage:!1};if(s[i]===13)return{preceding:i,index:i+1,carriage:!0}}return null}function zy(s){for(let r=0;r<s.length-1;r++){if(s[r]===10&&s[r+1]===10||s[r]===13&&s[r+1]===13)return r+2;if(s[r]===13&&s[r+1]===10&&r+3<s.length&&s[r+2]===13&&s[r+3]===10)return r+4}return-1}var Ye,Ze,Vt,_h=E(()=>{Bt();bh();Vt=class{constructor(){Ye.set(this,void 0),Ze.set(this,void 0),C(this,Ye,new Uint8Array,"f"),C(this,Ze,null,"f")}decode(e){if(e==null)return[];let t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?Ei(e):e;C(this,Ye,Ky([w(this,Ye,"f"),t]),"f");let r=[],i;for(;(i=sE(w(this,Ye,"f"),w(this,Ze,"f")))!=null;){if(i.carriage&&w(this,Ze,"f")==null){C(this,Ze,i.index,"f");continue}if(w(this,Ze,"f")!=null&&(i.index!==w(this,Ze,"f")+1||i.carriage)){r.push(wh(w(this,Ye,"f").subarray(0,w(this,Ze,"f")-1))),C(this,Ye,w(this,Ye,"f").subarray(w(this,Ze,"f")),"f"),C(this,Ze,null,"f");continue}let n=w(this,Ze,"f")!==null?i.preceding-1:i.preceding,o=wh(w(this,Ye,"f").subarray(0,n));r.push(o),C(this,Ye,w(this,Ye,"f").subarray(i.index),"f"),C(this,Ze,null,"f")}return r}flush(){return w(this,Ye,"f").length?this.decode(`
`):[]}};Ye=new WeakMap,Ze=new WeakMap;Vt.NEWLINE_CHARS=new Set([`
`,"\r"]);Vt.NEWLINE_REGEXP=/\r\n|[\n\r]/g});function Ti(){}function No(s,e,t){return!e||$o[s]>$o[t]?Ti:e[s].bind(e)}function Re(s){let e=s.logger,t=s.logLevel??"off";if(!e)return iE;let r=Wy.get(e);if(r&&r[0]===t)return r[1];let i={error:No("error",e,t),warn:No("warn",e,t),info:No("info",e,t),debug:No("debug",e,t)};return Wy.set(e,[t,i]),i}var $o,vh,iE,Wy,Ht,Io=E(()=>{_r();$o={off:0,error:200,warn:300,info:400,debug:500},vh=(s,e,t)=>{if(s){if(Ry($o,s))return s;Re(t).warn(`${e} was set to ${JSON.stringify(s)}, expected one of ${JSON.stringify(Object.keys($o))}`)}};iE={error:Ti,warn:Ti,info:Ti,debug:Ti},Wy=new WeakMap;Ht=s=>(s.options&&(s.options={...s.options},delete s.options.headers),s.headers&&(s.headers=Object.fromEntries((s.headers instanceof Headers?[...s.headers]:Object.entries(s.headers)).map(([e,t])=>[e,e.toLowerCase()==="x-api-key"||e.toLowerCase()==="authorization"||e.toLowerCase()==="cookie"||e.toLowerCase()==="set-cookie"?"***":t]))),"retryOfRequestLogID"in s&&(s.retryOfRequestLogID&&(s.retryOf=s.retryOfRequestLogID),delete s.retryOfRequestLogID),s)});async function*nE(s,e){if(!s.body)throw e.abort(),typeof globalThis.navigator<"u"&&globalThis.navigator.product==="ReactNative"?new D("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api"):new D("Attempted to iterate over a response with no body");let t=new Sh,r=new Vt,i=Si(s.body);for await(let n of oE(i))for(let o of r.decode(n)){let a=t.decode(o);a&&(yield a)}for(let n of r.flush()){let o=t.decode(n);o&&(yield o)}}async function*oE(s){let e=new Uint8Array;for await(let t of s){if(t==null)continue;let r=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?Ei(t):t,i=new Uint8Array(e.length+r.length);i.set(e),i.set(r,e.length),e=i;let n;for(;(n=zy(e))!==-1;)yield e.slice(0,n),e=e.slice(n)}e.length>0&&(yield e)}function aE(s,e){let t=s.indexOf(e);return t!==-1?[s.substring(0,t),e,s.substring(t+e.length)]:[s,"",""]}var Ai,kt,Sh,Eh=E(()=>{Bt();ot();ps();_h();ps();is();_r();bh();Io();ot();kt=class s{constructor(e,t,r){this.iterator=e,Ai.set(this,void 0),this.controller=t,C(this,Ai,r,"f")}static fromSSEResponse(e,t,r){let i=!1,n=r?Re(r):console;async function*o(){if(i)throw new D("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");i=!0;let a=!1;try{for await(let l of nE(e,t)){if(l.event==="completion")try{yield JSON.parse(l.data)}catch(c){throw n.error("Could not parse message into JSON:",l.data),n.error("From chunk:",l.raw),c}if(l.event==="message_start"||l.event==="message_delta"||l.event==="message_stop"||l.event==="content_block_start"||l.event==="content_block_delta"||l.event==="content_block_stop")try{yield JSON.parse(l.data)}catch(c){throw n.error("Could not parse message into JSON:",l.data),n.error("From chunk:",l.raw),c}if(l.event!=="ping"&&l.event==="error")throw new Ce(void 0,Ro(l.data)??l.data,void 0,e.headers)}a=!0}catch(l){if(Ft(l))return;throw l}finally{a||t.abort()}}return new s(o,t,r)}static fromReadableStream(e,t,r){let i=!1;async function*n(){let a=new Vt,l=Si(e);for await(let c of l)for(let u of a.decode(c))yield u;for(let c of a.flush())yield c}async function*o(){if(i)throw new D("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");i=!0;let a=!1;try{for await(let l of n())a||l&&(yield JSON.parse(l));a=!0}catch(l){if(Ft(l))return;throw l}finally{a||t.abort()}}return new s(o,t,r)}[(Ai=new WeakMap,Symbol.asyncIterator)](){return this.iterator()}tee(){let e=[],t=[],r=this.iterator(),i=n=>({next:()=>{if(n.length===0){let o=r.next();e.push(o),t.push(o)}return n.shift()}});return[new s(()=>i(e),this.controller,w(this,Ai,"f")),new s(()=>i(t),this.controller,w(this,Ai,"f"))]}toReadableStream(){let e=this,t;return yh({async start(){t=e[Symbol.asyncIterator]()},async pull(r){try{let{value:i,done:n}=await t.next();if(n)return r.close();let o=Ei(JSON.stringify(i)+`
`);r.enqueue(o)}catch(i){r.error(i)}},async cancel(){await t.return?.()}})}};Sh=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let n={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],n}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,r,i]=aE(e,":");return i.startsWith(" ")&&(i=i.substring(1)),t==="event"?this.event=i:t==="data"&&this.data.push(i),null}}});async function Mo(s,e){let{response:t,requestLogID:r,retryOfRequestLogID:i,startTime:n}=e,o=await(async()=>{if(e.options.stream)return Re(s).debug("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller):kt.fromSSEResponse(t,e.controller);if(t.status===204)return null;if(e.options.__binaryResponse)return t;let l=t.headers.get("content-type")?.split(";")[0]?.trim();if(l?.includes("application/json")||l?.endsWith("+json")){let f=await t.json();return Th(f,t)}return await t.text()})();return Re(s).debug(`[${r}] response parsed`,Ht({retryOfRequestLogID:i,url:t.url,status:t.status,body:o,durationMs:Date.now()-n})),o}function Th(s,e){return!s||typeof s!="object"||Array.isArray(s)?s:Object.defineProperty(s,"_request_id",{value:e.headers.get("request-id"),enumerable:!1})}var Ah=E(()=>{Eh();Io()});var ki,vr,Do=E(()=>{Bt();Ah();vr=class s extends Promise{constructor(e,t,r=Mo){super(i=>{i(null)}),this.responsePromise=t,this.parseResponse=r,ki.set(this,void 0),C(this,ki,e,"f")}_thenUnwrap(e){return new s(w(this,ki,"f"),this.responsePromise,async(t,r)=>Th(e(await this.parseResponse(t,r),r),r.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(w(this,ki,"f"),e))),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}};ki=new WeakMap});var jo,Lo,Pi,at,ms,Pt=E(()=>{Bt();ot();Ah();Do();_r();Lo=class{constructor(e,t,r,i){jo.set(this,void 0),C(this,jo,e,"f"),this.options=i,this.response=t,this.body=r}hasNextPage(){return this.getPaginatedItems().length?this.nextPageRequestOptions()!=null:!1}async getNextPage(){let e=this.nextPageRequestOptions();if(!e)throw new D("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await w(this,jo,"f").requestAPIList(this.constructor,e)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(jo=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}},Pi=class extends vr{constructor(e,t,r){super(e,t,async(i,n)=>new r(i,n.response,await Mo(i,n),n.options))}async*[Symbol.asyncIterator](){let e=await this;for await(let t of e)yield t}},at=class extends Lo{constructor(e,t,r,i){super(e,t,r,i),this.data=r.data||[],this.has_more=r.has_more||!1,this.first_id=r.first_id||null,this.last_id=r.last_id||null}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){if(this.options.query?.before_id){let t=this.first_id;return t?{...this.options,query:{...Co(this.options.query),before_id:t}}:null}let e=this.last_id;return e?{...this.options,query:{...Co(this.options.query),after_id:e}}:null}},ms=class extends Lo{constructor(e,t,r,i){super(e,t,r,i),this.data=r.data||[],this.has_more=r.has_more||!1,this.next_page=r.next_page||null}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){let e=this.next_page;return e?{...this.options,query:{...Co(this.options.query),page:e}}:null}}});function Sr(s,e,t){return Ph(),new File(s,e??"unknown_file",t)}function xi(s){return(typeof s=="object"&&s!==null&&("name"in s&&s.name&&String(s.name)||"url"in s&&s.url&&String(s.url)||"filename"in s&&s.filename&&String(s.filename)||"path"in s&&s.path&&String(s.path))||"").split(/[\\/]/).pop()||void 0}function cE(s){let e=typeof s=="function"?s:s.fetch,t=Qy.get(e);if(t)return t;let r=(async()=>{try{let i="Response"in e?e.Response:(await e("data:,")).constructor,n=new FormData;return n.toString()!==await new i(n).text()}catch{return!0}})();return Qy.set(e,r),r}var Ph,xh,gs,Qy,uE,dE,kh,ys=E(()=>{ps();Ph=()=>{if(typeof File>"u"){let{process:s}=globalThis,e=typeof s?.versions?.node=="string"&&parseInt(s.versions.node.split("."))<20;throw new Error("`File` is not defined as a global, which is required for file uploads."+(e?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};xh=s=>s!=null&&typeof s=="object"&&typeof s[Symbol.asyncIterator]=="function",gs=async(s,e)=>({...s,body:await uE(s.body,e)}),Qy=new WeakMap;uE=async(s,e)=>{if(!await cE(e))throw new TypeError("The provided fetch function does not support file uploads with the current global FormData class.");let t=new FormData;return await Promise.all(Object.entries(s||{}).map(([r,i])=>kh(t,r,i))),t},dE=s=>s instanceof Blob&&"name"in s,kh=async(s,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")s.append(e,String(t));else if(t instanceof Response){let r={},i=t.headers.get("Content-Type");i&&(r={type:i}),s.append(e,Sr([await t.blob()],xi(t),r))}else if(xh(t))s.append(e,Sr([await new Response(Oo(t)).blob()],xi(t)));else if(dE(t))s.append(e,Sr([t],xi(t),{type:t.type}));else if(Array.isArray(t))await Promise.all(t.map(r=>kh(s,e+"[]",r)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([r,i])=>kh(s,`${e}[${r}]`,i)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}}});async function qo(s,e,t){if(Ph(),s=await s,e||(e=xi(s)),hE(s))return s instanceof File&&e==null&&t==null?s:Sr([await s.arrayBuffer()],e??s.name,{type:s.type,lastModified:s.lastModified,...t});if(fE(s)){let i=await s.blob();return e||(e=new URL(s.url).pathname.split(/[\\/]/).pop()),Sr(await Ch(i),e,t)}let r=await Ch(s);if(!t?.type){let i=r.find(n=>typeof n=="object"&&"type"in n&&n.type);typeof i=="string"&&(t={...t,type:i})}return Sr(r,e,t)}async function Ch(s){let e=[];if(typeof s=="string"||ArrayBuffer.isView(s)||s instanceof ArrayBuffer)e.push(s);else if(Jy(s))e.push(s instanceof Blob?s:await s.arrayBuffer());else if(xh(s))for await(let t of s)e.push(...await Ch(t));else{let t=s?.constructor?.name;throw new Error(`Unexpected data type: ${typeof s}${t?`; constructor: ${t}`:""}${pE(s)}`)}return e}function pE(s){return typeof s!="object"||s===null?"":`; props: [${Object.getOwnPropertyNames(s).map(t=>`"${t}"`).join(", ")}]`}var Jy,hE,fE,Gy=E(()=>{ys();ys();Jy=s=>s!=null&&typeof s=="object"&&typeof s.size=="number"&&typeof s.type=="string"&&typeof s.text=="function"&&typeof s.slice=="function"&&typeof s.arrayBuffer=="function",hE=s=>s!=null&&typeof s=="object"&&typeof s.name=="string"&&typeof s.lastModified=="number"&&Jy(s),fE=s=>s!=null&&typeof s=="object"&&typeof s.url=="string"&&typeof s.blob=="function"});var Rh=E(()=>{Gy()});var Xy=E(()=>{});var pe,lt=E(()=>{pe=class{constructor(e){this._client=e}}});function*gE(s){if(!s)return;if(Yy in s){let{values:r,nulls:i}=s;yield*r.entries();for(let n of i)yield[n,null];return}let e=!1,t;s instanceof Headers?t=s.entries():ph(s)?t=s:(e=!0,t=Object.entries(s??{}));for(let r of t){let i=r[0];if(typeof i!="string")throw new TypeError("expected header name to be a string");let n=ph(r[1])?r[1]:[r[1]],o=!1;for(let a of n)a!==void 0&&(e&&!o&&(o=!0,yield[i,null]),yield[i,a])}}var Yy,q,ct=E(()=>{_r();Yy=Symbol.for("brand.privateNullableHeaders");q=s=>{let e=new Headers,t=new Set;for(let r of s){let i=new Set;for(let[n,o]of gE(r)){let a=n.toLowerCase();i.has(a)||(e.delete(n),i.add(a)),o===null?(e.delete(n),t.add(a)):(e.append(n,o),t.delete(a))}}return{[Yy]:!0,values:e,nulls:t}}});function ew(s){return s.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}var Zy,yE,me,ir=E(()=>{ot();Zy=Object.freeze(Object.create(null)),yE=(s=ew)=>function(t,...r){if(t.length===1)return t[0];let i=!1,n=[],o=t.reduce((u,f,d)=>{/[?#]/.test(f)&&(i=!0);let h=r[d],g=(i?encodeURIComponent:s)(""+h);return d!==r.length&&(h==null||typeof h=="object"&&h.toString===Object.getPrototypeOf(Object.getPrototypeOf(h.hasOwnProperty??Zy)??Zy)?.toString)&&(g=h+"",n.push({start:u.length+f.length,length:g.length,error:`Value of type ${Object.prototype.toString.call(h).slice(8,-1)} is not a valid path parameter`})),u+f+(d===r.length?"":g)},""),a=o.split(/[?#]/,1)[0],l=/(?<=^|\/)(?:\.|%2e){1,2}(?=\/|$)/gi,c;for(;(c=l.exec(a))!==null;)n.push({start:c.index,length:c[0].length,error:`Value "${c[0]}" can't be safely passed as a path parameter`});if(n.sort((u,f)=>u.start-f.start),n.length>0){let u=0,f=n.reduce((d,h)=>{let g=" ".repeat(h.start-u),y="^".repeat(h.length);return u=h.start+h.length,d+g+y},"");throw new D(`Path parameters result in path with invalid segments:
${n.map(d=>d.error).join(`
`)}
${o}
${f}`)}return o},me=yE(ew)});var ws,Oh=E(()=>{lt();Pt();ct();ys();ir();ws=class extends pe{list(e={},t){let{betas:r,...i}=e??{};return this._client.getAPIList("/v1/files",at,{query:i,...t,headers:q([{"anthropic-beta":[...r??[],"files-api-2025-04-14"].toString()},t?.headers])})}delete(e,t={},r){let{betas:i}=t??{};return this._client.delete(me`/v1/files/${e}`,{...r,headers:q([{"anthropic-beta":[...i??[],"files-api-2025-04-14"].toString()},r?.headers])})}download(e,t={},r){let{betas:i}=t??{};return this._client.get(me`/v1/files/${e}/content`,{...r,headers:q([{"anthropic-beta":[...i??[],"files-api-2025-04-14"].toString(),Accept:"application/binary"},r?.headers]),__binaryResponse:!0})}retrieveMetadata(e,t={},r){let{betas:i}=t??{};return this._client.get(me`/v1/files/${e}`,{...r,headers:q([{"anthropic-beta":[...i??[],"files-api-2025-04-14"].toString()},r?.headers])})}upload(e,t){let{betas:r,...i}=e;return this._client.post("/v1/files",gs({body:i,...t,headers:q([{"anthropic-beta":[...r??[],"files-api-2025-04-14"].toString()},t?.headers])},this._client))}}});var bs,Nh=E(()=>{lt();Pt();ct();ir();bs=class extends pe{retrieve(e,t={},r){let{betas:i}=t??{};return this._client.get(me`/v1/models/${e}?beta=true`,{...r,headers:q([{...i?.toString()!=null?{"anthropic-beta":i?.toString()}:void 0},r?.headers])})}list(e={},t){let{betas:r,...i}=e??{};return this._client.getAPIList("/v1/models?beta=true",at,{query:i,...t,headers:q([{...r?.toString()!=null?{"anthropic-beta":r?.toString()}:void 0},t?.headers])})}}});var Uo,$h=E(()=>{Uo={"claude-opus-4-20250514":8192,"claude-opus-4-0":8192,"claude-4-opus-20250514":8192,"anthropic.claude-opus-4-20250514-v1:0":8192,"claude-opus-4@20250514":8192,"claude-opus-4-1-20250805":8192,"anthropic.claude-opus-4-1-20250805-v1:0":8192,"claude-opus-4-1@20250805":8192}});function Ih(s,e){return!e||!("parse"in(e.output_format??{}))?{...s,content:s.content.map(t=>t.type==="text"?{...t,parsed:null}:t),parsed_output:null}:Mh(s,e)}function Mh(s,e){let t=null,r=s.content.map(i=>{if(i.type==="text"){let n=_E(e,i.text);return t===null&&(t=n),{...i,parsed:n}}return i});return{...s,content:r,parsed_output:t}}function _E(s,e){if(s.output_format?.type!=="json_schema")return null;try{return"parse"in s.output_format?s.output_format.parse(e):JSON.parse(e)}catch(t){throw new D(`Failed to parse structured output: ${t}`)}}var Dh=E(()=>{ot()});var vE,_s,SE,EE,Bo,jh=E(()=>{vE=s=>{let e=0,t=[];for(;e<s.length;){let r=s[e];if(r==="\\"){e++;continue}if(r==="{"){t.push({type:"brace",value:"{"}),e++;continue}if(r==="}"){t.push({type:"brace",value:"}"}),e++;continue}if(r==="["){t.push({type:"paren",value:"["}),e++;continue}if(r==="]"){t.push({type:"paren",value:"]"}),e++;continue}if(r===":"){t.push({type:"separator",value:":"}),e++;continue}if(r===","){t.push({type:"delimiter",value:","}),e++;continue}if(r==='"'){let a="",l=!1;for(r=s[++e];r!=='"';){if(e===s.length){l=!0;break}if(r==="\\"){if(e++,e===s.length){l=!0;break}a+=r+s[e],r=s[++e]}else a+=r,r=s[++e]}r=s[++e],l||t.push({type:"string",value:a});continue}if(r&&/\s/.test(r)){e++;continue}let n=/[0-9]/;if(r&&n.test(r)||r==="-"||r==="."){let a="";for(r==="-"&&(a+=r,r=s[++e]);r&&n.test(r)||r===".";)a+=r,r=s[++e];t.push({type:"number",value:a});continue}let o=/[a-z]/i;if(r&&o.test(r)){let a="";for(;r&&o.test(r)&&e!==s.length;)a+=r,r=s[++e];if(a=="true"||a=="false"||a==="null")t.push({type:"name",value:a});else{e++;continue}continue}e++}return t},_s=s=>{if(s.length===0)return s;let e=s[s.length-1];switch(e.type){case"separator":return s=s.slice(0,s.length-1),_s(s);break;case"number":let t=e.value[e.value.length-1];if(t==="."||t==="-")return s=s.slice(0,s.length-1),_s(s);case"string":let r=s[s.length-2];if(r?.type==="delimiter")return s=s.slice(0,s.length-1),_s(s);if(r?.type==="brace"&&r.value==="{")return s=s.slice(0,s.length-1),_s(s);break;case"delimiter":return s=s.slice(0,s.length-1),_s(s);break}return s},SE=s=>{let e=[];return s.map(t=>{t.type==="brace"&&(t.value==="{"?e.push("}"):e.splice(e.lastIndexOf("}"),1)),t.type==="paren"&&(t.value==="["?e.push("]"):e.splice(e.lastIndexOf("]"),1))}),e.length>0&&e.reverse().map(t=>{t==="}"?s.push({type:"brace",value:"}"}):t==="]"&&s.push({type:"paren",value:"]"})}),s},EE=s=>{let e="";return s.map(t=>{switch(t.type){case"string":e+='"'+t.value+'"';break;default:e+=t.value;break}}),e},Bo=s=>JSON.parse(EE(SE(_s(vE(s)))))});var Ci=E(()=>{ot()});var Lh=E(()=>{Eh()});function iw(s){return s.type==="tool_use"||s.type==="server_tool_use"||s.type==="mcp_tool_use"}var ut,nr,vs,Ri,Fo,Oi,Ni,Vo,$i,Kt,Ii,Ho,Ko,Ss,zo,Wo,qh,tw,Qo,Uh,Bh,Fh,rw,sw,Jo,nw=E(()=>{Bt();jh();Ci();is();Lh();Dh();sw="__json_buf";Jo=class s{constructor(e){ut.add(this),this.messages=[],this.receivedMessages=[],nr.set(this,void 0),vs.set(this,null),this.controller=new AbortController,Ri.set(this,void 0),Fo.set(this,()=>{}),Oi.set(this,()=>{}),Ni.set(this,void 0),Vo.set(this,()=>{}),$i.set(this,()=>{}),Kt.set(this,{}),Ii.set(this,!1),Ho.set(this,!1),Ko.set(this,!1),Ss.set(this,!1),zo.set(this,void 0),Wo.set(this,void 0),Qo.set(this,t=>{if(C(this,Ho,!0,"f"),Ft(t)&&(t=new Oe),t instanceof Oe)return C(this,Ko,!0,"f"),this._emit("abort",t);if(t instanceof D)return this._emit("error",t);if(t instanceof Error){let r=new D(t.message);return r.cause=t,this._emit("error",r)}return this._emit("error",new D(String(t)))}),C(this,Ri,new Promise((t,r)=>{C(this,Fo,t,"f"),C(this,Oi,r,"f")}),"f"),C(this,Ni,new Promise((t,r)=>{C(this,Vo,t,"f"),C(this,$i,r,"f")}),"f"),w(this,Ri,"f").catch(()=>{}),w(this,Ni,"f").catch(()=>{}),C(this,vs,e,"f")}get response(){return w(this,zo,"f")}get request_id(){return w(this,Wo,"f")}async withResponse(){let e=await w(this,Ri,"f");if(!e)throw new Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){let t=new s(null);return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,r){let i=new s(t);for(let n of t.messages)i._addMessageParam(n);return C(i,vs,{...t,stream:!0},"f"),i._run(()=>i._createMessage(e,{...t,stream:!0},{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),i}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},w(this,Qo,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,r){let i=r?.signal,n;i&&(i.aborted&&this.controller.abort(),n=this.controller.abort.bind(this.controller),i.addEventListener("abort",n));try{w(this,ut,"m",Uh).call(this);let{response:o,data:a}=await e.create({...t,stream:!0},{...r,signal:this.controller.signal}).withResponse();this._connected(o);for await(let l of a)w(this,ut,"m",Bh).call(this,l);if(a.controller.signal?.aborted)throw new Oe;w(this,ut,"m",Fh).call(this)}finally{i&&n&&i.removeEventListener("abort",n)}}_connected(e){this.ended||(C(this,zo,e,"f"),C(this,Wo,e?.headers.get("request-id"),"f"),w(this,Fo,"f").call(this,e),this._emit("connect"))}get ended(){return w(this,Ii,"f")}get errored(){return w(this,Ho,"f")}get aborted(){return w(this,Ko,"f")}abort(){this.controller.abort()}on(e,t){return(w(this,Kt,"f")[e]||(w(this,Kt,"f")[e]=[])).push({listener:t}),this}off(e,t){let r=w(this,Kt,"f")[e];if(!r)return this;let i=r.findIndex(n=>n.listener===t);return i>=0&&r.splice(i,1),this}once(e,t){return(w(this,Kt,"f")[e]||(w(this,Kt,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{C(this,Ss,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,t)})}async done(){C(this,Ss,!0,"f"),await w(this,Ni,"f")}get currentMessage(){return w(this,nr,"f")}async finalMessage(){return await this.done(),w(this,ut,"m",qh).call(this)}async finalText(){return await this.done(),w(this,ut,"m",tw).call(this)}_emit(e,...t){if(w(this,Ii,"f"))return;e==="end"&&(C(this,Ii,!0,"f"),w(this,Vo,"f").call(this));let r=w(this,Kt,"f")[e];if(r&&(w(this,Kt,"f")[e]=r.filter(i=>!i.once),r.forEach(({listener:i})=>i(...t))),e==="abort"){let i=t[0];!w(this,Ss,"f")&&!r?.length&&Promise.reject(i),w(this,Oi,"f").call(this,i),w(this,$i,"f").call(this,i),this._emit("end");return}if(e==="error"){let i=t[0];!w(this,Ss,"f")&&!r?.length&&Promise.reject(i),w(this,Oi,"f").call(this,i),w(this,$i,"f").call(this,i),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",w(this,ut,"m",qh).call(this))}async _fromReadableStream(e,t){let r=t?.signal,i;r&&(r.aborted&&this.controller.abort(),i=this.controller.abort.bind(this.controller),r.addEventListener("abort",i));try{w(this,ut,"m",Uh).call(this),this._connected(null);let n=kt.fromReadableStream(e,this.controller);for await(let o of n)w(this,ut,"m",Bh).call(this,o);if(n.controller.signal?.aborted)throw new Oe;w(this,ut,"m",Fh).call(this)}finally{r&&i&&r.removeEventListener("abort",i)}}[(nr=new WeakMap,vs=new WeakMap,Ri=new WeakMap,Fo=new WeakMap,Oi=new WeakMap,Ni=new WeakMap,Vo=new WeakMap,$i=new WeakMap,Kt=new WeakMap,Ii=new WeakMap,Ho=new WeakMap,Ko=new WeakMap,Ss=new WeakMap,zo=new WeakMap,Wo=new WeakMap,Qo=new WeakMap,ut=new WeakSet,qh=function(){if(this.receivedMessages.length===0)throw new D("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},tw=function(){if(this.receivedMessages.length===0)throw new D("stream ended without producing a Message with role=assistant");let t=this.receivedMessages.at(-1).content.filter(r=>r.type==="text").map(r=>r.text);if(t.length===0)throw new D("stream ended without producing a content block with type=text");return t.join(" ")},Uh=function(){this.ended||C(this,nr,void 0,"f")},Bh=function(t){if(this.ended)return;let r=w(this,ut,"m",rw).call(this,t);switch(this._emit("streamEvent",t,r),t.type){case"content_block_delta":{let i=r.content.at(-1);switch(t.delta.type){case"text_delta":{i.type==="text"&&this._emit("text",t.delta.text,i.text||"");break}case"citations_delta":{i.type==="text"&&this._emit("citation",t.delta.citation,i.citations??[]);break}case"input_json_delta":{iw(i)&&i.input&&this._emit("inputJson",t.delta.partial_json,i.input);break}case"thinking_delta":{i.type==="thinking"&&this._emit("thinking",t.delta.thinking,i.thinking);break}case"signature_delta":{i.type==="thinking"&&this._emit("signature",i.signature);break}default:t.delta}break}case"message_stop":{this._addMessageParam(r),this._addMessage(Ih(r,w(this,vs,"f")),!0);break}case"content_block_stop":{this._emit("contentBlock",r.content.at(-1));break}case"message_start":{C(this,nr,r,"f");break}case"content_block_start":case"message_delta":break}},Fh=function(){if(this.ended)throw new D("stream has ended, this shouldn't happen");let t=w(this,nr,"f");if(!t)throw new D("request ended without sending any chunks");return C(this,nr,void 0,"f"),Ih(t,w(this,vs,"f"))},rw=function(t){let r=w(this,nr,"f");if(t.type==="message_start"){if(r)throw new D(`Unexpected event order, got ${t.type} before receiving "message_stop"`);return t.message}if(!r)throw new D(`Unexpected event order, got ${t.type} before "message_start"`);switch(t.type){case"message_stop":return r;case"message_delta":return r.container=t.delta.container,r.stop_reason=t.delta.stop_reason,r.stop_sequence=t.delta.stop_sequence,r.usage.output_tokens=t.usage.output_tokens,r.context_management=t.context_management,t.usage.input_tokens!=null&&(r.usage.input_tokens=t.usage.input_tokens),t.usage.cache_creation_input_tokens!=null&&(r.usage.cache_creation_input_tokens=t.usage.cache_creation_input_tokens),t.usage.cache_read_input_tokens!=null&&(r.usage.cache_read_input_tokens=t.usage.cache_read_input_tokens),t.usage.server_tool_use!=null&&(r.usage.server_tool_use=t.usage.server_tool_use),r;case"content_block_start":return r.content.push(t.content_block),r;case"content_block_delta":{let i=r.content.at(t.index);switch(t.delta.type){case"text_delta":{i?.type==="text"&&(r.content[t.index]={...i,text:(i.text||"")+t.delta.text});break}case"citations_delta":{i?.type==="text"&&(r.content[t.index]={...i,citations:[...i.citations??[],t.delta.citation]});break}case"input_json_delta":{if(i&&iw(i)){let n=i[sw]||"";n+=t.delta.partial_json;let o={...i};if(Object.defineProperty(o,sw,{value:n,enumerable:!1,writable:!0}),n)try{o.input=Bo(n)}catch(a){let l=new D(`Unable to parse tool parameter JSON from model. Please retry your request or adjust your prompt. Error: ${a}. JSON: ${n}`);w(this,Qo,"f").call(this,l)}r.content[t.index]=o}break}case"thinking_delta":{i?.type==="thinking"&&(r.content[t.index]={...i,thinking:i.thinking+t.delta.thinking});break}case"signature_delta":{i?.type==="thinking"&&(r.content[t.index]={...i,signature:t.delta.signature});break}default:t.delta}return r}case"content_block_stop":return r}},Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("streamEvent",i=>{let n=t.shift();n?n.resolve(i):e.push(i)}),this.on("end",()=>{r=!0;for(let i of t)i.resolve(void 0);t.length=0}),this.on("abort",i=>{r=!0;for(let n of t)n.reject(i);t.length=0}),this.on("error",i=>{r=!0;for(let n of t)n.reject(i);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((n,o)=>t.push({resolve:n,reject:o})).then(n=>n?{value:n,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new kt(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}});var ow,aw=E(()=>{ow=`You have been working on the task described above but have not yet completed it. Write a continuation summary that will allow you (or another instance of yourself) to resume work efficiently in a future context window where the conversation history will be replaced with this summary. Your summary should be structured, concise, and actionable. Include:
1. Task Overview
The user's core request and success criteria
Any clarifications or constraints they specified
2. Current State
What has been completed so far
Files created, modified, or analyzed (with paths if relevant)
Key outputs or artifacts produced
3. Important Discoveries
Technical constraints or requirements uncovered
Decisions made and their rationale
Errors encountered and how they were resolved
What approaches were tried that didn't work (and why)
4. Next Steps
Specific actions needed to complete the task
Any blockers or open questions to resolve
Priority order if multiple steps remain
5. Context to Preserve
User preferences or style requirements
Domain-specific details that aren't obvious
Any promises made to the user
Be concise but complete\u2014err on the side of including information that would prevent duplicate work or repeated mistakes. Write in a way that enables immediate resumption of the task.
Wrap your summary in <summary></summary> tags.`});function cw(){let s,e;return{promise:new Promise((r,i)=>{s=r,e=i}),resolve:s,reject:e}}async function AE(s,e=s.messages.at(-1)){if(!e||e.role!=="assistant"||!e.content||typeof e.content=="string")return null;let t=e.content.filter(i=>i.type==="tool_use");return t.length===0?null:{role:"user",content:await Promise.all(t.map(async i=>{let n=s.tools.find(o=>("name"in o?o.name:o.mcp_server_name)===i.name);if(!n||!("run"in n))return{type:"tool_result",tool_use_id:i.id,content:`Error: Tool '${i.name}' not found`,is_error:!0};try{let o=i.input;"parse"in n&&n.parse&&(o=n.parse(o));let a=await n.run(o);return{type:"tool_result",tool_use_id:i.id,content:a}}catch(o){return{type:"tool_result",tool_use_id:i.id,content:`Error: ${o instanceof Error?o.message:String(o)}`,is_error:!0}}}))}}var Mi,Es,Er,Pe,Di,et,zt,or,ji,lw,Vh,Ts,Hh=E(()=>{Bt();ot();ct();aw();Ts=class{constructor(e,t,r){Mi.add(this),this.client=e,Es.set(this,!1),Er.set(this,!1),Pe.set(this,void 0),Di.set(this,void 0),et.set(this,void 0),zt.set(this,void 0),or.set(this,void 0),ji.set(this,0),C(this,Pe,{params:{...t,messages:structuredClone(t.messages)}},"f"),C(this,Di,{...r,headers:q([{"x-stainless-helper":"BetaToolRunner"},r?.headers])},"f"),C(this,or,cw(),"f")}async*[(Es=new WeakMap,Er=new WeakMap,Pe=new WeakMap,Di=new WeakMap,et=new WeakMap,zt=new WeakMap,or=new WeakMap,ji=new WeakMap,Mi=new WeakSet,lw=async function(){let t=w(this,Pe,"f").params.compactionControl;if(!t||!t.enabled)return!1;let r=0;if(w(this,et,"f")!==void 0)try{let c=await w(this,et,"f");r=c.usage.input_tokens+(c.usage.cache_creation_input_tokens??0)+(c.usage.cache_read_input_tokens??0)+c.usage.output_tokens}catch{return!1}let i=t.contextTokenThreshold??1e5;if(r<i)return!1;let n=t.model??w(this,Pe,"f").params.model,o=t.summaryPrompt??ow,a=w(this,Pe,"f").params.messages;if(a[a.length-1].role==="assistant"){let c=a[a.length-1];if(Array.isArray(c.content)){let u=c.content.filter(f=>f.type!=="tool_use");u.length===0?a.pop():c.content=u}}let l=await this.client.beta.messages.create({model:n,messages:[...a,{role:"user",content:[{type:"text",text:o}]}],max_tokens:w(this,Pe,"f").params.max_tokens},{headers:{"x-stainless-helper":"compaction"}});if(l.content[0]?.type!=="text")throw new D("Expected text response for compaction");return w(this,Pe,"f").params.messages=[{role:"user",content:l.content}],!0},Symbol.asyncIterator)](){var e;if(w(this,Es,"f"))throw new D("Cannot iterate over a consumed stream");C(this,Es,!0,"f"),C(this,Er,!0,"f"),C(this,zt,void 0,"f");try{for(;;){let t;try{if(w(this,Pe,"f").params.max_iterations&&w(this,ji,"f")>=w(this,Pe,"f").params.max_iterations)break;C(this,Er,!1,"f"),C(this,zt,void 0,"f"),C(this,ji,(e=w(this,ji,"f"),e++,e),"f"),C(this,et,void 0,"f");let{max_iterations:r,compactionControl:i,...n}=w(this,Pe,"f").params;if(n.stream?(t=this.client.beta.messages.stream({...n},w(this,Di,"f")),C(this,et,t.finalMessage(),"f"),w(this,et,"f").catch(()=>{}),yield t):(C(this,et,this.client.beta.messages.create({...n,stream:!1},w(this,Di,"f")),"f"),yield w(this,et,"f")),!await w(this,Mi,"m",lw).call(this)){if(!w(this,Er,"f")){let{role:l,content:c}=await w(this,et,"f");w(this,Pe,"f").params.messages.push({role:l,content:c})}let a=await w(this,Mi,"m",Vh).call(this,w(this,Pe,"f").params.messages.at(-1));if(a)w(this,Pe,"f").params.messages.push(a);else if(!w(this,Er,"f"))break}}finally{t&&t.abort()}}if(!w(this,et,"f"))throw new D("ToolRunner concluded without a message from the server");w(this,or,"f").resolve(await w(this,et,"f"))}catch(t){throw C(this,Es,!1,"f"),w(this,or,"f").promise.catch(()=>{}),w(this,or,"f").reject(t),C(this,or,cw(),"f"),t}}setMessagesParams(e){typeof e=="function"?w(this,Pe,"f").params=e(w(this,Pe,"f").params):w(this,Pe,"f").params=e,C(this,Er,!0,"f"),C(this,zt,void 0,"f")}async generateToolResponse(){let e=await w(this,et,"f")??this.params.messages.at(-1);return e?w(this,Mi,"m",Vh).call(this,e):null}done(){return w(this,or,"f").promise}async runUntilDone(){if(!w(this,Es,"f"))for await(let e of this);return this.done()}get params(){return w(this,Pe,"f").params}pushMessages(...e){this.setMessagesParams(t=>({...t,messages:[...t.messages,...e]}))}then(e,t){return this.runUntilDone().then(e,t)}};Vh=async function(e){return w(this,zt,"f")!==void 0?w(this,zt,"f"):(C(this,zt,AE(w(this,Pe,"f").params,e),"f"),w(this,zt,"f"))}});var As,Kh=E(()=>{ot();ps();_h();As=class s{constructor(e,t){this.iterator=e,this.controller=t}async*decoder(){let e=new Vt;for await(let t of this.iterator)for(let r of e.decode(t))yield JSON.parse(r);for(let t of e.flush())yield JSON.parse(t)}[Symbol.asyncIterator](){return this.decoder()}static fromResponse(e,t){if(!e.body)throw t.abort(),typeof globalThis.navigator<"u"&&globalThis.navigator.product==="ReactNative"?new D("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api"):new D("Attempted to iterate over a response with no body");return new s(Si(e.body),t)}}});var ks,zh=E(()=>{lt();Pt();ct();Kh();Ci();ir();ks=class extends pe{create(e,t){let{betas:r,...i}=e;return this._client.post("/v1/messages/batches?beta=true",{body:i,...t,headers:q([{"anthropic-beta":[...r??[],"message-batches-2024-09-24"].toString()},t?.headers])})}retrieve(e,t={},r){let{betas:i}=t??{};return this._client.get(me`/v1/messages/batches/${e}?beta=true`,{...r,headers:q([{"anthropic-beta":[...i??[],"message-batches-2024-09-24"].toString()},r?.headers])})}list(e={},t){let{betas:r,...i}=e??{};return this._client.getAPIList("/v1/messages/batches?beta=true",at,{query:i,...t,headers:q([{"anthropic-beta":[...r??[],"message-batches-2024-09-24"].toString()},t?.headers])})}delete(e,t={},r){let{betas:i}=t??{};return this._client.delete(me`/v1/messages/batches/${e}?beta=true`,{...r,headers:q([{"anthropic-beta":[...i??[],"message-batches-2024-09-24"].toString()},r?.headers])})}cancel(e,t={},r){let{betas:i}=t??{};return this._client.post(me`/v1/messages/batches/${e}/cancel?beta=true`,{...r,headers:q([{"anthropic-beta":[...i??[],"message-batches-2024-09-24"].toString()},r?.headers])})}async results(e,t={},r){let i=await this.retrieve(e);if(!i.results_url)throw new D(`No batch \`results_url\`; Has it finished processing? ${i.processing_status} - ${i.id}`);let{betas:n}=t??{};return this._client.get(i.results_url,{...r,headers:q([{"anthropic-beta":[...n??[],"message-batches-2024-09-24"].toString(),Accept:"application/binary"},r?.headers]),stream:!0,__binaryResponse:!0})._thenUnwrap((o,a)=>As.fromResponse(a.response,a.controller))}}});var uw,ar,Wh=E(()=>{lt();$h();ct();Dh();nw();Hh();zh();zh();Hh();uw={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-3-opus-20240229":"January 5th, 2026","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025","claude-3-7-sonnet-latest":"February 19th, 2026","claude-3-7-sonnet-20250219":"February 19th, 2026"},ar=class extends pe{constructor(){super(...arguments),this.batches=new ks(this._client)}create(e,t){let{betas:r,...i}=e;i.model in uw&&console.warn(`The model '${i.model}' is deprecated and will reach end-of-life on ${uw[i.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`);let n=this._client._options.timeout;if(!i.stream&&n==null){let o=Uo[i.model]??void 0;n=this._client.calculateNonstreamingTimeout(i.max_tokens,o)}return this._client.post("/v1/messages?beta=true",{body:i,timeout:n??6e5,...t,headers:q([{...r?.toString()!=null?{"anthropic-beta":r?.toString()}:void 0},t?.headers]),stream:e.stream??!1})}parse(e,t){return t={...t,headers:q([{"anthropic-beta":[...e.betas??[],"structured-outputs-2025-11-13"].toString()},t?.headers])},this.create(e,t).then(r=>Mh(r,e))}stream(e,t){return Jo.createMessage(this,e,t)}countTokens(e,t){let{betas:r,...i}=e;return this._client.post("/v1/messages/count_tokens?beta=true",{body:i,...t,headers:q([{"anthropic-beta":[...r??[],"token-counting-2024-11-01"].toString()},t?.headers])})}toolRunner(e,t){return new Ts(this._client,e,t)}};ar.Batches=ks;ar.BetaToolRunner=Ts});var Ps,Qh=E(()=>{lt();Pt();ct();ys();ir();Ps=class extends pe{create(e,t={},r){let{betas:i,...n}=t??{};return this._client.post(me`/v1/skills/${e}/versions?beta=true`,gs({body:n,...r,headers:q([{"anthropic-beta":[...i??[],"skills-2025-10-02"].toString()},r?.headers])},this._client))}retrieve(e,t,r){let{skill_id:i,betas:n}=t;return this._client.get(me`/v1/skills/${i}/versions/${e}?beta=true`,{...r,headers:q([{"anthropic-beta":[...n??[],"skills-2025-10-02"].toString()},r?.headers])})}list(e,t={},r){let{betas:i,...n}=t??{};return this._client.getAPIList(me`/v1/skills/${e}/versions?beta=true`,ms,{query:n,...r,headers:q([{"anthropic-beta":[...i??[],"skills-2025-10-02"].toString()},r?.headers])})}delete(e,t,r){let{skill_id:i,betas:n}=t;return this._client.delete(me`/v1/skills/${i}/versions/${e}?beta=true`,{...r,headers:q([{"anthropic-beta":[...n??[],"skills-2025-10-02"].toString()},r?.headers])})}}});var Tr,Jh=E(()=>{lt();Qh();Qh();Pt();ct();ys();ir();Tr=class extends pe{constructor(){super(...arguments),this.versions=new Ps(this._client)}create(e={},t){let{betas:r,...i}=e??{};return this._client.post("/v1/skills?beta=true",gs({body:i,...t,headers:q([{"anthropic-beta":[...r??[],"skills-2025-10-02"].toString()},t?.headers])},this._client))}retrieve(e,t={},r){let{betas:i}=t??{};return this._client.get(me`/v1/skills/${e}?beta=true`,{...r,headers:q([{"anthropic-beta":[...i??[],"skills-2025-10-02"].toString()},r?.headers])})}list(e={},t){let{betas:r,...i}=e??{};return this._client.getAPIList("/v1/skills?beta=true",ms,{query:i,...t,headers:q([{"anthropic-beta":[...r??[],"skills-2025-10-02"].toString()},t?.headers])})}delete(e,t={},r){let{betas:i}=t??{};return this._client.delete(me`/v1/skills/${e}?beta=true`,{...r,headers:q([{"anthropic-beta":[...i??[],"skills-2025-10-02"].toString()},r?.headers])})}};Tr.Versions=Ps});var wt,Gh=E(()=>{lt();Oh();Oh();Nh();Nh();Wh();Wh();Jh();Jh();wt=class extends pe{constructor(){super(...arguments),this.models=new bs(this._client),this.messages=new ar(this._client),this.files=new ws(this._client),this.skills=new Tr(this._client)}};wt.Models=bs;wt.Messages=ar;wt.Files=ws;wt.Skills=Tr});var Ar,Xh=E(()=>{lt();ct();Ar=class extends pe{create(e,t){let{betas:r,...i}=e;return this._client.post("/v1/complete",{body:i,timeout:this._client._options.timeout??6e5,...t,headers:q([{...r?.toString()!=null?{"anthropic-beta":r?.toString()}:void 0},t?.headers]),stream:e.stream??!1})}}});function pw(s){return s.type==="tool_use"||s.type==="server_tool_use"}var dt,lr,Li,Go,qi,Ui,Xo,Bi,Wt,Fi,Yo,Zo,xs,ea,ta,Yh,dw,Zh,ef,tf,rf,hw,fw,ra,mw=E(()=>{Bt();is();Ci();Lh();jh();fw="__json_buf";ra=class s{constructor(){dt.add(this),this.messages=[],this.receivedMessages=[],lr.set(this,void 0),this.controller=new AbortController,Li.set(this,void 0),Go.set(this,()=>{}),qi.set(this,()=>{}),Ui.set(this,void 0),Xo.set(this,()=>{}),Bi.set(this,()=>{}),Wt.set(this,{}),Fi.set(this,!1),Yo.set(this,!1),Zo.set(this,!1),xs.set(this,!1),ea.set(this,void 0),ta.set(this,void 0),Zh.set(this,e=>{if(C(this,Yo,!0,"f"),Ft(e)&&(e=new Oe),e instanceof Oe)return C(this,Zo,!0,"f"),this._emit("abort",e);if(e instanceof D)return this._emit("error",e);if(e instanceof Error){let t=new D(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new D(String(e)))}),C(this,Li,new Promise((e,t)=>{C(this,Go,e,"f"),C(this,qi,t,"f")}),"f"),C(this,Ui,new Promise((e,t)=>{C(this,Xo,e,"f"),C(this,Bi,t,"f")}),"f"),w(this,Li,"f").catch(()=>{}),w(this,Ui,"f").catch(()=>{})}get response(){return w(this,ea,"f")}get request_id(){return w(this,ta,"f")}async withResponse(){let e=await w(this,Li,"f");if(!e)throw new Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){let t=new s;return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,r){let i=new s;for(let n of t.messages)i._addMessageParam(n);return i._run(()=>i._createMessage(e,{...t,stream:!0},{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),i}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},w(this,Zh,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,r){let i=r?.signal,n;i&&(i.aborted&&this.controller.abort(),n=this.controller.abort.bind(this.controller),i.addEventListener("abort",n));try{w(this,dt,"m",ef).call(this);let{response:o,data:a}=await e.create({...t,stream:!0},{...r,signal:this.controller.signal}).withResponse();this._connected(o);for await(let l of a)w(this,dt,"m",tf).call(this,l);if(a.controller.signal?.aborted)throw new Oe;w(this,dt,"m",rf).call(this)}finally{i&&n&&i.removeEventListener("abort",n)}}_connected(e){this.ended||(C(this,ea,e,"f"),C(this,ta,e?.headers.get("request-id"),"f"),w(this,Go,"f").call(this,e),this._emit("connect"))}get ended(){return w(this,Fi,"f")}get errored(){return w(this,Yo,"f")}get aborted(){return w(this,Zo,"f")}abort(){this.controller.abort()}on(e,t){return(w(this,Wt,"f")[e]||(w(this,Wt,"f")[e]=[])).push({listener:t}),this}off(e,t){let r=w(this,Wt,"f")[e];if(!r)return this;let i=r.findIndex(n=>n.listener===t);return i>=0&&r.splice(i,1),this}once(e,t){return(w(this,Wt,"f")[e]||(w(this,Wt,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{C(this,xs,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,t)})}async done(){C(this,xs,!0,"f"),await w(this,Ui,"f")}get currentMessage(){return w(this,lr,"f")}async finalMessage(){return await this.done(),w(this,dt,"m",Yh).call(this)}async finalText(){return await this.done(),w(this,dt,"m",dw).call(this)}_emit(e,...t){if(w(this,Fi,"f"))return;e==="end"&&(C(this,Fi,!0,"f"),w(this,Xo,"f").call(this));let r=w(this,Wt,"f")[e];if(r&&(w(this,Wt,"f")[e]=r.filter(i=>!i.once),r.forEach(({listener:i})=>i(...t))),e==="abort"){let i=t[0];!w(this,xs,"f")&&!r?.length&&Promise.reject(i),w(this,qi,"f").call(this,i),w(this,Bi,"f").call(this,i),this._emit("end");return}if(e==="error"){let i=t[0];!w(this,xs,"f")&&!r?.length&&Promise.reject(i),w(this,qi,"f").call(this,i),w(this,Bi,"f").call(this,i),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",w(this,dt,"m",Yh).call(this))}async _fromReadableStream(e,t){let r=t?.signal,i;r&&(r.aborted&&this.controller.abort(),i=this.controller.abort.bind(this.controller),r.addEventListener("abort",i));try{w(this,dt,"m",ef).call(this),this._connected(null);let n=kt.fromReadableStream(e,this.controller);for await(let o of n)w(this,dt,"m",tf).call(this,o);if(n.controller.signal?.aborted)throw new Oe;w(this,dt,"m",rf).call(this)}finally{r&&i&&r.removeEventListener("abort",i)}}[(lr=new WeakMap,Li=new WeakMap,Go=new WeakMap,qi=new WeakMap,Ui=new WeakMap,Xo=new WeakMap,Bi=new WeakMap,Wt=new WeakMap,Fi=new WeakMap,Yo=new WeakMap,Zo=new WeakMap,xs=new WeakMap,ea=new WeakMap,ta=new WeakMap,Zh=new WeakMap,dt=new WeakSet,Yh=function(){if(this.receivedMessages.length===0)throw new D("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},dw=function(){if(this.receivedMessages.length===0)throw new D("stream ended without producing a Message with role=assistant");let t=this.receivedMessages.at(-1).content.filter(r=>r.type==="text").map(r=>r.text);if(t.length===0)throw new D("stream ended without producing a content block with type=text");return t.join(" ")},ef=function(){this.ended||C(this,lr,void 0,"f")},tf=function(t){if(this.ended)return;let r=w(this,dt,"m",hw).call(this,t);switch(this._emit("streamEvent",t,r),t.type){case"content_block_delta":{let i=r.content.at(-1);switch(t.delta.type){case"text_delta":{i.type==="text"&&this._emit("text",t.delta.text,i.text||"");break}case"citations_delta":{i.type==="text"&&this._emit("citation",t.delta.citation,i.citations??[]);break}case"input_json_delta":{pw(i)&&i.input&&this._emit("inputJson",t.delta.partial_json,i.input);break}case"thinking_delta":{i.type==="thinking"&&this._emit("thinking",t.delta.thinking,i.thinking);break}case"signature_delta":{i.type==="thinking"&&this._emit("signature",i.signature);break}default:t.delta}break}case"message_stop":{this._addMessageParam(r),this._addMessage(r,!0);break}case"content_block_stop":{this._emit("contentBlock",r.content.at(-1));break}case"message_start":{C(this,lr,r,"f");break}case"content_block_start":case"message_delta":break}},rf=function(){if(this.ended)throw new D("stream has ended, this shouldn't happen");let t=w(this,lr,"f");if(!t)throw new D("request ended without sending any chunks");return C(this,lr,void 0,"f"),t},hw=function(t){let r=w(this,lr,"f");if(t.type==="message_start"){if(r)throw new D(`Unexpected event order, got ${t.type} before receiving "message_stop"`);return t.message}if(!r)throw new D(`Unexpected event order, got ${t.type} before "message_start"`);switch(t.type){case"message_stop":return r;case"message_delta":return r.stop_reason=t.delta.stop_reason,r.stop_sequence=t.delta.stop_sequence,r.usage.output_tokens=t.usage.output_tokens,t.usage.input_tokens!=null&&(r.usage.input_tokens=t.usage.input_tokens),t.usage.cache_creation_input_tokens!=null&&(r.usage.cache_creation_input_tokens=t.usage.cache_creation_input_tokens),t.usage.cache_read_input_tokens!=null&&(r.usage.cache_read_input_tokens=t.usage.cache_read_input_tokens),t.usage.server_tool_use!=null&&(r.usage.server_tool_use=t.usage.server_tool_use),r;case"content_block_start":return r.content.push({...t.content_block}),r;case"content_block_delta":{let i=r.content.at(t.index);switch(t.delta.type){case"text_delta":{i?.type==="text"&&(r.content[t.index]={...i,text:(i.text||"")+t.delta.text});break}case"citations_delta":{i?.type==="text"&&(r.content[t.index]={...i,citations:[...i.citations??[],t.delta.citation]});break}case"input_json_delta":{if(i&&pw(i)){let n=i[fw]||"";n+=t.delta.partial_json;let o={...i};Object.defineProperty(o,fw,{value:n,enumerable:!1,writable:!0}),n&&(o.input=Bo(n)),r.content[t.index]=o}break}case"thinking_delta":{i?.type==="thinking"&&(r.content[t.index]={...i,thinking:i.thinking+t.delta.thinking});break}case"signature_delta":{i?.type==="thinking"&&(r.content[t.index]={...i,signature:t.delta.signature});break}default:t.delta}return r}case"content_block_stop":return r}},Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("streamEvent",i=>{let n=t.shift();n?n.resolve(i):e.push(i)}),this.on("end",()=>{r=!0;for(let i of t)i.resolve(void 0);t.length=0}),this.on("abort",i=>{r=!0;for(let n of t)n.reject(i);t.length=0}),this.on("error",i=>{r=!0;for(let n of t)n.reject(i);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((n,o)=>t.push({resolve:n,reject:o})).then(n=>n?{value:n,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new kt(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}});var Cs,sf=E(()=>{lt();Pt();ct();Kh();Ci();ir();Cs=class extends pe{create(e,t){return this._client.post("/v1/messages/batches",{body:e,...t})}retrieve(e,t){return this._client.get(me`/v1/messages/batches/${e}`,t)}list(e={},t){return this._client.getAPIList("/v1/messages/batches",at,{query:e,...t})}delete(e,t){return this._client.delete(me`/v1/messages/batches/${e}`,t)}cancel(e,t){return this._client.post(me`/v1/messages/batches/${e}/cancel`,t)}async results(e,t){let r=await this.retrieve(e);if(!r.results_url)throw new D(`No batch \`results_url\`; Has it finished processing? ${r.processing_status} - ${r.id}`);return this._client.get(r.results_url,{...t,headers:q([{Accept:"application/binary"},t?.headers]),stream:!0,__binaryResponse:!0})._thenUnwrap((i,n)=>As.fromResponse(n.response,n.controller))}}});var cr,gw,nf=E(()=>{lt();mw();sf();sf();$h();cr=class extends pe{constructor(){super(...arguments),this.batches=new Cs(this._client)}create(e,t){e.model in gw&&console.warn(`The model '${e.model}' is deprecated and will reach end-of-life on ${gw[e.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`);let r=this._client._options.timeout;if(!e.stream&&r==null){let i=Uo[e.model]??void 0;r=this._client.calculateNonstreamingTimeout(e.max_tokens,i)}return this._client.post("/v1/messages",{body:e,timeout:r??6e5,...t,stream:e.stream??!1})}stream(e,t){return ra.createMessage(this,e,t)}countTokens(e,t){return this._client.post("/v1/messages/count_tokens",{body:e,...t})}},gw={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-3-opus-20240229":"January 5th, 2026","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025","claude-3-7-sonnet-latest":"February 19th, 2026","claude-3-7-sonnet-20250219":"February 19th, 2026"};cr.Batches=Cs});var kr,of=E(()=>{lt();Pt();ct();ir();kr=class extends pe{retrieve(e,t={},r){let{betas:i}=t??{};return this._client.get(me`/v1/models/${e}`,{...r,headers:q([{...i?.toString()!=null?{"anthropic-beta":i?.toString()}:void 0},r?.headers])})}list(e={},t){let{betas:r,...i}=e??{};return this._client.getAPIList("/v1/models",at,{query:i,...t,headers:q([{...r?.toString()!=null?{"anthropic-beta":r?.toString()}:void 0},t?.headers])})}}});var yw=E(()=>{Xy();Gh();Xh();nf();of()});var Vi,ww=E(()=>{Vi=s=>{if(typeof globalThis.process<"u")return globalThis.process.env?.[s]?.trim()??void 0;if(typeof globalThis.Deno<"u")return globalThis.Deno.env?.get?.(s)?.trim()}});var af,lf,sa,bw,_w,vw,ye,xt,cf=E(()=>{Bt();Py();_r();$y();is();gh();ps();Fy();mh();ot();Pt();Rh();yw();Do();Xh();of();Gh();nf();gh();ct();ww();Io();_r();_w="\\n\\nHuman:",vw="\\n\\nAssistant:",ye=class{constructor({baseURL:e=Vi("ANTHROPIC_BASE_URL"),apiKey:t=Vi("ANTHROPIC_API_KEY")??null,authToken:r=Vi("ANTHROPIC_AUTH_TOKEN")??null,...i}={}){af.add(this),sa.set(this,void 0);let n={apiKey:t,authToken:r,...i,baseURL:e||"https://api.anthropic.com"};if(!n.dangerouslyAllowBrowser&&jy())throw new D(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new Anthropic({ apiKey, dangerouslyAllowBrowser: true });
`);this.baseURL=n.baseURL,this.timeout=n.timeout??lf.DEFAULT_TIMEOUT,this.logger=n.logger??console;let o="warn";this.logLevel=o,this.logLevel=vh(n.logLevel,"ClientOptions.logLevel",this)??vh(Vi("ANTHROPIC_LOG"),"process.env['ANTHROPIC_LOG']",this)??o,this.fetchOptions=n.fetchOptions,this.maxRetries=n.maxRetries??2,this.fetch=n.fetch??qy(),C(this,sa,By,"f"),this._options=n,this.apiKey=typeof t=="string"?t:null,this.authToken=r}withOptions(e){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,authToken:this.authToken,...e})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:e,nulls:t}){if(!(e.get("x-api-key")||e.get("authorization"))&&!(this.apiKey&&e.get("x-api-key"))&&!t.has("x-api-key")&&!(this.authToken&&e.get("authorization"))&&!t.has("authorization"))throw new Error('Could not resolve authentication method. Expected either apiKey or authToken to be set. Or for one of the "X-Api-Key" or "Authorization" headers to be explicitly omitted')}async authHeaders(e){return q([await this.apiKeyAuth(e),await this.bearerAuth(e)])}async apiKeyAuth(e){if(this.apiKey!=null)return q([{"X-Api-Key":this.apiKey}])}async bearerAuth(e){if(this.authToken!=null)return q([{Authorization:`Bearer ${this.authToken}`}])}stringifyQuery(e){return Object.entries(e).filter(([t,r])=>typeof r<"u").map(([t,r])=>{if(typeof r=="string"||typeof r=="number"||typeof r=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(r)}`;if(r===null)return`${encodeURIComponent(t)}=`;throw new D(`Cannot stringify type ${typeof r}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}getUserAgent(){return`${this.constructor.name}/JS ${sr}`}defaultIdempotencyKey(){return`stainless-node-retry-${hh()}`}makeStatusError(e,t,r,i){return Ce.generate(e,t,r,i)}buildURL(e,t,r){let i=!w(this,af,"m",bw).call(this)&&r||this.baseURL,n=xy(e)?new URL(e):new URL(i+(i.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),o=this.defaultQuery();return Cy(o)||(t={...o,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(n.search=this.stringifyQuery(t)),n.toString()}_calculateNonstreamingTimeout(e){if(3600*e/128e3>600)throw new D("Streaming is required for operations that may take longer than 10 minutes. See https://github.com/anthropics/anthropic-sdk-typescript#streaming-responses for more details");return 600*1e3}async prepareOptions(e){}async prepareRequest(e,{url:t,options:r}){}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,r){return this.request(Promise.resolve(r).then(i=>({method:e,path:t,...i})))}request(e,t=null){return new vr(this,this.makeRequest(e,t,void 0))}async makeRequest(e,t,r){let i=await e,n=i.maxRetries??this.maxRetries;t==null&&(t=n),await this.prepareOptions(i);let{req:o,url:a,timeout:l}=await this.buildRequest(i,{retryCount:n-t});await this.prepareRequest(o,{url:a,options:i});let c="log_"+(Math.random()*(1<<24)|0).toString(16).padStart(6,"0"),u=r===void 0?"":`, retryOf: ${r}`,f=Date.now();if(Re(this).debug(`[${c}] sending request`,Ht({retryOfRequestLogID:r,method:i.method,url:a,options:i,headers:o.headers})),i.signal?.aborted)throw new Oe;let d=new AbortController,h=await this.fetchWithTimeout(a,o,l,d).catch(vi),g=Date.now();if(h instanceof globalThis.Error){let b=`retrying, ${t} attempts remaining`;if(i.signal?.aborted)throw new Oe;let v=Ft(h)||/timed? ?out/i.test(String(h)+("cause"in h?String(h.cause):""));if(t)return Re(this).info(`[${c}] connection ${v?"timed out":"failed"} - ${b}`),Re(this).debug(`[${c}] connection ${v?"timed out":"failed"} (${b})`,Ht({retryOfRequestLogID:r,url:a,durationMs:g-f,message:h.message})),this.retryRequest(i,t,r??c);throw Re(this).info(`[${c}] connection ${v?"timed out":"failed"} - error; no more retries left`),Re(this).debug(`[${c}] connection ${v?"timed out":"failed"} (error; no more retries left)`,Ht({retryOfRequestLogID:r,url:a,durationMs:g-f,message:h.message})),v?new ns:new rr({cause:h})}let y=[...h.headers.entries()].filter(([b])=>b==="request-id").map(([b,v])=>", "+b+": "+JSON.stringify(v)).join(""),_=`[${c}${u}${y}] ${o.method} ${a} ${h.ok?"succeeded":"failed"} with status ${h.status} in ${g-f}ms`;if(!h.ok){let b=await this.shouldRetry(h);if(t&&b){let I=`retrying, ${t} attempts remaining`;return await Uy(h.body),Re(this).info(`${_} - ${I}`),Re(this).debug(`[${c}] response error (${I})`,Ht({retryOfRequestLogID:r,url:h.url,status:h.status,headers:h.headers,durationMs:g-f})),this.retryRequest(i,t,r??c,h.headers)}let v=b?"error; no more retries left":"error; not retryable";Re(this).info(`${_} - ${v}`);let A=await h.text().catch(I=>vi(I).message),N=Ro(A),te=N?void 0:A;throw Re(this).debug(`[${c}] response error (${v})`,Ht({retryOfRequestLogID:r,url:h.url,status:h.status,headers:h.headers,message:te,durationMs:Date.now()-f})),this.makeStatusError(h.status,N,te,h.headers)}return Re(this).info(_),Re(this).debug(`[${c}] response start`,Ht({retryOfRequestLogID:r,url:h.url,status:h.status,headers:h.headers,durationMs:g-f})),{response:h,options:i,controller:d,requestLogID:c,retryOfRequestLogID:r,startTime:f}}getAPIList(e,t,r){return this.requestAPIList(t,{method:"get",path:e,...r})}requestAPIList(e,t){let r=this.makeRequest(t,null,void 0);return new Pi(this,r,e)}async fetchWithTimeout(e,t,r,i){let{signal:n,method:o,...a}=t||{};n&&n.addEventListener("abort",()=>i.abort());let l=setTimeout(()=>i.abort(),r),c=globalThis.ReadableStream&&a.body instanceof globalThis.ReadableStream||typeof a.body=="object"&&a.body!==null&&Symbol.asyncIterator in a.body,u={signal:i.signal,...c?{duplex:"half"}:{},method:"GET",...a};o&&(u.method=o.toUpperCase());try{return await this.fetch.call(void 0,e,u)}finally{clearTimeout(l)}}async shouldRetry(e){let t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,r,i){let n,o=i?.get("retry-after-ms");if(o){let l=parseFloat(o);Number.isNaN(l)||(n=l)}let a=i?.get("retry-after");if(a&&!n){let l=parseFloat(a);Number.isNaN(l)?n=Date.parse(a)-Date.now():n=l*1e3}if(!(n&&0<=n&&n<60*1e3)){let l=e.maxRetries??this.maxRetries;n=this.calculateDefaultRetryTimeoutMillis(t,l)}return await Ny(n),this.makeRequest(e,t-1,r)}calculateDefaultRetryTimeoutMillis(e,t){let n=t-e,o=Math.min(.5*Math.pow(2,n),8),a=1-Math.random()*.25;return o*a*1e3}calculateNonstreamingTimeout(e,t){if(36e5*e/128e3>6e5||t!=null&&e>t)throw new D("Streaming is required for operations that may take longer than 10 minutes. See https://github.com/anthropics/anthropic-sdk-typescript#long-requests for more details");return 6e5}async buildRequest(e,{retryCount:t=0}={}){let r={...e},{method:i,path:n,query:o,defaultBaseURL:a}=r,l=this.buildURL(n,o,a);"timeout"in r&&Oy("timeout",r.timeout),r.timeout=r.timeout??this.timeout;let{bodyHeaders:c,body:u}=this.buildBody({options:r}),f=await this.buildHeaders({options:e,method:i,bodyHeaders:c,retryCount:t});return{req:{method:i,headers:f,...r.signal&&{signal:r.signal},...globalThis.ReadableStream&&u instanceof globalThis.ReadableStream&&{duplex:"half"},...u&&{body:u},...this.fetchOptions??{},...r.fetchOptions??{}},url:l,timeout:r.timeout}}async buildHeaders({options:e,method:t,bodyHeaders:r,retryCount:i}){let n={};this.idempotencyHeader&&t!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),n[this.idempotencyHeader]=e.idempotencyKey);let o=q([n,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(i),...e.timeout?{"X-Stainless-Timeout":String(Math.trunc(e.timeout/1e3))}:{},...Ly(),...this._options.dangerouslyAllowBrowser?{"anthropic-dangerous-direct-browser-access":"true"}:void 0,"anthropic-version":"2023-06-01"},await this.authHeaders(e),this._options.defaultHeaders,r,e.headers]);return this.validateHeaders(o),o.values}buildBody({options:{body:e,headers:t}}){if(!e)return{bodyHeaders:void 0,body:void 0};let r=q([t]);return ArrayBuffer.isView(e)||e instanceof ArrayBuffer||e instanceof DataView||typeof e=="string"&&r.values.has("content-type")||globalThis.Blob&&e instanceof globalThis.Blob||e instanceof FormData||e instanceof URLSearchParams||globalThis.ReadableStream&&e instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:e}:typeof e=="object"&&(Symbol.asyncIterator in e||Symbol.iterator in e&&"next"in e&&typeof e.next=="function")?{bodyHeaders:void 0,body:Oo(e)}:w(this,sa,"f").call(this,{body:e,headers:r})}};lf=ye,sa=new WeakMap,af=new WeakSet,bw=function(){return this.baseURL!=="https://api.anthropic.com"};ye.Anthropic=lf;ye.HUMAN_PROMPT=_w;ye.AI_PROMPT=vw;ye.DEFAULT_TIMEOUT=6e5;ye.AnthropicError=D;ye.APIError=Ce;ye.APIConnectionError=rr;ye.APIConnectionTimeoutError=ns;ye.APIUserAbortError=Oe;ye.NotFoundError=cs;ye.ConflictError=us;ye.RateLimitError=hs;ye.BadRequestError=os;ye.AuthenticationError=as;ye.InternalServerError=fs;ye.PermissionDeniedError=ls;ye.UnprocessableEntityError=ds;ye.toFile=qo;xt=class extends ye{constructor(){super(...arguments),this.completions=new Ar(this),this.messages=new cr(this),this.models=new kr(this),this.beta=new wt(this)}};xt.Completions=Ar;xt.Messages=cr;xt.Models=kr;xt.Beta=wt});var Sw=E(()=>{cf();Rh();Do();cf();Pt();ot()});var ia,Ew=E(()=>{"use strict";Sw();ia=class{anthropic;maxRetries=2;constructor(){let e=process.env.ANTHROPIC_API_KEY;e||console.warn("[CaptchaSolver] ANTHROPIC_API_KEY not set - CAPTCHA solving disabled"),this.anthropic=new xt({apiKey:e||"dummy-key"})}async solve(e){if(!process.env.ANTHROPIC_API_KEY)return console.log("[CaptchaSolver] API key not configured, skipping"),!1;let t=await this.detectCaptcha(e);if(console.log("[CaptchaSolver] detectCaptcha result:",JSON.stringify(t)),!t.detected)return console.log("[CaptchaSolver] \uC601\uC218\uC99D CAPTCHA \uC544\uB2D8 - \uB2E4\uB978 \uC720\uD615\uC758 \uBCF4\uC548 \uD398\uC774\uC9C0"),!1;console.log("[CaptchaSolver] \uC601\uC218\uC99D CAPTCHA \uAC10\uC9C0\uB428"),console.log(`[CaptchaSolver] \uC9C8\uBB38: ${t.question}`);for(let r=1;r<=this.maxRetries;r++)try{console.log(`[CaptchaSolver] \uD574\uACB0 \uC2DC\uB3C4 ${r}/${this.maxRetries}`);let i=await this.captureReceiptImage(e),n=await this.askClaudeVision(i,t.question);if(console.log(`[CaptchaSolver] Claude \uC751\uB2F5: "${n}"`),await this.submitAnswer(e,n),await this.verifySolved(e))return console.log("[CaptchaSolver] CAPTCHA \uD574\uACB0 \uC131\uACF5!"),!0;console.log(`[CaptchaSolver] \uC2DC\uB3C4 ${r} \uC2E4\uD328, \uC7AC\uC2DC\uB3C4...`),await this.delay(1e3)}catch(i){console.error(`[CaptchaSolver] \uC2DC\uB3C4 ${r} \uC5D0\uB7EC:`,i)}return console.log("[CaptchaSolver] \uBAA8\uB4E0 \uC2DC\uB3C4 \uC2E4\uD328"),!1}async detectCaptcha(e){try{await e.screenshot({path:"docs/captcha_debug.png",fullPage:!0}),console.log("[CaptchaSolver] DEBUG: Screenshot saved to docs/captcha_debug.png")}catch{console.log("[CaptchaSolver] DEBUG: Failed to save screenshot")}return await e.evaluate(()=>{let t=document.body.innerText||"",r=t.includes("\uC601\uC218\uC99D")||t.includes("\uAC00\uC0C1\uC73C\uB85C \uC81C\uC791"),i=t.includes("\uBB34\uC5C7\uC785\uB2C8\uAE4C")||t.includes("\uBE48 \uCE78\uC744 \uCC44\uC6CC\uC8FC\uC138\uC694")||t.includes("[?]")||t.includes("\uBC88\uC9F8 \uC22B\uC790"),n=t.includes("\uBCF4\uC548 \uD655\uC778"),o=r&&(i||n),a=document.querySelector('[class*="recaptcha"], iframe[src*="recaptcha"]')!==null,l=document.querySelector('[id*="captcha"], [class*="captcha"]')!==null;if(!o)return{detected:!1,question:"",questionType:"unknown"};let u="",f=t.match(/.+\??/);if(f&&(u=f[0].trim()),!u){let h=document.querySelectorAll('[style*="color: rgb(255, 68, 68)"], [style*="color:#ff4444"], [style*="color: red"], [style*="color:#"]');for(let g of h){let y=g.textContent?.trim();if(y&&(y.includes("[?]")||y.includes("\uBB34\uC5C7\uC785\uB2C8\uAE4C")||y.includes("\uBC88\uC9F8"))){u=y;break}}}if(!u){let h=t.match(/\s+.+?\s+\[?\?\]?\s*/);h&&(u=h[0])}if(!u){let h=[/\s*\s*.+?\s*\[?\?\]?\s*/,/\s*.+?\s*\[?\?\]?\s*/,/\s*.+?\s*\[?\?\]?\s*/,/.+\s*\s*/,/.+\s*\s*/];for(let g of h){let y=t.match(g);if(y){u=y[0];break}}}u||(u=t.substring(0,300));let d="unknown";return u.includes("\uC704\uCE58")||u.includes("\uC8FC\uC18C")||u.includes("\uAE38")?d="address":u.includes("\uC804\uD654")||u.includes("\uBC88\uD638")?d="phone":(u.includes("\uC0C1\uD638")||u.includes("\uAC00\uAC8C \uC774\uB984"))&&(d="store"),{detected:!0,question:u,questionType:d}})}async captureReceiptImage(e){let t=['img[src*="captcha"]','img[src*="receipt"]',".captcha_image img",".receipt_image img",'[class*="captcha"] img','[class*="receipt"] img',".security_check img","#captcha_image"];for(let n of t){let o=await e.$(n);if(o)try{let a=await o.screenshot({encoding:"base64"});return console.log(`[CaptchaSolver] \uC774\uBBF8\uC9C0 \uCEA1\uCC98 \uC131\uACF5: ${n}`),a}catch{continue}}let r=[".captcha_area",'[class*="captcha"]','[class*="security"]',".verify_area"];for(let n of r){let o=await e.$(n);if(o)try{let a=await o.screenshot({encoding:"base64"});return console.log(`[CaptchaSolver] \uC601\uC5ED \uCEA1\uCC98 \uC131\uACF5: ${n}`),a}catch{continue}}return console.log("[CaptchaSolver] \uC804\uCCB4 \uD398\uC774\uC9C0 \uCEA1\uCC98"),await e.screenshot({encoding:"base64"})}async askClaudeVision(e,t){let r=`\uC774 \uC601\uC218\uC99D \uC774\uBBF8\uC9C0\uB97C \uBCF4\uACE0 \uB2E4\uC74C \uC9C8\uBB38\uC5D0 \uB2F5\uD558\uC138\uC694.

\uC9C8\uBB38: ${t}

\uC601\uC218\uC99D\uC5D0\uC11C \uD574\uB2F9 \uC815\uBCF4\uB97C \uCC3E\uC544 [?] \uC704\uCE58\uC5D0 \uB4E4\uC5B4\uAC08 \uB2F5\uB9CC \uC815\uD655\uD788 \uC54C\uB824\uC8FC\uC138\uC694.
- \uC8FC\uC18C \uAD00\uB828 \uC9C8\uBB38\uC774\uBA74: \uD574\uB2F9 \uBC88\uC9C0\uC218\uB098 \uB3C4\uB85C\uBA85 \uBC88\uD638\uB9CC \uB2F5\uD558\uC138\uC694 (\uC608: "794", "123")
- \uC804\uD654\uBC88\uD638 \uAD00\uB828 \uC9C8\uBB38\uC774\uBA74: \uD574\uB2F9 \uC22B\uC790\uB9CC \uB2F5\uD558\uC138\uC694 (\uC608: "1234", "5678")
- \uC0C1\uD638\uBA85 \uAD00\uB828 \uC9C8\uBB38\uC774\uBA74: \uD574\uB2F9 \uD14D\uC2A4\uD2B8\uB9CC \uB2F5\uD558\uC138\uC694

\uB2E4\uB978 \uC124\uBA85 \uC5C6\uC774 \uB2F5\uB9CC \uCD9C\uB825\uD558\uC138\uC694. \uC22B\uC790\uB098 \uD14D\uC2A4\uD2B8\uB9CC \uB2F5\uD558\uC138\uC694.`,n=(await this.anthropic.messages.create({model:"claude-sonnet-4-20250514",max_tokens:50,messages:[{role:"user",content:[{type:"image",source:{type:"base64",media_type:"image/png",data:e}},{type:"text",text:r}]}]})).content[0];if(n.type==="text"){let o=n.text.trim();return o=o.replace(/\.?$/,"").trim(),o=o.replace(/^\s*:\s*/i,"").trim(),o}throw new Error("Failed to get text response from Claude")}async submitAnswer(e,t){let r=['input[type="text"]','input[placeholder*="\uC785\uB825"]','input[placeholder*="\uC815\uB2F5"]','input[name*="answer"]','input[id*="answer"]',".captcha_input input","#captcha_answer"],i=!1;for(let o of r)try{await e.waitForSelector(o,{timeout:2e3}),await e.evaluate(a=>{let l=document.querySelector(a);l&&(l.value="")},o),await e.type(o,t,{delay:80}),i=!0,console.log(`[CaptchaSolver] \uB2F5 \uC785\uB825 \uC644\uB8CC: ${o}`);break}catch{continue}if(!i)throw new Error("CAPTCHA input field not found");await this.delay(500);let n=['button:has-text("\uD655\uC778")','input[type="submit"]','button[type="submit"]',".confirm_btn",".submit_btn",'button[class*="confirm"]','button[class*="submit"]'];for(let o of n)try{let a=await e.$(o);if(a){await a.click(),console.log(`[CaptchaSolver] \uD655\uC778 \uBC84\uD2BC \uD074\uB9AD: ${o}`);break}}catch{continue}await e.keyboard.press("Enter"),await this.delay(2e3)}async verifySolved(e){return!await e.evaluate(()=>{let r=document.body.innerText||"";return r.includes("\uBE48 \uCE78\uC744 \uCC44\uC6CC\uC8FC\uC138\uC694")||r.includes("\uB2E4\uC2DC \uC785\uB825")||r.includes("\uC624\uB958")||r.includes("\uC601\uC218\uC99D")&&r.includes("[?]")})}delay(e){return new Promise(t=>setTimeout(t,e))}}});var Tw,NE,ue,tt=E(()=>{"use strict";Tw=require("puppeteer-real-browser");eu();Ew();NE=["cr.shopping.naver.com/bridge","cr2.shopping.naver.com/bridge","cr3.shopping.naver.com/bridge","cr4.shopping.naver.com/bridge","shopping.naver.com/bridge","naver.com/v2/bridge","/bridge?"],ue=class{browser=null;page=null;captchaSolver;constructor(){this.captchaSolver=new ia}async init(){let{browser:e,page:t}=await(0,Tw.connect)({headless:!1,turnstile:!0});this.browser=e,this.page=t,await this.page.setViewport({width:1366,height:768,deviceScaleFactor:1,isMobile:!1,hasTouch:!1}),await this.page.evaluateOnNewDocument(()=>{delete window.cdc_adoQpoasnfa76pfcZLmcfl_Array,delete window.cdc_adoQpoasnfa76pfcZLmcfl_Object,delete window.cdc_adoQpoasnfa76pfcZLmcfl_Promise,Object.defineProperty(window,"outerWidth",{value:1366,configurable:!1}),Object.defineProperty(window,"outerHeight",{value:768,configurable:!1}),Object.defineProperty(window,"innerWidth",{value:1366,configurable:!1}),Object.defineProperty(window,"innerHeight",{value:768,configurable:!1}),Object.defineProperties(screen,{availWidth:{value:1366,configurable:!1},availHeight:{value:728,configurable:!1},width:{value:1366,configurable:!1},height:{value:768,configurable:!1}}),Object.defineProperty(navigator,"userAgent",{value:"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.0.0 Safari/537.36",configurable:!1}),Object.defineProperty(navigator,"platform",{value:"Win32"}),Object.defineProperty(navigator,"userAgentData",{value:{brands:[{brand:"Google Chrome",version:"130"},{brand:"Chromium",version:"130"},{brand:"Not=A?Brand",version:"99"}],platform:"Windows",mobile:!1},configurable:!1});let i=WebGLRenderingContext.prototype.getParameter;WebGLRenderingContext.prototype.getParameter=function(n){return n===37445?"Intel Inc.":n===37446?"Intel(R) UHD Graphics 630":i.call(this,n)}}),this.page.setDefaultTimeout(3e4),this.page.setDefaultNavigationTimeout(3e4),console.log(`[${this.versionString}] Browser initialized (1366x768 perfect match, no stealth)`)}async close(){try{this.page&&await this.page.close().catch(()=>{}),this.browser&&await this.browser.close().catch(()=>{})}catch{}this.browser=null,this.page=null}async execute(e){let t=Date.now();if(!this.page)return{success:!1,version:this.versionString,blocked:!1,bridgeDetected:!1,midClicked:!1,error:"Browser not initialized"};try{await this.page.goto("https://m.naver.com/",{waitUntil:"domcontentloaded"}),await this.delay(500);let r=e.productName.substring(0,50);if(!await this.page.evaluate(f=>{let d=document.querySelector('input[type="search"], input[name="query"]');if(d){d.value=f,d.dispatchEvent(new Event("input",{bubbles:!0}));let h=d.closest("form");if(h)return h.submit(),!0}return!1},r))return{success:!1,version:this.versionString,blocked:!1,bridgeDetected:!1,midClicked:!1,error:"Search input not found"};if(await this.page.waitForNavigation({waitUntil:"domcontentloaded",timeout:2e4}).catch(()=>{}),await this.delay(1e3),await this.checkCaptcha())return{success:!1,version:this.versionString,blocked:!0,bridgeDetected:!1,midClicked:!1,error:"\uD1B5\uD569\uAC80\uC0C9 CAPTCHA",duration:Date.now()-t};for(let f=0;f<2;f++)await this.page.evaluate(()=>window.scrollBy(0,400)),await this.delay(200);let o=await this.clickDirectSmartStore(e.nvMid);console.log(`[${this.versionString}] clickDirectSmartStore: ${o}`),o||(o=await this.findAndClickMid(e.nvMid),console.log(`[${this.versionString}] findAndClickMid: ${o}`));let a=!1;if(o||(console.log(`[${this.versionString}] 1\uCC28 \uC2DC\uB3C4 \uC2E4\uD328 \u2192 Fallback \uC804\uB7B5 \uC2DC\uC791`),o=await this.tryShoppingTabFallback(e),a=!0,console.log(`[${this.versionString}] Fallback result: ${o}`)),!o)return{success:!1,version:this.versionString,blocked:!1,bridgeDetected:!1,midClicked:!1,error:`MID ${e.nvMid} not found (both strategies failed)`,duration:Date.now()-t};if(!a){try{await this.page.waitForNavigation({waitUntil:"domcontentloaded",timeout:8e3})}catch{}await this.delay(1500);let f=this.page.url();if(console.log(`[${this.versionString}] Current URL after navigation: ${f.substring(0,100)}`),this.isBridgeUrl(f)){console.log(`[${this.versionString}] Bridge URL detected, waiting for redirect...`);for(let d=0;d<5;d++)if(await this.delay(500),f=this.page.url(),!this.isBridgeUrl(f)){console.log(`[${this.versionString}] Redirect completed to: ${f.substring(0,80)}`);break}}}await this.delay(500);let l=this.page.url();if(console.log(`[${this.versionString}] Final URL for validation: ${l.substring(0,100)}`),!(l.includes("/catalog/")||l.includes("/products/")||l.includes("smartstore.naver.com")||l.includes("brand.naver.com")))return{success:!1,version:this.versionString,blocked:!1,bridgeDetected:!1,midClicked:!0,error:"Not a product page",duration:Date.now()-t};let u=await this.page.evaluate(f=>{let d=window.location.href;if(d.includes(f))return{found:!0,method:"URL",url:d};let h=document.querySelectorAll("[data-nv-mid], [data-nvmid], [data-product-id]");for(let b of Array.from(h))if((b.getAttribute("data-nv-mid")||b.getAttribute("data-nvmid")||b.getAttribute("data-product-id"))===f)return{found:!0,method:"data-attr",url:d};let g=document.querySelectorAll('meta[property*="product"], meta[name*="product"]');for(let b of Array.from(g))if((b.getAttribute("content")||"").includes(f))return{found:!0,method:"meta",url:d};let y=document.body.innerText,_=y.includes("\uBCF4\uC548 \uD655\uC778")||y.includes("\uC77C\uC2DC\uC801\uC73C\uB85C \uC81C\uD55C")||y.includes("\uBE44\uC815\uC0C1\uC801\uC778 \uC811\uADFC");return{found:!1,url:d,bodyPreview:y.substring(0,200),isBlocked:_}},e.nvMid);return u.isBlocked?{success:!1,version:this.versionString,blocked:!0,bridgeDetected:!1,midClicked:!0,error:`Blocked after click - ${u.bodyPreview?.substring(0,50)}`,duration:Date.now()-t}:(u.found||console.log(`[${this.versionString}] WARNING: MID mismatch - expected ${e.nvMid}, got ${u.url?.substring(0,80)}`),await this.delay(2e3),{success:!0,version:this.versionString,blocked:!1,bridgeDetected:!1,midClicked:!0,duration:Date.now()-t})}catch(r){return{success:!1,version:this.versionString,blocked:!1,bridgeDetected:!1,midClicked:!1,error:r.message,duration:Date.now()-t}}}async checkCaptcha(){try{return await this.page.evaluate(()=>{let e=document.body.innerText,t=["\uBCF4\uC548 \uD655\uC778","\uC77C\uC2DC\uC801\uC73C\uB85C \uC81C\uD55C","\uBCF4\uC548 \uD655\uC778\uC744 \uC644\uB8CC\uD574 \uC8FC\uC138\uC694","\uC1FC\uD551 \uC11C\uBE44\uC2A4 \uC811\uC18D\uC774 \uC77C\uC2DC\uC801\uC73C\uB85C \uC81C\uD55C","\uC2E4\uC81C \uC0AC\uC6A9\uC790\uC784\uC744 \uD655\uC778","\uC790\uB3D9\uC785\uB825 \uBC29\uC9C0","\uBCF4\uC548\uBB38\uC790","\uC790\uB3D9\uB4F1\uB85D\uBC29\uC9C0","\uBE44\uC815\uC0C1\uC801\uC778 \uC811\uADFC"];for(let r of t)if(e.includes(r))return!0;return!!document.querySelector('[id*="captcha"], [class*="captcha"]')})}catch{return!1}}async checkAndSolveCaptcha(){if(!this.page)return{hadCaptcha:!1,solved:!1};if(!await this.checkCaptcha())return{hadCaptcha:!1,solved:!1};console.log(`[${this.versionString}] CAPTCHA \uAC10\uC9C0! \uC790\uB3D9 \uD574\uACB0 \uC2DC\uB3C4...`);try{return await this.captchaSolver.solve(this.page)?(console.log(`[${this.versionString}] CAPTCHA \uD574\uACB0 \uC131\uACF5!`),{hadCaptcha:!0,solved:!0}):(console.log(`[${this.versionString}] CAPTCHA \uD574\uACB0 \uC2E4\uD328`),{hadCaptcha:!0,solved:!1})}catch(t){return console.error(`[${this.versionString}] CAPTCHA \uD574\uACB0 \uC911 \uC5D0\uB7EC:`,t),{hadCaptcha:!0,solved:!1}}}async clickDirectSmartStore(e){return await this.page.evaluate(t=>{let r=Array.from(document.querySelectorAll("a"));for(let i of r){let n=i.href||"";if(!(n.includes("/bridge")||n.includes("cr.shopping")||n.includes("cr2.shopping")||n.includes("cr3.shopping")||n.includes("cr4.shopping"))&&(n.includes("smartstore.naver.com")&&n.includes("/products/")&&n.includes(t)||n.includes("brand.naver.com")&&n.includes("/products/")&&n.includes(t)))return i.click(),!0}return!1},e)}async findAndClickMid(e){let t=await this.page.evaluate(i=>{let n=Array.from(document.querySelectorAll("a"));for(let o of n){let a=o.href||"";if(!(a.includes("/bridge")||a.includes("cr.shopping")||a.includes("cr2.shopping")||a.includes("cr3.shopping")||a.includes("cr4.shopping"))&&(a.includes("smartstore.naver.com/")||a.includes("brand.naver.com/"))&&a.includes("/products/")){if(a.includes(i))return{found:!0,href:a,type:"smartstore-direct"};if((o.getAttribute("data-nv-mid")||o.getAttribute("data-nvmid"))===i)return{found:!0,href:a,type:"smartstore-data"}}}for(let o of n){let a=o.href||"";if(a.includes(i)||a.includes(`nvMid=${i}`))return{found:!0,href:a,type:"mid-in-url"};if((o.getAttribute("data-nv-mid")||o.getAttribute("data-nvmid"))===i)return{found:!0,href:a,type:"data-attr"}}return{found:!1,href:"",type:""}},e);if(console.log(`[${this.versionString}] findAndClickMid result:`,t),!t.found)return!1;let r=this.isBridgeUrl(t.href);if(r&&console.log(`[${this.versionString}] Bridge URL \uAC10\uC9C0 \u2192 \uC9C1\uC811 \uD074\uB9AD (\uD2B8\uB798\uD0B9\uC744 \uC704\uD574)`),await this.page.evaluate(i=>{let n=Array.from(document.querySelectorAll("a")).find(o=>o.href===i);n&&n.click()},t.href),r){await this.delay(1500);let i=await this.checkAndSolveCaptcha();i.hadCaptcha&&!i.solved&&console.log(`[${this.versionString}] Bridge URL CAPTCHA \uD574\uACB0 \uC2E4\uD328`)}return!0}async navigateViaCatalogUrl(e){let t=`https://search.shopping.naver.com/catalog/${e}`,r=await this.page.evaluate(i=>{try{let n=document.createElement("a");return n.href=i,n.target="_self",document.body.appendChild(n),n.click(),!0}catch{return!1}},t);return r&&(console.log(`[${this.versionString}] \u2705 Catalog URL\uB85C \uC774\uB3D9: ${t}`),await this.delay(1500)),r}isBridgeUrl(e){return NE.some(t=>e.includes(t))}async tryShoppingTabFallback(e){if(!this.page)return!1;try{console.log(`[${this.versionString}] Fallback: \uC21C\uC704 \uCCB4\uD06C \uC2DC\uC2A4\uD15C\uC73C\uB85C MID \uAC80\uC0C9`);let t=await Sn(this.page,e.keyword,e.nvMid,10);if(!t||!t.found)return console.log(`[${this.versionString}] MID ${e.nvMid} not found in shopping tab (10 pages)`),!1;console.log(`[${this.versionString}] MID found: Page ${t.page}, Rank ${t.totalRank}`),await this.delay(2e3);let r=`https://search.shopping.naver.com/catalog/${e.nvMid}`;if(!await this.page.evaluate(o=>{try{let a=document.createElement("a");return a.href=o,a.target="_self",document.body.appendChild(a),a.click(),!0}catch{return!1}},r))return console.log(`[${this.versionString}] Failed to create/click catalog link`),!1;console.log(`[${this.versionString}] \u2705 Catalog link clicked, waiting for navigation...`),await this.delay(4e3);let n=this.page.url();return console.log(`[${this.versionString}] \u2705 Fallback success: Final URL: ${n.substring(0,80)}`),!0}catch(t){return console.log(`[${this.versionString}] Fallback error: ${t.message}`),!1}}delay(e){return new Promise(t=>setTimeout(t,e))}async executeFullname(e,t="\uD1B5\uAC80"){let r=Date.now();if(!this.page)return{success:!1,version:this.versionString,blocked:!1,bridgeDetected:!1,midClicked:!1,error:"Browser not initialized"};try{let i=t==="\uC1FC\uAC80"?"https://www.naver.com/":"https://m.naver.com/";await this.page.goto(i,{waitUntil:"domcontentloaded"}),await this.delay(500);let n=e.productName.substring(0,50);return await this.page.evaluate(l=>{let c=document.querySelector('#query, input[type="search"], input[name="query"]');if(c){c.value=l,c.dispatchEvent(new Event("input",{bubbles:!0}));let u=c.closest("form");if(u)return u.submit(),!0}return!1},n)?(await this.page.waitForNavigation({waitUntil:"domcontentloaded",timeout:1e4}).catch(()=>{}),await this.delay(1500),await this.checkCaptcha()?{success:!1,version:this.versionString,blocked:!0,bridgeDetected:!1,midClicked:!1,error:"\uD1B5\uD569\uAC80\uC0C9 CAPTCHA",duration:Date.now()-r}:t==="\uD1B5\uAC80"?await this.executeUnifiedSearchMode(e,r):await this.executeShoppingTabMode(e,r)):{success:!1,version:this.versionString,blocked:!1,bridgeDetected:!1,midClicked:!1,error:"Search input not found"}}catch(i){return{success:!1,version:this.versionString,blocked:!1,bridgeDetected:!1,midClicked:!1,error:i.message,duration:Date.now()-r}}}async executeUnifiedSearchMode(e,t){if(!this.page)throw new Error("Page not initialized");for(let n=0;n<2;n++)await this.page.evaluate(()=>window.scrollBy(0,400)),await this.delay(500);let r=await this.clickDirectSmartStore(e.nvMid);if(console.log(`[${this.versionString}] \uD1B5\uAC80 clickDirectSmartStore: ${r}`),r||(r=await this.findAndClickMid(e.nvMid),console.log(`[${this.versionString}] \uD1B5\uAC80 findAndClickMid: ${r}`)),!r)return{success:!1,version:this.versionString,blocked:!1,bridgeDetected:!1,midClicked:!1,error:`MID ${e.nvMid} not found (\uD1B5\uAC80)`,duration:Date.now()-t};try{await this.page.waitForNavigation({waitUntil:"domcontentloaded",timeout:1e4})}catch{}await this.delay(1500);let i=this.page.url();if(this.isBridgeUrl(i)){console.log(`[${this.versionString}] Bridge URL detected, waiting...`);for(let n=0;n<3&&(await this.delay(800),i=this.page.url(),!!this.isBridgeUrl(i));n++);}return await this.validateFinalPage(e.nvMid,t)}async executeShoppingTabMode(e,t){if(!this.page||!this.browser)throw new Error("Browser not initialized");let r=await this.page.evaluate(()=>{let d=Array.from(document.querySelectorAll("a"));for(let h of d)if((h.textContent||"").trim()==="\uC1FC\uD551"&&h.href.includes("shopping")){let g=h.getBoundingClientRect();return{found:!0,x:g.left+g.width/2,y:g.top+g.height/2}}return{found:!1,x:0,y:0}});if(!r.found)return{success:!1,version:this.versionString,blocked:!1,bridgeDetected:!1,midClicked:!1,error:"\uC1FC\uD551\uD0ED not found",duration:Date.now()-t};let i=(await this.browser.pages()).length;console.log(`[${this.versionString}] \uC1FC\uAC80: \uC1FC\uD551\uD0ED \uD074\uB9AD (${Math.round(r.x)}, ${Math.round(r.y)})`),await this.page.mouse.click(r.x,r.y),await this.delay(1500);let n=await this.browser.pages();if(n.length<=i)return{success:!1,version:this.versionString,blocked:!1,bridgeDetected:!1,midClicked:!1,error:"\uC1FC\uD551\uD0ED \uC0C8 \uD0ED \uC5C6\uC74C",duration:Date.now()-t};let o=n[n.length-1];if(await o.bringToFront(),await o.setViewport({width:1366,height:768,deviceScaleFactor:1,isMobile:!1,hasTouch:!1}),await this.delay(1e3),console.log(`[${this.versionString}] \uC1FC\uAC80: Shopping URL: ${o.url().substring(0,60)}`),await o.evaluate(()=>document.body.innerText.includes("\uBCF4\uC548 \uD655\uC778")))return await o.close(),{success:!1,version:this.versionString,blocked:!0,bridgeDetected:!1,midClicked:!1,error:"\uC1FC\uD551\uAC80\uC0C9 CAPTCHA",duration:Date.now()-t};let l=!1;for(let d=0;d<5&&!l;d++){let h=await o.evaluate(g=>{let y=Array.from(document.querySelectorAll("a"));for(let _ of y){let b=_.href||"";if(b.includes(`nv_mid=${g}`)||b.includes(g)){let v=_.getBoundingClientRect();if(v.width>0&&v.height>0&&v.top>0&&v.top<window.innerHeight)return{found:!0,x:v.left+v.width/2,y:v.top+v.height/2,href:b}}}return{found:!1,x:0,y:0,href:""}},e.nvMid);h.found?(console.log(`[${this.versionString}] \uC1FC\uAC80: MID \uBC1C\uACAC! \uD074\uB9AD...`),i=(await this.browser.pages()).length,await o.mouse.click(h.x,h.y),l=!0):(await o.evaluate(()=>window.scrollBy(0,400)),await this.delay(200))}if(!l)return await o.close(),{success:!1,version:this.versionString,blocked:!1,bridgeDetected:!1,midClicked:!1,error:"MID not found (\uC1FC\uAC80)",duration:Date.now()-t};if(await this.delay(1500),n=await this.browser.pages(),n.length<=i){let d=o.url();if(console.log(`[${this.versionString}] \uC1FC\uAC80: \uAC19\uC740 \uD0ED \uC774\uB3D9 - ${d.substring(0,60)}`),d.includes("/products/")||d.includes("smartstore.naver.com")){for(let g=0;g<3;g++)await o.evaluate(()=>window.scrollBy(0,300)),await this.delay(300);return{success:!0,version:this.versionString,blocked:!1,bridgeDetected:!1,midClicked:!0,duration:Date.now()-t}}}let c=n[n.length-1];await c.bringToFront(),await c.setViewport({width:1366,height:768,deviceScaleFactor:1,isMobile:!1,hasTouch:!1}),await this.delay(1e3);let u=c.url();console.log(`[${this.versionString}] \uC1FC\uAC80: \uC0C1\uD488 \uD398\uC774\uC9C0: ${u.substring(0,60)}`);let f=await c.evaluate(()=>{let d=document.body.innerText;return{hasError:d.includes("\uC874\uC7AC\uD558\uC9C0 \uC54A\uB294")||d.includes("\uBCF4\uC548 \uD655\uC778")||d.includes("\uD310\uB9E4\uC885\uB8CC")||d.includes("\uC0AD\uC81C\uB41C")||d.includes("\uC77C\uC2DC\uC801\uC73C\uB85C \uC81C\uD55C"),preview:d.substring(0,200)}});if(f.hasError)return console.log(`[${this.versionString}] \uC1FC\uAC80: \uC624\uB958 - ${f.preview.substring(0,80)}`),await c.close(),await o.close(),{success:!1,version:this.versionString,blocked:f.preview.includes("\uBCF4\uC548")||f.preview.includes("\uC81C\uD55C"),bridgeDetected:!1,midClicked:!0,error:f.preview.substring(0,50),duration:Date.now()-t};console.log(`[${this.versionString}] \uC1FC\uAC80: \uC2A4\uD06C\uB864...`);for(let d=0;d<2;d++)await c.evaluate(()=>window.scrollBy(0,300)),await this.delay(200);return await c.close(),await o.close(),{success:!0,version:this.versionString,blocked:!1,bridgeDetected:!1,midClicked:!0,duration:Date.now()-t}}async validateFinalPage(e,t){if(!this.page)throw new Error("Page not initialized");await this.delay(300);let r=this.page.url();if(console.log(`[${this.versionString}] Final URL: ${r.substring(0,100)}`),!(r.includes("/catalog/")||r.includes("/products/")||r.includes("smartstore.naver.com")||r.includes("brand.naver.com")))return{success:!1,version:this.versionString,blocked:!1,bridgeDetected:!1,midClicked:!0,error:"Not a product page",duration:Date.now()-t};let n=await this.page.evaluate(()=>{let o=document.body?.innerText||"",a=["\uBCF4\uC548 \uD655\uC778\uC744 \uC644\uB8CC\uD574 \uC8FC\uC138\uC694","\uBCF4\uC548 \uD655\uC778","\uC77C\uC2DC\uC801\uC73C\uB85C \uC81C\uD55C","\uBE44\uC815\uC0C1\uC801\uC778 \uC811\uADFC","\uC790\uB3D9\uC785\uB825 \uBC29\uC9C0","\uC2E4\uC81C \uC0AC\uC6A9\uC790\uC784\uC744 \uD655\uC778"];for(let l of a)if(o.includes(l))return{blocked:!0,pattern:l,preview:o.substring(0,200)};return{blocked:!1,pattern:"",preview:""}});if(n.blocked){console.log(`[${this.versionString}] CAPTCHA detected: "${n.pattern}"`),console.log(`[${this.versionString}] Page preview: ${n.preview.substring(0,100)}`),console.log(`[${this.versionString}] \uC601\uC218\uC99D CAPTCHA \uC790\uB3D9 \uD574\uACB0 \uC2DC\uB3C4...`);try{if(await this.captchaSolver.solve(this.page)&&(console.log(`[${this.versionString}] \u2705 CAPTCHA \uD574\uACB0 \uC131\uACF5! \uD398\uC774\uC9C0 \uC7AC\uAC80\uC99D...`),await this.delay(2e3),await this.page.evaluate(()=>{let l=document.body?.innerText||"";return!l.includes("\uBCF4\uC548 \uD655\uC778")&&!l.includes("\uC601\uC218\uC99D")&&!l.includes("[?]")})))return{success:!0,version:this.versionString,blocked:!1,bridgeDetected:!1,midClicked:!0,duration:Date.now()-t};console.log(`[${this.versionString}] CAPTCHA \uD574\uACB0 \uC2E4\uD328`)}catch(o){console.log(`[${this.versionString}] CAPTCHA \uD574\uACB0 \uC5D0\uB7EC: ${o.message}`)}return{success:!1,version:this.versionString,blocked:!0,bridgeDetected:!1,midClicked:!0,error:`\uC0C1\uD488\uD398\uC774\uC9C0 CAPTCHA (${n.pattern})`,duration:Date.now()-t}}return await this.delay(500),{success:!0,version:this.versionString,blocked:!1,bridgeDetected:!1,midClicked:!0,duration:Date.now()-t}}}});var na,uf=E(()=>{na={version:"v9",deviceName:"Samsung Galaxy S24 Ultra",userAgent:"Mozilla/5.0 (Linux; Android 14; SM-S928N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Mobile Safari/537.36",viewport:{width:412,height:915,deviceScaleFactor:3.5},platform:"Linux armv8l",webgl:{vendor:"Qualcomm",renderer:"Adreno (TM) 750"},deviceMemory:12,hardwareConcurrency:8,maxTouchPoints:10,headers:{"accept-language":"ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7","sec-ch-ua":'"Google Chrome";v="131", "Chromium";v="131", "Not_A Brand";v="24"',"sec-ch-ua-mobile":"?1","sec-ch-ua-platform":'"Android"'},timezone:"Asia/Seoul",languages:["ko-KR","ko","en-US","en"],colorDepth:24}});var IE,oa,Aw=E(()=>{"use strict";tt();uf();IE=na,oa=class extends ue{get profile(){return IE}get versionString(){return"v9-simple"}}});var aa,df=E(()=>{aa={version:"v10",deviceName:"Xiaomi 13 Pro",userAgent:"Mozilla/5.0 (Linux; Android 13; 2210132C) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Mobile Safari/537.36",viewport:{width:412,height:892,deviceScaleFactor:3},platform:"Linux armv8l",webgl:{vendor:"Qualcomm",renderer:"Adreno (TM) 740"},deviceMemory:12,hardwareConcurrency:8,maxTouchPoints:10,headers:{"accept-language":"ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7","sec-ch-ua":'"Google Chrome";v="131", "Chromium";v="131", "Not_A Brand";v="24"',"sec-ch-ua-mobile":"?1","sec-ch-ua-platform":'"Android"'},timezone:"Asia/Seoul",languages:["ko-KR","ko","en-US","en"],colorDepth:24}});var DE,la,kw=E(()=>{"use strict";tt();df();DE=aa,la=class extends ue{get profile(){return DE}get versionString(){return"v10-simple"}}});var ca,hf=E(()=>{ca={version:"v11",deviceName:"iPhone 14 Pro Max",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 16_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Mobile/15E148 Safari/604.1",viewport:{width:430,height:932,deviceScaleFactor:3},platform:"iPhone",webgl:{vendor:"Apple Inc.",renderer:"Apple A16 GPU"},deviceMemory:6,hardwareConcurrency:6,maxTouchPoints:5,headers:{"accept-language":"ko-KR,ko;q=0.9","sec-ch-ua":'"Not A(Brand";v="99", "Safari";v="16"',"sec-ch-ua-mobile":"?1","sec-ch-ua-platform":'"iOS"'},timezone:"Asia/Seoul",languages:["ko-KR","ko"],colorDepth:32}});var LE,ua,Pw=E(()=>{"use strict";tt();hf();LE=ca,ua=class extends ue{get profile(){return LE}get versionString(){return"v11-simple"}}});var da,ff=E(()=>{da={version:"v12",deviceName:"OPPO Find X5 Pro",userAgent:"Mozilla/5.0 (Linux; Android 13; PFEM10) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Mobile Safari/537.36",viewport:{width:412,height:919,deviceScaleFactor:3.5},platform:"Linux armv8l",webgl:{vendor:"Qualcomm",renderer:"Adreno (TM) 730"},deviceMemory:12,hardwareConcurrency:8,maxTouchPoints:10,headers:{"accept-language":"ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7","sec-ch-ua":'"Google Chrome";v="131", "Chromium";v="131", "Not_A Brand";v="24"',"sec-ch-ua-mobile":"?1","sec-ch-ua-platform":'"Android"'},timezone:"Asia/Seoul",languages:["ko-KR","ko","en-US","en"],colorDepth:24}});var UE,ha,xw=E(()=>{"use strict";tt();ff();UE=da,ha=class extends ue{get profile(){return UE}get versionString(){return"v12-simple"}}});var fa,pf=E(()=>{fa={version:"v13",deviceName:"Google Pixel 8 Pro",userAgent:"Mozilla/5.0 (Linux; Android 14; Pixel 8 Pro) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Mobile Safari/537.36",viewport:{width:412,height:915,deviceScaleFactor:2.625},platform:"Linux armv8l",webgl:{vendor:"Qualcomm",renderer:"Adreno (TM) 740"},deviceMemory:12,hardwareConcurrency:9,maxTouchPoints:10,headers:{"accept-language":"ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7","sec-ch-ua":'"Google Chrome";v="131", "Chromium";v="131", "Not_A Brand";v="24"',"sec-ch-ua-mobile":"?1","sec-ch-ua-platform":'"Android"'},timezone:"Asia/Seoul",languages:["ko-KR","ko","en-US","en"],colorDepth:24}});var FE,pa,Cw=E(()=>{"use strict";tt();pf();FE=fa,pa=class extends ue{get profile(){return FE}get versionString(){return"v13-simple"}}});var ma,mf=E(()=>{ma={version:"v14",deviceName:"OnePlus 11",userAgent:"Mozilla/5.0 (Linux; Android 13; CPH2449) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Mobile Safari/537.36",viewport:{width:412,height:919,deviceScaleFactor:3.5},platform:"Linux armv8l",webgl:{vendor:"Qualcomm",renderer:"Adreno (TM) 740"},deviceMemory:16,hardwareConcurrency:8,maxTouchPoints:10,headers:{"accept-language":"ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7","sec-ch-ua":'"Google Chrome";v="131", "Chromium";v="131", "Not_A Brand";v="24"',"sec-ch-ua-mobile":"?1","sec-ch-ua-platform":'"Android"'},timezone:"Asia/Seoul",languages:["ko-KR","ko","en-US","en"],colorDepth:24}});var HE,ga,Rw=E(()=>{"use strict";tt();mf();HE=ma,ga=class extends ue{get profile(){return HE}get versionString(){return"v14-simple"}}});var ya,gf=E(()=>{ya={version:"v15",deviceName:"Vivo X90 Pro",userAgent:"Mozilla/5.0 (Linux; Android 13; V2227A) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Mobile Safari/537.36",viewport:{width:412,height:915,deviceScaleFactor:3},platform:"Linux armv8l",webgl:{vendor:"ARM",renderer:"Mali-G715"},deviceMemory:12,hardwareConcurrency:8,maxTouchPoints:10,headers:{"accept-language":"ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7","sec-ch-ua":'"Google Chrome";v="131", "Chromium";v="131", "Not_A Brand";v="24"',"sec-ch-ua-mobile":"?1","sec-ch-ua-platform":'"Android"'},timezone:"Asia/Seoul",languages:["ko-KR","ko","en-US","en"],colorDepth:24}});var zE,wa,Ow=E(()=>{"use strict";tt();gf();zE=ya,wa=class extends ue{get profile(){return zE}get versionString(){return"v15-simple"}}});var ba,yf=E(()=>{ba={version:"v16",deviceName:"Samsung Galaxy Z Fold5",userAgent:"Mozilla/5.0 (Linux; Android 13; SM-F946N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Mobile Safari/537.36",viewport:{width:344,height:882,deviceScaleFactor:3},platform:"Linux armv8l",webgl:{vendor:"Qualcomm",renderer:"Adreno (TM) 740"},deviceMemory:12,hardwareConcurrency:8,maxTouchPoints:10,headers:{"accept-language":"ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7","sec-ch-ua":'"Google Chrome";v="131", "Chromium";v="131", "Not_A Brand";v="24"',"sec-ch-ua-mobile":"?1","sec-ch-ua-platform":'"Android"'},timezone:"Asia/Seoul",languages:["ko-KR","ko","en-US","en"],colorDepth:24}});var QE,_a,Nw=E(()=>{"use strict";tt();yf();QE=ba,_a=class extends ue{get profile(){return QE}get versionString(){return"v16-simple"}}});var va,wf=E(()=>{va={version:"v17",deviceName:"iPhone 13 Pro",userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 15_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.6 Mobile/15E148 Safari/604.1",viewport:{width:390,height:844,deviceScaleFactor:3},platform:"iPhone",webgl:{vendor:"Apple Inc.",renderer:"Apple A15 GPU"},deviceMemory:6,hardwareConcurrency:6,maxTouchPoints:5,headers:{"accept-language":"ko-KR,ko;q=0.9","sec-ch-ua":'"Not A(Brand";v="99", "Safari";v="15"',"sec-ch-ua-mobile":"?1","sec-ch-ua-platform":'"iOS"'},timezone:"Asia/Seoul",languages:["ko-KR","ko"],colorDepth:32}});var GE,Sa,$w=E(()=>{"use strict";tt();wf();GE=va,Sa=class extends ue{get profile(){return GE}get versionString(){return"v17-simple"}}});var Ea,bf=E(()=>{Ea={version:"v18",deviceName:"ASUS ROG Phone 7",userAgent:"Mozilla/5.0 (Linux; Android 13; ASUS_AI2205) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Mobile Safari/537.36",viewport:{width:412,height:892,deviceScaleFactor:2.625},platform:"Linux armv8l",webgl:{vendor:"Qualcomm",renderer:"Adreno (TM) 740"},deviceMemory:16,hardwareConcurrency:8,maxTouchPoints:10,headers:{"accept-language":"ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7","sec-ch-ua":'"Google Chrome";v="131", "Chromium";v="131", "Not_A Brand";v="24"',"sec-ch-ua-mobile":"?1","sec-ch-ua-platform":'"Android"'},timezone:"Asia/Seoul",languages:["ko-KR","ko","en-US","en"],colorDepth:24}});var YE,Ta,Iw=E(()=>{"use strict";tt();bf();YE=Ea,Ta=class extends ue{get profile(){return YE}get versionString(){return"v18-simple"}}});var Aa,_f=E(()=>{Aa={version:"v19",deviceName:"Samsung Galaxy A54",userAgent:"Mozilla/5.0 (Linux; Android 13; SM-A546N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Mobile Safari/537.36",viewport:{width:412,height:915,deviceScaleFactor:2.625},platform:"Linux armv8l",webgl:{vendor:"ARM",renderer:"Mali-G68"},deviceMemory:8,hardwareConcurrency:8,maxTouchPoints:10,headers:{"accept-language":"ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7","sec-ch-ua":'"Google Chrome";v="131", "Chromium";v="131", "Not_A Brand";v="24"',"sec-ch-ua-mobile":"?1","sec-ch-ua-platform":'"Android"'},timezone:"Asia/Seoul",languages:["ko-KR","ko","en-US","en"],colorDepth:24}});var eT,ka,Mw=E(()=>{"use strict";tt();_f();eT=Aa,ka=class extends ue{get profile(){return eT}get versionString(){return"v19-simple"}}});var Pa,vf=E(()=>{Pa={version:"v20",deviceName:"Motorola Edge 40 Pro",userAgent:"Mozilla/5.0 (Linux; Android 13; motorola edge 40 pro) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Mobile Safari/537.36",viewport:{width:412,height:915,deviceScaleFactor:2.75},platform:"Linux armv8l",webgl:{vendor:"Qualcomm",renderer:"Adreno (TM) 730"},deviceMemory:12,hardwareConcurrency:8,maxTouchPoints:10,headers:{"accept-language":"ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7","sec-ch-ua":'"Google Chrome";v="131", "Chromium";v="131", "Not_A Brand";v="24"',"sec-ch-ua-mobile":"?1","sec-ch-ua-platform":'"Android"'},timezone:"Asia/Seoul",languages:["ko-KR","ko","en-US","en"],colorDepth:24}});var rT,xa,Dw=E(()=>{"use strict";tt();vf();rT=Pa,xa=class extends ue{get profile(){return rT}get versionString(){return"v20-simple"}}});var jw,Ca,Lw=E(()=>{"use strict";jw=require("puppeteer-real-browser"),Ca=class{constructor(e,t){this.profile=e;this.userDataDir=t}browser=null;page=null;async init(){let e={headless:!1,turnstile:!0,fingerprint:!0,args:["--no-sandbox","--disable-setuid-sandbox","--disable-blink-features=AutomationControlled","--start-maximized"]};this.userDataDir&&(e.userDataDir=this.userDataDir,console.log(`[BrowserManager] Using profile: ${this.userDataDir}`));let t=await(0,jw.connect)(e);this.browser=t.browser,this.page=t.page,await this.page.setViewport({width:1920,height:1080}),this.page.setDefaultTimeout(3e4),this.page.setDefaultNavigationTimeout(3e4)}getPage(){if(!this.page)throw new Error("Browser not initialized");return this.page}setPage(e){this.page=e}getBrowser(){if(!this.browser)throw new Error("Browser not initialized");return this.browser}async close(){this.browser&&(await this.browser.close(),this.browser=null,this.page=null)}}});var Ra,qw=E(()=>{"use strict";Ra=class{constructor(e){this.browserManager=e}async goto(e){await this.browserManager.getPage().goto(e,{waitUntil:"domcontentloaded"})}async gotoNaverHome(){await this.goto("https://m.naver.com/"),await this.delay(2e3)}async delay(e){return new Promise(t=>setTimeout(t,e))}}});var Oa,Uw=E(()=>{"use strict";Oa=class{constructor(e){this.browserManager=e}async typeSearch(e){let t=this.browserManager.getPage();if(!await t.evaluate(i=>{let n=document.querySelector('input[type="search"], input[name="query"]');if(n){n.value=i,n.dispatchEvent(new Event("input",{bubbles:!0}));let o=n.closest("form");if(o)return o.submit(),!0}return!1},e))throw new Error("Search input not found");try{await t.waitForNavigation({waitUntil:"domcontentloaded",timeout:2e4})}catch{}await this.delay(2500+Math.random()*1e3)}naturalDelay(e){let t=e+Math.random()*500;return new Promise(r=>setTimeout(r,t))}delay(e){return new Promise(t=>setTimeout(t,e))}}});var Na,Bw=E(()=>{"use strict";Na=class{constructor(e){this.browserManager=e}async isBlocked(){try{let t=await this.browserManager.getPage().evaluate(()=>{let r=document.body.innerText,i=document.documentElement.innerHTML;return r.includes("\uC77C\uC2DC\uC801\uC73C\uB85C \uC81C\uD55C")?(console.log("[BlockDetector] Detected: \uC77C\uC2DC\uC801\uC73C\uB85C \uC81C\uD55C"),!0):r.includes("\uC790\uB3D9\uC785\uB825 \uBC29\uC9C0")||r.includes("\uBCF4\uC548\uBB38\uC790")||r.includes("\uC790\uB3D9\uB4F1\uB85D\uBC29\uC9C0")||i.includes("captcha")||i.includes("Captcha")||i.includes("CAPTCHA")?(console.log("[BlockDetector] Detected: CAPTCHA"),!0):[document.querySelector('img[src*="captcha"]'),document.querySelector('[id*="captcha"]'),document.querySelector('[class*="captcha"]'),document.querySelector('input[name*="captcha"]')].some(o=>o!==null)?(console.log("[BlockDetector] Detected: CAPTCHA element found"),!0):r.includes("\uB85C\uBD07\uC774 \uC544\uB2D9\uB2C8\uB2E4")||r.includes("robot")||r.includes("Robot")?(console.log("[BlockDetector] Detected: Robot verification"),!0):!1});return t&&console.log("[BlockDetector] \u26A0\uFE0F Page is blocked or has CAPTCHA"),t}catch(e){return console.error("[BlockDetector] Error checking block status:",e),!1}}}});var Rs,Sf=E(()=>{"use strict";Rs=class{constructor(e){this.browserManager=e}async clickDirectSmartStore(e){return await this.browserManager.getPage().evaluate(r=>{let i=Array.from(document.querySelectorAll("a"));for(let n of i){let o=n.href||"";if(!(o.includes("/bridge")||o.includes("cr.shopping")||o.includes("cr2.shopping")||o.includes("cr3.shopping")||o.includes("cr4.shopping"))){if(o.includes("smartstore.naver.com")&&o.includes("/products/")&&o.includes(r))return console.log(`[MidMatcher] Direct smartstore: ${o.substring(0,80)}`),n.click(),!0;if(o.includes("brand.naver.com")&&o.includes("/products/")&&o.includes(r))return console.log(`[MidMatcher] Direct brand: ${o.substring(0,80)}`),n.click(),!0}}return!1},e)}async clickByMid(e){let t=this.browserManager.getPage();if(await this.clickDirectSmartStore(e))return console.log(`[MidMatcher] \u2705 Direct link clicked: ${e}`),!0;let i=await t.evaluate(n=>{let o=Array.from(document.querySelectorAll("a"));for(let a of o){let l=a.href||"";if(l.includes(n)||l.includes(`nvMid=${n}`))return{found:!0,href:l};if((a.getAttribute("data-nv-mid")||a.getAttribute("data-nvmid"))===n)return{found:!0,href:l}}return{found:!1}},e);return i.found?(await t.evaluate(n=>{let o=Array.from(document.querySelectorAll("a")).find(a=>a.href===n);o&&(console.log(`[MidMatcher] Clicking MID link: ${n.substring(0,80)}`),o.click())},i.href),console.log(`[MidMatcher] \u2705 MID link clicked: ${e}`),!0):(console.warn(`[MidMatcher] \u274C MID not found: ${e}`),!1)}delay(e){return new Promise(t=>setTimeout(t,e))}}});var sT,$a,Fw=E(()=>{"use strict";Sf();sT=["cr.shopping.naver.com/bridge","cr2.shopping.naver.com/bridge","cr3.shopping.naver.com/bridge","cr4.shopping.naver.com/bridge","shopping.naver.com/bridge","naver.com/v2/bridge","/bridge?"],$a=class{constructor(e){this.browserManager=e;this.midMatcher=new Rs(e)}midMatcher;isBridgeUrl(e){return sT.some(t=>e.includes(t))}async avoidIfDetected(e){let r=this.browserManager.getPage();for(let i=0;i<3;i++){await this.delay(800);let n=r.url();if(this.isBridgeUrl(n)){console.log(`[BridgeDetector] \uBE0C\uB9BF\uC9C0 \uAC10\uC9C0 (${i+1}/3): ${n.substring(0,50)}...`),await r.evaluate(()=>{window.stop()});try{await r.goBack({waitUntil:"domcontentloaded"})}catch{}if(await this.delay(1e3),await this.midMatcher.clickDirectSmartStore(e)){await this.delay(1500);let l=r.url();if(!this.isBridgeUrl(l))return console.log("[BridgeDetector] \u2705 \uBE0C\uB9BF\uC9C0 \uC6B0\uD68C \uC131\uACF5 (\uC9C1\uC811 \uB9C1\uD06C)"),!0}await this.midMatcher.clickByMid(e)&&await this.delay(1500)}else return console.log("[BridgeDetector] \u2705 \uBE0C\uB9BF\uC9C0 \uC5C6\uC74C"),!0}return console.warn("[BridgeDetector] \u274C \uBE0C\uB9BF\uC9C0 \uC6B0\uD68C \uC2E4\uD328 (3\uD68C \uC2DC\uB3C4)"),!1}delay(e){return new Promise(t=>setTimeout(t,e))}}});var Ia,Vw=E(()=>{"use strict";Ia=class{constructor(e){this.engineVersion=e}info(e,t){console.log(`[${this.engineVersion}] ${e}`,t||"")}warn(e,t){console.warn(`[${this.engineVersion}] ${e}`,t||"")}error(e,t){console.error(`[${this.engineVersion}] ${e}`,t||"")}success(e,t){console.log(`[${this.engineVersion}] \u2705 ${e}`,t||"")}}});var Af={};zi(Af,{EngineConfigLoader:()=>Tf});var Ma,Os,Hw,nT,iT,Ef,Tf,kf=E(()=>{"use strict";Ma=Jt(require("fs/promises"),1),Os=Jt(require("path"),1),Hw=require("url"),nT={},iT=(0,Hw.fileURLToPath)(nT.url),Ef=Os.dirname(iT),Tf=class{static cache={};static patternCache={};static async loadFromFile(e){if(this.cache[e])return this.cache[e];try{let t=Os.join(Ef,"../../engine-patterns.json"),r=await Ma.readFile(t,"utf-8"),n=JSON.parse(r).engine_config[e];if(!n)throw new Error(`No config found for engine ${e}`);return this.cache[e]={reach:n.reach,dwell:n.dwell},this.cache[e]}catch(t){throw new Error(`Failed to load config for ${e}: ${t.message}`)}}static async getPatternDefinition(e){if(this.patternCache[e])return this.patternCache[e];try{let t=Os.join(Ef,"../../engine-patterns.json"),r=await Ma.readFile(t,"utf-8"),n=JSON.parse(r).patterns[e];if(!n)throw new Error(`No pattern definition found for ${e}`);return this.patternCache[e]=n,n}catch(t){throw new Error(`Failed to load pattern ${e}: ${t.message}`)}}static clearCache(){this.cache={},this.patternCache={}}static async loadAllConfigs(){let e=Os.join(Ef,"../../engine-patterns.json"),t=await Ma.readFile(e,"utf-8");return JSON.parse(t).engine_config}}});var Z,qe=E(()=>{"use strict";Lw();qw();Uw();Bw();Fw();Sf();Vw();Z=class{constructor(e){this.profile=e;this.browserManager=new Ca(e),this.navigationOps=new Ra(this.browserManager),this.inputOps=new Oa(this.browserManager),this.blockDetector=new Na(this.browserManager),this.bridgeDetector=new $a(this.browserManager),this.midMatcher=new Rs(this.browserManager),this.logger=new Ia(e.version)}browserManager;navigationOps;inputOps;blockDetector;bridgeDetector;midMatcher;logger;async init(){this.logger.info("Initializing traffic engine"),await this.browserManager.init()}async execute(e){this.logger.info(`Executing traffic for ${e.productName}`);try{let t=this.browserManager.getPage();if(await this.navigationOps.gotoNaverHome(),this.logger.info("Navigated to Naver home"),await this.delay(1500+Math.random()*1e3),await this.inputOps.typeSearch(e.productName),this.logger.info(`Searched for: ${e.productName}`),await this.delay(2500+Math.random()*1e3),await this.blockDetector.isBlocked())return this.logger.warn("Traffic blocked by Naver"),{success:!1,version:this.profile.version,blocked:!0,bridgeDetected:!1,midClicked:!1,error:"Naver blocked traffic"};this.logger.info("Scrolling search results...");for(let a=0;a<5;a++)await t.evaluate(()=>window.scrollBy(0,400)),await this.delay(500);if(!await this.midMatcher.clickByMid(e.nvMid))return this.logger.warn("Failed to click MID"),{success:!1,version:this.profile.version,blocked:!1,bridgeDetected:!1,midClicked:!1,error:"MID not found in search results"};this.logger.info("MID clicked successfully"),await this.naturalDelay(1500);let n=t.url(),o=this.bridgeDetector.isBridgeUrl(n);return o&&(this.logger.warn("Bridge URL detected, avoiding..."),!await this.bridgeDetector.avoidIfDetected(e.nvMid))?{success:!1,version:this.profile.version,blocked:!1,bridgeDetected:!0,midClicked:!0,error:"Bridge avoidance failed"}:(this.logger.info("Dwelling on product page..."),await this.naturalDelay(5e3),this.logger.success("Traffic executed successfully"),{success:!0,version:this.profile.version,blocked:!1,bridgeDetected:o,midClicked:!0})}catch(t){return this.logger.error("Traffic execution failed",t),{success:!1,version:this.profile.version,blocked:!1,bridgeDetected:!1,midClicked:!1,error:t.message}}}delay(e){return new Promise(t=>setTimeout(t,e))}naturalDelay(e){let t=e+Math.random()*1e3;return new Promise(r=>setTimeout(r,t))}async buildNaverHistory(){let e=this.browserManager.getPage();this.logger.info("\uD788\uC2A4\uD1A0\uB9AC \uC313\uAE30 \uC2DC\uC791 (\uB274\uC2A4 2\uAC1C + \uC1FC\uD551 1\uAC1C)");let t=["https://news.naver.com/","https://entertain.naver.com/"];for(let r of t)await e.goto(r,{waitUntil:"domcontentloaded"}),this.logger.info(`\uD788\uC2A4\uD1A0\uB9AC: ${r.substring(8,30)}...`),await this.delay(2e3+Math.random()*2e3),await e.evaluate(()=>window.scrollBy(0,300+Math.random()*200)),await this.delay(500+Math.random()*500),await this.microMouseJitter(400+Math.random()*200,300+Math.random()*100),await this.delay(1e3+Math.random()*1e3);await e.goto("https://shopping.naver.com/",{waitUntil:"domcontentloaded"}),this.logger.info("\uD788\uC2A4\uD1A0\uB9AC: shopping.naver.com"),await this.delay(2e3+Math.random()*2e3),await e.evaluate(()=>window.scrollBy(0,400+Math.random()*200)),await this.microMouseJitter(350+Math.random()*200,250+Math.random()*100),await this.delay(1500+Math.random()*1e3),this.logger.info("\uD788\uC2A4\uD1A0\uB9AC \uC313\uAE30 \uC644\uB8CC")}async mistakeAction(e,t){let r=this.browserManager.getPage();if(Math.random()<.35){let i=(Math.random()-.5)*60+(Math.random()>.5?30:-30),n=(Math.random()-.5)*60+(Math.random()>.5?30:-30),o=e+i,a=t+n;return this.logger.info(`\uC2E4\uC218 \uD589\uB3D9: (${Math.round(e)}, ${Math.round(t)}) \u2192 (${Math.round(o)}, ${Math.round(a)})`),await this.moveMouseBezier(e,t,o,a),await this.delay(300+Math.random()*500),{x:o,y:a}}return{x:e,y:t}}async moveMouseBezier(e,t,r,i){let n=this.browserManager.getPage(),o=20+Math.floor(Math.random()*10),a=e+(r-e)*.3+(Math.random()-.5)*100,l=t+(i-t)*.3+(Math.random()-.5)*100,c=e+(r-e)*.7+(Math.random()-.5)*100,u=t+(i-t)*.7+(Math.random()-.5)*100;for(let f=0;f<=o;f++){let d=f/o,h=Math.pow(1-d,3)*e+3*Math.pow(1-d,2)*d*a+3*(1-d)*Math.pow(d,2)*c+Math.pow(d,3)*r,g=Math.pow(1-d,3)*t+3*Math.pow(1-d,2)*d*l+3*(1-d)*Math.pow(d,2)*u+Math.pow(d,3)*i,y=h+(Math.random()-.5)*(3+Math.random()*3),_=g+(Math.random()-.5)*(3+Math.random()*3);await n.mouse.move(y,_),await this.delay(10+Math.random()*15)}}async microMouseJitter(e,t){let r=this.browserManager.getPage(),i=2+Math.floor(Math.random()*2);for(let n=0;n<i;n++){let o=e+(Math.random()-.5)*30,a=t+(Math.random()-.5)*30;await r.mouse.move(o,a),await this.delay(50+Math.random()*100)}}async getRandomProductElement(){return await this.browserManager.getPage().evaluate(()=>{let t=document.querySelectorAll("[data-shp-contents-id]");if(t.length===0)return null;let r=Math.floor(Math.random()*Math.min(t.length,10)),n=t[r].getBoundingClientRect();return{x:n.left+n.width/2+(Math.random()-.5)*40,y:n.top+n.height/2+(Math.random()-.5)*40}})}async findTargetProductPosition(e){return await this.browserManager.getPage().evaluate(r=>{let i=document.querySelectorAll("[data-shp-contents-id]");for(let n of i)if(n.getAttribute("data-shp-contents-id")===r){let a=n.getBoundingClientRect(),l=n.closest("a")||n.querySelector("a");return{x:a.left+a.width/2+(Math.random()-.5)*40,y:a.top+a.height/2+(Math.random()-.5)*40,url:l?.href||""}}return null},e)}async executeShopping2Scenario(e){let t=this.browserManager.getPage();this.logger.info("v3 Step 1: \uCD08\uAE30 \uBA48\uCDA4 1.4~2.4\uCD08"),await this.delay(1400+Math.random()*1e3);let r=100+Math.random()*300,i=50+Math.random()*50,n=200+Math.random()*400,o=150+Math.random()*100;this.logger.info("v3 Step 2: \uCD08\uAE30 \uB9C8\uC6B0\uC2A4 \uACE1\uC120 \uC774\uB3D9"),await this.moveMouseBezier(r,i,n,o),await this.delay(400+Math.random()*500),this.logger.info("v3 Step 3: \uC2A4\uD06C\uB864 2~3\uD68C");let a=180+Math.floor(Math.random()*80);await t.evaluate(_=>window.scrollBy(0,_),a),await this.delay(350+Math.random()*350);let l=200+Math.floor(Math.random()*130);if(await t.evaluate(_=>window.scrollBy(0,_),l),await this.delay(500+Math.random()*400),Math.random()<.25){let _=120+Math.floor(Math.random()*100);this.logger.info(`v3 Step 3: \uCD94\uAC00 \uC2A4\uD06C\uB864 ${_}px`),await t.evaluate(b=>window.scrollBy(0,b),_),await this.delay(300+Math.random()*300)}let c=await this.mistakeAction(n,o);n=c.x,o=c.y;let u=await this.getRandomProductElement();u&&(this.logger.info("v3 Step 5: \uB79C\uB364 \uC0C1\uD488 hover"),await this.moveMouseBezier(n,o,u.x,u.y),await this.delay(500+Math.random()*600),n=u.x,o=u.y);let f=await this.findTargetProductPosition(e.nvMid);if(!f)return this.logger.warn("v3: MID not found"),{success:!1,version:this.profile.version,blocked:!1,bridgeDetected:!1,midClicked:!1,error:"MID not found (v3)"};this.logger.info("v3 Step 6: \uBAA9\uD45C \uC0C1\uD488\uC73C\uB85C \uC774\uB3D9"),await this.moveMouseBezier(n,o,f.x,f.y),await this.delay(500+Math.random()*400);let d=f.x+(Math.random()-.5)*50,h=f.y+(Math.random()-.5)*50,g=30+Math.floor(Math.random()*60);this.logger.info(`v3 Step 7: \uD074\uB9AD (${Math.round(d)}, ${Math.round(h)}) delay=${g}ms`),await t.mouse.click(d,h,{delay:g}),await t.waitForNavigation({waitUntil:"domcontentloaded",timeout:15e3}).catch(()=>{}),this.logger.info("v3 Step 8: \uC0C1\uC138\uD398\uC774\uC9C0 \uB300\uAE30"),await this.delay(900+Math.random()*900);let y=2+Math.floor(Math.random()*3);this.logger.info(`v3 Step 9: \uC0C1\uC138\uD398\uC774\uC9C0 \uC2A4\uD06C\uB864 ${y}\uD68C`);for(let _=0;_<y;_++){let b=220+Math.floor(Math.random()*200);await t.evaluate(v=>window.scrollBy(0,v),b),await this.delay(400+Math.random()*500)}return this.logger.info("v3 Step 10: \uB9C8\uC9C0\uB9C9 \uCCB4\uB958 1.4~2.6\uCD08"),await this.delay(1400+Math.random()*1200),this.logger.success("v3 \uC2DC\uB098\uB9AC\uC624 \uC644\uB8CC"),{success:!0,version:this.profile.version,blocked:!1,bridgeDetected:!1,midClicked:!0}}async executeFullname(e,t="\uD1B5\uAC80"){this.logger.info(`Executing fullname traffic (${t}) for ${e.productName}`);try{let r=this.browserManager.getPage();if(t==="\uC1FC\uAC802"&&await this.buildNaverHistory(),await r.goto("https://www.naver.com/",{waitUntil:"domcontentloaded"}),this.logger.info("Navigated to Naver home (PC)"),await this.delay(t==="\uC1FC\uAC80"?800:1500),t==="\uC1FC\uAC802"){let l=await r.evaluate(()=>{let d=document.querySelector("span.service_icon.type_shopping");if(d){let y=d.closest("a");if(y&&y.href)return y.href}let h=document.querySelector('a[href*="shopping.naver.com/ns/home"]');if(h)return h.href;let g=Array.from(document.querySelectorAll("a"));for(let y of g)if(y.innerText.trim()==="\uC2A4\uD1A0\uC5B4"&&y.href.includes("shopping"))return y.href;return null});if(l){this.logger.info(`Found store URL: ${l.substring(0,60)}`);let d=r.url();await r.goto(l,{waitUntil:"domcontentloaded",timeout:15e3,referer:d})}else this.logger.warn("Store button not found, falling back to direct URL"),await r.goto("https://shopping.naver.com/ns/home",{waitUntil:"domcontentloaded"});this.logger.info("\uC1FC\uAC802: \uC2A4\uD1A0\uC5B4 \uD648 \uC0AC\uC804 \uB3D9\uC791 \uC2DC\uC791"),await this.delay(5e3+Math.random()*3e3);let c=400+Math.random()*200,u=400+Math.random()*100;await this.moveMouseBezier(c,u,300+Math.random()*200,150+Math.random()*50);let f=200+Math.floor(Math.random()*150);await r.evaluate(d=>window.scrollBy(0,d),f),this.logger.info(`\uC1FC\uAC802: \uC2A4\uD1A0\uC5B4 \uD648 \uC2A4\uD06C\uB864 ${f}px`),await this.delay(800+Math.random()*400),await r.evaluate(d=>window.scrollBy(0,-d),f),await this.delay(600+Math.random()*300),await this.microMouseJitter(350+Math.random()*100,100+Math.random()*50),this.logger.info(`Now at: ${r.url()}`)}this.logger.info(`Searching fullname (${t}): ${e.productName.substring(0,50)}...`);let i=!1;if(t==="\uC1FC\uAC802"){let l='input#input_text, input[name="query"]',c=await r.evaluate(()=>{let f=document.querySelector('input#input_text, input[name="query"]');if(f){let d=f.getBoundingClientRect();return{x:d.left+d.width/2,y:d.top+d.height/2}}return null});if(!c)return{success:!1,version:this.profile.version,blocked:!1,bridgeDetected:!1,midClicked:!1,error:"Shopping search input not found (position)"};this.logger.info("\uC1FC\uAC802: \uAC80\uC0C9\uCC3D\uC73C\uB85C \uB9C8\uC6B0\uC2A4 \uC774\uB3D9"),await this.moveMouseBezier(350,150,c.x,c.y),await this.delay(400+Math.random()*300);try{await r.mouse.click(c.x,c.y),this.logger.info("\uC1FC\uAC802: \uAC80\uC0C9\uCC3D \uD074\uB9AD"),await this.delay(500+Math.random()*300),this.logger.info("\uC1FC\uAC802: \uD0C0\uC774\uD551 \uC2DC\uC791 (\uB290\uB9B0 \uC18D\uB3C4)"),await r.type(l,e.productName,{delay:80+Math.random()*70}),await this.delay(600+Math.random()*400);let f=await r.evaluate(()=>{let d=Array.from(document.querySelectorAll("button"));for(let h of d)if(h.className.includes("_searchInput_button_search_")||h.innerText.trim()==="\uAC80\uC0C9"&&h.type==="button"){let g=h.getBoundingClientRect();return{x:g.left+g.width/2,y:g.top+g.height/2}}return null});f?(this.logger.info("\uC1FC\uAC802: \uAC80\uC0C9 \uBC84\uD2BC\uC73C\uB85C \uB9C8\uC6B0\uC2A4 \uC774\uB3D9"),await this.moveMouseBezier(c.x,c.y,f.x,f.y),await this.delay(300+Math.random()*200),await r.mouse.click(f.x,f.y),this.logger.info("\uC1FC\uAC802: \uAC80\uC0C9 \uBC84\uD2BC \uD074\uB9AD"),i=!0):(this.logger.info("\uC1FC\uAC802: \uAC80\uC0C9 \uBC84\uD2BC \uC5C6\uC74C, Enter \uD0A4 \uC0AC\uC6A9"),await r.keyboard.press("Enter"),i=!0)}catch{this.logger.warn("Shopping search input click/type failed"),i=!1}return i?(await r.waitForNavigation({waitUntil:"domcontentloaded",timeout:15e3}).catch(()=>{}),await this.delay(2500+Math.random()*500),await r.evaluate(()=>{let f=document.body?.innerText||"";return f.includes("\uC77C\uC2DC\uC801\uC73C\uB85C \uC81C\uD55C")||f.includes("\uBCF4\uC548 \uD655\uC778\uC744 \uC644\uB8CC\uD574 \uC8FC\uC138\uC694")||f.includes("\uC790\uB3D9\uC785\uB825 \uBC29\uC9C0")||f.includes("\uC601\uC218\uC99D")})?(this.logger.warn("Shopping CAPTCHA detected (\uC1FC\uAC802)"),{success:!1,version:this.profile.version,blocked:!0,bridgeDetected:!1,midClicked:!1,error:"CAPTCHA at shopping search (\uC1FC\uAC802)"}):(this.logger.info("\uC1FC\uAC802: \uCD5C\uC801\uD654 \uC2DC\uB098\uB9AC\uC624 \uC2DC\uC791 (12\uB2E8\uACC4)"),await this.executeShopping2Scenario(e))):{success:!1,version:this.profile.version,blocked:!1,bridgeDetected:!1,midClicked:!1,error:"Shopping search input not found"}}else if(t==="\uD1B5\uAC80")i=await r.evaluate(l=>{let c=document.querySelector("input.search_input, input#query");if(c){c.value=l,c.focus(),c.dispatchEvent(new Event("input",{bubbles:!0}));let u=document.querySelector("button.btn_search, button.bt_search");if(u)return u.click(),!0}return!1},e.productName);else{if(i=await r.evaluate(f=>{let d=document.querySelector("input.search_input, input#query");if(d){d.value=f,d.focus(),d.dispatchEvent(new Event("input",{bubbles:!0}));let h=document.querySelector("button.btn_search, button.bt_search");if(h)return h.click(),!0}return!1},e.productName),!i)return{success:!1,version:this.profile.version,blocked:!1,bridgeDetected:!1,midClicked:!1,error:"Unified search failed"};await r.waitForNavigation({waitUntil:"domcontentloaded"}).catch(()=>{}),await this.delay(2e3);let l=await r.evaluate(()=>{let f=Array.from(document.querySelectorAll("a"));for(let d of f){let h=d.getAttribute("href")||"";if(h.includes("search.shopping.naver.com/search"))return h}return null});if(!l)return{success:!1,version:this.profile.version,blocked:!1,bridgeDetected:!1,midClicked:!1,error:"Shopping link not found"};let c=r.url();if(await r.goto(l,{waitUntil:"networkidle0",timeout:3e4,referer:c}),await this.delay(5e3),await r.evaluate(()=>{let f=document.body?.innerText||"";return f.includes("\uBCF4\uC548 \uD655\uC778\uC744 \uC644\uB8CC\uD574 \uC8FC\uC138\uC694")||f.includes("\uC77C\uC2DC\uC801\uC73C\uB85C \uC81C\uD55C")||f.includes("\uC790\uB3D9\uC785\uB825 \uBC29\uC9C0")||f.includes("\uC2E4\uC81C \uC0AC\uC6A9\uC790\uC784\uC744 \uD655\uC778")}))return this.logger.warn("CAPTCHA detected at shopping search (\uC1FC\uAC80)"),{success:!1,version:this.profile.version,blocked:!0,bridgeDetected:!1,midClicked:!1,error:"CAPTCHA at shopping search"};i=!0}if(!i)return{success:!1,version:this.profile.version,blocked:!1,bridgeDetected:!1,midClicked:!1,error:"Search input not found"};if(t==="\uD1B5\uAC80"&&(await r.waitForNavigation({waitUntil:"domcontentloaded",timeout:2e4}).catch(()=>{}),await this.naturalDelay(2e3),await r.evaluate(()=>{let c=document.body?.innerText||"";return c.includes("\uC77C\uC2DC\uC801\uC73C\uB85C \uC81C\uD55C")||c.includes("\uBCF4\uC548 \uD655\uC778")||c.includes("\uC790\uB3D9\uC785\uB825 \uBC29\uC9C0")})))return this.logger.warn("CAPTCHA detected"),{success:!1,version:this.profile.version,blocked:!0,bridgeDetected:!1,midClicked:!1,error:"CAPTCHA at unified search"};if(t==="\uD1B5\uAC80"){let{EngineConfigLoader:l}=await Promise.resolve().then(()=>(kf(),Af)),c=await l.loadFromFile(this.profile.version),u=await l.getPatternDefinition(c.reach);this.logger.info(`Pattern: ${c.reach} + ${c.dwell}\uCD08`),u.scrollBeforeClick?(this.logger.info(`B2: Scroll ${u.scrollAmount}px before click`),await r.evaluate(f=>window.scrollBy(0,f),u.scrollAmount),await this.delay(u.scrollDelay)):this.logger.info("B1: Direct click")}else this.logger.info(`${t}: Direct click (no pattern)`);if(this.logger.info(`Finding MID ${e.nvMid} in search results...`),t==="\uD1B5\uAC80"){let l=await r.evaluate(u=>{let f=Array.from(document.querySelectorAll("a"));for(let d of f){let h=d.href||"";if(h.includes("smartstore.naver.com")&&h.includes(`/products/${u}`))return console.log(`[Found Exact] smartstore: ${h}`),h;if(h.includes("brand.naver.com")&&h.includes(`/products/${u}`))return console.log(`[Found Exact] brand: ${h}`),h;if(h.includes(`/catalog/${u}`))return console.log(`[Found Exact] catalog: ${h}`),h}for(let d of f){let h=d.href||"",g=h.match(/[?&]nv_mid=(\d+)/i);if(g&&g[1]===u)return console.log(`[Found Exact] nv_mid param: ${h}`),h}console.log(`[Fallback] Exact MID ${u} not found, using first product link...`);for(let d of f){let h=d.href||"";if(h.includes("smartstore.naver.com")&&h.includes("/products/")&&!h.includes("/outlink/"))return console.log(`[Fallback] First smartstore product: ${h}`),h;if(h.includes("brand.naver.com")&&h.includes("/products/"))return console.log(`[Fallback] First brand product: ${h}`),h}for(let d of f){let h=d.href||"";if(h.includes("/catalog/")&&h.includes("shopping.naver.com"))return console.log(`[Fallback] First catalog: ${h}`),h}return console.log(`[Debug] No product links found. Total links: ${f.length}`),null},e.nvMid);if(!l)return this.logger.warn("MID not found in unified search results"),{success:!1,version:this.profile.version,blocked:!1,bridgeDetected:!1,midClicked:!1,error:"MID not found (\uD1B5\uAC80)"};this.logger.info(`Found product URL: ${l.substring(0,60)}...`);let c=r.url();await r.goto(l,{waitUntil:"domcontentloaded",timeout:15e3,referer:c}),await this.delay(1e3)}else{let l=await r.evaluate(d=>{let h=document.querySelectorAll("[data-shp-contents-id]");for(let y of h)if(y.getAttribute("data-shp-contents-id")===d){let b=y.tagName==="A"?y:y.closest("a")||y.querySelector("a");if(b){let v=b.getBoundingClientRect();return{found:!0,x:v.left+v.width/2,y:v.top+v.height/2,href:b.href}}}let g=Array.from(document.querySelectorAll("a"));for(let y of g){let _=y.href||"",b=_.match(/[?&]nv_mid=(\d+)/i);if(b&&b[1]===d){let v=y.getBoundingClientRect();return{found:!0,x:v.left+v.width/2,y:v.top+v.height/2,href:_}}if(_.includes(`/products/${d}`)||_.includes(`/catalog/${d}`)){let v=y.getBoundingClientRect();return{found:!0,x:v.left+v.width/2,y:v.top+v.height/2,href:_}}}return{found:!1,x:0,y:0,href:""}},e.nvMid);if(!l.found)return{success:!1,version:this.profile.version,blocked:!1,bridgeDetected:!1,midClicked:!1,error:`MID not found (${t})`};this.logger.info(`Found product URL (\uC1FC\uAC80): ${l.href.substring(0,60)}...`);let c=r.browser(),u=(await c.pages()).length;await r.mouse.click(l.x,l.y),await this.delay(2e3);let f=await c.pages();if(f.length>u){let d=f[f.length-1];await d.bringToFront(),await d.waitForNavigation({waitUntil:"domcontentloaded",timeout:1e4}).catch(()=>{});let h=d.url(),g=h.includes("/catalog/")||h.includes("/products/")||h.includes("smartstore.naver.com")||h.includes("brand.naver.com"),y=await d.evaluate(()=>{let _=document.body?.innerText||"";return _.includes("\uBCF4\uC548 \uD655\uC778\uC744 \uC644\uB8CC\uD574 \uC8FC\uC138\uC694")||_.includes("\uC77C\uC2DC\uC801\uC73C\uB85C \uC81C\uD55C")});if(await d.close(),y)return this.logger.warn("Product page CAPTCHA detected (new tab)"),{success:!1,version:this.profile.version,blocked:!0,bridgeDetected:!1,midClicked:!0,error:"Product page CAPTCHA (new tab)"};if(g)return this.logger.info("Dwell (\uC1FC\uAC80): 1.0\uCD08"),await this.delay(1e3),{success:!0,version:this.profile.version,blocked:!1,bridgeDetected:!1,midClicked:!0}}await this.delay(1e3)}if(await r.evaluate(()=>{let l=document.body?.innerText||"",c=document.title||"";return!!(l.includes("\uBCF4\uC548 \uD655\uC778\uC744 \uC644\uB8CC\uD574 \uC8FC\uC138\uC694")||c.includes("\uBCF4\uC548 \uD655\uC778")||l.includes("\uC77C\uC2DC\uC801\uC73C\uB85C \uC81C\uD55C"))}))return this.logger.warn("Product page CAPTCHA detected"),{success:!1,version:this.profile.version,blocked:!0,bridgeDetected:!1,midClicked:!0,error:"Product page CAPTCHA"};let o=r.url();if(!(o.includes("/catalog/")||o.includes("/products/")||o.includes("smartstore.naver.com")||o.includes("brand.naver.com")))return{success:!1,version:this.profile.version,blocked:!1,bridgeDetected:!1,midClicked:!0,error:"Not a product page"};if(t==="\uD1B5\uAC80"){let{EngineConfigLoader:l}=await Promise.resolve().then(()=>(kf(),Af)),c=await l.loadFromFile(this.profile.version),u=c.dwell*1e3;this.logger.info(`Dwell (\uD1B5\uAC80): ${c.dwell}\uCD08`),await this.delay(u)}else this.logger.info(`Dwell (${t}): 1.0\uCD08`),await this.delay(1e3);return this.logger.success("Fullname traffic executed successfully"),{success:!0,version:this.profile.version,blocked:!1,bridgeDetected:!1,midClicked:!0}}catch(r){return this.logger.error("Fullname traffic execution failed",r),{success:!1,version:this.profile.version,blocked:!1,bridgeDetected:!1,midClicked:!1,error:r.message}}}async close(){this.logger.info("Closing browser"),await this.browserManager.close()}}});var ee,Ue=E(()=>{"use strict";ee=class{static load(e){return e}}});var Da,Kw=E(()=>{"use strict";qe();Ue();_y();Da=class extends Z{constructor(){super(ee.load(vy))}}});var ja,zw=E(()=>{"use strict";qe();Ue();uh();ja=class extends Z{constructor(){super(ee.load(Po))}}});var La,Ww=E(()=>{"use strict";qe();Ue();uf();La=class extends Z{constructor(){super(ee.load(na))}}});var qa,Qw=E(()=>{"use strict";qe();Ue();df();qa=class extends Z{constructor(){super(ee.load(aa))}}});var Ua,Jw=E(()=>{"use strict";qe();Ue();hf();Ua=class extends Z{constructor(){super(ee.load(ca))}}});var Ba,Gw=E(()=>{"use strict";qe();Ue();ff();Ba=class extends Z{constructor(){super(ee.load(da))}}});var Fa,Xw=E(()=>{"use strict";qe();Ue();pf();Fa=class extends Z{constructor(){super(ee.load(fa))}}});var Va,Yw=E(()=>{"use strict";qe();Ue();mf();Va=class extends Z{constructor(){super(ee.load(ma))}}});var Ha,Zw=E(()=>{"use strict";qe();Ue();gf();Ha=class extends Z{constructor(){super(ee.load(ya))}}});var Ka,eb=E(()=>{"use strict";qe();Ue();yf();Ka=class extends Z{constructor(){super(ee.load(ba))}}});var za,tb=E(()=>{"use strict";qe();Ue();wf();za=class extends Z{constructor(){super(ee.load(va))}}});var Wa,rb=E(()=>{"use strict";qe();Ue();bf();Wa=class extends Z{constructor(){super(ee.load(Ea))}}});var Qa,sb=E(()=>{"use strict";qe();Ue();_f();Qa=class extends Z{constructor(){super(ee.load(Aa))}}});var Ja,ib=E(()=>{"use strict";qe();Ue();vf();Ja=class extends Z{constructor(){super(ee.load(Pa))}}});var nb={};zi(nb,{EngineRouter:()=>Pf});var Pf,ob=E(()=>{"use strict";Ey();ky();Aw();kw();Pw();xw();Cw();Rw();Ow();Nw();$w();Iw();Mw();Dw();Kw();zw();Ww();Qw();Jw();Gw();Xw();Yw();Zw();eb();tb();rb();sb();ib();Pf=class{static getEngine(e){switch(e){case"v7":return new ko;case"v8":return new xo;case"v9":return new oa;case"v10":return new la;case"v11":return new ua;case"v12":return new ha;case"v13":return new pa;case"v14":return new ga;case"v15":return new wa;case"v16":return new _a;case"v17":return new Sa;case"v18":return new Ta;case"v19":return new ka;case"v20":return new xa;default:throw new Error(`Unknown engine version: ${e}`)}}static getAllVersions(){return["v7","v8","v9","v10","v11","v12","v13","v14","v15","v16","v17","v18","v19","v20"]}static getRandomVersion(){let e=this.getAllVersions();return e[Math.floor(Math.random()*e.length)]}static getFullnameEngine(e){switch(e){case"v7":return new Da;case"v8":return new ja;case"v9":return new La;case"v10":return new qa;case"v11":return new Ua;case"v12":return new Ba;case"v13":return new Fa;case"v14":return new Va;case"v15":return new Ha;case"v16":return new Ka;case"v17":return new za;case"v18":return new Wa;case"v19":return new Qa;case"v20":return new Ja;default:throw new Error(`Unknown fullname engine version: ${e}`)}}static getRandomFullnameEngine(){let e=this.getRandomVersion();return this.getFullnameEngine(e)}}});var Rf=Jt(require("os"),1);var p=Symbol.for("drizzle:entityKind"),mT=Symbol.for("drizzle:hasOwnEntityKind");function S(s,e){if(!s||typeof s!="object")return!1;if(s instanceof e)return!0;if(!Object.prototype.hasOwnProperty.call(e,p))throw new Error(`Class "${e.name??"<unknown>"}" doesn't look like a Drizzle entity. If this is incorrect and the class is provided by Drizzle, please report this as a bug.`);let t=Object.getPrototypeOf(s).constructor;if(t)for(;t;){if(p in t&&t[p]===e[p])return!0;t=Object.getPrototypeOf(t)}return!1}var se=class{constructor(e,t){this.table=e,this.config=t,this.name=t.name,this.keyAsName=t.keyAsName,this.notNull=t.notNull,this.default=t.default,this.defaultFn=t.defaultFn,this.onUpdateFn=t.onUpdateFn,this.hasDefault=t.hasDefault,this.primary=t.primaryKey,this.isUnique=t.isUnique,this.uniqueName=t.uniqueName,this.uniqueType=t.uniqueType,this.dataType=t.dataType,this.columnType=t.columnType,this.generated=t.generated,this.generatedIdentity=t.generatedIdentity}static[p]="Column";name;keyAsName;primary;notNull;default;defaultFn;onUpdateFn;hasDefault;isUnique;uniqueName;uniqueType;dataType;columnType;enumValues=void 0;generated=void 0;generatedIdentity=void 0;config;mapFromDriverValue(e){return e}mapToDriverValue(e){return e}shouldDisableInsert(){return this.config.generated!==void 0&&this.config.generated.type!=="byDefault"}};var Wi=class{static[p]="ColumnBuilder";config;constructor(e,t,r){this.config={name:e,keyAsName:e==="",notNull:!1,default:void 0,hasDefault:!1,primaryKey:!1,isUnique:!1,uniqueName:void 0,uniqueType:void 0,dataType:t,columnType:r,generated:void 0}}$type(){return this}notNull(){return this.config.notNull=!0,this}default(e){return this.config.default=e,this.config.hasDefault=!0,this}$defaultFn(e){return this.config.defaultFn=e,this.config.hasDefault=!0,this}$default=this.$defaultFn;$onUpdateFn(e){return this.config.onUpdateFn=e,this.config.hasDefault=!0,this}$onUpdate=this.$onUpdateFn;primaryKey(){return this.config.primaryKey=!0,this.config.notNull=!0,this}setName(e){this.config.name===""&&(this.config.name=e)}};var ht=Symbol.for("drizzle:Name");var Qi=class{static[p]="PgForeignKeyBuilder";reference;_onUpdate="no action";_onDelete="no action";constructor(e,t){this.reference=()=>{let{name:r,columns:i,foreignColumns:n}=e();return{name:r,columns:i,foreignTable:n[0].table,foreignColumns:n}},t&&(this._onUpdate=t.onUpdate,this._onDelete=t.onDelete)}onUpdate(e){return this._onUpdate=e===void 0?"no action":e,this}onDelete(e){return this._onDelete=e===void 0?"no action":e,this}build(e){return new el(e,this)}},el=class{constructor(e,t){this.table=e,this.reference=t.reference,this.onUpdate=t._onUpdate,this.onDelete=t._onDelete}static[p]="PgForeignKey";reference;onUpdate;onDelete;getName(){let{name:e,columns:t,foreignColumns:r}=this.reference(),i=t.map(a=>a.name),n=r.map(a=>a.name),o=[this.table[ht],...i,r[0].table[ht],...n];return e??`${o.join("_")}_fk`}};function Ji(s,...e){return s(...e)}function sl(s,e){return`${s[ht]}_${e.join("_")}_unique`}var tl=class{constructor(e,t){this.name=t,this.columns=e}static[p]="PgUniqueConstraintBuilder";columns;nullsNotDistinctConfig=!1;nullsNotDistinct(){return this.nullsNotDistinctConfig=!0,this}build(e){return new rl(e,this.columns,this.nullsNotDistinctConfig,this.name)}},Nf=class{static[p]="PgUniqueOnConstraintBuilder";name;constructor(e){this.name=e}on(...e){return new tl(e,this.name)}},rl=class{constructor(e,t,r,i){this.table=e,this.columns=t,this.name=i??sl(this.table,this.columns.map(n=>n.name)),this.nullsNotDistinct=r}static[p]="PgUniqueConstraint";columns;name;nullsNotDistinct=!1;getName(){return this.name}};function $f(s,e,t){for(let r=e;r<s.length;r++){let i=s[r];if(i==="\\"){r++;continue}if(i==='"')return[s.slice(e,r).replace(/\\/g,""),r+1];if(!t&&(i===","||i==="}"))return[s.slice(e,r).replace(/\\/g,""),r]}return[s.slice(e).replace(/\\/g,""),s.length]}function If(s,e=0){let t=[],r=e,i=!1;for(;r<s.length;){let n=s[r];if(n===","){(i||r===e)&&t.push(""),i=!0,r++;continue}if(i=!1,n==="\\"){r+=2;continue}if(n==='"'){let[l,c]=$f(s,r+1,!0);t.push(l),r=c;continue}if(n==="}")return[t,r+1];if(n==="{"){let[l,c]=If(s,r+1);t.push(l),r=c;continue}let[o,a]=$f(s,r,!1);t.push(o),r=a}return[t,r]}function Mf(s){let[e]=If(s,1);return e}function il(s){return`{${s.map(e=>Array.isArray(e)?il(e):typeof e=="string"?`"${e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`:`${e}`).join(",")}}`}var O=class extends Wi{foreignKeyConfigs=[];static[p]="PgColumnBuilder";array(e){return new ol(this.config.name,this,e)}references(e,t={}){return this.foreignKeyConfigs.push({ref:e,actions:t}),this}unique(e,t){return this.config.isUnique=!0,this.config.uniqueName=e,this.config.uniqueType=t?.nulls,this}generatedAlwaysAs(e){return this.config.generated={as:e,type:"always",mode:"stored"},this}buildForeignKeys(e,t){return this.foreignKeyConfigs.map(({ref:r,actions:i})=>Ji((n,o)=>{let a=new Qi(()=>{let l=n();return{columns:[e],foreignColumns:[l]}});return o.onUpdate&&a.onUpdate(o.onUpdate),o.onDelete&&a.onDelete(o.onDelete),a.build(t)},r,i))}buildExtraConfigColumn(e){return new nl(e,this.config)}},k=class extends se{constructor(e,t){t.uniqueName||(t.uniqueName=sl(e,[t.name])),super(e,t),this.table=e}static[p]="PgColumn"},nl=class extends k{static[p]="ExtraConfigColumn";getSQLType(){return this.getSQLType()}indexConfig={order:this.config.order??"asc",nulls:this.config.nulls??"last",opClass:this.config.opClass};defaultConfig={order:"asc",nulls:"last",opClass:void 0};asc(){return this.indexConfig.order="asc",this}desc(){return this.indexConfig.order="desc",this}nullsFirst(){return this.indexConfig.nulls="first",this}nullsLast(){return this.indexConfig.nulls="last",this}op(e){return this.indexConfig.opClass=e,this}},Df=class{static[p]="IndexedColumn";constructor(e,t,r,i){this.name=e,this.keyAsName=t,this.type=r,this.indexConfig=i}name;keyAsName;type;indexConfig},ol=class extends O{static[p]="PgArrayBuilder";constructor(e,t,r){super(e,"array","PgArray"),this.config.baseBuilder=t,this.config.size=r}build(e){let t=this.config.baseBuilder.build(e);return new al(e,this.config,t)}},al=class s extends k{constructor(e,t,r,i){super(e,t),this.baseColumn=r,this.range=i,this.size=t.size}size;static[p]="PgArray";getSQLType(){return`${this.baseColumn.getSQLType()}[${typeof this.size=="number"?this.size:""}]`}mapFromDriverValue(e){return typeof e=="string"&&(e=Mf(e)),e.map(t=>this.baseColumn.mapFromDriverValue(t))}mapToDriverValue(e,t=!1){let r=e.map(i=>i===null?null:S(this.baseColumn,s)?this.baseColumn.mapToDriverValue(i,!0):this.baseColumn.mapToDriverValue(i));return t?r:il(r)}};var ll=class extends O{static[p]="PgEnumObjectColumnBuilder";constructor(e,t){super(e,"string","PgEnumObjectColumn"),this.config.enum=t}build(e){return new cl(e,this.config)}},cl=class extends k{static[p]="PgEnumObjectColumn";enum;enumValues=this.config.enum.enumValues;constructor(e,t){super(e,t),this.enum=t.enum}getSQLType(){return this.enum.enumName}},Gi=Symbol.for("drizzle:isPgEnum");function jf(s){return!!s&&typeof s=="function"&&Gi in s&&s[Gi]===!0}var ul=class extends O{static[p]="PgEnumColumnBuilder";constructor(e,t){super(e,"string","PgEnumColumn"),this.config.enum=t}build(e){return new dl(e,this.config)}},dl=class extends k{static[p]="PgEnumColumn";enum=this.config.enum;enumValues=this.config.enum.enumValues;constructor(e,t){super(e,t),this.enum=t.enum}getSQLType(){return this.enum.enumName}};function ke(s,e){return Array.isArray(e)?yb(s,[...e],void 0):wb(s,e,void 0)}function yb(s,e,t){let r=Object.assign(i=>new ul(i??"",r),{enumName:s,enumValues:e,schema:t,[Gi]:!0});return r}function wb(s,e,t){let r=Object.assign(i=>new ll(i??"",r),{enumName:s,enumValues:Object.values(e),schema:t,[Gi]:!0});return r}var we=class{static[p]="Subquery";constructor(e,t,r,i=!1,n=[]){this._={brand:"Subquery",sql:e,selectedFields:t,alias:r,isWith:i,usedTables:n}}},xr=class extends we{static[p]="WithSubquery"};var Lf="0.44.6";var hl,fl,ne={startActiveSpan(s,e){return hl?(fl||(fl=hl.trace.getTracer("drizzle-orm",Lf)),Ji((t,r)=>r.startActiveSpan(s,i=>{try{return e(i)}catch(n){throw i.setStatus({code:t.SpanStatusCode.ERROR,message:n instanceof Error?n.message:"Unknown error"}),n}finally{i.end()}}),hl,fl)):e()}};var oe=Symbol.for("drizzle:ViewBaseConfig");var dr=Symbol.for("drizzle:Schema"),Xi=Symbol.for("drizzle:Columns"),qf=Symbol.for("drizzle:ExtraConfigColumns"),pl=Symbol.for("drizzle:OriginalName"),ml=Symbol.for("drizzle:BaseName"),Ns=Symbol.for("drizzle:IsAlias"),Uf=Symbol.for("drizzle:ExtraConfigBuilder"),bb=Symbol.for("drizzle:IsDrizzleTable"),P=class{static[p]="Table";static Symbol={Name:ht,Schema:dr,OriginalName:pl,Columns:Xi,ExtraConfigColumns:qf,BaseName:ml,IsAlias:Ns,ExtraConfigBuilder:Uf};[ht];[pl];[dr];[Xi];[qf];[ml];[Ns]=!1;[bb]=!0;[Uf]=void 0;constructor(e,t,r){this[ht]=this[pl]=e,this[dr]=t,this[ml]=r}};function Fe(s){return s[ht]}function hr(s){return`${s[dr]??"public"}.${s[ht]}`}var Bf=class{static[p]="FakePrimitiveParam"};function gl(s){return s!=null&&typeof s.getSQL=="function"}function _b(s){let e={sql:"",params:[]};for(let t of s)e.sql+=t.sql,e.params.push(...t.params),t.typings?.length&&(e.typings||(e.typings=[]),e.typings.push(...t.typings));return e}var ve=class{static[p]="StringChunk";value;constructor(e){this.value=Array.isArray(e)?e:[e]}getSQL(){return new $([this])}},$=class s{constructor(e){this.queryChunks=e;for(let t of e)if(S(t,P)){let r=t[P.Symbol.Schema];this.usedTables.push(r===void 0?t[P.Symbol.Name]:r+"."+t[P.Symbol.Name])}}static[p]="SQL";decoder=Vf;shouldInlineParams=!1;usedTables=[];append(e){return this.queryChunks.push(...e.queryChunks),this}toQuery(e){return ne.startActiveSpan("drizzle.buildSQL",t=>{let r=this.buildQueryFromSourceParams(this.queryChunks,e);return t?.setAttributes({"drizzle.query.text":r.sql,"drizzle.query.params":JSON.stringify(r.params)}),r})}buildQueryFromSourceParams(e,t){let r=Object.assign({},t,{inlineParams:t.inlineParams||this.shouldInlineParams,paramStartIndex:t.paramStartIndex||{value:0}}),{casing:i,escapeName:n,escapeParam:o,prepareTyping:a,inlineParams:l,paramStartIndex:c}=r;return _b(e.map(u=>{if(S(u,ve))return{sql:u.value.join(""),params:[]};if(S(u,$s))return{sql:n(u.value),params:[]};if(u===void 0)return{sql:"",params:[]};if(Array.isArray(u)){let f=[new ve("(")];for(let[d,h]of u.entries())f.push(h),d<u.length-1&&f.push(new ve(", "));return f.push(new ve(")")),this.buildQueryFromSourceParams(f,r)}if(S(u,s))return this.buildQueryFromSourceParams(u.queryChunks,{...r,inlineParams:l||u.shouldInlineParams});if(S(u,P)){let f=u[P.Symbol.Schema],d=u[P.Symbol.Name];return{sql:f===void 0||u[Ns]?n(d):n(f)+"."+n(d),params:[]}}if(S(u,se)){let f=i.getColumnCasing(u);if(t.invokeSource==="indexes")return{sql:n(f),params:[]};let d=u.table[P.Symbol.Schema];return{sql:u.table[Ns]||d===void 0?n(u.table[P.Symbol.Name])+"."+n(f):n(d)+"."+n(u.table[P.Symbol.Name])+"."+n(f),params:[]}}if(S(u,De)){let f=u[oe].schema,d=u[oe].name;return{sql:f===void 0||u[oe].isAlias?n(d):n(f)+"."+n(d),params:[]}}if(S(u,Ve)){if(S(u.value,Rt))return{sql:o(c.value++,u),params:[u],typings:["none"]};let f=u.value===null?null:u.encoder.mapToDriverValue(u.value);if(S(f,s))return this.buildQueryFromSourceParams([f],r);if(l)return{sql:this.mapInlineParam(f,r),params:[]};let d=["none"];return a&&(d=[a(u.encoder)]),{sql:o(c.value++,f),params:[f],typings:d}}return S(u,Rt)?{sql:o(c.value++,u),params:[u],typings:["none"]}:S(u,s.Aliased)&&u.fieldAlias!==void 0?{sql:n(u.fieldAlias),params:[]}:S(u,we)?u._.isWith?{sql:n(u._.alias),params:[]}:this.buildQueryFromSourceParams([new ve("("),u._.sql,new ve(") "),new $s(u._.alias)],r):jf(u)?u.schema?{sql:n(u.schema)+"."+n(u.enumName),params:[]}:{sql:n(u.enumName),params:[]}:gl(u)?u.shouldOmitSQLParens?.()?this.buildQueryFromSourceParams([u.getSQL()],r):this.buildQueryFromSourceParams([new ve("("),u.getSQL(),new ve(")")],r):l?{sql:this.mapInlineParam(u,r),params:[]}:{sql:o(c.value++,u),params:[u],typings:["none"]}}))}mapInlineParam(e,{escapeString:t}){if(e===null)return"null";if(typeof e=="number"||typeof e=="boolean")return e.toString();if(typeof e=="string")return t(e);if(typeof e=="object"){let r=e.toString();return t(r==="[object Object]"?JSON.stringify(e):r)}throw new Error("Unexpected param value: "+e)}getSQL(){return this}as(e){return e===void 0?this:new s.Aliased(this,e)}mapWith(e){return this.decoder=typeof e=="function"?{mapFromDriverValue:e}:e,this}inlineParams(){return this.shouldInlineParams=!0,this}if(e){return e?this:void 0}},$s=class{constructor(e){this.value=e}static[p]="Name";brand;getSQL(){return new $([this])}};function Ff(s){return typeof s=="object"&&s!==null&&"mapToDriverValue"in s&&typeof s.mapToDriverValue=="function"}var Vf={mapFromDriverValue:s=>s},Hf={mapToDriverValue:s=>s},iA={...Vf,...Hf},Ve=class{constructor(e,t=Hf){this.value=e,this.encoder=t}static[p]="Param";brand;getSQL(){return new $([this])}};function m(s,...e){let t=[];(e.length>0||s.length>0&&s[0]!=="")&&t.push(new ve(s[0]));for(let[r,i]of e.entries())t.push(i,new ve(s[r+1]));return new $(t)}(s=>{function e(){return new $([])}s.empty=e;function t(l){return new $(l)}s.fromList=t;function r(l){return new $([new ve(l)])}s.raw=r;function i(l,c){let u=[];for(let[f,d]of l.entries())f>0&&c!==void 0&&u.push(c),u.push(d);return new $(u)}s.join=i;function n(l){return new $s(l)}s.identifier=n;function o(l){return new Rt(l)}s.placeholder=o;function a(l,c){return new Ve(l,c)}s.param=a})(m||(m={}));(s=>{class e{constructor(r,i){this.sql=r,this.fieldAlias=i}static[p]="SQL.Aliased";isSelectionField=!1;getSQL(){return this.sql}clone(){return new e(this.sql,this.fieldAlias)}}s.Aliased=e})($||($={}));var Rt=class{constructor(e){this.name=e}static[p]="Placeholder";getSQL(){return new $([this])}};function yl(s,e){return s.map(t=>{if(S(t,Rt)){if(!(t.name in e))throw new Error(`No value for placeholder "${t.name}" was provided`);return e[t.name]}if(S(t,Ve)&&S(t.value,Rt)){if(!(t.value.name in e))throw new Error(`No value for placeholder "${t.value.name}" was provided`);return t.encoder.mapToDriverValue(e[t.value.name])}return t})}var vb=Symbol.for("drizzle:IsDrizzleView"),De=class{static[p]="View";[oe];[vb]=!0;constructor({name:e,schema:t,selectedFields:r,query:i}){this[oe]={name:e,originalName:e,schema:t,selectedFields:r,query:i,isExisting:!i,isAlias:!1}}getSQL(){return new $([this])}};se.prototype.getSQL=function(){return new $([this])};P.prototype.getSQL=function(){return new $([this])};we.prototype.getSQL=function(){return new $([this])};var fr=class{constructor(e){this.table=e}static[p]="ColumnAliasProxyHandler";get(e,t){return t==="table"?this.table:e[t]}},Cr=class{constructor(e,t){this.alias=e,this.replaceOriginalName=t}static[p]="TableAliasProxyHandler";get(e,t){if(t===P.Symbol.IsAlias)return!0;if(t===P.Symbol.Name)return this.alias;if(this.replaceOriginalName&&t===P.Symbol.OriginalName)return this.alias;if(t===oe)return{...e[oe],name:this.alias,isAlias:!0};if(t===P.Symbol.Columns){let i=e[P.Symbol.Columns];if(!i)return i;let n={};return Object.keys(i).map(o=>{n[o]=new Proxy(i[o],new fr(new Proxy(e,this)))}),n}let r=e[t];return S(r,se)?new Proxy(r,new fr(new Proxy(e,this))):r}},Kf=class{constructor(e){this.alias=e}static[p]="RelationTableAliasProxyHandler";get(e,t){return t==="sourceTable"?Is(e.sourceTable,this.alias):e[t]}};function Is(s,e){return new Proxy(s,new Cr(e,!1))}function bt(s,e){return new Proxy(s,new fr(new Proxy(s.table,new Cr(e,!1))))}function wl(s,e){return new $.Aliased(Ms(s.sql,e),s.fieldAlias)}function Ms(s,e){return m.join(s.queryChunks.map(t=>S(t,se)?bt(t,e):S(t,$)?Ms(t,e):S(t,$.Aliased)?wl(t,e):t))}var Ds=class extends Error{static[p]="DrizzleError";constructor({message:e,cause:t}){super(e),this.name="DrizzleError",this.cause=t}},Ot=class s extends Error{constructor(e,t,r){super(`Failed query: ${e}
params: ${t}`),this.query=e,this.params=t,this.cause=r,Error.captureStackTrace(this,s),r&&(this.cause=r)}},Yi=class extends Ds{static[p]="TransactionRollbackError";constructor(){super({message:"Rollback"})}};var bl=class{static[p]="ConsoleLogWriter";write(e){console.log(e)}},Zi=class{static[p]="DefaultLogger";writer;constructor(e){this.writer=e?.writer??new bl}logQuery(e,t){let r=t.map(n=>{try{return JSON.stringify(n)}catch{return String(n)}}),i=r.length?` -- params: [${r.join(", ")}]`:"";this.writer.write(`Query: ${e}${i}`)}},en=class{static[p]="NoopLogger";logQuery(){}};var Ne=class{static[p]="QueryPromise";[Symbol.toStringTag]="QueryPromise";catch(e){return this.then(void 0,e)}finally(e){return this.then(t=>(e?.(),t),t=>{throw e?.(),t})}then(e,t){return this.execute().then(e,t)}};function zf(s,e,t){let r={},i=s.reduce((n,{path:o,field:a},l)=>{let c;S(a,se)?c=a:S(a,$)?c=a.decoder:c=a.sql.decoder;let u=n;for(let[f,d]of o.entries())if(f<o.length-1)d in u||(u[d]={}),u=u[d];else{let h=e[l],g=u[d]=h===null?null:c.mapFromDriverValue(h);if(t&&S(a,se)&&o.length===2){let y=o[0];y in r?typeof r[y]=="string"&&r[y]!==Fe(a.table)&&(r[y]=!1):r[y]=g===null?Fe(a.table):!1}}return n},{});if(t&&Object.keys(r).length>0)for(let[n,o]of Object.entries(r))typeof o=="string"&&!t[o]&&(i[n]=null);return i}function rt(s,e){return Object.entries(s).reduce((t,[r,i])=>{if(typeof r!="string")return t;let n=e?[...e,r]:[r];return S(i,se)||S(i,$)||S(i,$.Aliased)?t.push({path:n,field:i}):S(i,P)?t.push(...rt(i[P.Symbol.Columns],n)):t.push(...rt(i,n)),t},[])}function js(s,e){let t=Object.keys(s),r=Object.keys(e);if(t.length!==r.length)return!1;for(let[i,n]of t.entries())if(n!==r[i])return!1;return!0}function tn(s,e){let t=Object.entries(e).filter(([,r])=>r!==void 0).map(([r,i])=>S(i,$)||S(i,se)?[r,i]:[r,new Ve(i,s[P.Symbol.Columns][r])]);if(t.length===0)throw new Error("No values to set");return Object.fromEntries(t)}function Wf(s,e){for(let t of e)for(let r of Object.getOwnPropertyNames(t.prototype))r!=="constructor"&&Object.defineProperty(s.prototype,r,Object.getOwnPropertyDescriptor(t.prototype,r)||Object.create(null))}function Qf(s){return s[P.Symbol.Columns]}function Nt(s){return S(s,we)?s._.alias:S(s,De)?s[oe].name:S(s,$)?void 0:s[P.Symbol.IsAlias]?s[P.Symbol.Name]:s[P.Symbol.BaseName]}function F(s,e){return{name:typeof s=="string"&&s.length>0?s:"",config:typeof s=="object"?s:e}}function Jf(s){if(typeof s!="object"||s===null||s.constructor.name!=="Object")return!1;if("logger"in s){let e=typeof s.logger;return!(e!=="boolean"&&(e!=="object"||typeof s.logger.logQuery!="function")&&e!=="undefined")}if("schema"in s){let e=typeof s.schema;return!(e!=="object"&&e!=="undefined")}if("casing"in s){let e=typeof s.casing;return!(e!=="string"&&e!=="undefined")}if("mode"in s)return!(s.mode!=="default"||s.mode!=="planetscale"||s.mode!==void 0);if("connection"in s){let e=typeof s.connection;return!(e!=="string"&&e!=="object"&&e!=="undefined")}if("client"in s){let e=typeof s.client;return!(e!=="object"&&e!=="function"&&e!=="undefined")}return Object.keys(s).length===0}var TA=typeof TextDecoder>"u"?null:new TextDecoder;var $t=class extends O{static[p]="PgIntColumnBaseBuilder";generatedAlwaysAsIdentity(e){if(e){let{name:t,...r}=e;this.config.generatedIdentity={type:"always",sequenceName:t,sequenceOptions:r}}else this.config.generatedIdentity={type:"always"};return this.config.hasDefault=!0,this.config.notNull=!0,this}generatedByDefaultAsIdentity(e){if(e){let{name:t,...r}=e;this.config.generatedIdentity={type:"byDefault",sequenceName:t,sequenceOptions:r}}else this.config.generatedIdentity={type:"byDefault"};return this.config.hasDefault=!0,this.config.notNull=!0,this}};var _l=class extends $t{static[p]="PgBigInt53Builder";constructor(e){super(e,"number","PgBigInt53")}build(e){return new vl(e,this.config)}},vl=class extends k{static[p]="PgBigInt53";getSQLType(){return"bigint"}mapFromDriverValue(e){return typeof e=="number"?e:Number(e)}},Sl=class extends $t{static[p]="PgBigInt64Builder";constructor(e){super(e,"bigint","PgBigInt64")}build(e){return new El(e,this.config)}},El=class extends k{static[p]="PgBigInt64";getSQLType(){return"bigint"}mapFromDriverValue(e){return BigInt(e)}};function Gf(s,e){let{name:t,config:r}=F(s,e);return r.mode==="number"?new _l(t):new Sl(t)}var Tl=class extends O{static[p]="PgBigSerial53Builder";constructor(e){super(e,"number","PgBigSerial53"),this.config.hasDefault=!0,this.config.notNull=!0}build(e){return new Al(e,this.config)}},Al=class extends k{static[p]="PgBigSerial53";getSQLType(){return"bigserial"}mapFromDriverValue(e){return typeof e=="number"?e:Number(e)}},kl=class extends O{static[p]="PgBigSerial64Builder";constructor(e){super(e,"bigint","PgBigSerial64"),this.config.hasDefault=!0}build(e){return new Pl(e,this.config)}},Pl=class extends k{static[p]="PgBigSerial64";getSQLType(){return"bigserial"}mapFromDriverValue(e){return BigInt(e)}};function Xf(s,e){let{name:t,config:r}=F(s,e);return r.mode==="number"?new Tl(t):new kl(t)}var xl=class extends O{static[p]="PgBooleanBuilder";constructor(e){super(e,"boolean","PgBoolean")}build(e){return new Cl(e,this.config)}},Cl=class extends k{static[p]="PgBoolean";getSQLType(){return"boolean"}};function Yf(s){return new xl(s??"")}var Rl=class extends O{static[p]="PgCharBuilder";constructor(e,t){super(e,"string","PgChar"),this.config.length=t.length,this.config.enumValues=t.enum}build(e){return new Ol(e,this.config)}},Ol=class extends k{static[p]="PgChar";length=this.config.length;enumValues=this.config.enumValues;getSQLType(){return this.length===void 0?"char":`char(${this.length})`}};function Zf(s,e={}){let{name:t,config:r}=F(s,e);return new Rl(t,r)}var Nl=class extends O{static[p]="PgCidrBuilder";constructor(e){super(e,"string","PgCidr")}build(e){return new $l(e,this.config)}},$l=class extends k{static[p]="PgCidr";getSQLType(){return"cidr"}};function ep(s){return new Nl(s??"")}var Il=class extends O{static[p]="PgCustomColumnBuilder";constructor(e,t,r){super(e,"custom","PgCustomColumn"),this.config.fieldConfig=t,this.config.customTypeParams=r}build(e){return new Ml(e,this.config)}},Ml=class extends k{static[p]="PgCustomColumn";sqlName;mapTo;mapFrom;constructor(e,t){super(e,t),this.sqlName=t.customTypeParams.dataType(t.fieldConfig),this.mapTo=t.customTypeParams.toDriver,this.mapFrom=t.customTypeParams.fromDriver}getSQLType(){return this.sqlName}mapFromDriverValue(e){return typeof this.mapFrom=="function"?this.mapFrom(e):e}mapToDriverValue(e){return typeof this.mapTo=="function"?this.mapTo(e):e}};function tp(s){return(e,t)=>{let{name:r,config:i}=F(e,t);return new Il(r,i,s)}}var _t=class extends O{static[p]="PgDateColumnBaseBuilder";defaultNow(){return this.default(m`now()`)}};var Dl=class extends _t{static[p]="PgDateBuilder";constructor(e){super(e,"date","PgDate")}build(e){return new Ls(e,this.config)}},Ls=class extends k{static[p]="PgDate";getSQLType(){return"date"}mapFromDriverValue(e){return new Date(e)}mapToDriverValue(e){return e.toISOString()}},jl=class extends _t{static[p]="PgDateStringBuilder";constructor(e){super(e,"string","PgDateString")}build(e){return new qs(e,this.config)}},qs=class extends k{static[p]="PgDateString";getSQLType(){return"date"}};function rp(s,e){let{name:t,config:r}=F(s,e);return r?.mode==="date"?new Dl(t):new jl(t)}var Ll=class extends O{static[p]="PgDoublePrecisionBuilder";constructor(e){super(e,"number","PgDoublePrecision")}build(e){return new ql(e,this.config)}},ql=class extends k{static[p]="PgDoublePrecision";getSQLType(){return"double precision"}mapFromDriverValue(e){return typeof e=="string"?Number.parseFloat(e):e}};function sp(s){return new Ll(s??"")}var Ul=class extends O{static[p]="PgInetBuilder";constructor(e){super(e,"string","PgInet")}build(e){return new Bl(e,this.config)}},Bl=class extends k{static[p]="PgInet";getSQLType(){return"inet"}};function ip(s){return new Ul(s??"")}var Fl=class extends $t{static[p]="PgIntegerBuilder";constructor(e){super(e,"number","PgInteger")}build(e){return new Vl(e,this.config)}},Vl=class extends k{static[p]="PgInteger";getSQLType(){return"integer"}mapFromDriverValue(e){return typeof e=="string"?Number.parseInt(e):e}};function T(s){return new Fl(s??"")}var Hl=class extends O{static[p]="PgIntervalBuilder";constructor(e,t){super(e,"string","PgInterval"),this.config.intervalConfig=t}build(e){return new Kl(e,this.config)}},Kl=class extends k{static[p]="PgInterval";fields=this.config.intervalConfig.fields;precision=this.config.intervalConfig.precision;getSQLType(){let e=this.fields?` ${this.fields}`:"",t=this.precision?`(${this.precision})`:"";return`interval${e}${t}`}};function np(s,e={}){let{name:t,config:r}=F(s,e);return new Hl(t,r)}var zl=class extends O{static[p]="PgJsonBuilder";constructor(e){super(e,"json","PgJson")}build(e){return new Us(e,this.config)}},Us=class extends k{static[p]="PgJson";constructor(e,t){super(e,t)}getSQLType(){return"json"}mapToDriverValue(e){return JSON.stringify(e)}mapFromDriverValue(e){if(typeof e=="string")try{return JSON.parse(e)}catch{return e}return e}};function op(s){return new zl(s??"")}var Wl=class extends O{static[p]="PgJsonbBuilder";constructor(e){super(e,"json","PgJsonb")}build(e){return new Bs(e,this.config)}},Bs=class extends k{static[p]="PgJsonb";constructor(e,t){super(e,t)}getSQLType(){return"jsonb"}mapToDriverValue(e){return JSON.stringify(e)}mapFromDriverValue(e){if(typeof e=="string")try{return JSON.parse(e)}catch{return e}return e}};function ap(s){return new Wl(s??"")}var Ql=class extends O{static[p]="PgLineBuilder";constructor(e){super(e,"array","PgLine")}build(e){return new Jl(e,this.config)}},Jl=class extends k{static[p]="PgLine";getSQLType(){return"line"}mapFromDriverValue(e){let[t,r,i]=e.slice(1,-1).split(",");return[Number.parseFloat(t),Number.parseFloat(r),Number.parseFloat(i)]}mapToDriverValue(e){return`{${e[0]},${e[1]},${e[2]}}`}},Gl=class extends O{static[p]="PgLineABCBuilder";constructor(e){super(e,"json","PgLineABC")}build(e){return new Xl(e,this.config)}},Xl=class extends k{static[p]="PgLineABC";getSQLType(){return"line"}mapFromDriverValue(e){let[t,r,i]=e.slice(1,-1).split(",");return{a:Number.parseFloat(t),b:Number.parseFloat(r),c:Number.parseFloat(i)}}mapToDriverValue(e){return`{${e.a},${e.b},${e.c}}`}};function lp(s,e){let{name:t,config:r}=F(s,e);return!r?.mode||r.mode==="tuple"?new Ql(t):new Gl(t)}var Yl=class extends O{static[p]="PgMacaddrBuilder";constructor(e){super(e,"string","PgMacaddr")}build(e){return new Zl(e,this.config)}},Zl=class extends k{static[p]="PgMacaddr";getSQLType(){return"macaddr"}};function cp(s){return new Yl(s??"")}var ec=class extends O{static[p]="PgMacaddr8Builder";constructor(e){super(e,"string","PgMacaddr8")}build(e){return new tc(e,this.config)}},tc=class extends k{static[p]="PgMacaddr8";getSQLType(){return"macaddr8"}};function up(s){return new ec(s??"")}var rc=class extends O{static[p]="PgNumericBuilder";constructor(e,t,r){super(e,"string","PgNumeric"),this.config.precision=t,this.config.scale=r}build(e){return new Fs(e,this.config)}},Fs=class extends k{static[p]="PgNumeric";precision;scale;constructor(e,t){super(e,t),this.precision=t.precision,this.scale=t.scale}mapFromDriverValue(e){return typeof e=="string"?e:String(e)}getSQLType(){return this.precision!==void 0&&this.scale!==void 0?`numeric(${this.precision}, ${this.scale})`:this.precision===void 0?"numeric":`numeric(${this.precision})`}},sc=class extends O{static[p]="PgNumericNumberBuilder";constructor(e,t,r){super(e,"number","PgNumericNumber"),this.config.precision=t,this.config.scale=r}build(e){return new ic(e,this.config)}},ic=class extends k{static[p]="PgNumericNumber";precision;scale;constructor(e,t){super(e,t),this.precision=t.precision,this.scale=t.scale}mapFromDriverValue(e){return typeof e=="number"?e:Number(e)}mapToDriverValue=String;getSQLType(){return this.precision!==void 0&&this.scale!==void 0?`numeric(${this.precision}, ${this.scale})`:this.precision===void 0?"numeric":`numeric(${this.precision})`}},nc=class extends O{static[p]="PgNumericBigIntBuilder";constructor(e,t,r){super(e,"bigint","PgNumericBigInt"),this.config.precision=t,this.config.scale=r}build(e){return new oc(e,this.config)}},oc=class extends k{static[p]="PgNumericBigInt";precision;scale;constructor(e,t){super(e,t),this.precision=t.precision,this.scale=t.scale}mapFromDriverValue=BigInt;mapToDriverValue=String;getSQLType(){return this.precision!==void 0&&this.scale!==void 0?`numeric(${this.precision}, ${this.scale})`:this.precision===void 0?"numeric":`numeric(${this.precision})`}};function dp(s,e){let{name:t,config:r}=F(s,e),i=r?.mode;return i==="number"?new sc(t,r?.precision,r?.scale):i==="bigint"?new nc(t,r?.precision,r?.scale):new rc(t,r?.precision,r?.scale)}var ac=class extends O{static[p]="PgPointTupleBuilder";constructor(e){super(e,"array","PgPointTuple")}build(e){return new lc(e,this.config)}},lc=class extends k{static[p]="PgPointTuple";getSQLType(){return"point"}mapFromDriverValue(e){if(typeof e=="string"){let[t,r]=e.slice(1,-1).split(",");return[Number.parseFloat(t),Number.parseFloat(r)]}return[e.x,e.y]}mapToDriverValue(e){return`(${e[0]},${e[1]})`}},cc=class extends O{static[p]="PgPointObjectBuilder";constructor(e){super(e,"json","PgPointObject")}build(e){return new uc(e,this.config)}},uc=class extends k{static[p]="PgPointObject";getSQLType(){return"point"}mapFromDriverValue(e){if(typeof e=="string"){let[t,r]=e.slice(1,-1).split(",");return{x:Number.parseFloat(t),y:Number.parseFloat(r)}}return e}mapToDriverValue(e){return`(${e.x},${e.y})`}};function hp(s,e){let{name:t,config:r}=F(s,e);return!r?.mode||r.mode==="tuple"?new ac(t):new cc(t)}function Sb(s){let e=[];for(let t=0;t<s.length;t+=2)e.push(Number.parseInt(s.slice(t,t+2),16));return new Uint8Array(e)}function fp(s,e){let t=new ArrayBuffer(8),r=new DataView(t);for(let i=0;i<8;i++)r.setUint8(i,s[e+i]);return r.getFloat64(0,!0)}function dc(s){let e=Sb(s),t=0,r=e[t];t+=1;let i=new DataView(e.buffer),n=i.getUint32(t,r===1);t+=4;let o;if(n&536870912&&(o=i.getUint32(t,r===1),t+=4),(n&65535)===1){let a=fp(e,t);t+=8;let l=fp(e,t);return t+=8,[a,l]}throw new Error("Unsupported geometry type")}var hc=class extends O{static[p]="PgGeometryBuilder";constructor(e){super(e,"array","PgGeometry")}build(e){return new fc(e,this.config)}},fc=class extends k{static[p]="PgGeometry";getSQLType(){return"geometry(point)"}mapFromDriverValue(e){return dc(e)}mapToDriverValue(e){return`point(${e[0]} ${e[1]})`}},pc=class extends O{static[p]="PgGeometryObjectBuilder";constructor(e){super(e,"json","PgGeometryObject")}build(e){return new mc(e,this.config)}},mc=class extends k{static[p]="PgGeometryObject";getSQLType(){return"geometry(point)"}mapFromDriverValue(e){let t=dc(e);return{x:t[0],y:t[1]}}mapToDriverValue(e){return`point(${e.x} ${e.y})`}};function pp(s,e){let{name:t,config:r}=F(s,e);return!r?.mode||r.mode==="tuple"?new hc(t):new pc(t)}var gc=class extends O{static[p]="PgRealBuilder";constructor(e,t){super(e,"number","PgReal"),this.config.length=t}build(e){return new yc(e,this.config)}},yc=class extends k{static[p]="PgReal";constructor(e,t){super(e,t)}getSQLType(){return"real"}mapFromDriverValue=e=>typeof e=="string"?Number.parseFloat(e):e};function mp(s){return new gc(s??"")}var wc=class extends O{static[p]="PgSerialBuilder";constructor(e){super(e,"number","PgSerial"),this.config.hasDefault=!0,this.config.notNull=!0}build(e){return new bc(e,this.config)}},bc=class extends k{static[p]="PgSerial";getSQLType(){return"serial"}};function gp(s){return new wc(s??"")}var _c=class extends $t{static[p]="PgSmallIntBuilder";constructor(e){super(e,"number","PgSmallInt")}build(e){return new vc(e,this.config)}},vc=class extends k{static[p]="PgSmallInt";getSQLType(){return"smallint"}mapFromDriverValue=e=>typeof e=="string"?Number(e):e};function yp(s){return new _c(s??"")}var Sc=class extends O{static[p]="PgSmallSerialBuilder";constructor(e){super(e,"number","PgSmallSerial"),this.config.hasDefault=!0,this.config.notNull=!0}build(e){return new Ec(e,this.config)}},Ec=class extends k{static[p]="PgSmallSerial";getSQLType(){return"smallserial"}};function wp(s){return new Sc(s??"")}var Tc=class extends O{static[p]="PgTextBuilder";constructor(e,t){super(e,"string","PgText"),this.config.enumValues=t.enum}build(e){return new Ac(e,this.config)}},Ac=class extends k{static[p]="PgText";enumValues=this.config.enumValues;getSQLType(){return"text"}};function K(s,e={}){let{name:t,config:r}=F(s,e);return new Tc(t,r)}var kc=class extends _t{constructor(e,t,r){super(e,"string","PgTime"),this.withTimezone=t,this.precision=r,this.config.withTimezone=t,this.config.precision=r}static[p]="PgTimeBuilder";build(e){return new Vs(e,this.config)}},Vs=class extends k{static[p]="PgTime";withTimezone;precision;constructor(e,t){super(e,t),this.withTimezone=t.withTimezone,this.precision=t.precision}getSQLType(){return`time${this.precision===void 0?"":`(${this.precision})`}${this.withTimezone?" with time zone":""}`}};function bp(s,e={}){let{name:t,config:r}=F(s,e);return new kc(t,r.withTimezone??!1,r.precision)}var Pc=class extends _t{static[p]="PgTimestampBuilder";constructor(e,t,r){super(e,"date","PgTimestamp"),this.config.withTimezone=t,this.config.precision=r}build(e){return new Hs(e,this.config)}},Hs=class extends k{static[p]="PgTimestamp";withTimezone;precision;constructor(e,t){super(e,t),this.withTimezone=t.withTimezone,this.precision=t.precision}getSQLType(){return`timestamp${this.precision===void 0?"":` (${this.precision})`}${this.withTimezone?" with time zone":""}`}mapFromDriverValue=e=>new Date(this.withTimezone?e:e+"+0000");mapToDriverValue=e=>e.toISOString()},xc=class extends _t{static[p]="PgTimestampStringBuilder";constructor(e,t,r){super(e,"string","PgTimestampString"),this.config.withTimezone=t,this.config.precision=r}build(e){return new Ks(e,this.config)}},Ks=class extends k{static[p]="PgTimestampString";withTimezone;precision;constructor(e,t){super(e,t),this.withTimezone=t.withTimezone,this.precision=t.precision}getSQLType(){return`timestamp${this.precision===void 0?"":`(${this.precision})`}${this.withTimezone?" with time zone":""}`}};function j(s,e={}){let{name:t,config:r}=F(s,e);return r?.mode==="string"?new xc(t,r.withTimezone??!1,r.precision):new Pc(t,r?.withTimezone??!1,r?.precision)}var Cc=class extends O{static[p]="PgUUIDBuilder";constructor(e){super(e,"string","PgUUID")}defaultRandom(){return this.default(m`gen_random_uuid()`)}build(e){return new zs(e,this.config)}},zs=class extends k{static[p]="PgUUID";getSQLType(){return"uuid"}};function _p(s){return new Cc(s??"")}var Rc=class extends O{static[p]="PgVarcharBuilder";constructor(e,t){super(e,"string","PgVarchar"),this.config.length=t.length,this.config.enumValues=t.enum}build(e){return new Oc(e,this.config)}},Oc=class extends k{static[p]="PgVarchar";length=this.config.length;enumValues=this.config.enumValues;getSQLType(){return this.length===void 0?"varchar":`varchar(${this.length})`}};function H(s,e={}){let{name:t,config:r}=F(s,e);return new Rc(t,r)}var Nc=class extends O{static[p]="PgBinaryVectorBuilder";constructor(e,t){super(e,"string","PgBinaryVector"),this.config.dimensions=t.dimensions}build(e){return new $c(e,this.config)}},$c=class extends k{static[p]="PgBinaryVector";dimensions=this.config.dimensions;getSQLType(){return`bit(${this.dimensions})`}};function vp(s,e){let{name:t,config:r}=F(s,e);return new Nc(t,r)}var Ic=class extends O{static[p]="PgHalfVectorBuilder";constructor(e,t){super(e,"array","PgHalfVector"),this.config.dimensions=t.dimensions}build(e){return new Mc(e,this.config)}},Mc=class extends k{static[p]="PgHalfVector";dimensions=this.config.dimensions;getSQLType(){return`halfvec(${this.dimensions})`}mapToDriverValue(e){return JSON.stringify(e)}mapFromDriverValue(e){return e.slice(1,-1).split(",").map(t=>Number.parseFloat(t))}};function Sp(s,e){let{name:t,config:r}=F(s,e);return new Ic(t,r)}var Dc=class extends O{static[p]="PgSparseVectorBuilder";constructor(e,t){super(e,"string","PgSparseVector"),this.config.dimensions=t.dimensions}build(e){return new jc(e,this.config)}},jc=class extends k{static[p]="PgSparseVector";dimensions=this.config.dimensions;getSQLType(){return`sparsevec(${this.dimensions})`}};function Ep(s,e){let{name:t,config:r}=F(s,e);return new Dc(t,r)}var Lc=class extends O{static[p]="PgVectorBuilder";constructor(e,t){super(e,"array","PgVector"),this.config.dimensions=t.dimensions}build(e){return new qc(e,this.config)}},qc=class extends k{static[p]="PgVector";dimensions=this.config.dimensions;getSQLType(){return`vector(${this.dimensions})`}mapToDriverValue(e){return JSON.stringify(e)}mapFromDriverValue(e){return e.slice(1,-1).split(",").map(t=>Number.parseFloat(t))}};function Tp(s,e){let{name:t,config:r}=F(s,e);return new Lc(t,r)}function Ap(){return{bigint:Gf,bigserial:Xf,boolean:Yf,char:Zf,cidr:ep,customType:tp,date:rp,doublePrecision:sp,inet:ip,integer:T,interval:np,json:op,jsonb:ap,line:lp,macaddr:cp,macaddr8:up,numeric:dp,point:hp,geometry:pp,real:mp,serial:gp,smallint:yp,smallserial:wp,text:K,time:bp,timestamp:j,uuid:_p,varchar:H,bit:vp,halfvec:Sp,sparsevec:Ep,vector:Tp}}var Uc=Symbol.for("drizzle:PgInlineForeignKeys"),kp=Symbol.for("drizzle:EnableRLS"),Se=class extends P{static[p]="PgTable";static Symbol=Object.assign({},P.Symbol,{InlineForeignKeys:Uc,EnableRLS:kp});[Uc]=[];[kp]=!1;[P.Symbol.ExtraConfigBuilder]=void 0;[P.Symbol.ExtraConfigColumns]={}};function Eb(s,e,t,r,i=s){let n=new Se(s,r,i),o=typeof e=="function"?e(Ap()):e,a=Object.fromEntries(Object.entries(o).map(([u,f])=>{let d=f;d.setName(u);let h=d.build(n);return n[Uc].push(...d.buildForeignKeys(h,n)),[u,h]})),l=Object.fromEntries(Object.entries(o).map(([u,f])=>{let d=f;d.setName(u);let h=d.buildExtraConfigColumn(n);return[u,h]})),c=Object.assign(n,a);return c[P.Symbol.Columns]=a,c[P.Symbol.ExtraConfigColumns]=l,t&&(c[Se.Symbol.ExtraConfigBuilder]=t),Object.assign(c,{enableRLS:()=>(c[Se.Symbol.EnableRLS]=!0,c)})}var Ee=(s,e,t)=>Eb(s,e,t,void 0);var rn=class{static[p]="PgPrimaryKeyBuilder";columns;name;constructor(e,t){this.columns=e,this.name=t}build(e){return new Bc(e,this.columns,this.name)}},Bc=class{constructor(e,t,r){this.table=e,this.columns=t,this.name=r}static[p]="PgPrimaryKey";columns;name;getName(){return this.name??`${this.table[Se.Symbol.Name]}_${this.columns.map(e=>e.name).join("_")}_pk`}};function He(s,e){return Ff(e)&&!gl(s)&&!S(s,Ve)&&!S(s,Rt)&&!S(s,se)&&!S(s,P)&&!S(s,De)?new Ve(s,e):s}var It=(s,e)=>m`${s} = ${He(e,s)}`,Pp=(s,e)=>m`${s} <> ${He(e,s)}`;function Ws(...s){let e=s.filter(t=>t!==void 0);if(e.length!==0)return e.length===1?new $(e):new $([new ve("("),m.join(e,new ve(" and ")),new ve(")")])}function xp(...s){let e=s.filter(t=>t!==void 0);if(e.length!==0)return e.length===1?new $(e):new $([new ve("("),m.join(e,new ve(" or ")),new ve(")")])}function Cp(s){return m`not ${s}`}var Rp=(s,e)=>m`${s} > ${He(e,s)}`,Op=(s,e)=>m`${s} >= ${He(e,s)}`,Np=(s,e)=>m`${s} < ${He(e,s)}`,$p=(s,e)=>m`${s} <= ${He(e,s)}`;function Ip(s,e){return Array.isArray(e)?e.length===0?m`false`:m`${s} in ${e.map(t=>He(t,s))}`:m`${s} in ${He(e,s)}`}function Mp(s,e){return Array.isArray(e)?e.length===0?m`true`:m`${s} not in ${e.map(t=>He(t,s))}`:m`${s} not in ${He(e,s)}`}function Dp(s){return m`${s} is null`}function jp(s){return m`${s} is not null`}function Lp(s){return m`exists ${s}`}function qp(s){return m`not exists ${s}`}function Up(s,e,t){return m`${s} between ${He(e,s)} and ${He(t,s)}`}function Bp(s,e,t){return m`${s} not between ${He(e,s)} and ${He(t,s)}`}function Fp(s,e){return m`${s} like ${e}`}function Vp(s,e){return m`${s} not like ${e}`}function Hp(s,e){return m`${s} ilike ${e}`}function Kp(s,e){return m`${s} not ilike ${e}`}function zp(s){return m`${s} asc`}function Wp(s){return m`${s} desc`}var sn=class{constructor(e,t,r){this.sourceTable=e,this.referencedTable=t,this.relationName=r,this.referencedTableName=t[P.Symbol.Name]}static[p]="Relation";referencedTableName;fieldName},Fc=class{constructor(e,t){this.table=e,this.config=t}static[p]="Relations"},Gt=class s extends sn{constructor(e,t,r,i){super(e,t,r?.relationName),this.config=r,this.isNullable=i}static[p]="One";withFieldName(e){let t=new s(this.sourceTable,this.referencedTable,this.config,this.isNullable);return t.fieldName=e,t}},Qs=class s extends sn{constructor(e,t,r){super(e,t,r?.relationName),this.config=r}static[p]="Many";withFieldName(e){let t=new s(this.sourceTable,this.referencedTable,this.config);return t.fieldName=e,t}};function Qp(){return{and:Ws,between:Up,eq:It,exists:Lp,gt:Rp,gte:Op,ilike:Hp,inArray:Ip,isNull:Dp,isNotNull:jp,like:Fp,lt:Np,lte:$p,ne:Pp,not:Cp,notBetween:Bp,notExists:qp,notLike:Vp,notIlike:Kp,notInArray:Mp,or:xp,sql:m}}function Jp(){return{sql:m,asc:zp,desc:Wp}}function Gp(s,e){Object.keys(s).length===1&&"default"in s&&!S(s.default,P)&&(s=s.default);let t={},r={},i={};for(let[n,o]of Object.entries(s))if(S(o,P)){let a=hr(o),l=r[a];t[a]=n,i[n]={tsName:n,dbName:o[P.Symbol.Name],schema:o[P.Symbol.Schema],columns:o[P.Symbol.Columns],relations:l?.relations??{},primaryKey:l?.primaryKey??[]};for(let u of Object.values(o[P.Symbol.Columns]))u.primary&&i[n].primaryKey.push(u);let c=o[P.Symbol.ExtraConfigBuilder]?.(o[P.Symbol.ExtraConfigColumns]);if(c)for(let u of Object.values(c))S(u,rn)&&i[n].primaryKey.push(...u.columns)}else if(S(o,Fc)){let a=hr(o.table),l=t[a],c=o.config(e(o.table)),u;for(let[f,d]of Object.entries(c))if(l){let h=i[l];h.relations[f]=d,u&&h.primaryKey.push(...u)}else a in r||(r[a]={relations:{},primaryKey:u}),r[a].relations[f]=d}return{tables:i,tableNamesMap:t}}function Tb(s){return function(t,r){return new Gt(s,t,r,r?.fields.reduce((i,n)=>i&&n.notNull,!0)??!1)}}function Ab(s){return function(t,r){return new Qs(s,t,r)}}function Xp(s,e,t){if(S(t,Gt)&&t.config)return{fields:t.config.fields,references:t.config.references};let r=e[hr(t.referencedTable)];if(!r)throw new Error(`Table "${t.referencedTable[P.Symbol.Name]}" not found in schema`);let i=s[r];if(!i)throw new Error(`Table "${r}" not found in schema`);let n=t.sourceTable,o=e[hr(n)];if(!o)throw new Error(`Table "${n[P.Symbol.Name]}" not found in schema`);let a=[];for(let l of Object.values(i.relations))(t.relationName&&t!==l&&l.relationName===t.relationName||!t.relationName&&l.referencedTable===t.sourceTable)&&a.push(l);if(a.length>1)throw t.relationName?new Error(`There are multiple relations with name "${t.relationName}" in table "${r}"`):new Error(`There are multiple relations between "${r}" and "${t.sourceTable[P.Symbol.Name]}". Please specify relation name`);if(a[0]&&S(a[0],Gt)&&a[0].config)return{fields:a[0].config.references,references:a[0].config.fields};throw new Error(`There is not enough information to infer relation "${o}.${t.fieldName}"`)}function Yp(s){return{one:Tb(s),many:Ab(s)}}function nn(s,e,t,r,i=n=>n){let n={};for(let[o,a]of r.entries())if(a.isJson){let l=e.relations[a.tsKey],c=t[o],u=typeof c=="string"?JSON.parse(c):c;n[a.tsKey]=S(l,Gt)?u&&nn(s,s[a.relationTableTsKey],u,a.selection,i):u.map(f=>nn(s,s[a.relationTableTsKey],f,a.selection,i))}else{let l=i(t[o]),c=a.field,u;S(c,se)?u=c:S(c,$)?u=c.decoder:u=c.sql.decoder,n[a.tsKey]=l===null?null:u.mapFromDriverValue(l)}return n}var wn=Jt(require("postgres"),1);var be=class s{static[p]="SelectionProxyHandler";config;constructor(e){this.config={...e}}get(e,t){if(t==="_")return{...e._,selectedFields:new Proxy(e._.selectedFields,this)};if(t===oe)return{...e[oe],selectedFields:new Proxy(e[oe].selectedFields,this)};if(typeof t=="symbol")return e[t];let i=(S(e,we)?e._.selectedFields:S(e,De)?e[oe].selectedFields:e)[t];if(S(i,$.Aliased)){if(this.config.sqlAliasedBehavior==="sql"&&!i.isSelectionField)return i.sql;let n=i.clone();return n.isSelectionField=!0,n}if(S(i,$)){if(this.config.sqlBehavior==="sql")return i;throw new Error(`You tried to reference "${t}" field from a subquery, which is a raw SQL field, but it doesn't have an alias declared. Please add an alias to the field using ".as('alias')" method.`)}return S(i,se)?this.config.alias?new Proxy(i,new fr(new Proxy(i.table,new Cr(this.config.alias,this.config.replaceOriginalName??!1)))):i:typeof i!="object"||i===null?i:new Proxy(i,new s(this.config))}};function kb(s){return(s.replace(/['\u2019]/g,"").match(/[\da-z]+|[A-Z]+(?![a-z])|[A-Z][\da-z]+/g)??[]).map(t=>t.toLowerCase()).join("_")}function Pb(s){return(s.replace(/['\u2019]/g,"").match(/[\da-z]+|[A-Z]+(?![a-z])|[A-Z][\da-z]+/g)??[]).reduce((t,r,i)=>{let n=i===0?r.toLowerCase():`${r[0].toUpperCase()}${r.slice(1)}`;return t+n},"")}function xb(s){return s}var on=class{static[p]="CasingCache";cache={};cachedTables={};convert;constructor(e){this.convert=e==="snake_case"?kb:e==="camelCase"?Pb:xb}getColumnCasing(e){if(!e.keyAsName)return e.name;let t=e.table[P.Symbol.Schema]??"public",r=e.table[P.Symbol.OriginalName],i=`${t}.${r}.${e.name}`;return this.cache[i]||this.cacheTable(e.table),this.cache[i]}cacheTable(e){let t=e[P.Symbol.Schema]??"public",r=e[P.Symbol.OriginalName],i=`${t}.${r}`;if(!this.cachedTables[i]){for(let n of Object.values(e[P.Symbol.Columns])){let o=`${i}.${n.name}`;this.cache[o]=this.convert(n.name)}this.cachedTables[i]=!0}}clearCache(){this.cache={},this.cachedTables={}}};var Rr=class extends De{static[p]="PgViewBase"};var Xt=class{static[p]="PgDialect";casing;constructor(e){this.casing=new on(e?.casing)}async migrate(e,t,r){let i=typeof r=="string"?"__drizzle_migrations":r.migrationsTable??"__drizzle_migrations",n=typeof r=="string"?"drizzle":r.migrationsSchema??"drizzle",o=m`
			CREATE TABLE IF NOT EXISTS ${m.identifier(n)}.${m.identifier(i)} (
				id SERIAL PRIMARY KEY,
				hash text NOT NULL,
				created_at bigint
			)
		`;await t.execute(m`CREATE SCHEMA IF NOT EXISTS ${m.identifier(n)}`),await t.execute(o);let l=(await t.all(m`select id, hash, created_at from ${m.identifier(n)}.${m.identifier(i)} order by created_at desc limit 1`))[0];await t.transaction(async c=>{for await(let u of e)if(!l||Number(l.created_at)<u.folderMillis){for(let f of u.sql)await c.execute(m.raw(f));await c.execute(m`insert into ${m.identifier(n)}.${m.identifier(i)} ("hash", "created_at") values(${u.hash}, ${u.folderMillis})`)}})}escapeName(e){return`"${e}"`}escapeParam(e){return`$${e+1}`}escapeString(e){return`'${e.replace(/'/g,"''")}'`}buildWithCTE(e){if(!e?.length)return;let t=[m`with `];for(let[r,i]of e.entries())t.push(m`${m.identifier(i._.alias)} as (${i._.sql})`),r<e.length-1&&t.push(m`, `);return t.push(m` `),m.join(t)}buildDeleteQuery({table:e,where:t,returning:r,withList:i}){let n=this.buildWithCTE(i),o=r?m` returning ${this.buildSelection(r,{isSingleTable:!0})}`:void 0,a=t?m` where ${t}`:void 0;return m`${n}delete from ${e}${a}${o}`}buildUpdateSet(e,t){let r=e[P.Symbol.Columns],i=Object.keys(r).filter(o=>t[o]!==void 0||r[o]?.onUpdateFn!==void 0),n=i.length;return m.join(i.flatMap((o,a)=>{let l=r[o],c=t[o]??m.param(l.onUpdateFn(),l),u=m`${m.identifier(this.casing.getColumnCasing(l))} = ${c}`;return a<n-1?[u,m.raw(", ")]:[u]}))}buildUpdateQuery({table:e,set:t,where:r,returning:i,withList:n,from:o,joins:a}){let l=this.buildWithCTE(n),c=e[Se.Symbol.Name],u=e[Se.Symbol.Schema],f=e[Se.Symbol.OriginalName],d=c===f?void 0:c,h=m`${u?m`${m.identifier(u)}.`:void 0}${m.identifier(f)}${d&&m` ${m.identifier(d)}`}`,g=this.buildUpdateSet(e,t),y=o&&m.join([m.raw(" from "),this.buildFromTable(o)]),_=this.buildJoins(a),b=i?m` returning ${this.buildSelection(i,{isSingleTable:!o})}`:void 0,v=r?m` where ${r}`:void 0;return m`${l}update ${h} set ${g}${y}${_}${v}${b}`}buildSelection(e,{isSingleTable:t=!1}={}){let r=e.length,i=e.flatMap(({field:n},o)=>{let a=[];if(S(n,$.Aliased)&&n.isSelectionField)a.push(m.identifier(n.fieldAlias));else if(S(n,$.Aliased)||S(n,$)){let l=S(n,$.Aliased)?n.sql:n;t?a.push(new $(l.queryChunks.map(c=>S(c,k)?m.identifier(this.casing.getColumnCasing(c)):c))):a.push(l),S(n,$.Aliased)&&a.push(m` as ${m.identifier(n.fieldAlias)}`)}else S(n,se)&&(t?a.push(m.identifier(this.casing.getColumnCasing(n))):a.push(n));return o<r-1&&a.push(m`, `),a});return m.join(i)}buildJoins(e){if(!e||e.length===0)return;let t=[];for(let[r,i]of e.entries()){r===0&&t.push(m` `);let n=i.table,o=i.lateral?m` lateral`:void 0,a=i.on?m` on ${i.on}`:void 0;if(S(n,Se)){let l=n[Se.Symbol.Name],c=n[Se.Symbol.Schema],u=n[Se.Symbol.OriginalName],f=l===u?void 0:i.alias;t.push(m`${m.raw(i.joinType)} join${o} ${c?m`${m.identifier(c)}.`:void 0}${m.identifier(u)}${f&&m` ${m.identifier(f)}`}${a}`)}else if(S(n,De)){let l=n[oe].name,c=n[oe].schema,u=n[oe].originalName,f=l===u?void 0:i.alias;t.push(m`${m.raw(i.joinType)} join${o} ${c?m`${m.identifier(c)}.`:void 0}${m.identifier(u)}${f&&m` ${m.identifier(f)}`}${a}`)}else t.push(m`${m.raw(i.joinType)} join${o} ${n}${a}`);r<e.length-1&&t.push(m` `)}return m.join(t)}buildFromTable(e){if(S(e,P)&&e[P.Symbol.IsAlias]){let t=m`${m.identifier(e[P.Symbol.OriginalName])}`;return e[P.Symbol.Schema]&&(t=m`${m.identifier(e[P.Symbol.Schema])}.${t}`),m`${t} ${m.identifier(e[P.Symbol.Name])}`}return e}buildSelectQuery({withList:e,fields:t,fieldsFlat:r,where:i,having:n,table:o,joins:a,orderBy:l,groupBy:c,limit:u,offset:f,lockingClause:d,distinct:h,setOperators:g}){let y=r??rt(t);for(let Ge of y)if(S(Ge.field,se)&&Fe(Ge.field.table)!==(S(o,we)?o._.alias:S(o,Rr)?o[oe].name:S(o,$)?void 0:Fe(o))&&!(Ct=>a?.some(({alias:Za})=>Za===(Ct[P.Symbol.IsAlias]?Fe(Ct):Ct[P.Symbol.BaseName])))(Ge.field.table)){let Ct=Fe(Ge.field.table);throw new Error(`Your "${Ge.path.join("->")}" field references a column "${Ct}"."${Ge.field.name}", but the table "${Ct}" is not part of the query! Did you forget to join it?`)}let _=!a||a.length===0,b=this.buildWithCTE(e),v;h&&(v=h===!0?m` distinct`:m` distinct on (${m.join(h.on,m`, `)})`);let A=this.buildSelection(y,{isSingleTable:_}),N=this.buildFromTable(o),te=this.buildJoins(a),U=i?m` where ${i}`:void 0,I=n?m` having ${n}`:void 0,B;l&&l.length>0&&(B=m` order by ${m.join(l,m`, `)}`);let he;c&&c.length>0&&(he=m` group by ${m.join(c,m`, `)}`);let Hi=typeof u=="object"||typeof u=="number"&&u>=0?m` limit ${u}`:void 0,Ya=f?m` offset ${f}`:void 0,Pr=m.empty();if(d){let Ge=m` for ${m.raw(d.strength)}`;d.config.of&&Ge.append(m` of ${m.join(Array.isArray(d.config.of)?d.config.of:[d.config.of],m`, `)}`),d.config.noWait?Ge.append(m` nowait`):d.config.skipLocked&&Ge.append(m` skip locked`),Pr.append(Ge)}let Qt=m`${b}select${v} ${A} from ${N}${te}${U}${he}${I}${B}${Hi}${Ya}${Pr}`;return g.length>0?this.buildSetOperations(Qt,g):Qt}buildSetOperations(e,t){let[r,...i]=t;if(!r)throw new Error("Cannot pass undefined values to any set operator");return i.length===0?this.buildSetOperationQuery({leftSelect:e,setOperator:r}):this.buildSetOperations(this.buildSetOperationQuery({leftSelect:e,setOperator:r}),i)}buildSetOperationQuery({leftSelect:e,setOperator:{type:t,isAll:r,rightSelect:i,limit:n,orderBy:o,offset:a}}){let l=m`(${e.getSQL()}) `,c=m`(${i.getSQL()})`,u;if(o&&o.length>0){let g=[];for(let y of o)if(S(y,k))g.push(m.identifier(y.name));else if(S(y,$)){for(let _=0;_<y.queryChunks.length;_++){let b=y.queryChunks[_];S(b,k)&&(y.queryChunks[_]=m.identifier(b.name))}g.push(m`${y}`)}else g.push(m`${y}`);u=m` order by ${m.join(g,m`, `)} `}let f=typeof n=="object"||typeof n=="number"&&n>=0?m` limit ${n}`:void 0,d=m.raw(`${t} ${r?"all ":""}`),h=a?m` offset ${a}`:void 0;return m`${l}${d}${c}${u}${f}${h}`}buildInsertQuery({table:e,values:t,onConflict:r,returning:i,withList:n,select:o,overridingSystemValue_:a}){let l=[],c=e[P.Symbol.Columns],u=Object.entries(c).filter(([b,v])=>!v.shouldDisableInsert()),f=u.map(([,b])=>m.identifier(this.casing.getColumnCasing(b)));if(o){let b=t;S(b,$)?l.push(b):l.push(b.getSQL())}else{let b=t;l.push(m.raw("values "));for(let[v,A]of b.entries()){let N=[];for(let[te,U]of u){let I=A[te];if(I===void 0||S(I,Ve)&&I.value===void 0)if(U.defaultFn!==void 0){let B=U.defaultFn(),he=S(B,$)?B:m.param(B,U);N.push(he)}else if(!U.default&&U.onUpdateFn!==void 0){let B=U.onUpdateFn(),he=S(B,$)?B:m.param(B,U);N.push(he)}else N.push(m`default`);else N.push(I)}l.push(N),v<b.length-1&&l.push(m`, `)}}let d=this.buildWithCTE(n),h=m.join(l),g=i?m` returning ${this.buildSelection(i,{isSingleTable:!0})}`:void 0,y=r?m` on conflict ${r}`:void 0,_=a===!0?m`overriding system value `:void 0;return m`${d}insert into ${e} ${f} ${_}${h}${y}${g}`}buildRefreshMaterializedViewQuery({view:e,concurrently:t,withNoData:r}){let i=t?m` concurrently`:void 0,n=r?m` with no data`:void 0;return m`refresh materialized view${i} ${e}${n}`}prepareTyping(e){return S(e,Bs)||S(e,Us)?"json":S(e,Fs)?"decimal":S(e,Vs)?"time":S(e,Hs)||S(e,Ks)?"timestamp":S(e,Ls)||S(e,qs)?"date":S(e,zs)?"uuid":"none"}sqlToQuery(e,t){return e.toQuery({casing:this.casing,escapeName:this.escapeName,escapeParam:this.escapeParam,escapeString:this.escapeString,prepareTyping:this.prepareTyping,invokeSource:t})}buildRelationalQueryWithoutPK({fullSchema:e,schema:t,tableNamesMap:r,table:i,tableConfig:n,queryConfig:o,tableAlias:a,nestedQueryRelation:l,joinOn:c}){let u=[],f,d,h=[],g,y=[];if(o===!0)u=Object.entries(n.columns).map(([v,A])=>({dbKey:A.name,tsKey:v,field:bt(A,a),relationTableTsKey:void 0,isJson:!1,selection:[]}));else{let b=Object.fromEntries(Object.entries(n.columns).map(([I,B])=>[I,bt(B,a)]));if(o.where){let I=typeof o.where=="function"?o.where(b,Qp()):o.where;g=I&&Ms(I,a)}let v=[],A=[];if(o.columns){let I=!1;for(let[B,he]of Object.entries(o.columns))he!==void 0&&B in n.columns&&(!I&&he===!0&&(I=!0),A.push(B));A.length>0&&(A=I?A.filter(B=>o.columns?.[B]===!0):Object.keys(n.columns).filter(B=>!A.includes(B)))}else A=Object.keys(n.columns);for(let I of A){let B=n.columns[I];v.push({tsKey:I,value:B})}let N=[];o.with&&(N=Object.entries(o.with).filter(I=>!!I[1]).map(([I,B])=>({tsKey:I,queryConfig:B,relation:n.relations[I]})));let te;if(o.extras){te=typeof o.extras=="function"?o.extras(b,{sql:m}):o.extras;for(let[I,B]of Object.entries(te))v.push({tsKey:I,value:wl(B,a)})}for(let{tsKey:I,value:B}of v)u.push({dbKey:S(B,$.Aliased)?B.fieldAlias:n.columns[I].name,tsKey:I,field:S(B,se)?bt(B,a):B,relationTableTsKey:void 0,isJson:!1,selection:[]});let U=typeof o.orderBy=="function"?o.orderBy(b,Jp()):o.orderBy??[];Array.isArray(U)||(U=[U]),h=U.map(I=>S(I,se)?bt(I,a):Ms(I,a)),f=o.limit,d=o.offset;for(let{tsKey:I,queryConfig:B,relation:he}of N){let Hi=Xp(t,r,he),Ya=hr(he.referencedTable),Pr=r[Ya],Qt=`${a}_${I}`,Ge=Ws(...Hi.fields.map((ub,db)=>It(bt(Hi.references[db],Qt),bt(ub,a)))),Ct=this.buildRelationalQueryWithoutPK({fullSchema:e,schema:t,tableNamesMap:r,table:e[Pr],tableConfig:t[Pr],queryConfig:S(he,Gt)?B===!0?{limit:1}:{...B,limit:1}:B,tableAlias:Qt,joinOn:Ge,nestedQueryRelation:he}),Za=m`${m.identifier(Qt)}.${m.identifier("data")}`.as(I);y.push({on:m`true`,table:new we(Ct.sql,{},Qt),alias:Qt,joinType:"left",lateral:!0}),u.push({dbKey:I,tsKey:I,field:Za,relationTableTsKey:Pr,isJson:!0,selection:Ct.selection})}}if(u.length===0)throw new Ds({message:`No fields selected for table "${n.tsName}" ("${a}")`});let _;if(g=Ws(c,g),l){let b=m`json_build_array(${m.join(u.map(({field:N,tsKey:te,isJson:U})=>U?m`${m.identifier(`${a}_${te}`)}.${m.identifier("data")}`:S(N,$.Aliased)?N.sql:N),m`, `)})`;S(l,Qs)&&(b=m`coalesce(json_agg(${b}${h.length>0?m` order by ${m.join(h,m`, `)}`:void 0}), '[]'::json)`);let v=[{dbKey:"data",tsKey:"data",field:b.as("data"),isJson:!0,relationTableTsKey:n.tsName,selection:u}];f!==void 0||d!==void 0||h.length>0?(_=this.buildSelectQuery({table:Is(i,a),fields:{},fieldsFlat:[{path:[],field:m.raw("*")}],where:g,limit:f,offset:d,orderBy:h,setOperators:[]}),g=void 0,f=void 0,d=void 0,h=[]):_=Is(i,a),_=this.buildSelectQuery({table:S(_,Se)?_:new we(_,{},a),fields:{},fieldsFlat:v.map(({field:N})=>({path:[],field:S(N,se)?bt(N,a):N})),joins:y,where:g,limit:f,offset:d,orderBy:h,setOperators:[]})}else _=this.buildSelectQuery({table:Is(i,a),fields:{},fieldsFlat:u.map(({field:b})=>({path:[],field:S(b,se)?bt(b,a):b})),joins:y,where:g,limit:f,offset:d,orderBy:h,setOperators:[]});return{tableTsKey:n.tsName,sql:_,selection:u}}};var an=class{static[p]="TypedQueryBuilder";getSelectedFields(){return this._.selectedFields}};var $e=class{static[p]="PgSelectBuilder";fields;session;dialect;withList=[];distinct;constructor(e){this.fields=e.fields,this.session=e.session,this.dialect=e.dialect,e.withList&&(this.withList=e.withList),this.distinct=e.distinct}authToken;setToken(e){return this.authToken=e,this}from(e){let t=!!this.fields,r=e,i;return this.fields?i=this.fields:S(r,we)?i=Object.fromEntries(Object.keys(r._.selectedFields).map(n=>[n,r[n]])):S(r,Rr)?i=r[oe].selectedFields:S(r,$)?i={}:i=Qf(r),new ln({table:r,fields:i,isPartialSelect:t,session:this.session,dialect:this.dialect,withList:this.withList,distinct:this.distinct}).setToken(this.authToken)}},Vc=class extends an{static[p]="PgSelectQueryBuilder";_;config;joinsNotNullableMap;tableName;isPartialSelect;session;dialect;cacheConfig=void 0;usedTables=new Set;constructor({table:e,fields:t,isPartialSelect:r,session:i,dialect:n,withList:o,distinct:a}){super(),this.config={withList:o,table:e,fields:{...t},distinct:a,setOperators:[]},this.isPartialSelect=r,this.session=i,this.dialect=n,this._={selectedFields:t,config:this.config},this.tableName=Nt(e),this.joinsNotNullableMap=typeof this.tableName=="string"?{[this.tableName]:!0}:{};for(let l of ft(e))this.usedTables.add(l)}getUsedTables(){return[...this.usedTables]}createJoin(e,t){return(r,i)=>{let n=this.tableName,o=Nt(r);for(let a of ft(r))this.usedTables.add(a);if(typeof o=="string"&&this.config.joins?.some(a=>a.alias===o))throw new Error(`Alias "${o}" is already used in this query`);if(!this.isPartialSelect&&(Object.keys(this.joinsNotNullableMap).length===1&&typeof n=="string"&&(this.config.fields={[n]:this.config.fields}),typeof o=="string"&&!S(r,$))){let a=S(r,we)?r._.selectedFields:S(r,De)?r[oe].selectedFields:r[P.Symbol.Columns];this.config.fields[o]=a}if(typeof i=="function"&&(i=i(new Proxy(this.config.fields,new be({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))),this.config.joins||(this.config.joins=[]),this.config.joins.push({on:i,table:r,joinType:e,alias:o,lateral:t}),typeof o=="string")switch(e){case"left":{this.joinsNotNullableMap[o]=!1;break}case"right":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([a])=>[a,!1])),this.joinsNotNullableMap[o]=!0;break}case"cross":case"inner":{this.joinsNotNullableMap[o]=!0;break}case"full":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([a])=>[a,!1])),this.joinsNotNullableMap[o]=!1;break}}return this}}leftJoin=this.createJoin("left",!1);leftJoinLateral=this.createJoin("left",!0);rightJoin=this.createJoin("right",!1);innerJoin=this.createJoin("inner",!1);innerJoinLateral=this.createJoin("inner",!0);fullJoin=this.createJoin("full",!1);crossJoin=this.createJoin("cross",!1);crossJoinLateral=this.createJoin("cross",!0);createSetOperator(e,t){return r=>{let i=typeof r=="function"?r(Cb()):r;if(!js(this.getSelectedFields(),i.getSelectedFields()))throw new Error("Set operator error (union / intersect / except): selected fields are not the same or are in a different order");return this.config.setOperators.push({type:e,isAll:t,rightSelect:i}),this}}union=this.createSetOperator("union",!1);unionAll=this.createSetOperator("union",!0);intersect=this.createSetOperator("intersect",!1);intersectAll=this.createSetOperator("intersect",!0);except=this.createSetOperator("except",!1);exceptAll=this.createSetOperator("except",!0);addSetOperators(e){return this.config.setOperators.push(...e),this}where(e){return typeof e=="function"&&(e=e(new Proxy(this.config.fields,new be({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))),this.config.where=e,this}having(e){return typeof e=="function"&&(e=e(new Proxy(this.config.fields,new be({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))),this.config.having=e,this}groupBy(...e){if(typeof e[0]=="function"){let t=e[0](new Proxy(this.config.fields,new be({sqlAliasedBehavior:"alias",sqlBehavior:"sql"})));this.config.groupBy=Array.isArray(t)?t:[t]}else this.config.groupBy=e;return this}orderBy(...e){if(typeof e[0]=="function"){let t=e[0](new Proxy(this.config.fields,new be({sqlAliasedBehavior:"alias",sqlBehavior:"sql"}))),r=Array.isArray(t)?t:[t];this.config.setOperators.length>0?this.config.setOperators.at(-1).orderBy=r:this.config.orderBy=r}else{let t=e;this.config.setOperators.length>0?this.config.setOperators.at(-1).orderBy=t:this.config.orderBy=t}return this}limit(e){return this.config.setOperators.length>0?this.config.setOperators.at(-1).limit=e:this.config.limit=e,this}offset(e){return this.config.setOperators.length>0?this.config.setOperators.at(-1).offset=e:this.config.offset=e,this}for(e,t={}){return this.config.lockingClause={strength:e,config:t},this}getSQL(){return this.dialect.buildSelectQuery(this.config)}toSQL(){let{typings:e,...t}=this.dialect.sqlToQuery(this.getSQL());return t}as(e){let t=[];if(t.push(...ft(this.config.table)),this.config.joins)for(let r of this.config.joins)t.push(...ft(r.table));return new Proxy(new we(this.getSQL(),this.config.fields,e,!1,[...new Set(t)]),new be({alias:e,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}getSelectedFields(){return new Proxy(this.config.fields,new be({alias:this.tableName,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}$dynamic(){return this}$withCache(e){return this.cacheConfig=e===void 0?{config:{},enable:!0,autoInvalidate:!0}:e===!1?{enable:!1}:{enable:!0,autoInvalidate:!0,...e},this}},ln=class extends Vc{static[p]="PgSelect";_prepare(e){let{session:t,config:r,dialect:i,joinsNotNullableMap:n,authToken:o,cacheConfig:a,usedTables:l}=this;if(!t)throw new Error("Cannot execute a query on a query builder. Please use a database instance instead.");let{fields:c}=r;return ne.startActiveSpan("drizzle.prepareQuery",()=>{let u=rt(c),f=t.prepareQuery(i.sqlToQuery(this.getSQL()),u,e,!0,void 0,{type:"select",tables:[...l]},a);return f.joinsNotNullableMap=n,f.setToken(o)})}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>ne.startActiveSpan("drizzle.operation",()=>this._prepare().execute(e,this.authToken))};Wf(ln,[Ne]);function Or(s,e){return(t,r,...i)=>{let n=[r,...i].map(o=>({type:s,isAll:e,rightSelect:o}));for(let o of n)if(!js(t.getSelectedFields(),o.rightSelect.getSelectedFields()))throw new Error("Set operator error (union / intersect / except): selected fields are not the same or are in a different order");return t.addSetOperators(n)}}var Cb=()=>({union:Rb,unionAll:Ob,intersect:Nb,intersectAll:$b,except:Ib,exceptAll:Mb}),Rb=Or("union",!1),Ob=Or("union",!0),Nb=Or("intersect",!1),$b=Or("intersect",!0),Ib=Or("except",!1),Mb=Or("except",!0);var Nr=class{static[p]="PgQueryBuilder";dialect;dialectConfig;constructor(e){this.dialect=S(e,Xt)?e:void 0,this.dialectConfig=S(e,Xt)?void 0:e}$with=(e,t)=>{let r=this;return{as:n=>(typeof n=="function"&&(n=n(r)),new Proxy(new xr(n.getSQL(),t??("getSelectedFields"in n?n.getSelectedFields()??{}:{}),e,!0),new be({alias:e,sqlAliasedBehavior:"alias",sqlBehavior:"error"})))}};with(...e){let t=this;function r(o){return new $e({fields:o??void 0,session:void 0,dialect:t.getDialect(),withList:e})}function i(o){return new $e({fields:o??void 0,session:void 0,dialect:t.getDialect(),distinct:!0})}function n(o,a){return new $e({fields:a??void 0,session:void 0,dialect:t.getDialect(),distinct:{on:o}})}return{select:r,selectDistinct:i,selectDistinctOn:n}}select(e){return new $e({fields:e??void 0,session:void 0,dialect:this.getDialect()})}selectDistinct(e){return new $e({fields:e??void 0,session:void 0,dialect:this.getDialect(),distinct:!0})}selectDistinctOn(e,t){return new $e({fields:t??void 0,session:void 0,dialect:this.getDialect(),distinct:{on:e}})}getDialect(){return this.dialect||(this.dialect=new Xt(this.dialectConfig)),this.dialect}};function ft(s){return S(s,Se)?[s[dr]?`${s[dr]}.${s[P.Symbol.BaseName]}`:s[P.Symbol.BaseName]]:S(s,we)?s._.usedTables??[]:S(s,$)?s.usedTables??[]:[]}var Js=class extends Ne{constructor(e,t,r,i){super(),this.session=t,this.dialect=r,this.config={table:e,withList:i}}static[p]="PgDelete";config;cacheConfig;where(e){return this.config.where=e,this}returning(e=this.config.table[P.Symbol.Columns]){return this.config.returningFields=e,this.config.returning=rt(e),this}getSQL(){return this.dialect.buildDeleteQuery(this.config)}toSQL(){let{typings:e,...t}=this.dialect.sqlToQuery(this.getSQL());return t}_prepare(e){return ne.startActiveSpan("drizzle.prepareQuery",()=>this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),this.config.returning,e,!0,void 0,{type:"delete",tables:ft(this.config.table)},this.cacheConfig))}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>ne.startActiveSpan("drizzle.operation",()=>this._prepare().execute(e,this.authToken));getSelectedFields(){return this.config.returningFields?new Proxy(this.config.returningFields,new be({alias:Fe(this.config.table),sqlAliasedBehavior:"alias",sqlBehavior:"error"})):void 0}$dynamic(){return this}};var Gs=class{constructor(e,t,r,i,n){this.table=e,this.session=t,this.dialect=r,this.withList=i,this.overridingSystemValue_=n}static[p]="PgInsertBuilder";authToken;setToken(e){return this.authToken=e,this}overridingSystemValue(){return this.overridingSystemValue_=!0,this}values(e){if(e=Array.isArray(e)?e:[e],e.length===0)throw new Error("values() must be called with at least one value");let t=e.map(r=>{let i={},n=this.table[P.Symbol.Columns];for(let o of Object.keys(r)){let a=r[o];i[o]=S(a,$)?a:new Ve(a,n[o])}return i});return new cn(this.table,t,this.session,this.dialect,this.withList,!1,this.overridingSystemValue_).setToken(this.authToken)}select(e){let t=typeof e=="function"?e(new Nr):e;if(!S(t,$)&&!js(this.table[Xi],t._.selectedFields))throw new Error("Insert select error: selected fields are not the same or are in a different order compared to the table definition");return new cn(this.table,t,this.session,this.dialect,this.withList,!0)}},cn=class extends Ne{constructor(e,t,r,i,n,o,a){super(),this.session=r,this.dialect=i,this.config={table:e,values:t,withList:n,select:o,overridingSystemValue_:a}}static[p]="PgInsert";config;cacheConfig;returning(e=this.config.table[P.Symbol.Columns]){return this.config.returningFields=e,this.config.returning=rt(e),this}onConflictDoNothing(e={}){if(e.target===void 0)this.config.onConflict=m`do nothing`;else{let t="";t=Array.isArray(e.target)?e.target.map(i=>this.dialect.escapeName(this.dialect.casing.getColumnCasing(i))).join(","):this.dialect.escapeName(this.dialect.casing.getColumnCasing(e.target));let r=e.where?m` where ${e.where}`:void 0;this.config.onConflict=m`(${m.raw(t)})${r} do nothing`}return this}onConflictDoUpdate(e){if(e.where&&(e.targetWhere||e.setWhere))throw new Error('You cannot use both "where" and "targetWhere"/"setWhere" at the same time - "where" is deprecated, use "targetWhere" or "setWhere" instead.');let t=e.where?m` where ${e.where}`:void 0,r=e.targetWhere?m` where ${e.targetWhere}`:void 0,i=e.setWhere?m` where ${e.setWhere}`:void 0,n=this.dialect.buildUpdateSet(this.config.table,tn(this.config.table,e.set)),o="";return o=Array.isArray(e.target)?e.target.map(a=>this.dialect.escapeName(this.dialect.casing.getColumnCasing(a))).join(","):this.dialect.escapeName(this.dialect.casing.getColumnCasing(e.target)),this.config.onConflict=m`(${m.raw(o)})${r} do update set ${n}${t}${i}`,this}getSQL(){return this.dialect.buildInsertQuery(this.config)}toSQL(){let{typings:e,...t}=this.dialect.sqlToQuery(this.getSQL());return t}_prepare(e){return ne.startActiveSpan("drizzle.prepareQuery",()=>this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),this.config.returning,e,!0,void 0,{type:"insert",tables:ft(this.config.table)},this.cacheConfig))}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>ne.startActiveSpan("drizzle.operation",()=>this._prepare().execute(e,this.authToken));getSelectedFields(){return this.config.returningFields?new Proxy(this.config.returningFields,new be({alias:Fe(this.config.table),sqlAliasedBehavior:"alias",sqlBehavior:"error"})):void 0}$dynamic(){return this}};var un=class extends Ne{constructor(e,t,r){super(),this.session=t,this.dialect=r,this.config={view:e}}static[p]="PgRefreshMaterializedView";config;concurrently(){if(this.config.withNoData!==void 0)throw new Error("Cannot use concurrently and withNoData together");return this.config.concurrently=!0,this}withNoData(){if(this.config.concurrently!==void 0)throw new Error("Cannot use concurrently and withNoData together");return this.config.withNoData=!0,this}getSQL(){return this.dialect.buildRefreshMaterializedViewQuery(this.config)}toSQL(){let{typings:e,...t}=this.dialect.sqlToQuery(this.getSQL());return t}_prepare(e){return ne.startActiveSpan("drizzle.prepareQuery",()=>this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),void 0,e,!0))}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>ne.startActiveSpan("drizzle.operation",()=>this._prepare().execute(e,this.authToken))};var Xs=class{constructor(e,t,r,i){this.table=e,this.session=t,this.dialect=r,this.withList=i}static[p]="PgUpdateBuilder";authToken;setToken(e){return this.authToken=e,this}set(e){return new Hc(this.table,tn(this.table,e),this.session,this.dialect,this.withList).setToken(this.authToken)}},Hc=class extends Ne{constructor(e,t,r,i,n){super(),this.session=r,this.dialect=i,this.config={set:t,table:e,withList:n,joins:[]},this.tableName=Nt(e),this.joinsNotNullableMap=typeof this.tableName=="string"?{[this.tableName]:!0}:{}}static[p]="PgUpdate";config;tableName;joinsNotNullableMap;cacheConfig;from(e){let t=e,r=Nt(t);return typeof r=="string"&&(this.joinsNotNullableMap[r]=!0),this.config.from=t,this}getTableLikeFields(e){return S(e,Se)?e[P.Symbol.Columns]:S(e,we)?e._.selectedFields:e[oe].selectedFields}createJoin(e){return(t,r)=>{let i=Nt(t);if(typeof i=="string"&&this.config.joins.some(n=>n.alias===i))throw new Error(`Alias "${i}" is already used in this query`);if(typeof r=="function"){let n=this.config.from&&!S(this.config.from,$)?this.getTableLikeFields(this.config.from):void 0;r=r(new Proxy(this.config.table[P.Symbol.Columns],new be({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})),n&&new Proxy(n,new be({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))}if(this.config.joins.push({on:r,table:t,joinType:e,alias:i}),typeof i=="string")switch(e){case"left":{this.joinsNotNullableMap[i]=!1;break}case"right":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([n])=>[n,!1])),this.joinsNotNullableMap[i]=!0;break}case"inner":{this.joinsNotNullableMap[i]=!0;break}case"full":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([n])=>[n,!1])),this.joinsNotNullableMap[i]=!1;break}}return this}}leftJoin=this.createJoin("left");rightJoin=this.createJoin("right");innerJoin=this.createJoin("inner");fullJoin=this.createJoin("full");where(e){return this.config.where=e,this}returning(e){if(!e&&(e=Object.assign({},this.config.table[P.Symbol.Columns]),this.config.from)){let t=Nt(this.config.from);if(typeof t=="string"&&this.config.from&&!S(this.config.from,$)){let r=this.getTableLikeFields(this.config.from);e[t]=r}for(let r of this.config.joins){let i=Nt(r.table);if(typeof i=="string"&&!S(r.table,$)){let n=this.getTableLikeFields(r.table);e[i]=n}}}return this.config.returningFields=e,this.config.returning=rt(e),this}getSQL(){return this.dialect.buildUpdateQuery(this.config)}toSQL(){let{typings:e,...t}=this.dialect.sqlToQuery(this.getSQL());return t}_prepare(e){let t=this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),this.config.returning,e,!0,void 0,{type:"insert",tables:ft(this.config.table)},this.cacheConfig);return t.joinsNotNullableMap=this.joinsNotNullableMap,t}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>this._prepare().execute(e,this.authToken);getSelectedFields(){return this.config.returningFields?new Proxy(this.config.returningFields,new be({alias:Fe(this.config.table),sqlAliasedBehavior:"alias",sqlBehavior:"error"})):void 0}$dynamic(){return this}};var dn=class s extends ${constructor(e){super(s.buildEmbeddedCount(e.source,e.filters).queryChunks),this.params=e,this.mapWith(Number),this.session=e.session,this.sql=s.buildCount(e.source,e.filters)}sql;token;static[p]="PgCountBuilder";[Symbol.toStringTag]="PgCountBuilder";session;static buildEmbeddedCount(e,t){return m`(select count(*) from ${e}${m.raw(" where ").if(t)}${t})`}static buildCount(e,t){return m`select count(*) as count from ${e}${m.raw(" where ").if(t)}${t};`}setToken(e){return this.token=e,this}then(e,t){return Promise.resolve(this.session.count(this.sql,this.token)).then(e,t)}catch(e){return this.then(void 0,e)}finally(e){return this.then(t=>(e?.(),t),t=>{throw e?.(),t})}};var hn=class{constructor(e,t,r,i,n,o,a){this.fullSchema=e,this.schema=t,this.tableNamesMap=r,this.table=i,this.tableConfig=n,this.dialect=o,this.session=a}static[p]="PgRelationalQueryBuilder";findMany(e){return new fn(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e||{},"many")}findFirst(e){return new fn(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e?{...e,limit:1}:{limit:1},"first")}},fn=class extends Ne{constructor(e,t,r,i,n,o,a,l,c){super(),this.fullSchema=e,this.schema=t,this.tableNamesMap=r,this.table=i,this.tableConfig=n,this.dialect=o,this.session=a,this.config=l,this.mode=c}static[p]="PgRelationalQuery";_prepare(e){return ne.startActiveSpan("drizzle.prepareQuery",()=>{let{query:t,builtQuery:r}=this._toSQL();return this.session.prepareQuery(r,void 0,e,!0,(i,n)=>{let o=i.map(a=>nn(this.schema,this.tableConfig,a,t.selection,n));return this.mode==="first"?o[0]:o})})}prepare(e){return this._prepare(e)}_getQuery(){return this.dialect.buildRelationalQueryWithoutPK({fullSchema:this.fullSchema,schema:this.schema,tableNamesMap:this.tableNamesMap,table:this.table,tableConfig:this.tableConfig,queryConfig:this.config,tableAlias:this.tableConfig.tsName})}getSQL(){return this._getQuery().sql}_toSQL(){let e=this._getQuery(),t=this.dialect.sqlToQuery(e.sql);return{query:e,builtQuery:t}}toSQL(){return this._toSQL().builtQuery}authToken;setToken(e){return this.authToken=e,this}execute(){return ne.startActiveSpan("drizzle.operation",()=>this._prepare().execute(void 0,this.authToken))}};var pn=class extends Ne{constructor(e,t,r,i){super(),this.execute=e,this.sql=t,this.query=r,this.mapBatchResult=i}static[p]="PgRaw";getSQL(){return this.sql}getQuery(){return this.query}mapResult(e,t){return t?this.mapBatchResult(e):e}_prepare(){return this}isResponseInArrayMode(){return!1}};var $r=class{constructor(e,t,r){if(this.dialect=e,this.session=t,this._=r?{schema:r.schema,fullSchema:r.fullSchema,tableNamesMap:r.tableNamesMap,session:t}:{schema:void 0,fullSchema:{},tableNamesMap:{},session:t},this.query={},this._.schema)for(let[i,n]of Object.entries(this._.schema))this.query[i]=new hn(r.fullSchema,this._.schema,this._.tableNamesMap,r.fullSchema[i],n,e,t);this.$cache={invalidate:async i=>{}}}static[p]="PgDatabase";query;$with=(e,t)=>{let r=this;return{as:n=>(typeof n=="function"&&(n=n(new Nr(r.dialect))),new Proxy(new xr(n.getSQL(),t??("getSelectedFields"in n?n.getSelectedFields()??{}:{}),e,!0),new be({alias:e,sqlAliasedBehavior:"alias",sqlBehavior:"error"})))}};$count(e,t){return new dn({source:e,filters:t,session:this.session})}$cache;with(...e){let t=this;function r(c){return new $e({fields:c??void 0,session:t.session,dialect:t.dialect,withList:e})}function i(c){return new $e({fields:c??void 0,session:t.session,dialect:t.dialect,withList:e,distinct:!0})}function n(c,u){return new $e({fields:u??void 0,session:t.session,dialect:t.dialect,withList:e,distinct:{on:c}})}function o(c){return new Xs(c,t.session,t.dialect,e)}function a(c){return new Gs(c,t.session,t.dialect,e)}function l(c){return new Js(c,t.session,t.dialect,e)}return{select:r,selectDistinct:i,selectDistinctOn:n,update:o,insert:a,delete:l}}select(e){return new $e({fields:e??void 0,session:this.session,dialect:this.dialect})}selectDistinct(e){return new $e({fields:e??void 0,session:this.session,dialect:this.dialect,distinct:!0})}selectDistinctOn(e,t){return new $e({fields:t??void 0,session:this.session,dialect:this.dialect,distinct:{on:e}})}update(e){return new Xs(e,this.session,this.dialect)}insert(e){return new Gs(e,this.session,this.dialect)}delete(e){return new Js(e,this.session,this.dialect)}refreshMaterializedView(e){return new un(e,this.session,this.dialect)}authToken;execute(e){let t=typeof e=="string"?m.raw(e):e.getSQL(),r=this.dialect.sqlToQuery(t),i=this.session.prepareQuery(r,void 0,void 0,!1);return new pn(()=>i.execute(void 0,this.authToken),t,r,n=>i.mapResult(n,!0))}transaction(e,t){return this.session.transaction(e,t)}};var Kc=class{static[p]="Cache"},Ir=class extends Kc{strategy(){return"all"}static[p]="NoopCache";async get(e){}async put(e,t,r,i){}async onMutate(e){}};async function zc(s,e){let t=`${s}-${JSON.stringify(e)}`,i=new TextEncoder().encode(t),n=await crypto.subtle.digest("SHA-256",i);return[...new Uint8Array(n)].map(l=>l.toString(16).padStart(2,"0")).join("")}var mn=class{constructor(e,t,r,i){this.query=e,this.cache=t,this.queryMetadata=r,this.cacheConfig=i,t&&t.strategy()==="all"&&i===void 0&&(this.cacheConfig={enable:!0,autoInvalidate:!0}),this.cacheConfig?.enable||(this.cacheConfig=void 0)}authToken;getQuery(){return this.query}mapResult(e,t){return e}setToken(e){return this.authToken=e,this}static[p]="PgPreparedQuery";joinsNotNullableMap;async queryWithCache(e,t,r){if(this.cache===void 0||S(this.cache,Ir)||this.queryMetadata===void 0)try{return await r()}catch(i){throw new Ot(e,t,i)}if(this.cacheConfig&&!this.cacheConfig.enable)try{return await r()}catch(i){throw new Ot(e,t,i)}if((this.queryMetadata.type==="insert"||this.queryMetadata.type==="update"||this.queryMetadata.type==="delete")&&this.queryMetadata.tables.length>0)try{let[i]=await Promise.all([r(),this.cache.onMutate({tables:this.queryMetadata.tables})]);return i}catch(i){throw new Ot(e,t,i)}if(!this.cacheConfig)try{return await r()}catch(i){throw new Ot(e,t,i)}if(this.queryMetadata.type==="select"){let i=await this.cache.get(this.cacheConfig.tag??await zc(e,t),this.queryMetadata.tables,this.cacheConfig.tag!==void 0,this.cacheConfig.autoInvalidate);if(i===void 0){let n;try{n=await r()}catch(o){throw new Ot(e,t,o)}return await this.cache.put(this.cacheConfig.tag??await zc(e,t),n,this.cacheConfig.autoInvalidate?this.queryMetadata.tables:[],this.cacheConfig.tag!==void 0,this.cacheConfig.config),n}return i}try{return await r()}catch(i){throw new Ot(e,t,i)}}},gn=class{constructor(e){this.dialect=e}static[p]="PgSession";execute(e,t){return ne.startActiveSpan("drizzle.operation",()=>ne.startActiveSpan("drizzle.prepareQuery",()=>this.prepareQuery(this.dialect.sqlToQuery(e),void 0,void 0,!1)).setToken(t).execute(void 0,t))}all(e){return this.prepareQuery(this.dialect.sqlToQuery(e),void 0,void 0,!1).all()}async count(e,t){let r=await this.execute(e,t);return Number(r[0].count)}},yn=class extends $r{constructor(e,t,r,i=0){super(e,t,r),this.schema=r,this.nestedIndex=i}static[p]="PgTransaction";rollback(){throw new Yi}getTransactionConfigSQL(e){let t=[];return e.isolationLevel&&t.push(`isolation level ${e.isolationLevel}`),e.accessMode&&t.push(e.accessMode),typeof e.deferrable=="boolean"&&t.push(e.deferrable?"deferrable":"not deferrable"),m.raw(t.join(" "))}setTransaction(e){return this.session.execute(m`set transaction ${this.getTransactionConfigSQL(e)}`)}};var Wc=class extends mn{constructor(e,t,r,i,n,o,a,l,c,u){super({sql:t,params:r},n,o,a),this.client=e,this.queryString=t,this.params=r,this.logger=i,this.fields=l,this._isResponseInArrayMode=c,this.customResultMapper=u}static[p]="PostgresJsPreparedQuery";async execute(e={}){return ne.startActiveSpan("drizzle.execute",async t=>{let r=yl(this.params,e);t?.setAttributes({"drizzle.query.text":this.queryString,"drizzle.query.params":JSON.stringify(r)}),this.logger.logQuery(this.queryString,r);let{fields:i,queryString:n,client:o,joinsNotNullableMap:a,customResultMapper:l}=this;if(!i&&!l)return ne.startActiveSpan("drizzle.driver.execute",()=>this.queryWithCache(n,r,async()=>await o.unsafe(n,r)));let c=await ne.startActiveSpan("drizzle.driver.execute",()=>(t?.setAttributes({"drizzle.query.text":n,"drizzle.query.params":JSON.stringify(r)}),this.queryWithCache(n,r,async()=>await o.unsafe(n,r).values())));return ne.startActiveSpan("drizzle.mapResponse",()=>l?l(c):c.map(u=>zf(i,u,a)))})}all(e={}){return ne.startActiveSpan("drizzle.execute",async t=>{let r=yl(this.params,e);return t?.setAttributes({"drizzle.query.text":this.queryString,"drizzle.query.params":JSON.stringify(r)}),this.logger.logQuery(this.queryString,r),ne.startActiveSpan("drizzle.driver.execute",()=>(t?.setAttributes({"drizzle.query.text":this.queryString,"drizzle.query.params":JSON.stringify(r)}),this.queryWithCache(this.queryString,r,async()=>this.client.unsafe(this.queryString,r))))})}isResponseInArrayMode(){return this._isResponseInArrayMode}},Ys=class s extends gn{constructor(e,t,r,i={}){super(t),this.client=e,this.schema=r,this.options=i,this.logger=i.logger??new en,this.cache=i.cache??new Ir}static[p]="PostgresJsSession";logger;cache;prepareQuery(e,t,r,i,n,o,a){return new Wc(this.client,e.sql,e.params,this.logger,this.cache,o,a,t,i,n)}query(e,t){return this.logger.logQuery(e,t),this.client.unsafe(e,t).values()}queryObjects(e,t){return this.client.unsafe(e,t)}transaction(e,t){return this.client.begin(async r=>{let i=new s(r,this.dialect,this.schema,this.options),n=new Qc(this.dialect,i,this.schema);return t&&await n.setTransaction(t),e(n)})}},Qc=class s extends yn{constructor(e,t,r,i=0){super(e,t,r,i),this.session=t}static[p]="PostgresJsTransaction";transaction(e){return this.session.client.savepoint(t=>{let r=new Ys(t,this.dialect,this.schema,this.session.options),i=new s(this.dialect,r,this.schema);return e(i)})}};var Jc=class extends $r{static[p]="PostgresJsDatabase"};function Mr(s,e={}){let t=l=>l;for(let l of["1184","1082","1083","1114","1182","1185","1115","1231"])s.options.parsers[l]=t,s.options.serializers[l]=t;s.options.serializers[114]=t,s.options.serializers[3802]=t;let r=new Xt({casing:e.casing}),i;e.logger===!0?i=new Zi:e.logger!==!1&&(i=e.logger);let n;if(e.schema){let l=Gp(e.schema,Yp);n={fullSchema:e.schema,schema:l.tables,tableNamesMap:l.tableNamesMap}}let o=new Ys(s,r,n,{logger:i,cache:e.cache}),a=new Jc(r,o,n);return a.$client=s,a.$cache=e.cache,a.$cache&&(a.$cache.invalidate=e.cache?.onMutate),a}function bn(...s){if(typeof s[0]=="string"){let e=(0,wn.default)(s[0]);return Mr(e,s[1])}if(Jf(s[0])){let{connection:e,client:t,...r}=s[0];if(t)return Mr(t,r);if(typeof e=="object"&&e.url!==void 0){let{url:n,...o}=e,a=(0,wn.default)(n,o);return Mr(a,r)}let i=(0,wn.default)(e);return Mr(i,r)}return Mr(s[0],s[1])}(s=>{function e(t){return Mr({options:{parsers:{},serializers:{}}},t)}s.mock=e})(bn||(bn={}));var pm=Jt(require("postgres"),1);var Zc={};zi(Zc,{abTestLogs:()=>Jb,abTestProducts:()=>Qb,abTestStatusEnum:()=>lm,abWorkTypeEnum:()=>Gc,botRoleEnum:()=>rm,botStatusEnum:()=>sm,bots:()=>Lb,campaignStatusEnum:()=>tm,campaigns:()=>jb,distributedExperimentStatusEnum:()=>fm,distributedExperiments:()=>Yb,distributedTaskStatusEnum:()=>hm,distributedTaskTypeEnum:()=>dm,distributedTasks:()=>_n,enginePerformance:()=>Gb,engineTestProducts:()=>Xb,engineTestStatusEnum:()=>cm,experimentProducts:()=>Hb,experimentRankHistory:()=>Wb,experimentRuns:()=>Kb,experimentTrafficLogs:()=>zb,logLevelEnum:()=>om,naverCookies:()=>Vb,platformEnum:()=>em,rankings:()=>Ub,roleEnum:()=>Zp,searchTypeEnum:()=>Xc,taskLogs:()=>Fb,taskStatusEnum:()=>nm,tasks:()=>Bb,trafficStatusEnum:()=>am,users:()=>Db,variableCombinations:()=>qb,variableStatusEnum:()=>im,workerNodeStatusEnum:()=>um,workerNodeTypeEnum:()=>Yc,workerNodes:()=>Mt});var Zp=ke("role",["user","admin"]),em=ke("platform",["naver","coupang"]),tm=ke("campaign_status",["active","paused","completed"]),rm=ke("bot_role",["leader","follower","rank_checker"]),sm=ke("bot_status",["online","offline","error"]),im=ke("variable_status",["new","testing","elite","significant","deprecated"]),nm=ke("task_status",["pending","running","completed","failed"]),om=ke("log_level",["info","warning","error"]),Db=Ee("users",{id:T("id").primaryKey().generatedAlwaysAsIdentity(),openId:H("openId",{length:64}).notNull().unique(),name:K("name"),email:H("email",{length:320}),loginMethod:H("loginMethod",{length:64}),role:Zp("role").default("user").notNull(),createdAt:j("createdAt").defaultNow().notNull(),updatedAt:j("updatedAt").defaultNow().notNull(),lastSignedIn:j("lastSignedIn").defaultNow().notNull()}),jb=Ee("campaigns",{id:T("id").primaryKey().generatedAlwaysAsIdentity(),name:H("name",{length:255}).notNull(),platform:em("platform").notNull(),keyword:H("keyword",{length:255}).notNull(),productId:H("productId",{length:100}).notNull(),status:tm("status").default("paused").notNull(),createdAt:j("createdAt").defaultNow().notNull(),updatedAt:j("updatedAt").defaultNow().notNull()}),Lb=Ee("bots",{id:T("id").primaryKey().generatedAlwaysAsIdentity(),deviceId:H("deviceId",{length:50}).notNull().unique(),deviceModel:H("deviceModel",{length:100}),role:rm("role").notNull(),groupId:T("groupId"),status:sm("status").default("offline").notNull(),lastActivity:j("lastActivity").defaultNow().notNull(),createdAt:j("createdAt").defaultNow().notNull()}),qb=Ee("variable_combinations",{id:T("id").primaryKey().generatedAlwaysAsIdentity(),variables:K("variables").notNull(),status:im("status").default("new").notNull(),generation:T("generation").default(0).notNull(),performanceScore:T("performanceScore").default(0),avgRank:T("avgRank"),successRate:T("successRate"),captchaAvoidRate:T("captchaAvoidRate"),createdAt:j("createdAt").defaultNow().notNull()}),Ub=Ee("rankings",{id:T("id").primaryKey().generatedAlwaysAsIdentity(),campaignId:T("campaignId").notNull(),rank:T("rank").notNull(),reliabilityScore:T("reliabilityScore"),isSignificant:T("isSignificant").default(0),timestamp:j("timestamp").defaultNow().notNull()}),Bb=Ee("tasks",{id:T("id").primaryKey().generatedAlwaysAsIdentity(),campaignId:T("campaignId").notNull(),keywordId:T("keywordId"),trafficId:T("trafficId"),uaChange:T("uaChange").notNull().default(1),cookieHomeMode:T("cookieHomeMode").notNull().default(1),shopHome:T("shopHome").notNull().default(1),useNid:T("useNid").notNull().default(0),useImage:T("useImage").notNull().default(1),workType:T("workType").notNull().default(3),randomClickCount:T("randomClickCount").notNull().default(2),workMore:T("workMore").notNull().default(1),secFetchSiteMode:T("secFetchSiteMode").notNull().default(1),lowDelay:T("lowDelay").notNull().default(2),status:nm("status").default("pending").notNull(),rank:T("rank"),errorMessage:K("errorMessage"),createdAt:j("createdAt").defaultNow().notNull(),updatedAt:j("updatedAt").defaultNow().notNull()}),Fb=Ee("taskLogs",{id:T("id").primaryKey().generatedAlwaysAsIdentity(),taskId:T("taskId").notNull(),level:om("level").default("info").notNull(),message:K("message").notNull(),metadata:K("metadata"),createdAt:j("createdAt").defaultNow().notNull()}),Vb=Ee("naverCookies",{id:T("id").primaryKey().generatedAlwaysAsIdentity(),nnb:H("nnb",{length:255}).notNull(),nidAut:H("nidAut",{length:255}),nidSes:H("nidSes",{length:255}),nidJkl:H("nidJkl",{length:255}),isActive:T("isActive").default(1).notNull(),lastUsedAt:j("lastUsedAt"),createdAt:j("createdAt").defaultNow().notNull()}),am=ke("traffic_status",["pending","in_progress","completed","checked"]),Gc=ke("ab_work_type",["\uD1B5\uAC80","\uC1FC\uAC80"]),lm=ke("ab_test_status",["pending","running","completed","failed"]),Hb=Ee("experimentProducts",{id:T("id").primaryKey().generatedAlwaysAsIdentity(),productName:K("productName").notNull(),keyword:H("keyword",{length:255}).notNull(),sourceUrl:K("sourceUrl"),position:T("position"),productId:H("productId",{length:100}),isUsed:T("isUsed").default(0).notNull(),trafficCount:T("trafficCount").default(0),successCount:T("successCount").default(0),trafficStatus:am("trafficStatus").default("pending"),trafficDate:j("trafficDate"),checkDate:j("checkDate"),resultRank:T("resultRank"),searchMethod:H("searchMethod",{length:50}),strategyDetails:K("strategyDetails"),createdAt:j("createdAt").defaultNow().notNull()}),Kb=Ee("experimentRuns",{id:T("id").primaryKey().generatedAlwaysAsIdentity(),description:K("description"),startedAt:j("startedAt").defaultNow().notNull(),completedAt:j("completedAt"),totalProducts:T("totalProducts").default(0),totalTrafficExecuted:T("totalTrafficExecuted").default(0)}),zb=Ee("experimentTrafficLogs",{id:T("id").primaryKey().generatedAlwaysAsIdentity(),experimentRunId:T("experimentRunId").notNull(),productId:H("productId",{length:100}).notNull(),variableCombinationId:T("variableCombinationId"),variablesUsed:K("variablesUsed"),executedAt:j("executedAt").defaultNow().notNull(),success:T("success").default(1).notNull(),errorMessage:K("errorMessage")}),Wb=Ee("experimentRankHistory",{id:T("id").primaryKey().generatedAlwaysAsIdentity(),experimentRunId:T("experimentRunId").notNull(),productId:H("productId",{length:100}).notNull(),rank:T("rank").notNull(),checkDay:T("checkDay").notNull(),checkedAt:j("checkedAt").defaultNow().notNull(),notes:K("notes")}),Qb=Ee("abTestProducts",{id:T("id").primaryKey().generatedAlwaysAsIdentity(),mid:H("mid",{length:100}).notNull(),keyword:H("keyword",{length:255}).notNull(),productName:K("productName").notNull(),currentRank:T("currentRank"),finalRank:T("finalRank"),rankChange:T("rankChange"),workType:Gc("workType").notNull(),status:lm("status").default("pending").notNull(),variables:K("variables"),testGroup:H("testGroup",{length:50}),trafficCount:T("trafficCount").default(0),successCount:T("successCount").default(0),lastUrl:K("lastUrl"),errorMessage:K("errorMessage"),executedAt:j("executedAt"),checkedAt:j("checkedAt"),createdAt:j("createdAt").defaultNow().notNull(),updatedAt:j("updatedAt").defaultNow().notNull()}),Jb=Ee("abTestLogs",{id:T("id").primaryKey().generatedAlwaysAsIdentity(),productId:T("productId").notNull(),workType:Gc("workType").notNull(),variables:K("variables"),success:T("success").default(1).notNull(),finalUrl:K("finalUrl"),duration:T("duration"),errorMessage:K("errorMessage"),createdAt:j("createdAt").defaultNow().notNull()}),Xc=ke("search_type",["\uC1FC\uAC801","\uD1B5\uAC80"]),cm=ke("engine_test_status",["pending","running","completed","failed"]),Gb=Ee("enginePerformance",{id:T("id").primaryKey().generatedAlwaysAsIdentity(),engineVersion:H("engineVersion",{length:10}).notNull(),searchType:Xc("searchType").notNull(),totalRankChange:T("totalRankChange").default(0),avgRankChange:T("avgRankChange").default(0),totalProducts:T("totalProducts").default(0),successProducts:T("successProducts").default(0),trafficSuccessRate:T("trafficSuccessRate").default(0),captchaRate:T("captchaRate").default(0),date:j("date").notNull(),createdAt:j("createdAt").defaultNow().notNull(),updatedAt:j("updatedAt").defaultNow().notNull()}),Xb=Ee("engineTestProducts",{id:T("id").primaryKey().generatedAlwaysAsIdentity(),mid:H("mid",{length:100}).notNull(),catalogMid:H("catalogMid",{length:100}),keyword:H("keyword",{length:255}).notNull(),productName:K("productName").notNull(),url:K("url"),engineVersion:H("engineVersion",{length:10}).notNull(),searchType:Xc("searchType").notNull(),beforeRank:T("beforeRank"),afterRank:T("afterRank"),rankChange:T("rankChange"),status:cm("status").default("pending").notNull(),trafficCount:T("trafficCount").default(0),successCount:T("successCount").default(0),captchaCount:T("captchaCount").default(0),errorMessage:K("errorMessage"),entryTimeMs:T("entryTimeMs"),entrySuccess:T("entrySuccess"),dwellTimeMs:T("dwellTimeMs"),profileData:K("profileData"),date:j("date").notNull(),beforeCheckedAt:j("beforeCheckedAt"),trafficStartedAt:j("trafficStartedAt"),trafficCompletedAt:j("trafficCompletedAt"),afterCheckedAt:j("afterCheckedAt"),createdAt:j("createdAt").defaultNow().notNull(),updatedAt:j("updatedAt").defaultNow().notNull()}),Yc=ke("worker_node_type",["experiment","worker"]),um=ke("worker_node_status",["online","offline","busy"]),dm=ke("distributed_task_type",["experiment","production"]),hm=ke("distributed_task_status",["pending","assigned","running","completed","failed"]),fm=ke("distributed_experiment_status",["draft","running","analyzing","completed"]),Mt=Ee("workerNodes",{id:T("id").primaryKey().generatedAlwaysAsIdentity(),nodeId:H("nodeId",{length:50}).notNull().unique(),nodeType:Yc("nodeType").notNull(),status:um("status").default("offline").notNull(),lastHeartbeat:j("lastHeartbeat"),currentTaskId:T("currentTaskId"),leaseExpiresAt:j("leaseExpiresAt"),leaseTtlSeconds:T("leaseTtlSeconds").default(60),hostname:H("hostname",{length:100}),ipAddress:H("ipAddress",{length:50}),createdAt:j("createdAt").defaultNow().notNull(),updatedAt:j("updatedAt").defaultNow().notNull()}),Yb=Ee("distributedExperiments",{id:T("id").primaryKey().generatedAlwaysAsIdentity(),name:H("name",{length:255}).notNull(),description:K("description"),variableConfig:K("variableConfig").notNull(),testCountPerCombo:T("testCountPerCombo").default(10).notNull(),successThreshold:T("successThreshold").default(90),status:fm("status").default("draft").notNull(),generation:T("generation").default(0).notNull(),totalCombinations:T("totalCombinations").default(0),testedCombinations:T("testedCombinations").default(0),eliteCombinations:K("eliteCombinations"),createdAt:j("createdAt").defaultNow().notNull(),startedAt:j("startedAt"),completedAt:j("completedAt")}),_n=Ee("distributedTasks",{id:T("id").primaryKey().generatedAlwaysAsIdentity(),experimentId:T("experimentId"),taskType:dm("taskType").notNull(),targetNodeType:Yc("targetNodeType"),assignedNodeId:H("assignedNodeId",{length:50}),productId:T("productId"),keyword:H("keyword",{length:255}).notNull(),nvMid:H("nvMid",{length:100}).notNull(),productName:K("productName").notNull(),productUrl:K("productUrl"),variables:K("variables").notNull(),status:hm("status").default("pending").notNull(),priority:T("priority").default(0).notNull(),assignedExpiresAt:j("assignedExpiresAt"),leaseTtlSeconds:T("leaseTtlSeconds").default(120),retryCount:T("retryCount").default(0),maxRetries:T("maxRetries").default(3),deadLetterReason:K("deadLetterReason"),result:K("result"),beforeRank:T("beforeRank"),afterRank:T("afterRank"),createdAt:j("createdAt").defaultNow().notNull(),assignedAt:j("assignedAt"),startedAt:j("startedAt"),completedAt:j("completedAt")});var Dr=null,Dt=null;function mm(){let s=process.env.ENV_MODE||"experiment";return s!=="experiment"&&s!=="production"&&s!=="control"?(console.warn(`[DirectDb] Unknown ENV_MODE: ${s}, defaulting to experiment`),"experiment"):s}function Zb(){let s=mm(),e=process.env.DATABASE_URL;if(!e)throw new Error(`[DirectDb] DATABASE_URL not set.
  Current ENV_MODE: ${s}
  Please set DATABASE_URL in your .env file for the ${s} environment.`);return e}async function jr(){if(Dr)return Dr;let s=Zb(),e=mm();console.log(`[DirectDb] Connecting to ${e} database...`);try{return Dt=(0,pm.default)(s,{max:10,idle_timeout:20,connect_timeout:10}),Dr=bn(Dt,{schema:Zc}),await Dt`SELECT 1`,console.log(`[DirectDb] Connected to ${e} database successfully`),Dr}catch(t){throw console.error(`[DirectDb] Failed to connect to ${e} database:`,t),Dr=null,Dt=null,t}}async function vn(){Dt&&(console.log("[DirectDb] Closing database connection..."),await Dt.end(),Dt=null,Dr=null,console.log("[DirectDb] Database connection closed"))}async function gm(){return Dt||await jr(),Dt}process.on("SIGINT",async()=>{await vn(),process.exit(0)});process.on("SIGTERM",async()=>{await vn(),process.exit(0)});var ur=process.env.NODE_ID||`worker-${Rf.default.hostname()}`,ab=parseInt(process.env.BATCH_SIZE||"10"),xf=parseInt(process.env.BATCH_REST_INTERVAL||"60000"),oT=parseInt(process.env.POLL_INTERVAL||"5000"),aT=parseInt(process.env.HEARTBEAT_INTERVAL||"30000"),lb=!0,Ga=null,Xa=0,Be={totalTasks:0,successCount:0,failCount:0,captchaCount:0,totalDuration:0};function de(s,e="info"){let t=new Date().toISOString(),r={info:"[INFO]",warn:"[WARN]",error:"[ERROR]"}[e];console.log(`[${t}] ${r} ${s}`)}function Cf(s){return new Promise(e=>setTimeout(e,s))}async function lT(){let s=await jr();(await s.select().from(Mt).where(It(Mt.nodeId,ur)).limit(1)).length===0?(await s.insert(Mt).values({nodeId:ur,nodeType:"worker",hostname:Rf.default.hostname(),status:"online",lastHeartbeat:new Date}),de(`New worker registered: ${ur}`)):(await s.update(Mt).set({status:"online",lastHeartbeat:new Date}).where(It(Mt.nodeId,ur)),de(`Worker reconnected: ${ur}`))}async function cT(){try{await(await jr()).update(Mt).set({lastHeartbeat:new Date,status:"online"}).where(It(Mt.nodeId,ur))}catch(s){de(`Heartbeat failed: ${s.message}`,"warn")}}async function uT(){try{let e=await(await gm())`
      UPDATE "distributedTasks"
      SET
        status = 'processing',
        "assignedTo" = ${ur},
        "startedAt" = NOW()
      WHERE id = (
        SELECT id FROM "distributedTasks"
        WHERE status = 'pending'
          AND "assignedTo" IS NULL
        ORDER BY priority DESC, "createdAt" ASC
        LIMIT 1
        FOR UPDATE SKIP LOCKED
      )
      RETURNING *
    `;return e.length===0?null:e[0]}catch(s){return de(`Poll failed: ${s.message}`,"error"),null}}async function dT(s){let e=Date.now();try{let r=(s.variables||{}).engine_version||"v7";de(`Executing: ${s.productName?.substring(0,30)}... (${r})`);let{EngineRouter:i}=await Promise.resolve().then(()=>(ob(),nb)),n=i.getEngine(r);await n.init();let o=await n.execute({nvMid:s.nvMid,productName:s.productName,keyword:s.keyword});await n.close();let a=Date.now()-e;return{success:o.success,captcha:o.blocked||!1,duration:a,finalUrl:o.finalUrl}}catch(t){return{success:!1,captcha:!1,duration:Date.now()-e,error:t.message}}}async function hT(s,e){try{await(await jr()).update(_n).set({status:e.success?"completed":"failed",completedAt:new Date,result:{success:e.success,captcha:e.captcha,duration:e.duration,error:e.error,finalUrl:e.finalUrl}}).where(It(_n.id,s))}catch(t){de(`Report failed: ${t.message}`,"error")}}function cb(){let s=Be.totalTasks>0?Math.round(Be.successCount/Be.totalTasks*100):0,e=Be.totalTasks>0?Math.round(Be.captchaCount/Be.totalTasks*100):0,t=Be.totalTasks>0?Math.round(Be.totalDuration/Be.totalTasks/1e3):0;de(`Stats: Total ${Be.totalTasks} | Success ${s}% | Captcha ${e}% | Avg ${t}s`)}async function fT(){de("==========================================="),de("  TURAFIC Standalone Worker Runner"),de("==========================================="),de(`  Node ID: ${ur}`),de(`  Batch Size: ${ab}`),de(`  Batch Rest: ${Math.round(xf/1e3)}s`),de("===========================================");try{await jr(),de("Database connected successfully")}catch(e){de(`Database connection failed: ${e.message}`,"error"),de("Check DATABASE_URL in your .env file","error"),process.exit(1)}await lT();let s=setInterval(cT,aT);for(process.on("SIGINT",async()=>{de("Shutdown signal received..."),lb=!1,clearInterval(s),Ga&&de(`Waiting for current task #${Ga} to complete...`),cb(),await vn(),process.exit(0)}),de("Starting task polling...");lb;){let e=await uT();if(!e){await Cf(oT);continue}Ga=e.id;let t=await dT(e);await hT(e.id,t),Be.totalTasks++,Be.totalDuration+=t.duration,t.success?Be.successCount++:Be.failCount++,t.captcha&&Be.captchaCount++;let r=t.success?"[OK]":"[FAIL]";de(`${r} Task #${e.id} completed (${Math.round(t.duration/1e3)}s)`),Ga=null,Xa++,Xa>=ab?(de(`Batch complete (${Xa} tasks). Resting ${Math.round(xf/1e3)}s...`),cb(),Xa=0,await Cf(xf),de("Resuming...")):await Cf(1e3)}de("Worker stopped")}fT().catch(s=>{de(`Fatal error: ${s.message}`,"error"),process.exit(1)});
